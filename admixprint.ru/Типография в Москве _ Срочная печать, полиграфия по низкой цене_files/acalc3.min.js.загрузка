$(function(){
	$(window).scroll(function(){
		calcPricePositionFix();
	});
	calcPricePositionFix();
	
	$(".iagree_form_block_calc").html(
		'<input type="checkbox" data-id="agreement" name="agreement" class="agreement">'
		+'<label for="agreement"><div class="agreement_block">Я согласен с <a target="_blank" href="/pravila-prodazhi-tovarov-i-uslug-v-internet-magazine-a-cifra/">Пользовательским соглашением</a></div></label>'
		+'<p style="margin-top:10px; font-size:10px; color: #7d7d7d; line-height: 11px;">Мы гарантируем, что Ваши данные не будут использованы для рассылки нежелательной информации и ни при каких условиях не будут переданы третьим лицам</p>'
		+'<div style="color:#d7121c; font-size: 14px; line-height: 14px; margin-top: 5px;" class="input_confirm"></div>'
	);

    initCalc();

    $("#calcPostLoadContainer").append('<div class="sp40"></div><div class="calcBlock"><a href="#" data-tab="digital" class="active">Цифровая печать</a><a href="#" data-tab="offset">Офсетная печать</a><hr /><div style="height:40px;"></div><div class="digital"></div><div style="display:none;" class="offset offset_only"></div></div><div class="sp40"></div>');
    $("#calcPostLoadContainer").find(".digital").load("/tpl/newcalculator5.tpl", function(){ initCalc(); });
    $("#calcPostLoadContainer").find(".offset").load("/tpl/newcalculator5.tpl", function(){ initCalc(); });
});

function initCalc(){
    $("div.calcPrice .dostavka a").on("click", function(e){
        e.preventDefault();
        e.stopPropagation();

        var acalc = $(this).closest("form.acalc");

        $('html, body').animate({
            scrollTop: acalc.find(".deliveryBlock").offset().top
        }, 500, function(){
            acalc.find(".deliveryBlock a[data-tab=\"sdek\"]").trigger("click");
            acalc.find(".deliveryBlock .tab-sdek a:first").trigger("click");
        });

        return false;
    });

    $("div.calcBlock").not(".nohelpers").append(
		$("<a class=\"helper ofsethint\" href=\"#\"></a>")
			.on('click', function(e){
				e.preventDefault();
				e.stopPropagation();

				return helper(this);
			})
	);
	$("div.calcBlock").not(".nohelpers").append(
		$("<a class=\"helper cifrahint\" href=\"#\"></a>")
			.on('click', function(e){
				e.preventDefault();
				e.stopPropagation();

				return helper(this);
			})
	);

	$("form.acalc").find("input[name=needmaket]").on("change", function(){
		$(this).parent().find("input[name=needmaket_val]").val($(this).val());
		if($(this).val() == "не срочно 1-2 дня"){
			$(this).closest(".acalc").find(".workout").hide();
			$(this).closest(".acalc").find(".finalPrice > div:nth-child(4)").hide();
		}
		else {
			$(this).closest(".acalc").find(".workout").show();
			$(this).closest(".acalc").find(".finalPrice > div:nth-child(4)").show();
		}
	});

	$("form.acalc > .calcStep2 > .paymentBlock").find("input").on("change", function(){
		if($(this).val() == "Предоплата по безналу"){
			if(!$(this).closest("div.calcStep2").find(".businessBlock").is(":visible")) {
				$(this).closest("div.calcStep2").find(".businessBlock").slideDown(200);
			}
		}
		else if($(this).closest("div.calcStep2").find(".businessBlock").is(":visible")) {
			$(this).closest("div.calcStep2").find(".businessBlock").slideUp(200);
		}
	});

	$("div.calcBlock > a:not(.helper)").on("click", function(e){
		e.preventDefault();
		e.stopPropagation();

		$("div.calcBlock > a").removeClass("active");
		$("div.calcBlock > div.digital").hide();
		$("div.calcBlock > div.offset").hide();
		$("div.calcBlock > div."+$(this).data("tab")).show();
		$(this).addClass("active");

		return false;
	});

	$("form.acalc").find("input[type=file]").each(function(){
		var label = $(this).next();

		$(this).on('change', function(e){
			var fileName = '';
			var fileinput = $(this)[0];
			if (fileinput.files && fileinput.files.length > 1)
				fileName = ( fileinput.getAttribute('data-multiple-caption') || '' ).replace('{count}', fileinput.files.length);
			else
				fileName = e.target.value.split('\\').pop();

			if (fileName) {
				label.find('span').html(fileName);
			}
			else {
				label.find('span').html(label.html());
			}
		});

		// Firefox bug fix
		$(this).on('focus', function () {
			$(this).addClass('has-focus');
		});
		$(this).on('blur', function () {
			$(this).removeClass('has-focus');
		});
	});

	$("form.acalc > .calcStep2 > .deliveryBlock .tabs").find("a").each(function(){
		$(this).on("click", function(e){
			e.preventDefault();
			e.stopPropagation();

			$(this).parent().find("a").removeClass("active");
			$(this).addClass("active");
			$(this).parent().parent().find("div.tab-self").hide();
			$(this).parent().parent().find("div.tab-delivery").hide();
            $(this).parent().parent().find("div.tab-sdek").hide();
			$(this).parent().parent().find("div.tab-"+$(this).data("tab")).show();
			$("input[name=address]").val("");

			return false;
		});
	});

	$("form.acalc").find("a.nomaket").unbind("click").on("click", function(e){
		e.preventDefault();
		e.stopPropagation();

		$(this).toggleClass("active").next().slideToggle(200);
		if($(this).hasClass("active")){
			$(this).next().find("input[name=needmaket_val]").val($(this).next().find("input[name=needmaket]").val());
		}
		else {
			$(this).next().find("input[name=needmaket_val]").val("");
		}

		return false;
	});
    $("form.acalc").find("div.slider-range").slider({
      	range: "max",
      	min: 1,
      	max: 10,
      	value: 1,
      	slide: function(event, ui) {
        	$("input[name=layouts]").val(ui.value);
      	}
	});

	$("form.acalc").find("input[name=layouts]")
		.val($("form.acalc").find("div.slider-range").slider("value"))
		.on("change", function(){
			var value = parseInt($(this).val());
			if($(this).val() > 10){
				value = 10;
				$(this).val(10);
			}
			if($(this).val() < 1){
				value = 1;
				$(this).val(1);
			}
			$("form.acalc").find("div.slider-range").slider("value", value);
		});

	$("form.acalc").each(function(){
		if($(this).parent().hasClass("offset_only")){
            $(this).find("input[data-id]").each(function(){
                $(this).attr("id", "offest_"+$(this).data("id"));
                $(this).next().attr("for", "offest_"+$(this).data("id"));
            });

			if($(this).parent().parent().find("select[name=product] option:selected").val() == 7){
				$(this).parent().parent().find("select[name=product] option:selected").removeAttr("selected");
				$(this).parent().parent().find("select[name=product] option[value=4]").attr("selected", "selected");
			}
			$(this).parent().find("div.acalc_plus > span:nth-child(1)").attr("data-value", "Бесплатная цветопроба");
			$(this).parent().find("div.acalc_plus > span:nth-child(2)").attr("data-value", "Печать от 3 дней");
			$(this).parent().find("div.acalc_plus > span:nth-child(3)").attr("data-value", "Оплата картой");
			$(this).parent().find("div.acalc_plus > span:nth-child(4)").attr("data-value", "Курьерская доставка");
		}
        else {
            $(this).find("input[data-id]").each(function(){
                $(this).attr("id", $(this).data("id"));
                $(this).next().attr("for", $(this).data("id"));
            });
        }
	});

	$("div.acalc_plus > span").hover(
		function(){
			$(this).parent().append(
				$("<div class=\"hint\"></div>")
					.text($(this).data("value"))
			);

		},
		function(){
			$(this).parent().find("div.hint").remove();
		}
	);

	$('.phone').inputmask("+7 (999) 999 9999");

    $("form.acalc").find("a.finalCalcOrder").on('click', function(e){
        e.preventDefault();
		e.stopPropagation();

		var calc = $(this).closest("form.acalc");
        if(calc.is(":visible")){
    		var submit = true;

    		submit = checkField('name', 'Укажите ваше имя', false, calc);
    		submit = checkField('phone', 'Укажите контактный телефон', false, calc);
    		submit = checkField('email', 'Укажите контактный email', true, calc);

    		if(!calc.find(".agreement").is(":checked")){
    			submit = false;
    			calc.find(".input_confirm").text("Подтвердите свое согласие на обработку персональных данных");
    		}
    		else{
    			calc.find(".input_confirm").text("");
    		}

    		if(submit){
    			 if (!!window.send_calltouch){ window.send_calltouch(calc); }
    			 try{
    			 	yaCounter21621268.reachGoal('calc');
    			 	ga('send', 'event', 'Calculator', 'order');
    			} catch(e) { }

    			calc.submit();
    		}
    		else {
    			if(calc.find("input.error:first").length){
    				$('html, body').animate({
    					scrollTop: calc.find("input.error:first").parent().offset().top
    				}, 500);
    			}
    			else if(calc.find(".input_confirm").text() != ""){
    				$('html, body').animate({
    					scrollTop: calc.find(".finalBtnBlock").offset().top
    				}, 500);
    			}
    		}
        }

		return false;
	});

	$("form.acalc").find(".firstCalcOrder").on('click', function(e){
		e.preventDefault();
		e.stopPropagation();

		var form = $(this).closest('form')[0];
		var formData = new FormData(form);
		formData.append('resulttime', $(this).closest('form').find("span.resulttime").text());
		formData.append('maket', $('input[name="maket[]"]')[0].files[0]);

		$.ajax({
		       url : '/newcalcshow2.php?addtocart=1',
		       type : 'POST',
		       data : formData,
		       processData: false,  // tell jQuery not to process the data
		       contentType: false,  // tell jQuery not to set contentType
		       success : function(data) {
		           $(".cartHolder>span").text(data);
		       }
		});

		return false;
	});

	$(".procentDiscount").click(function(){
		$(this).parent().find(".discount_like_click").val(1);
	});

	$("a.deleteCartItem").on('click', function(e){
		e.stopPropagation();
		e.preventDefault();

		let caller = $(this);

		$.get("/newcalcshow2.php?removefromcart="+caller.data('id'), function(data){
			caller.parent().remove();
			if(data == 0) {
				$("div.calcStep2").html('<span style="float:left;" class="calcTitle">Корзина</span><a style="float:right;" class="makeCalcOrder" href="/">Продолжить покупки</a><div class="clr"></div><p>Ваша корзина пуста</p>');
			}
		}, "text");

		return false;
	});

	if($("div.calcStep1").length){
		getProduct();
	}
}

function calcPricePositionFix(){
	var acalc = $("form.acalc:visible");
	var height = acalc.find(".calcStep1").height();
	var calcPrice = $("form.acalc:visible .calcPrice");

	if(calcPrice.length) {
		if(acalc.length && acalc.offset().top < $(window).scrollTop()){
			if((($(window).scrollTop() + calcPrice.height()) >= (calcPrice.offset().top + calcPrice.height())) && ((acalc.offset().top + height) < (calcPrice.offset().top + calcPrice.height()))){
				if((calcPrice.offset().top + calcPrice.height()) < (height + acalc.offset().top)){
					calcPrice.css({
						"position": "absolute",
						"top": "auto",
						"bottom": 0,
						"right": 0
					});
				}
			}
			else {
				var shift = acalc.find(".calcStep1").offset().top + height - calcPrice.height();
				var calcPriceTop = shift > $(window).scrollTop() ? $(window).scrollTop() : shift;
				calcPrice.css({
					"position": "absolute",
					"top": calcPriceTop - acalc.offset().top,
					"bottom": "auto",
					"right": 0
				});
			}
		}
		else {
			calcPrice.css("position", "relative");
		}
	}
}

function isValidEmail(email, strict) {
	if ( !strict ) {
		email = email.replace(/^\s+|\s+$/g, '');
	}
	return (/^([a-z0-9_\-]+\.)*[a-z0-9_\-]+@([a-z0-9][a-z0-9\-]*[a-z0-9]\.)+[a-z]{2,4}$/i).test(email);
}

function checkField(name, txt, checkmail, calc, colorNormal) {
	var colorWarning = '#d7121c';
	var colorNormal = colorNormal ? colorNormal : '#8f0f0f';

	var input = $(calc).find('input[name='+name+']');
	if(input.length <= 0){
		var input = $(calc).find('textarea[name='+name+']');
	}
	var value = input.val();

	input.css('color', colorNormal).removeClass("error");

	var condition;

	if(checkmail){
		condition = (!isValidEmail(value) || value == txt);
	} else {
		condition = (value == '' || value == txt);
	}

	if (condition) {
		input
			.val(txt)
			.css('color', colorWarning)
			.addClass("error");
		input.focus(function(){
			if ($(this).val() == txt) {
				$(this)
					.val('')
					.css('color', colorNormal)
					.removeClass("error");
			}
		});

		return false;
	} else {
		return true;
	}
}

var calc_prices = {};
function getProduct(){
	/** инициализируем все калькуляторы на странице */
	$(".acalc").each(function(){
		var calc = $(this);

        /** Какой калькулятор выбран */
		var calc_type = calc.parent().hasClass("offset_only") ? "ofset" : "cifra";

		/** Какая продукция выбрана */
        var product_id = 0;
        var fulladdress = $("#fulladdress_block").text();

        if(!calc.find("fieldset.select_product > select[name=product]").length){
            switch(fulladdress){
                case "/pechat-putevoditelej/": case "/pechat-evrobukletov/": case "/pechat-prospektov/": case "/pechat-lifletov/": case "/services/bukleti/": product_id = calc_type == "cifra" ? 7 : 2; break;
                case "/pechat-zakladok/": case "/pechat-i-izgotovlenie-menju/": case "/anketi/": case "/pechat-biletov/": case "/articles/cifrovaya-pechat-prajs-listov/": case "/pechat-sxem/": case "/shuber-na-korobku/": case "/pechat-prejskurantov/": case "/pechat-listovok-a4/": case "/pechat-sertifikatov/": case "/pechat-instruktsij/": case "/autocad/": case "/services/flaeri/": product_id = calc_type == "cifra" ? 8 : 3; break;
                case "/services/rizografija/": product_id = calc_type == "cifra" ? 8 : 0; break;
                case "/services/listovoki/": product_id = calc_type == "cifra" ? 9 : 4; break;
				case "/services/blanki/": product_id = calc_type == "cifra" ? 10 : 0; break;
                case "/pechat-metodichek/": product_id = calc_type == "cifra" ? 24 : 0; break;
				case "/services/broshjuri/":
				case "/ofsetnaya-pechat/broshuri/":
				case "/ofsetnaya-pechat/katalogi/":
					product_id = calc_type == "cifra" ? 0 : 23;
					$('div.calcBlock > a[data-tab="offset"]').trigger("click");
				break;
				case "/ofsetnaya-pechat/listovki/": product_id = calc_type == "cifra" ? 0 : 3; $('div.calcBlock > a[data-tab="offset"]').trigger("click"); break;
				case "/ofsetnaya-pechat/bukleti/": product_id = calc_type == "cifra" ? 0 : 2; $('div.calcBlock > a[data-tab="offset"]').trigger("click"); break;
				case "/ofsetnaya-pechat/papki/": product_id = calc_type == "cifra" ? 0 : 12; $('div.calcBlock > a[data-tab="offset"]').trigger("click"); break;
				case "/ofsetnaya-pechat/flaeri/": product_id = calc_type == "cifra" ? 0 : 3; $('div.calcBlock > a[data-tab="offset"]').trigger("click"); break;
				case "/ofsetnaya-pechat/bloknoti/": product_id = calc_type == "cifra" ? 0 : 13; $('div.calcBlock > a[data-tab="offset"]').trigger("click"); break;
				case "/ofsetnaya-pechat/konverty/": product_id = calc_type == "cifra" ? 0 : 14; $('div.calcBlock > a[data-tab="offset"]').trigger("click"); break;
				case "/tipografija/tipografija-voprosy-i-otvety/u-vas-tipografija-pechat-priglashenij-za-chas-sdelaet/": product_id = calc_type == "cifra" ? 9 : 0; break;
				case "/ofsetnaya-pechat/plakaty/": product_id = calc_type == "cifra" ? 0 : 3; $('div.calcBlock > a[data-tab="offset"]').trigger("click"); break;
				case "/gramoti/": case "/afishi/": product_id = calc_type == "cifra" ? 8 : 0; break;
				case "/ofsetnaya-pechat/otkrytki/": product_id = calc_type == "cifra" ? 0 : 4; $('div.calcBlock > a[data-tab="offset"]').trigger("click"); break;
				case "/ofsetnaya-pechat/vizitki/": $('div.calcBlock > a[data-tab="offset"]').trigger("click"); break;
				case "/ofsetnaya-pechat/kvartalnye-kalendari/" : case "/services/kalendari/kvartalnye-kalendari/" : case "/services/kalendari/": product_id = calc_type == "cifra" ? 19 : 0; break;
				case "/ofsetnaya-pechat/blanki/": product_id = calc_type == "cifra" ? 10 : 0; break;
				case "/proekty-chertezhi/": case "/broshyurovanie/": case "/articles/cifrovaya-pechat-prezentacij/": product_id = calc_type == "cifra" ? 20 : 0; break;
				case "/articles/nakleyki-poligrafiya-lyubyh-razmerov/": product_id = calc_type == "cifra" ? 18 : 0; break;
				case "/articles/poligrafiya-diplomy-pechataet-ot-1-shtuk/": product_id = calc_type == "cifra" ? 8 : 0; break;
				case "/services/kalendari/karmannye-kalendari/": product_id = calc_type == "cifra" ? 22 : 0; break;
            }

            if(fulladdress.indexOf('/services/listovki/') >= 0){
                product_id = calc_type == "cifra" ? 8 : 3;
            }
        }
        else {
            product_id = calc.find("select[name=product]").val();
        }
        product_id = parseInt(product_id);

		/** Разный текст для разных калькуляторов */
		if(calc_type == "ofset"){
			calc.find("fieldset.total_price > label").text("ИТОГО:").next();
			calc.find("span.resulttime").text("2 - 3 рабочих дня*");
		}
		else {
			var d = new Date();
			if(d.getHours() >= 14){
				calc.find("span.resulttime").text("с 10:00 до 14:00");
			}
			else {
				calc.find("span.resulttime").text("с 14:00 до 20:00");
			}
		}

		/** получаем все необходимые данные для построения */
		if (!$("a.finalCalcOrder").length) {
			$.get("/newcalcshow2.php?type="+calc_type+"&getProduct="+(product_id > 0 ? product_id : 0), function(data){
				/** обнуляем все свойства */
				var properties = calc.find("div.params");
				properties.text("");

				if(!calc.find("fieldset.select_product > select[name=product]").length){
					/** первый запуск */

					/** заполняем селект продукции */
					var select = $("<select name='product'></select>");
					jQuery.each(data.product_list, function(key, product) {
						select.append("<option "+(product_id == key ? "selected='selected'" : "")+" value='"+key+"'>"+product+"</option>");
					});
					calc.find("fieldset.select_product").append(select);
					select
						.select2({ minimumResultsForSearch: -1, language: "ru" })
						.on('select2:select', function (e) {
							getProduct();
						});

					/** вешаем события на допы */
					$(calc).find("fieldset.dops > input[name=lamination]").change(function(){ getPrice(calc); });
					$(calc).find("input[name='dop[]']").change(function(){ getPrice(calc); });
				}

				/** записываем все цены в глобальный массив */
				calc_prices[calc_type] = data.prices;

				/** заполняем все свойства */
				jQuery.each(data.properties, function(key, property_select) {
					var select = $("<select name='"+property_select.name+"'></select>");
					jQuery.each(property_select.options, function(key2, property_option) {
						select.append("<option "+(property_option.default > 0 ? "selected='selected'" : "")+" value='"+property_option.id+"'>"+property_option.value+"</option>");
					});

					properties.append(
						$('<fieldset></fieldset>')
							.append("<label>"+(property_select.label+(property_select.label == 'Бумага' ? ' <a class="helper" href="#">Бумага?</a>' : '')+(property_select.label == 'Цветность' ? ' <a class="helper" href="#">Цветность?</a>' : ''))+"</label>")
							.append(select)
					);

					if(key != 0 && key % 2){
						properties.append("<div class='clr'></div>");
					}
				});

				calc.find("div.params select")
					.select2({ minimumResultsForSearch: -1, language: "ru" })
					.on('select2:select', function (e) {
						getPrice(calc);
					});

				/** Выставляем цену */
				getPrice(calc);

				/** Подсказки по свойствам */
				calc.find("a.helper").each(function(){
					$(this).on('click', function(e){
						e.preventDefault();
						e.stopPropagation();

						return helper(this);
					});
				});
			}, "json");
		}
	});
}

function getPrice(calc){
	var calc_type = calc.parent().hasClass("offset_only") ? "ofset" : "cifra";

	/** Показываем или прячем допы */
	$(calc).find("fieldset.dops").hide();
	$(calc).find("input[name='dop[]']").parent().show().next().next().show().next().show();

	var quantity = parseInt(calc.find("select[name=quantity] option:selected").text().replace(" - Скидка 12%", "").replace(" - Скидка 15%", "").replace(" шт.", "").replace(" - цифровая печать", "").replace(" - офсетная печать", "").replace(" ", ""));
	if(calc_type == "ofset"){
		$(calc).find("input[name='dop[]']").parent().hide().next().next().hide().next().hide();
	}
	else {
		var product_id = $(calc).find("select[name=product]").val();
		var dop = "";

		/** Допы показываем только для визиток 3-х видов бумаги */
		if(product_id == 6){
            if(window.location.href == "https://www.a-cifra.ru/services/vizitki/"){
                if($("select[name=quantity]:first").val() == 47){
                    $("select[name=quantity]:first").next().find("span.select2-selection__rendered").css("font-weight", "bold");
                }
                else {
                    $("#calcPriceDiscount").remove();
                    $("select[name=quantity]:first").next().find("span.select2-selection__rendered").css("font-weight", "normal");
                }
            }

			var bumaga_id = $(calc).find("select[name=bumaga]").val();
			if(bumaga_id == 226 || bumaga_id == 225 || bumaga_id == 44 || bumaga_id == 43 || bumaga_id == 42 || bumaga_id == 41 || bumaga_id == 40 || bumaga_id == 39 || bumaga_id == 38 || bumaga_id == 37 || bumaga_id == 36 || bumaga_id == 35 || bumaga_id == 275 || bumaga_id == 30 || bumaga_id == 31 || bumaga_id == 32){
				$(calc).find("fieldset.dops").show();
				dop = $(calc).find("fieldset.dops input:checked").val();
			}
			else {
				$(calc).find("fieldset.dops > input[name=lamination]").removeAttr("checked");
				$(calc).find("fieldset.dops > input:nth-child(1)").prop("checked", "checked");
			}
		}
		else {
			/** Для Буклеты / Лифлеты и Листовки / Флаеры / Наклейки скрываем скругление */
			if(product_id == 7 || product_id == 8 || product_id == 18){
				$(calc).find("input[name='dop[]']").parent().hide().next().next().hide().next().hide();
			}
			$(calc).find("fieldset.dops > input[name=lamination]").removeAttr("checked");
			$(calc).find("fieldset.dops > input:nth-child(1)").prop("checked", "checked");
		}
	}

	var properties_key = [];
	calc.find("div.params select").each(function(){
		properties_key.push(parseInt($(this).val()));
	});
	properties_key.sort(function(a, b){
		return a - b;
	});
	properties_key = "|"+properties_key.join("|")+"|";

	var item = calc_prices[calc_type][properties_key] ? calc_prices[calc_type][properties_key] : { "price": "" };

	if(item.price){
		var price = parseInt(item.price);
		/**
		 * Добавляем к стоимости допы
		 */
		switch(dop){
			case "Soft Touch 32 мкр":
				price += quantity*6;
			break;
			case "Матовая 32 мкр":
				price += quantity*3;
			break;
			case "Глянцевая 32 мкр":
				price += quantity*3;
			break;
		}
		if($(calc).find("input[name='dop[]']:checked").length){
			price += quantity;
		}

		calc.find("fieldset.total_price > span").text(formatMoney(price, 0, "", " "));
		calc.find("div.finalPrice > div:nth-child(1) > span").text(formatMoney(price, 0, "", " "));
		calc.find("fieldset.total_price > i.rub").html("Р<hr />");
		calc.find("div.finalPrice > div:nth-child(1) > i.rub").html("Р<hr />");
		calc.find("fieldset.total_price > .per_unit").show();

		var per_price = (price/quantity).toFixed(2);
		calc.find(".per_unit").remove();

		if(per_price != "NaN" && per_price != "0.00") {
			calc.find("fieldset.total_price:first").append("<div class='per_unit'>("+per_price+" <i class='rub'>Р<hr /></i> за шт.)</div>");
		}

        var category = 1;
        if(quantity < 400){
            category = 1;
        }
        else if(quantity < 700){
            category = 2;
        }
        else if(quantity < 2500){
            category = 3;
        }
        addCargo(category);
	}
	else {
		calc.find("fieldset.total_price > span").html("");
		calc.find("fieldset.total_price > i.rub").html("Цена по запросу");

		calc.find("div.finalPrice > div:nth-child(1) > span").html("");
		calc.find("div.finalPrice > div:nth-child(1) > i.rub").html("Цена по запросу");

		calc.find("fieldset.total_price > .per_unit").hide();
	}

	if(item.stock_text || item.stock){
		if(item.stock_text) {
			calc.find(".procentDiscount").hide();
			calc.find(".textDiscount").html(item.stock_text).show();
			calc.find("div.total_price_stock").hide().prev().hide();
		}
		else if(item.stock) {
			calc.find(".procentDiscount").show();
			calc.find(".textDiscount").html("Дарим скидку <i>"+item.stock+"</i> за репост!").show();

			if(parseInt(item.price_stock) > 0){
				var price_stock = price - price * parseInt(item.stock_value) / 100;
				calc.find("div.total_price_stock > span").text(formatMoney(price_stock, 0, "", " "));
				calc.find("div.total_price_stock").show().prev().show();
			}
			else {
				calc.find("div.total_price_stock").hide().prev().hide();
			}
		}
		else {
			calc.find(".procentDiscount").hide();
			calc.find(".textDiscount").html("").hide();
			calc.find("div.total_price_stock").hide().prev().hide();
		}
	}
	else {
		calc.find(".procentDiscount").hide();
		calc.find(".textDiscount").hide();
		calc.find("div.total_price_stock").hide().prev().hide();
	}

    if(product_id == 6 && quantity < 3000){
        $(".sdek_part").show();
    }
    else{
        $(".sdek_part").hide();
    }
}

function helper(link, calc){
	calc = $("form.acalc:visible");
	if($(link).hasClass("active")){
		$('div.helper').remove();
		$("div.calcBlock").find("a.helper").removeClass("active");
	}
	else {
		if($('div.helper').length){
			$('div.helper').remove();
			$("div.calcBlock").find("a.helper").removeClass("active");
		}

		$(link).addClass('active');
		var position = $(link).position();

		var shift = 0;
		if($(link).hasClass("ofsethint")){
			shift = 50;
			var text = "<p>Выгодно при больших тиражах:</p><p style='margin-bottom:0;'>- срок изготовления от 3 дней</p><p style='margin-bottom:0;'>- печатаем от 1000 штук</p><p style='margin-bottom:0;'>- запуск в печать до 17:00</p>";
		}
		else if($(link).hasClass("cifrahint")){
			shift = 50;
			var text = "<p>Срочно и небольшой тираж:</p><p style='margin-bottom:0;'>- сроки изготовления от 40 минут</p><p style='margin-bottom:0;'>- печатаем от 10 до 500 штук</p><p style='margin-bottom:0;'>- без выходных до 21:00</p>";
		}
		else if($(link).text() == "Цветность?"){
			var text = "<p>- Односторонняя печать, на одной стороне напечатали, вторая чистая (белая)</p><p style='margin-bottom:0;'>- Двухсторонняя печать, печать с обеих сторон изделия</p>";
		}
		else {
			var text = "<p>- Классическая бумага Xerox Colotech плотностью от 90 до 350 гр/м2, производство Австрия</p><p>- Дизайнерская бумага применяется для визиток и открыток, в наличие более 21 вида бумаг</p><p style='margin-bottom:0;'>- Премиальная бумага Touch Cover и Ламинация Soft Touch для директоров и важных мероприятий</p>";
		}

		calc.find(".calcStep1>div").append(
			$('<div class="helper"></div>')
				.css("top", position.top-195-shift)
				.append(
					$('<div></div>')
						.append(
							$('<a href="#" class="close">x</a>').on('click', function(e){
								e.preventDefault();
								e.stopPropagation();

								$(this).parent().parent().remove();
								$("div.calcBlock").find("a.helper").removeClass("active");

								return false;
							})
						)
						.append(text)
						.append(
							$('<div class="triangle"></div>')
								.css("left", position.left+25-(shift*1.5))
						)
				)
		);
		$("body").on("click", function(){
			$('div.helper').remove();
			calc.find("a.helper").removeClass("active");
			$("body").unbind("click");
		});
	}

	return false;
}

function formatMoney(number, decPlaces, decSep, thouSep) {
	decPlaces = isNaN(decPlaces = Math.abs(decPlaces)) ? 2 : decPlaces,
	decSep = typeof decSep === "undefined" ? "." : decSep;
	thouSep = typeof thouSep === "undefined" ? "," : thouSep;
	var sign = number < 0 ? "-" : "";
	var i = String(parseInt(number = Math.abs(Number(number) || 0).toFixed(decPlaces)));
	var j = (j = i.length) > 3 ? j % 3 : 0;

	return sign +
		(j ? i.substr(0, j) + thouSep : "") +
		i.substr(j).replace(/(\decSep{3})(?=\decSep)/g, "$1" + thouSep) +
		(decPlaces ? decSep + Math.abs(number - i).toFixed(decPlaces).slice(2) : "");
}

function onChoose(wat){
	let sdek = "<br /><p>Выбран пункт выдачи заказа: "+wat.id+"</p><p>Выбранный адрес пункта самовывоза: "+wat.cityName+", "+wat.PVZ.Address+"</p><p>Стоимость доставки: "+(parseInt(wat.price) + 50)+" руб.</p><p>Сроки доставки (дни): "+wat.term+"</p>";
    $("#deliveryWidgetResult").html(sdek);
    $("#deliveryWidgetResult").append("<input type='hidden' name='sdek' value='"+sdek+"' />");

    $("#youraddress").hide();
    var calc = $("form.acalc:visible");
    var quantity = parseInt(calc.find("select[name=quantity] option:selected").text().replace(" - Скидка 12%", "").replace(" - Скидка 15%", "").replace(" шт.", "").replace(" - цифровая печать", "").replace(" - офсетная печать", "").replace(" ", ""));
    var category = 1;
    if(quantity < 400){
        category = 1;
    }
    else if(quantity < 700){
        category = 2;
    }
    else if(quantity < 2500){
        category = 3;
    }
    addCargo(category);
}

function onChooseProfile(wat){
	let sdek = "<br /><p>Выбрана доставка курьером в город "+wat.cityName+"</p><p>Стоимость доставки: "+(parseInt(wat.price) + 50)+" руб.</p><p>Сроки доставки (дни): "+wat.term+"</p>";
    $("#deliveryWidgetResult").html(sdek);
    $("#deliveryWidgetResult").append("<input type='hidden' name='sdek' value='"+sdek+"' />");
    $("#youraddress").show();
    var calc = $("form.acalc:visible");
    var quantity = parseInt(calc.find("select[name=quantity] option:selected").text().replace(" - Скидка 12%", "").replace(" - Скидка 15%", "").replace(" шт.", "").replace(" - цифровая печать", "").replace(" - офсетная печать", "").replace(" ", ""));
    var category = 1;
    if(quantity < 400){
        category = 1;
    }
    else if(quantity < 700){
        category = 2;
    }
    else if(quantity < 2500){
        category = 3;
    }
    addCargo(category);
}

function addCargo(category){
    if(category){
        if(widjet){
            widjet.cargo.reset();
            switch(category){
                case 1:
                    widjet.cargo.add({
                		length: 17,
                		width: 12,
                		height: 10,
                        weight: 0.5
                	});
                break;
                case 2:
                    widjet.cargo.add({
                		length: 24,
                		width: 17,
                		height: 10,
                        weight: 1
                	});
                break;
                case 3:
                    widjet.cargo.add({
                		length: 24,
                		width: 24,
                		height: 21,
                        weight: 3
                	});
                break;
            }
            //console.log(widjet.cargo.get());
        }
    }
}
