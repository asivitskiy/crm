(window.__LOADABLE_LOADED_CHUNKS__=window.__LOADABLE_LOADED_CHUNKS__||[]).push([["ymaps-vector"],{10:function(t,e,i){"use strict";i.r(e),i.d(e,"mathSign",(function(){return n})),i.d(e,"mathLog2",(function(){return o})),i.d(e,"mathLog10",(function(){return a})),i.d(e,"arrayFindIndex",(function(){return _})),i.d(e,"arrayFind",(function(){return p})),i.d(e,"arrayFrom",(function(){return m})),i.d(e,"arraySome",(function(){return b})),i.d(e,"Symbol",(function(){return h})),i.d(e,"Map",(function(){return d})),i.d(e,"Set",(function(){return f})),i.d(e,"WeakMap",(function(){return u})),i.d(e,"MAX_SAFE_INTEGER",(function(){return c}));var r=i(13),s={},n=Math.sign?Math.sign.bind(Math):function(t){return t<0?-1:0===t?0:1},o=Math.log2?Math.log2.bind(Math):function(t){return Math.log(t)*Math.LOG2E},a=Math.log10?Math.log10.bind(Math):function(t){return Math.log(t)/Math.LN10},c=Number.MAX_SAFE_INTEGER||9007199254740991,h="undefined"==typeof Symbol?function(t){return"__Symbol_".concat(t,"_").concat(Date.now(),"_").concat(Math.random())}:Symbol,l=function(t){return new t([[s,1]]).has(s)?function(e){return new t(e)}:function(e){var i=new t;if(void 0!==e)for(var r=0,s=e;r<s.length;r++){var n=s[r],o=n[0],a=n[1];i.set(o,a)}return i}},d=l(Map),u=l(WeakMap),f=new Set([s]).has(s)?function(t){return new Set(t)}:function(t){var e=new Set;if(void 0!==t)for(var i=0,r=t;i<r.length;i++){var s=r[i];e.add(s)}return e};d.prototype=Map.prototype,u.prototype=WeakMap.prototype,f.prototype=Set.prototype;var _=Boolean(Array.prototype.findIndex)?function(t,e,i){return t.findIndex(e,i)}:function(t,e,i){for(var r=0;r<t.length;r++)if(e.call(i,t[r],r,t))return r;return-1},p=Boolean(Array.prototype.find)?function(t,e,i){return t.find(e,i)}:function(t,e,i){var r=_(t,e,i);return-1===r?void 0:t[r]},m=Array.from?Array.from:function(t){var e=this,i=Object(t);null==t&&Object(r.c)(new TypeError("Array.from requires an array-like object - not null or undefined"));var s=arguments.length>1?arguments[1]:void 0,n=arguments.length>2?arguments[2]:void 0;void 0===s||y(s)||Object(r.c)(new TypeError("Array.from: when provided, the second argument must be a function"));for(var o=v(i.length),a=y(e)?Object(new e(o)):new Array(o),c=0;c<o;){var h=i[c];a[c]=s?void 0===n?s(h,c):s.call(n,h,c):h,c+=1}return a.length=o,a},g=Object.prototype.toString;function y(t){return"function"==typeof t||"[object Function]"===g.call(t)}function v(t){var e=Number(t);return isNaN(e)||e<=0?0:Math.min(e,c)}var b=function(t,e,i){return-1!==_(t,e,i)}},100:function(t,e,i){"use strict";i.d(e,"a",(function(){return h})),i.d(e,"b",(function(){return c}));var r=i(8),s=i(10),n=i(51),o=(i(35),i(108)),a=i(11),c="__root__",h=function(t){function e(e){var i=(void 0===e?{}:e).disablePointGeometry,r=t.call(this)||this;return r._features=new s.Map,r._groups=new s.Map([[c,{type:"group",id:c,style:Object(o.b)({}),children:[],parentGroupId:null}]]),r._disablePointGeometry=Boolean(i),r}return Object(r.b)(e,t),Object.defineProperty(e.prototype,"features",{get:function(){return this._features},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"groups",{get:function(){return this._groups},enumerable:!1,configurable:!0}),e.prototype.addGroup=function(t,e,i){var r={type:"group",id:t,style:Object(o.b)(e),children:[],parentGroupId:i};this._addChild(i,r),this._groups.set(t,r),this._emit("groupAdded",t),this._emit("changed")},e.prototype.removeGroupAndChildren=function(t){if(this._groups.has(t)){for(var e=this._groups.get(t),i=[e],r=[];i.length>0;){var s=i.pop();r.push(s);for(var n=0,o=s.children;n<o.length;n++){var a=o[n];"feature"===a.type?(this._features.delete(a.id),r.push(a)):i.push(a)}this._groups.delete(s.id)}e.parentGroupId&&this._removeChild(e.parentGroupId,e),this._emit("groupRemoved",{id:t,removed:r}),this._emit("changed")}},e.prototype.addFeature=function(t,e,i,r){Object(n.a)(t),this._assertPointIsAllowed(t);var s={type:"feature",id:t.id,feature:t,style:Object(o.a)(t.geometry,e),bbox:i,parentGroupId:r};this._addChild(r,s),this._features.set(s.id,s),this._emit("featureAdded",s.id),this._emit("changed")},e.prototype.removeFeatureById=function(t){if(this._features.has(t)){var e=this._features.get(t);e.parentGroupId&&this._removeChild(e.parentGroupId,e),this._features.delete(t),this._emit("featureRemoved",t),this._emit("changed")}},e.prototype.updateFeature=function(t,e,i){this._assertPointIsAllowed(t);var r=this._features.get(t.id).parentGroupId,s={type:"feature",id:t.id,feature:t,style:Object(o.a)(t.geometry,e),bbox:i,parentGroupId:r},n=this._groups.get(r),a=this._features.get(s.id),c=n.children.indexOf(a);n.children[c]=s,this._features.set(s.id,s),this._emit("featureUpdated",s.id),this._emit("changed")},e.prototype.hasFeatureWithId=function(t){return this._features.has(t)},e.prototype.moveFeatureToGroup=function(t,e){var i=this._features.get(t);i.parentGroupId!==e&&(this._removeChild(i.parentGroupId,i),this._addChild(e,i),i.parentGroupId=e,this._emit("featureMovedToGroup",t),this._emit("changed"))},e.prototype._addChild=function(t,e){this._groups.get(t).children.push(e)},e.prototype._removeChild=function(t,e){var i=this._groups.get(t),r=i.children.indexOf(e);i.children.splice(r,1)},e.prototype._assertPointIsAllowed=function(t){if(this._disablePointGeometry&&"Point"===t.geometry.type)throw new Error('Unexpected geometry type: "'.concat(t.geometry.type,'"'))},e}(Object(a.a)().with())},101:function(t,e,i){"use strict";i.d(e,"a",(function(){return o}));var r=i(8),s=i(10),n=i(11),o=function(t){function e(e){var i=t.call(this)||this;return i._tiles=new s.Map,i.setSource(e),i}return Object(r.b)(e,t),Object.defineProperty(e.prototype,"priority",{get:function(){return this._source.priority},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"workerUrl",{get:function(){return this._source.workerUrl},enumerable:!1,configurable:!0}),e.prototype.setSource=function(t){this._source=t,this._emit("changed")},e.prototype.addRootTile=function(t,e,i,r){var s={uri:t,tile:e,buildingObjectIds:i,detalizationFactor:r};this._tiles.set(t,s),this._emit("rootTileAdded",s)},e.prototype.removeRootTile=function(t){this._tiles.delete(t)&&this._emit("rootTileRemoved",t)},e}(Object(n.a)().with())},107:function(t,e,i){"use strict";var r=i(8);function s(t,e){return t===e?null:{old:t,new:e}}var n=i(79),o=i(64),a=i(83),c=i(11);i(35);i.d(e,"a",(function(){return h})),i.d(e,"c",(function(){return l})),i.d(e,"b",(function(){return d}));var h=function(t){function e(e,i){var r=t.call(this)||this;return r._makeFields=function(t,e){return{tileSize:(null==e?void 0:e.size)||n.c,transparent:Boolean(null==e?void 0:e.transparent),clampMapZoom:Boolean(t.clampMapZoom),zoomRange:t.zoomRange||Object(o.c)(),fetchHotspots:null==e?void 0:e.fetchHotspots,hotspotAbortRadius:(null==e?void 0:e.hotspotAbortRadius)||n.a,vectorHotspots:t.vector&&t.vector.hotspots||{},awaitAllTilesOnFirstDisplay:Boolean(null==e?void 0:e.awaitAllTilesOnFirstDisplay)}},r.setSource(e),r.worldOptions=i,r}return Object(r.b)(e,t),Object.defineProperty(e.prototype,"rasterSourceDescription",{get:function(){return this._source.raster},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"vectorSourceDescription",{get:function(){return this._source.vector},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"internalFindHostpotInPosition",{get:function(){var t;return null===(t=this._source.raster)||void 0===t?void 0:t._internalFindHotspotInPosition},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"vectorHotspots",{get:function(){return this._fields.vectorHotspots},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"zoomRange",{get:function(){return this._fields.zoomRange},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"clampMapZoom",{get:function(){return this._fields.clampMapZoom},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"transparent",{get:function(){return this._fields.transparent},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"tileSize",{get:function(){return this._fields.tileSize},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"fetchHotspots",{get:function(){return this._fields.fetchHotspots},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"hotspotAbortRadius",{get:function(){return this._fields.hotspotAbortRadius},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"awaitAllTilesOnFirstDisplay",{get:function(){return this._fields.awaitAllTilesOnFirstDisplay},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"tileRevealDuration",{get:function(){var t,e;return Math.max(null!==(e=null===(t=this._source.raster)||void 0===t?void 0:t.tileRevealDuration)&&void 0!==e?e:200,0)},enumerable:!1,configurable:!0}),e.prototype.getHotspotTileDataSource=function(){return this._rasterSource.fetchHotspots?{fetchHotspots:this._rasterSource.fetchHotspots,hotspotAbortRadius:this._rasterSource.hotspotAbortRadius||n.a,tileSize:this._rasterSource.size||n.c,inset:void 0===this._rasterSource.hotspotInset?n.b:this._rasterSource.hotspotInset,padding:this._rasterSource.hotspotPadding||0,zoomRange:this.zoomRange,internalFindHotspotInPosition:this.internalFindHostpotInPosition}:null},e.prototype.setSource=function(t){var e,i=this._makeFields(t,t.raster),n=Object(r.a)(Object(r.a)({},function(t,e){for(var i={},r=0,n=Object.keys(t);r<n.length;r++){var o=n[r];i[o]=s(t[o],e[o])}return i}(this._fields||{},i)),{fetchTile:s(this._rasterSource&&this._rasterSource.tileUrl,null===(e=t.raster)||void 0===e?void 0:e.tileUrl)});this._source=t,this._fields=i,t.raster&&(this._rasterSource=t.raster,"string"==typeof this._rasterSource.tileUrl&&(this._tileUrlGenerator=l(this._rasterSource.tileUrl))),this._emit("changed"),this._emit("sourceChanged",n)},e.prototype.generateTileUrl=function(t,e,i,r){var s=this.fitTileIntoWorld(t,e,i);if(!s)return null;var n=s.x,o=s.y;return this._tileUrlGenerator(n,o,i,r)},e.prototype.fitTileIntoWorld=function(t,e,i){var r=Object(a.d)(i,this.tileSize);return Object(a.f)({x:t,y:e},r,this.worldOptions)?Object(a.h)({x:t,y:e},r):null},e}(Object(c.a)().with());function l(t){return function(e,i,r,s){return t.replace("{{x}}",String(e)).replace("{{y}}",String(i)).replace("{{z}}",String(r)).replace("{{scale}}",String(s)).replace(/\{\{d\|(\d+)\}\}/,(function(t,s){var n=(e+i+r)%Number(s)+1;return String(n)}))}}function d(t,e){return t.fetchHotspots===e.fetchHotspots&&t.hotspotAbortRadius===e.hotspotAbortRadius&&t.tileSize===e.tileSize}},108:function(t,e,i){"use strict";var r=i(8),s=i(10);i.d(e,"c",(function(){return c})),i.d(e,"a",(function(){return h})),i.d(e,"b",(function(){return d}));var n={width:1,opacity:1,color:"rgb(0,102,255)",palette:[],simplifyPalette:!0,dash:[]},o={url:"No icon url provided",offset:[0,0],scale:1},a={zIndex:0,opacity:1};function c(t){var e=Object(r.a)(Object(r.a)({},n),t);return Object(r.a)(Object(r.a)({},e),{dash:Object(r.c)([],e.dash,!0),paletteColors:[]})}function h(t,e){var i=e.stroke||[n],a="LineString"===t.type?function(t,e){for(var i=t.coordinates.length-1,r=[],n=[],o=new s.Set,a=[],h=0,l=e;h<l.length;h++){var d=l[h],u=d.palette,f=c(d);if(n.push(f),u&&0!==u.length){for(var _=new s.Map,p=0,m=0;m<u.length;m++){var g=u[m],y=g.count,v=g.color;_.set(p,v),p+=y;var b=m===u.length-1||p>i;if(b||v!==u[m+1].color){var x=b?i:p;if(o.has(x)||(o.add(x),a.push(x)),b)break}}r.push({stopsColors:_,paletteColors:f.paletteColors})}}a.sort((function(t,e){return t-e}));for(var w=0,A=r;w<A.length;w++){var T=A[w],S=(_=T.stopsColors,T.paletteColors);S.push(_.get(0));for(m=0;m<a.length-1;m++){v=_.get(a[m]);S.push("string"==typeof v?v:S[S.length-1])}}return{paletteColorStops:a,stroke:n}}(t,i):{paletteColorStops:[],stroke:i.map(c)},h=a.stroke,d=a.paletteColorStops;return{zIndex:l(e.zIndex,0),fill:e.fill||"rgb(0,102,255)",fillOpacity:l(e.fillOpacity,.6),fillRule:e.fillRule||"evenodd",stroke:h,paletteColorStops:d,cursor:e.cursor||"inherit",interactive:l(e.interactive,!0),simplificationRate:l(e.simplificationRate,2),icon:Object(r.a)(Object(r.a)({},o),e.icon)}}function l(t,e){return void 0!==t?t:e}function d(t){return Object(r.a)(Object(r.a)({},a),t)}},11:function(t,e,i){"use strict";var r=i(8),s=i(10),n=(i(35),Object(s.Symbol)("EventEmitter")),o=Object(s.Symbol)("EventEmitter.MixinConstructor"),a=Object(s.Symbol)("EventEmitter.MixinPrototype"),c=function(){function t(){}return t[o]=function(t){t._eventListenersHash={}},t[a]=function(e){e[n]=t.prototype[n],e.group=t.prototype.group,e.on=t.prototype.on,e.offSingle=t.prototype.offSingle,e._emit=t.prototype._emit},t.prototype.on=function(t,e){return this.group().on(t,e)},t.prototype.offSingle=function(t,e){var i=this._eventListenersHash[t];i&&i.delete(e)},t.prototype.group=function(){return new t._eventGroupImpl(this)},t.prototype._emit=function(t){for(var e=[],i=1;i<arguments.length;i++)e[i-1]=arguments[i];var r=this._eventListenersHash[t];if(r){var s=[];r.forEach((function(t){return s.push(t)}));for(var n=0,o=s;n<o.length;n++){var a=o[n];a(e[0])}}},t._eventGroupImpl=function(){function t(t){this._listeners=[],this._emitter=t}return t.prototype.on=function(t,e){var i=this._emitter._eventListenersHash[t];return i?i.add(e):(this._emitter._eventListenersHash[t]=new s.Set,this._emitter._eventListenersHash[t].add(e)),this._listeners.push([t,e]),this},t.prototype.offAll=function(){for(var t=0,e=this._listeners;t<e.length;t++){var i=e[t],r=i[0],s=i[1];this._emitter._eventListenersHash[r].delete(s)}this._listeners=[]},t}(),t}();c.prototype[n]=!0,i.d(e,"a",(function(){return l}));var h=function(){},l=function(t){return void 0===t&&(t=h),{with:function(){if(e=t.prototype,Boolean(e&&e[n]))return t;var e,i=function(t){function e(){for(var e=[],i=0;i<arguments.length;i++)e[i]=arguments[i];var r=t.apply(this,e)||this;return c[o](r),r}return Object(r.b)(e,t),e}(t);return c[a](i.prototype),i}}}},126:function(t,e,i){"use strict";i.d(e,"a",(function(){return s}));var r=i(16);function s(){return Object(r.b)(devicePixelRatio,1,3)}},16:function(t,e,i){"use strict";function r(t,e,i){return t-Math.floor((t-e)/(i-e))*(i-e)}function s(t,e,i){return Math.max(Math.min(t,i),e)}i.d(e,"a",(function(){return r})),i.d(e,"b",(function(){return s}))},17:function(t,e,i){"use strict";i.d(e,"a",(function(){return a}));var r=i(8),s=i(10),n=i(16),o=i(12),a={getScale:function(t,e){return Math.pow(2,e-t)},getWorldPixelSize:function(t){return 256*Math.pow(2,t)},worldToPixels:function(t,e){var i=Math.pow(2,e)/2*256;return o.muln({x:t.x+1,y:1-t.y},i)},worldToRelativePixels:function(t,e){var i=Math.pow(2,e)/2*256;return o.mulv(t,{x:i,y:-i})},worldToTile:function(t,e,i){var r=a.worldToPixels(t,e);return o.divn(r,i)},moveCloseToCenter:function(t,e,i){i=i||t;var r=o.sub(t,e).x;return Math.abs(r)>1?o.add(i,{x:-2*Object(s.mathSign)(r),y:0}):i},convertPixelSizeToWorldSize:function(t,e,i){var r=Math.pow(2,e)/2*256;return o.divv(t,{x:r,y:-r},i)},pixelsToWorld:function(t,e){var i=Math.pow(2,e)/2*256;return{x:t.x/i-1,y:1-t.y/i}},fitViewportToWorld:function(t,e){var i=e.zoom,r=e.worldOptions,s=e.size,n=void 0===s?o.ORIGIN:s;if(r.cycledX&&r.cycledY)return t;var h=a.convertPixelSizeToWorldSize(n,i);return{x:c(t.x,h.x,r.cycledX),y:c(t.y,-h.y,r.cycledY)}},restrictToZeroWorld:function(t,e){var i=Object(r.a)({},t);return e.cycledX&&(i.x=Object(n.a)(i.x,-1,1)),e.cycledY&&(i.y=Object(n.a)(i.y,-1,1)),i},computePixelPerfectWorldCoordinates:function(t,e,i,r,s){void 0===r&&(r=1),void 0===s&&(s={x:0,y:0});var n=a.getWorldPixelSize(e)/2*r*i;return o.applyFunction(t,(function(t){return Math.round(t*n)/n}),s)}};function c(t,e,i){var r=e/2;return i?Object(n.a)(t,-1,1):Object(n.b)(t,Math.min(0,r-1),Math.max(0,1-r))}},21:function(t,e,i){"use strict";var r=i(8),s=i(12),n=i(65),o=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1];function a(){return new Array(16)}function c(t,e){void 0===e&&(e=a());for(var i=0;i<16;++i)e[i]=t[i];return e}function h(t,e,i){void 0===i&&(i=a());for(var r=0;r<16;r+=4)for(var s=t[r],n=t[r+1],o=t[r+2],c=t[r+3],h=0;h<4;++h)i[r+h]=s*e[h]+n*e[4+h]+o*e[8+h]+c*e[12+h];return i}var l=c(o);function d(t,e,i){void 0===i&&(i=n.e(0,0,0));var r=t[3]*e.x+t[7]*e.y+t[11]*e.z+t[15],s=(t[0]*e.x+t[4]*e.y+t[8]*e.z+t[12])/r,o=(t[1]*e.x+t[5]*e.y+t[9]*e.z+t[13])/r,a=(t[2]*e.x+t[6]*e.y+t[10]*e.z+t[14])/r;return i.x=s,i.y=o,i.z=a,i}var u=i(17),f=i(13);function _(t,e){var i=e.container.getBoundingClientRect();return m({x:t.x-i.left,y:t.y-i.top},e)}function p(t,e){var i=g(t,e),r=e.container.getBoundingClientRect();return s.add(i,{x:r.left,y:r.top},i),i}function m(t,e){var i=e.size,s=e.zoom,o=e.worldCenter,a=e.azimuth,c=e.tilt,h=e.fov,l=Math.tan(.5*h),d={x:0,y:0,z:y(-u.a.convertPixelSizeToWorldSize(i,s).y,h)};n.k(d,c,d),n.l(d,a,d),n.c(d,Object(r.a)(Object(r.a)({},o),{z:0}),d);var _=i.x/i.y,p=n.e(l*_,l,1),m={x:2*(t.x-i.x/2)/i.x,y:2*(i.y/2-t.y)/i.y,z:-1};n.i(m,p,m),n.k(m,c,m),n.l(m,a,m);var g=n.h(n.b,{origin:d,direction:m});return g||Object(f.c)(new Error("Pointer above the horizon.")),g}function g(t,e){var i=e.size,f=e.zoom,_=e.worldCenter,p=e.azimuth,m=e.tilt,g=e.fov,v=u.a.convertPixelSizeToWorldSize(i,f),b=s.divn(v,2),x=y(-v.y,g),w={x:0,y:0,z:x};n.k(w,m,w),n.l(w,p,w),n.c(w,Object(r.a)(Object(r.a)({},_),{z:0}),w);var A=function(t,e,i,r,s){void 0===s&&(s=a());var o=n.m(e,i);n.j(o,o);var c=n.f(r,o);n.j(c,c);var d=n.f(o,c);return l[0]=c.x,l[1]=d.x,l[2]=o.x,l[4]=c.y,l[5]=d.y,l[6]=o.y,l[8]=c.z,l[9]=d.z,l[10]=o.z,l[12]=-n.g(c,e),l[13]=-n.g(d,e),l[14]=-n.g(o,e),h(t,l,s)}(o,w,Object(r.a)(Object(r.a)({},_),{z:0}),n.l({x:0,y:1,z:0},p));if(m>0){var T=-b.y*Math.sin(m),S=-T-x,P=T-x,R=b.x/-b.y,M=function(t,e,i,r,s,n){void 0===n&&(n=a());for(var o=1/Math.tan(.5*e),c=o/i,h=(r+s)/(r-s),l=2*r*s/(r-s),d=0;d<16;d+=4){n[d]=t[d]*c,n[d+1]=t[d+1]*o;var u=t[d+2],f=t[d+3];n[d+2]=u*h+f*l,n[d+3]=-u}return n}(c(o),g,R,S,P);return M[0]=M[0]*i.x/2,M[5]=M[5]*(-i.y/2),M[8]=-i.x/2,M[9]=-i.y/2,d(h(A,M),Object(r.a)(Object(r.a)({},t),{z:0}))}var C=d(A,Object(r.a)(Object(r.a)({},t),{z:0})),z=s.add(C,b);return u.a.worldToRelativePixels(z,f)}function y(t,e){return.5*t/Math.tan(.5*e)}i.d(e,"c",(function(){return _})),i.d(e,"e",(function(){return p})),i.d(e,"b",(function(){return m})),i.d(e,"d",(function(){return g})),i.d(e,"a",(function(){return y}))},230:function(t,e,i){"use strict";i.d(e,"a",(function(){return m}));var r=i(8),s=i(10),n=i(25),o=i(83),a=i(11),c=i(46),h=i(98),l=i(17),d=i(51),u=i(16),f=i(12),_=i(13),p=function(){},m=function(t){function e(e,i,r,n,o,a){var c=t.call(this)||this;return c._newTiles=new s.Map,c._loadingTiles=new s.Map,c._readyTiles=new s.Map,c._size=e,c._camera=i,c._tileSource=r,c._zoomRoundingRule=a,c._worldOptions=o,c._queue=n,c}return Object(r.b)(e,t),Object.defineProperty(e.prototype,"state",{get:function(){return{tilesLoaded:0,tilesReady:0,tilesTotal:0,borderTotal:0,borderLoaded:0,borderReady:0,graphicsTotal:0,graphicsReady:0}},enumerable:!1,configurable:!0}),e.prototype.destroy=function(){this._loadingTiles.forEach((function(t){t.abortController.abort()}))},e.prototype.preloadHotspotsInPoint=function(t){for(var e=this._zoomRoundingRule(this._camera.zoom),i=!1,r=0,s=this._computeAffectedTiles(t,e);r<s.length;r++){var n=s[r],a=Object(o.e)(n,n.zoom);this._isTileDataReadyOrLoading(a)||this._newTiles.has(a)||(this._newTiles.set(a,{id:n}),i=!0)}var c=this._stopLoadingTilesOutsideRadius(t);(i||c)&&this._emit("hotspotsChanged"),i&&this._emit("requestRender")},e.prototype.preloadHotspotsForViewport=function(){for(var t=this,e=!1,i=0,r=this._getTilesForViewport().filter((function(e){return!t._isTileDataReadyOrLoading(Object(o.e)(e,e.zoom))}));i<r.length;i++){var s=r[i],n=Object(o.e)(s,s.zoom);this._isTileDataReadyOrLoading(n)||this._newTiles.has(n)||(this._newTiles.set(n,{id:s}),e=!0)}e&&(this._emit("hotspotsChanged"),this._emit("requestRender"))},e.prototype.resize=function(t){f.areEqual(t,this._size)||(this._size=t,this._removeTilesOutsideViewport()&&this._emit("hotspotsChanged"))},e.prototype.update=function(t,e){var i=t.worldCenter,r=t.zoom;i===this._camera.worldCenter&&r===this._camera.zoom||(this._camera=t,this._removeTilesOutsideViewport()&&this._emit("hotspotsChanged"))},e.prototype.render=function(t){var e=this;t.qualityHint<c.a.FULL||this._camera.zoom<this._tileSource.zoomRange.min||this._camera.zoom>this._tileSource.zoomRange.max||(this._newTiles.forEach((function(t){var i=Object(o.e)(t.id,t.id.zoom),s=e._loadTile(t);e._loadingTiles.set(i,s),Object(n.promiseFinally)(s.promise.then((function(n){var o=n.map((function(i){return"world"===i.type?i:function(t,e,i){var r=f.muln(e,i);return{type:"world",feature:t.feature,geometry:Object(d.d)(t.geometry,(function(t){return l.a.pixelsToWorld(f.add(t,r),e.zoom)}))}}(i,t.id,e._tileSource.tileSize)})),a=e._zoomRoundingRule(e._camera.zoom),c=e._tileSource.padding/l.a.getWorldPixelSize(a),h=0===e._tileSource.padding?o:o.map((function(t){return Object(r.a)(Object(r.a)({},t),{geometry:y(t.geometry,c)})}));e._readyTiles.set(i,{id:s.id,hotspots:h}),e._emit("hotspotsChanged")})),(function(){return e._loadingTiles.delete(i)})).catch((function(t){t&&"AbortError"===t.name||Object(_.c)(t)}))})),this._newTiles.clear())},e.prototype.findObjectInPosition=function(t){for(var e,i,r=l.a.restrictToZeroWorld(t,this._worldOptions),s=this._zoomRoundingRule(this._camera.zoom),n=!0,a=0,c=this._computeAffectedTiles(r,s);a<c.length;a++){var d=c[a],u=this._readyTiles.get(Object(o.e)(d,s));if(u)for(var f=u.hotspots.length-1;f>=0;f--){var _=u.hotspots[f];if(Object(h.a)(_.geometry,r))return{type:"raw-hotspot",feature:_.feature}}else n=!1}var p=null===(i=(e=this._tileSource).internalFindHotspotInPosition)||void 0===i?void 0:i.call(e,r,s);return p||(n?null:void 0)},e.prototype._stopLoadingTilesOutsideRadius=function(t){var e=this._zoomRoundingRule(this._camera.zoom),i=f.divn(l.a.worldToPixels(t,e),this._tileSource.tileSize),r=Math.max(this._tileSource.hotspotAbortRadius,this._tileSource.inset)/this._tileSource.tileSize;return g(this._loadingTiles,(function(t){return function(t,e,i){var r=f.create(Object(u.b)(e.x,t.x,t.x+1),Object(u.b)(e.y,t.y,t.y+1));return f.sub(r,e,r),f.length2(r)<=Math.pow(i,2)}(t.id,i,r)}),(function(t){return t.abortController.abort()}))},e.prototype._removeTilesOutsideViewport=function(){var t=this._zoomRoundingRule(this._camera.zoom),e=l.a.getScale(t,this._camera.zoom),i=f.create(this._size.x+2*this._tileSource.inset,this._size.y+2*this._tileSource.inset),r=l.a.worldToPixels(this._camera.worldCenter,t),s=Object(o.a)(r,i,e,this._tileSource.tileSize),n=function(e){var i=e.id;return i.zoom===t&&i.x<=s.maxX&&i.x+1>=s.minX&&i.y<=s.maxY&&i.y+1>=s.minY},a=g(this._newTiles,n),c=g(this._loadingTiles,n,(function(t){return t.abortController.abort()})),h=g(this._readyTiles,n);return a||c||h},e.prototype._isTileDataReadyOrLoading=function(t){return this._loadingTiles.has(t)||this._readyTiles.has(t)},e.prototype._getTilesForViewport=function(){for(var t=this._zoomRoundingRule(this._camera.zoom),e=l.a.getScale(t,this._camera.zoom),i=l.a.worldToPixels(this._camera.worldCenter,t),r=Object(o.a)(i,this._size,e,this._tileSource.tileSize),s=[],n=r.minX;n<=r.maxX;n++)for(var a=r.minY;a<=r.maxY;a++)s.push({x:n,y:a,zoom:t});return s},e.prototype._loadTile=function(t){var e=this,i=Object(o.d)(t.id.zoom,this._tileSource.tileSize),r=f.applyFunction(t.id,(function(t){return Object(u.a)(t,0,i)})),s=this._queue.enqueue((function(i){var s=e._tileSource.fetchHotspots;return!i.aborted&&s?Promise.resolve(s(r.x,r.y,t.id.zoom,i)).catch((function(t){return Object(_.c)(t)})):Promise.resolve([])})),n=s.promise,a=s.abortController;return{id:t.id,abortController:a,promise:n}},e.prototype._computeAffectedTiles=function(t,e){var i=l.a.worldToTile(t,e,this._tileSource.tileSize),r=f.applyFunction(i,Math.floor),s=f.sub(i,r);f.muln(s,this._tileSource.tileSize,s);var n=s.x<this._tileSource.inset,o=s.x>this._tileSource.tileSize-this._tileSource.inset,a=s.y<this._tileSource.inset,c=s.y>this._tileSource.tileSize-this._tileSource.inset,h=[{x:r.x,y:r.y,zoom:e}];return n&&h.push({x:r.x-1,y:r.y,zoom:e}),o&&h.push({x:r.x+1,y:r.y,zoom:e}),a&&h.push({x:r.x,y:r.y-1,zoom:e}),c&&h.push({x:r.x,y:r.y+1,zoom:e}),n&&a&&h.push({x:r.x-1,y:r.y-1,zoom:e}),n&&c&&h.push({x:r.x-1,y:r.y+1,zoom:e}),o&&a&&h.push({x:r.x+1,y:r.y-1,zoom:e}),o&&c&&h.push({x:r.x+1,y:r.y+1,zoom:e}),h},e}(Object(a.a)().with());function g(t,e,i){void 0===i&&(i=p);var r=!1;return t.forEach((function(s,n){e(s)||(i(s),t.delete(n),r=!0)})),r}function y(t,e){if("Polygon"!==t.type)return t;for(var i=t.coordinates[0],r=i.reduce((function(t,e){return f.add(t,e,t)}),f.create(0,0)),s=f.divn(r,i.length),n=1+e/i.reduce((function(t,e){return Math.max(t,f.length(f.sub(e,s)))}),0),o=0,a=i;o<a.length;o++){var c=a[o],h=f.sub(c,s);f.muln(h,n,h),f.add(h,s,c)}return t}},25:function(t,e,i){"use strict";i.r(e),i.d(e,"queueMicrotask",(function(){return n})),i.d(e,"Promise",(function(){return r})),i.d(e,"promiseFinally",(function(){return o}));var r=Promise,s=r.resolve(),n=function(t){return s.then(t)},o=function(t,e){var i=Promise.resolve(t);return"finally"in i?i.finally(e):i.then((function(t){return Promise.resolve(e()).then((function(){return Promise.resolve(t)}))}),(function(t){return Promise.resolve(e()).then((function(){return Promise.reject(t)}))}))}},35:function(t,e,i){"use strict";var r=i(8);!function(t){function e(e){var i=t.call(this,e)||this;return i.name="AssertionError",i}Object(r.b)(e,t)}(Error)},46:function(t,e,i){"use strict";i.d(e,"b",(function(){return c})),i.d(e,"a",(function(){return r}));var r,s=i(8),n=i(11),o=i(81),a=i(13);!function(t){t[t.QUICK=1]="QUICK",t[t.INTERMEDIATE=2]="INTERMEDIATE",t[t.FULL=3]="FULL"}(r||(r={}));var c=function(t){function e(){var e=t.call(this)||this;return e._rafId=0,e._animationsCounter=0,e._framesSinceIntermediateRendering=0,e._renderFrame=function(){e._rafId=0,e._updateIsRequested=!1;var t=Date.now();try{e._emit("beforeRender",t);var i=e._getQualityForCurrentFrame();e._emit("render",{time:t,qualityHint:i})}catch(r){r&&"object"==typeof r&&e._lastTriggerStack&&(r.additionalInfo=e._lastTriggerStack),Object(a.c)(r)}e._isRunning&&e._requestFrame()},e._updateIsRequested=!1,e._isRunning=!1,e}return Object(s.b)(e,t),Object.defineProperty(e.prototype,"isActive",{get:function(){return this._isRunning},enumerable:!1,configurable:!0}),e.prototype.start=function(){this._isRunning=!0,this._requestFrame(),this._lastTriggerStack=(new Error).stack},e.prototype.stop=function(){this._isRunning&&(this._isRunning=!1,this._updateIsRequested||this._cancelFrame(),this._lastTriggerStack=void 0)},e.prototype.renderImmediately=function(t){var e=Date.now();this._rafId&&(cancelAnimationFrame(this._rafId),this._rafId=0),this._updateIsRequested=!1,this._emit("beforeRender",e),this._emit("render",{time:e,qualityHint:t})},e.prototype.update=function(){this._isRunning||(this._lastTriggerStack=(new Error).stack),this._updateIsRequested=!0,this._requestFrame()},e.prototype.destroy=function(){this._cancelFrame()},e.prototype.animate=function(t){var e=this;0===this._animationsCounter&&this.start(),this._animationsCounter++;var i=!0,r=this.on("beforeRender",(function(s){i?t(s):(r.offAll(),e._animationsCounter--,0===e._animationsCounter&&e.stop())})),s=new o.b;return{complete:s.promise,get isRunning(){return i},stop:function(){i?(i=!1,s.resolve()):console.warn("Trying to stop animation twice")}}},e.prototype.animateForDuration=function(t,e){var i=-1,r=this.animate((function(s){if(i<0)i=s;else{var n=(s-i)/e;n<1?t(n):(t(1),r.stop())}}));return r},e.prototype._requestFrame=function(){this._rafId||(this._rafId=requestAnimationFrame(this._renderFrame))},e.prototype._cancelFrame=function(){cancelAnimationFrame(this._rafId),this._rafId=0},e.prototype._getQualityForCurrentFrame=function(){return this._isRunning?this._framesSinceIntermediateRendering<12?(this._framesSinceIntermediateRendering++,r.QUICK):(this._framesSinceIntermediateRendering=1,r.INTERMEDIATE):(this._framesSinceIntermediateRendering=0,r.FULL)},e}(Object(n.a)().with())},503:function(t,e){!function(t,e){for(var i in e)t[i]=e[i]}(e,function(t){var e={};function i(r){if(e[r])return e[r].exports;var s=e[r]={i:r,l:!1,exports:{}};return t[r].call(s.exports,s,s.exports,i),s.l=!0,s.exports}return i.m=t,i.c=e,i.d=function(t,e,r){i.o(t,e)||Object.defineProperty(t,e,{enumerable:!0,get:r})},i.r=function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},i.t=function(t,e){if(1&e&&(t=i(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var r=Object.create(null);if(i.r(r),Object.defineProperty(r,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var s in t)i.d(r,s,function(e){return t[e]}.bind(null,s));return r},i.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return i.d(e,"a",e),e},i.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},i.p="",i(i.s=35)}([function(t,e){t.exports="varying lowp vec4 id;void main(void){gl_FragColor=id;}"},function(t,e){t.exports="#version 100\nattribute vec2 vertexPosition;attribute vec2 vertexUv;uniform float zIndex;\n#ifndef YV_LEAST_16b_P\n#   ifdef GL_FRAGMENT_PRECISION_HIGH\n#       define YV_LEAST_16b_P highp\n#   else\n#       define YV_LEAST_16b_P mediump\n#   endif\n#endif\nvarying YV_LEAST_16b_P vec2 uv;void main(void){gl_Position=vec4(vertexPosition,zIndex,1);uv=vertexUv;}"},function(t,e){t.exports="#version 100\nattribute vec2 vertexPosHigh;attribute vec2 vertexPosLow;attribute vec2 vertexDisplacement;attribute vec4 vertexId;uniform vec2 lookAtHigh;uniform vec2 lookAtLow;uniform mat4 viewProjMatrix;uniform vec2 pixelSize;uniform vec2 shift;const float A=pow(2.,16.);const float B=pow(2.,-30.);const float C=1.-pow(2.,-24.);varying vec4 id;void main(){vec4 D=viewProjMatrix*vec4((A*(vertexPosHigh-lookAtHigh)+(vertexPosLow-lookAtLow))*B,0,1);gl_Position=vec4(D.xy/D.w,C,1.);gl_Position.xy+=vertexDisplacement*pixelSize;gl_Position.xy+=shift;id=vec4(vertexId.xy/255.,0,1);}"},function(t,e){t.exports="#version 100\nprecision mediump float;uniform sampler2D atlas;varying highp vec2 uv;varying float weight;varying float smoothness;varying lowp vec4 color;void main(void){vec4 A=color;float B=texture2D(atlas,uv).a;float C=smoothstep(weight-smoothness,weight+smoothness,B);gl_FragColor=vec4(A.rgb,A.a*C);}"},function(t,e){t.exports="#version 100\nattribute vec2 vertexPosHigh;attribute vec2 vertexPosLow;attribute vec2 vertexNormal;attribute vec2 vertexDisplacement;attribute vec2 vertexUv;attribute vec4 vertexIconLocation;attribute float vertexScale;attribute vec4 vertexId;attribute vec2 vertexZoomRelatedData;attribute float vertexZIndex;attribute vec2 vertexCurrentAndSegmentLength;varying highp vec2 textureCoordinates;varying highp vec4 iconLocation;varying vec4 id;uniform vec2 lookAtHigh;uniform vec2 lookAtLow;uniform mat4 viewProjMatrix;uniform highp float worldToPxFactor;uniform float zoom;uniform float zoomScaleFactor;uniform bool snapGeometryToNearestZoom;const float A=256.;const float B=2048.;const float C=64.;const float D=1024.;const float E=pow(2.,16.);const float F=pow(2.,-30.);void main(void){float G=snapGeometryToNearestZoom?floor(zoom+0.5):vertexZoomRelatedData[0]*C;float H=vertexZoomRelatedData[1]*D;float I=pow(2.,(zoom-G)*zoomScaleFactor);float J=worldToPxFactor*I;float K=vertexCurrentAndSegmentLength.y/J;vec2 L=vec2(vertexNormal.y,-vertexNormal.x);vec2 M=vertexDisplacement*A;M.x=min(abs(M.x),K)*sign(M.x);gl_Position=viewProjMatrix*vec4((E*(vertexPosHigh-lookAtHigh)+(vertexPosLow-lookAtLow))*F+(M.x*L+M.y*vertexNormal)*J,0,1);gl_Position.z=gl_Position.w*vertexZIndex;\n#ifndef YV_COLOR_ID\ntextureCoordinates=vertexUv*B*vertexScale;iconLocation=vertexIconLocation;float N=pow(2.,G-zoom)*I;float O=worldToPxFactor*pow(2.,zoom-G);float P=vertexCurrentAndSegmentLength.x/O;float Q=min(abs(H),K)*sign(H);textureCoordinates.x+=(P+Q*N)*vertexScale;\n#else\nid=vertexId;\n#endif\n}"},function(t,e){t.exports="#version 100\nattribute vec4 vertexId;attribute vec2 vertexPosHigh;attribute vec2 vertexPosLow;attribute vec2 vertexDisplacement;attribute vec2 vertexUV;attribute float vertexPriority;attribute lowp vec4 vertexColor;attribute lowp vec4 vertexOutlineColor;attribute float vertexScale;uniform float isOutlinePhase;uniform vec2 lookAtHigh;uniform vec2 lookAtLow;uniform mat4 viewProjMatrix;uniform vec2 pixelSize;uniform vec2 atlasSize;uniform sampler2D visibility;uniform vec2 idHalfPxSize;uniform vec2 shift;uniform lowp float currentZoom;uniform float dpr;uniform bool isColorTransformed;uniform mat4 colorTransform;varying highp vec2 uv;varying float weight;varying float smoothness;varying lowp vec4 color;varying lowp vec4 id;const vec4 A=vec4(2,2,2,1);vec4 B(vec4 color,mat4 C){return C*vec4(color.rgb,1)*vec4(1,1,1,color.a);}const float D=pow(2.,16.);const float E=pow(2.,-30.);vec4 F(mat4 viewProjMatrix,vec2 lookAtHigh,vec2 lookAtLow,vec2 G,vec2 H,vec2 I,vec2 J){vec4 K=viewProjMatrix*vec4((D*(G-lookAtHigh)+(H-lookAtLow))*E,0,1);K=vec4(K.xy/K.w,0.,1.);return K+vec4(I*J,0.,0.);}const float L=0.5;float M(float N){return clamp(N,0.,L);}const float O=0.717;const float P=0.1;const float Q=0.12;float R(float N,bool S){return O+P*N+(S?-Q/N:0.);}const float T=0.1;const float U=0.06;float V(float N,float dpr){return(T+U/N)/dpr;}void main(void){float W=texture2D(visibility,vertexId.xy/256.+idHalfPxSize).a;if(W!=0.){gl_Position=F(viewProjMatrix,lookAtHigh,lookAtLow,vertexPosHigh,vertexPosLow,vertexDisplacement,pixelSize);\n#ifndef YV_COLOR_ID\nuv=vertexUV/atlasSize;bool S=isOutlinePhase>0.;float N=M(vertexScale);weight=R(N,S);smoothness=V(N,dpr);vec4 X=isColorTransformed?B(vertexColor,colorTransform):vertexColor;vec4 Y=vertexOutlineColor;Y.a=isColorTransformed?B(Y,colorTransform).a:Y.a;color=(isOutlinePhase*Y)+(1.-isOutlinePhase)*X;color.a*=W;\n#else\nid=vec4(vertexId.xy/255.,0,0);\n#endif\n}else{gl_Position=A;}}"},function(t,e){t.exports="#version 100\nattribute vec2 vertexPosHigh;attribute vec2 vertexPosLow;attribute vec2 vertexDisplacement;attribute vec2 vertexOffset;attribute vec2 vertexUV;attribute vec4 vertexId;attribute float vertexPriority;attribute vec2 vertexBrightness;uniform vec2 lookAtHigh;uniform vec2 lookAtLow;uniform mat4 viewProjMatrix;uniform vec2 pixelSize;uniform vec2 atlasSize;uniform sampler2D visibility;uniform vec2 idHalfPxSize;uniform vec2 extensionAndMinSize;varying vec2 uv;varying float alpha;varying vec4 id;varying float minBrightness;varying float maxBrightness;const float A=32.;const float B=pow(2.,16.);const float C=pow(2.,-30.);const vec4 D=vec4(2,2,2,1);void main(){float E=texture2D(visibility,vertexId.xy/256.+idHalfPxSize).a;if(E!=0.){vec4 F=viewProjMatrix*vec4((B*(vertexPosHigh-lookAtHigh)+(vertexPosLow-lookAtLow))*C,0,1);vec2 G=vertexDisplacement/A;vec2 H=vertexOffset/A;float I=extensionAndMinSize.x;float J=extensionAndMinSize.y;vec2 K=max(vec2(J*0.5),I+abs(G))*sign(G)+H;gl_Position=vec4(F.xy/F.w+K*pixelSize,0.,1.);\n#ifndef YV_COLOR_ID\nuv=vertexUV/atlasSize;alpha=E;minBrightness=vertexBrightness[0];maxBrightness=vertexBrightness[1];\n#else\nid=vec4(vertexId.xy/255.,0,0);\n#endif\n}else{gl_Position=D;}}"},function(t,e){t.exports="#version 100\nattribute vec2 vertexPosHigh;attribute vec2 vertexPosLow;attribute vec4 vertexColor;attribute float vertexZIndex;attribute vec4 vertexId;uniform vec2 lookAtHigh;uniform vec2 lookAtLow;uniform mat4 viewProjMatrix;uniform bool isColorTransformed;uniform mat4 colorTransform;varying vec4 id;varying vec4 color;vec4 A(vec4 color,mat4 B){return B*vec4(color.rgb,1)*vec4(1,1,1,color.a);}const float C=pow(2.,16.);const float D=pow(2.,-30.);void main(void){gl_Position=viewProjMatrix*vec4((C*(vertexPosHigh-lookAtHigh)+(vertexPosLow-lookAtLow))*D,0,1);gl_Position.z=gl_Position.w*vertexZIndex;\n#ifndef YV_COLOR_ID\ncolor=isColorTransformed?A(vertexColor,colorTransform):vertexColor;\n#else\nid=vertexId;\n#endif\n}"},function(t,e){t.exports="#version 100\nattribute vec3 vertexPosHigh;attribute vec3 vertexPosLow;attribute float vertexHeight;attribute vec4 vertexColor;attribute vec4 vertexId;uniform vec2 lookAtHigh;uniform vec2 lookAtLow;uniform mat4 viewProjMatrix;uniform float zFactor;uniform bool isColorTransformed;uniform mat4 colorTransform;varying vec4 globalPosition;varying vec4 diffuseColor;varying vec4 id;const float A=pow(2.,16.);const float B=pow(2.,-30.);vec4 C(vec4 D,mat4 E){return E*vec4(D.rgb,1)*vec4(1,1,1,D.a);}void main(void){vec4 F=vec4((A*(vertexPosHigh.xy-lookAtHigh)+(vertexPosLow.xy-lookAtLow))*B,vertexHeight*zFactor,1);gl_Position=viewProjMatrix*F;\n#ifndef YV_COLOR_ID\ndiffuseColor=isColorTransformed?C(vertexColor,colorTransform):vertexColor;globalPosition=F;\n#else\nid=vertexId;\n#endif\n}"},function(t,e){t.exports="#version 100\nattribute vec4 vertexId;attribute vec2 vertexPosHigh;attribute vec2 vertexPosLow;attribute vec3 vertexDisplacements;attribute vec2 vertexUV;attribute float vertexPriority;attribute lowp vec4 vertexColor;attribute lowp vec4 vertexOutlineColor;attribute vec2 polylineLength_vertexScale;attribute vec4 leftPolylineRatios;attribute vec4 leftPolylineAngles;attribute vec4 rightPolylineRatios;attribute vec4 rightPolylineAngles;uniform float isOutlinePhase;uniform vec2 lookAtHigh;uniform vec2 lookAtLow;uniform mat4 viewProjMatrix;uniform vec2 pixelSize;uniform vec2 atlasSize;uniform sampler2D visibility;uniform vec2 idHalfPxSize;uniform vec2 shift;uniform lowp float currentZoom;uniform float dpr;varying highp vec2 uv;varying float weight;varying float smoothness;varying lowp vec4 color;varying lowp vec4 id;const vec4 A=vec4(2,2,2,1);const float B=pow(2.,16.);const float C=pow(2.,-30.);const float D=3.1415927410125732;const int E=4;const float F=1000000.;const float G=1./256.;vec2 H(mat4 viewProjMatrix,vec2 lookAtHigh,vec2 lookAtLow,vec2 pixelSize,vec2 I,vec2 J,vec2 K){vec4 L=viewProjMatrix*vec4((B*(I-lookAtHigh)+(J-lookAtLow))*C+K,0,1);vec2 M=L.xy/L.w;return M/pixelSize;}vec2 N(float O,float P,float Q){float R=P*2.*D-D;float S=O*Q;return vec2(cos(R),sin(R))*S;}float T(vec4 R,int U){if(U==0)return R[0];if(U==1)return R[1];if(U==2)return R[2];return R[3];}vec4 V(mat4 viewProjMatrix,vec2 lookAtHigh,vec2 lookAtLow,vec2 W,vec2 X,vec2 Y,vec2 Z,float a,float Q,vec4 leftPolylineRatios,vec4 leftPolylineAngles,vec4 rightPolylineRatios,vec4 rightPolylineAngles){vec2 L=H(viewProjMatrix,lookAtHigh,lookAtLow,W,X,Y,vec2(0,0));vec2 b=N(rightPolylineRatios[0],rightPolylineAngles[0],Q);vec2 c=H(viewProjMatrix,lookAtHigh,lookAtLow,W,X,Y,b);bool d=a>0.;bool e=c.x<L.x;bool f=d^^e;if(d==e){b=f?N(rightPolylineRatios[0],rightPolylineAngles[0],Q):N(leftPolylineRatios[0],leftPolylineAngles[0],Q);c=H(viewProjMatrix,lookAtHigh,lookAtLow,W,X,Y,b);}float g=abs(a);for(int U=1;U<=E;U++){vec2 h=c-L;bool i=U==E||T(f?rightPolylineRatios:leftPolylineRatios,U)<G;float j=i?F:length(h);if(j>g){float k=a>0.?1.:-1.;vec2 l=normalize(h);vec2 m=vec2(-l.y,l.x);L+=l*g;L+=k*l*Z.x;L+=k*m*Z.y;break;}else{g-=j;L+=h;vec2 n=f?N(T(rightPolylineRatios,U),T(rightPolylineAngles,U),Q):N(T(leftPolylineRatios,U),T(leftPolylineAngles,U),Q);c=H(viewProjMatrix,lookAtHigh,lookAtLow,W,X,Y,n);}}return vec4(L*W,0.,1.);}const float o=0.5;float p(float q){return clamp(q,0.,o);}const float r=0.717;const float s=0.1;const float t=0.12;float u(float q,bool v){return r+s*q+(v?-t/q:0.);}const float w=0.1;const float x=0.06;float y(float q,float dpr){return(w+x/q)/dpr;}void main(void){float z=texture2D(visibility,vertexId.xy/256.+idHalfPxSize).a;if(z!=0.){vec2 AA=vertexDisplacements.xy;float AB=vertexDisplacements.z;float Q=polylineLength_vertexScale[0];float AC=polylineLength_vertexScale[1];gl_Position=V(viewProjMatrix,lookAtHigh,lookAtLow,pixelSize,vertexPosHigh,vertexPosLow,AA,AB,Q,leftPolylineRatios,leftPolylineAngles,rightPolylineRatios,rightPolylineAngles);\n#ifndef YV_COLOR_ID\nuv=vertexUV/atlasSize;bool v=isOutlinePhase>0.;float q=p(AC);weight=u(q,v);smoothness=y(q,dpr);color=v?vertexOutlineColor:vertexColor;color.a*=z;\n#else\nid=vec4(vertexId.xy/255.,0,0);\n#endif\n}else{gl_Position=A;}}"},function(t,e,i){t.exports=function(){return i(34)('!function(t){var e={};function i(s){if(e[s])return e[s].exports;var n=e[s]={i:s,l:!1,exports:{}};return t[s].call(n.exports,n,n.exports,i),n.l=!0,n.exports}i.m=t,i.c=e,i.d=function(t,e,s){i.o(t,e)||Object.defineProperty(t,e,{enumerable:!0,get:s})},i.r=function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},i.t=function(t,e){if(1&e&&(t=i(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var s=Object.create(null);if(i.r(s),Object.defineProperty(s,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var n in t)i.d(s,n,function(e){return t[e]}.bind(null,n));return s},i.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return i.d(e,"a",e),e},i.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},i.p="",i(i.s=41)}([function(t,e,i){"use strict";function s(t,e){for(const i of t)if(e(i))return i}function*n(t,e){for(const i of t)yield e(i)}function*r(t,e){for(const i of t)e(i)&&(yield i)}function o(t,e,i){let s=i;for(const n of t)s=e(s,n);return s}function a(t,e){for(const i of t)if(e(i))return!0;return!1}function*l(t,e,i=((t,e)=>[t,e])){const s=t[Symbol.iterator](),n=e[Symbol.iterator]();for(let r=s.next(),o=n.next();!r.done&&!o.done;r=s.next(),o=n.next())yield i(r.value,o.value)}i.d(e,"b",(function(){return s})),i.d(e,"c",(function(){return n})),i.d(e,"a",(function(){return r})),i.d(e,"e",(function(){return o})),i.d(e,"d",(function(){return a})),i.d(e,"f",(function(){return l}))},function(module,__webpack_exports__,__webpack_require__){"use strict";__webpack_require__.d(__webpack_exports__,"a",(function(){return batchPrimitiveDescriptions})),__webpack_require__.d(__webpack_exports__,"b",(function(){return batchTexturedPrimitiveDescriptions})),__webpack_require__.d(__webpack_exports__,"c",(function(){return createPrimitivesBatchingPredicate}));var _util_iterable__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__(0),_render_util_primitive_batching__WEBPACK_IMPORTED_MODULE_1__=__webpack_require__(8);function batchPrimitiveDescriptions(t,e=(()=>!0)){return Object(_util_iterable__WEBPACK_IMPORTED_MODULE_0__.c)(Object(_render_util_primitive_batching__WEBPACK_IMPORTED_MODULE_1__.a)(t,t=>t.location,t=>Object.assign(Object.assign({},t.location),{id:t.id}),e),t=>({location:t,id:t.id}))}function batchTexturedPrimitiveDescriptions(t,e=(()=>!0)){return Object(_util_iterable__WEBPACK_IMPORTED_MODULE_0__.c)(Object(_render_util_primitive_batching__WEBPACK_IMPORTED_MODULE_1__.a)(t,t=>t.location,t=>Object.assign(Object.assign({},t.location),{id:t.id,atlasId:t.atlasId}),(t,i)=>t.atlasId===i.atlasId&&e(t,i)),t=>({location:t,id:t.id,atlasId:t.atlasId}))}function createPrimitivesBatchingPredicate(rule,metadata){const predicate=eval(rule);if("function"!=typeof predicate)throw new Error("Predicate must be a function");return(t,e)=>{const i=void 0!==t.id?metadata.get(t.id):void 0,s=void 0!==e.id?metadata.get(e.id):void 0;return predicate(i,s,t,e)}}},function(t,e,i){"use strict";var s;function n(t,e){return t.b===e.b&&t.a===e.a}function r(t,e){return t.b<e.b||t.b===e.b&&t.a<=e.a}function o(t,e,i){var s=e.b-t.b,n=i.b-e.b;return 0<s+n?s<n?e.a-t.a+s/(s+n)*(t.a-i.a):e.a-i.a+n/(s+n)*(i.a-t.a):0}function a(t,e,i){var s=e.b-t.b,n=i.b-e.b;return 0<s+n?(e.a-i.a)*s+(e.a-t.a)*n:0}function l(t,e){return t.a<e.a||t.a===e.a&&t.b<=e.b}function h(t,e,i){var s=e.a-t.a,n=i.a-e.a;return 0<s+n?s<n?e.b-t.b+s/(s+n)*(t.b-i.b):e.b-i.b+n/(s+n)*(i.b-t.b):0}function c(t,e,i){var s=e.a-t.a,n=i.a-e.a;return 0<s+n?(e.b-i.b)*s+(e.b-t.b)*n:0}function d(t){return r(t.b.a,t.a)}function u(t){return r(t.a,t.b.a)}function f(t,e,i,s){return(t=0>t?0:t)<=(i=0>i?0:i)?0===i?(e+s)/2:e+t/(t+i)*(s-e):s+i/(t+i)*(e-s)}function p(t){var e=b(t.b);return v(e,t.c),v(e.b,t.c),x(e,t.a),e}function _(t,e){var i=!1,s=!1;t!==e&&(e.a!==t.a&&(s=!0,A(e.a,t.a)),e.d!==t.d&&(i=!0,S(e.d,t.d)),w(e,t),s||(v(e,t.a),t.a.c=t),i||(x(e,t.d),t.d.a=t))}function g(t){var e=t.b,i=!1;t.d!==t.b.d&&(i=!0,S(t.d,t.b.d)),t.c===t?A(t.a,null):(t.b.d.a=et(t),t.a.c=t.c,w(t,et(t)),i||x(t,t.d)),e.c===e?(A(e.a,null),S(e.d,null)):(t.d.a=et(e),e.a.c=e.c,w(e,et(e))),k(t)}function m(t){var e=b(t),i=e.b;return w(e,t.e),e.a=t.b.a,v(i,e.a),e.d=i.d=t.d,e=e.b,w(t.b,et(t.b)),w(t.b,e),t.b.a=e.a,e.b.a.c=e.b,e.b.d=t.b.d,e.f=t.f,e.b.f=t.b.f,e}function y(t,e){var i=!1,s=b(t),n=s.b;return e.d!==t.d&&(i=!0,S(e.d,t.d)),w(s,t.e),w(n,e),s.a=t.b.a,n.a=e.a,s.d=n.d=t.d,t.d.a=n,i||x(s,t.d),s}function b(t){var e=new tt,i=new tt,s=t.b.h;return i.h=s,s.b.h=e,e.h=t,t.b.h=i,e.b=i,e.c=e,e.e=i,i.b=e,i.c=i,i.e=e}function w(t,e){var i=t.c,s=e.c;i.b.e=e,s.b.e=t,t.c=s,e.c=i}function v(t,e){var i=e.f,s=new st(e,i);i.e=s,e.f=s,i=s.c=t;do{i.a=s,i=i.c}while(i!==t)}function x(t,e){var i=e.d,s=new J(e,i);i.b=s,e.d=s,s.a=t,s.c=e.c,i=t;do{i.d=s,i=i.e}while(i!==t)}function k(t){var e=t.h;t=t.b.h,e.b.h=t,t.b.h=e}function A(t,e){var i=t.c,s=i;do{s.a=e,s=s.c}while(s!==i);i=t.f,(s=t.e).f=i,i.e=s}function S(t,e){var i=t.a,s=i;do{s.d=e,s=s.e}while(s!==i);i=t.d,(s=t.b).d=i,i.b=s}function T(t){var e=0;return Math.abs(t[1])>Math.abs(t[0])&&(e=1),Math.abs(t[2])>Math.abs(t[e])&&(e=2),e}var R=4e150;function I(t,e){t.f+=e.f,t.b.f+=e.b.f}function C(t,e,i){return t=t.a,e=e.a,i=i.a,e.b.a===t?i.b.a===t?r(e.a,i.a)?0>=a(i.b.a,e.a,i.a):0<=a(e.b.a,i.a,e.a):0>=a(i.b.a,t,i.a):i.b.a===t?0<=a(e.b.a,t,e.a):(e=o(e.b.a,t,e.a))>=(t=o(i.b.a,t,i.a))}function z(t){t.a.i=null;var e=t.e;e.a.c=e.c,e.c.a=e.a,t.e=null}function P(t,e){g(t.a),t.c=!1,t.a=e,e.i=t}function O(t){var e=t.a.a;do{t=_t(t)}while(t.a.a===e);return t.c&&(P(t,e=y(pt(t).a.b,t.a.e)),t=_t(t)),t}function E(t,e,i){var s=new ft;return s.a=i,s.e=X(t.f,e.e,s),i.i=s}function M(t,e){switch(t.s){case 100130:return 0!=(1&e);case 100131:return 0!==e;case 100132:return 0<e;case 100133:return 0>e;case 100134:return 2<=e||-2>=e}return!1}function L(t){var e=t.a,i=e.d;i.c=t.d,i.a=e,z(t)}function B(t,e,i){for(t=e,e=e.a;t!==i;){t.c=!1;var s=pt(t),n=s.a;if(n.a!==e.a){if(!s.c){L(t);break}P(s,n=y(e.c.b,n.b))}e.c!==n&&(_(et(n),n),_(e,n)),L(t),e=s.a,t=s}return e}function U(t,e,i,s,n,r){var o=!0;do{E(t,e,i.b),i=i.c}while(i!==s);for(null===n&&(n=pt(e).a.b.c);(i=(s=pt(e)).a.b).a===n.a;)i.c!==n&&(_(et(i),i),_(et(n),i)),s.f=e.f-i.f,s.d=M(t,s.f),e.b=!0,!o&&V(t,e)&&(I(i,n),z(e),g(n)),o=!1,e=s,n=i;e.b=!0,r&&q(t,e)}function D(t,e,i,s,n){var r=[e.g[0],e.g[1],e.g[2]];e.d=null,e.d=t.o&&t.o(r,i,s,t.c)||null,null===e.d&&(n?t.n||(Q(t,100156),t.n=!0):e.d=i[0])}function j(t,e,i){var s=[null,null,null,null];s[0]=e.a.d,s[1]=i.a.d,D(t,e.a,s,[.5,.5,0,0],!1),_(e,i)}function N(t,e,i,s,n){var r=Math.abs(e.b-t.b)+Math.abs(e.a-t.a),o=Math.abs(i.b-t.b)+Math.abs(i.a-t.a),a=n+1;s[n]=.5*o/(r+o),s[a]=.5*r/(r+o),t.g[0]+=s[n]*e.g[0]+s[a]*i.g[0],t.g[1]+=s[n]*e.g[1]+s[a]*i.g[1],t.g[2]+=s[n]*e.g[2]+s[a]*i.g[2]}function V(t,e){var i=pt(e),s=e.a,o=i.a;if(r(s.a,o.a)){if(0<a(o.b.a,s.a,o.a))return!1;if(n(s.a,o.a)){if(s.a!==o.a){i=t.e;var l=s.a.h;if(0<=l){var h=(i=i.b).d,c=i.e,d=i.c,u=d[l];h[u]=h[i.a],d[h[u]]=u,u<=--i.a&&(1>=u||r(c[h[u>>1]],c[h[u]])?dt(i,u):ut(i,u)),c[l]=null,d[l]=i.b,i.b=l}else for(i.c[-(l+1)]=null;0<i.a&&null===i.c[i.d[i.a-1]];)--i.a;j(t,et(o),s)}}else m(o.b),_(s,et(o)),e.b=i.b=!0}else{if(0>a(s.b.a,o.a,s.a))return!1;_t(e).b=e.b=!0,m(s.b),_(et(o),s)}return!0}function W(t,e){var i=pt(e),s=e.a,d=i.a,u=s.a,p=d.a,g=s.b.a,y=d.b.a,b=new st;if(a(g,t.a,u),a(y,t.a,p),u===p||Math.min(u.a,g.a)>Math.max(p.a,y.a))return!1;if(r(u,p)){if(0<a(y,u,p))return!1}else if(0>a(g,p,u))return!1;var w,v,x=g,k=u,A=y,S=p;if(r(x,k)||(w=x,x=k,k=w),r(A,S)||(w=A,A=S,S=w),r(x,A)||(w=x,x=A,A=w,w=k,k=S,S=w),r(A,k)?r(k,S)?(0>(w=o(x,A,k))+(v=o(A,k,S))&&(w=-w,v=-v),b.b=f(w,A.b,v,k.b)):(0>(w=a(x,A,k))+(v=-a(x,S,k))&&(w=-w,v=-v),b.b=f(w,A.b,v,S.b)):b.b=(A.b+k.b)/2,l(x,k)||(w=x,x=k,k=w),l(A,S)||(w=A,A=S,S=w),l(x,A)||(w=x,x=A,A=w,w=k,k=S,S=w),l(A,k)?l(k,S)?(0>(w=h(x,A,k))+(v=h(A,k,S))&&(w=-w,v=-v),b.a=f(w,A.a,v,k.a)):(0>(w=c(x,A,k))+(v=-c(x,S,k))&&(w=-w,v=-v),b.a=f(w,A.a,v,S.a)):b.a=(A.a+k.a)/2,r(b,t.a)&&(b.b=t.a.b,b.a=t.a.a),x=r(u,p)?u:p,r(x,b)&&(b.b=x.b,b.a=x.a),n(b,u)||n(b,p))return V(t,e),!1;if(!n(g,t.a)&&0<=a(g,t.a,b)||!n(y,t.a)&&0>=a(y,t.a,b)){if(y===t.a)return m(s.b),_(d.b,s),s=pt(e=O(e)).a,B(t,pt(e),i),U(t,e,et(s),s,s,!0),!0;if(g===t.a){m(d.b),_(s.e,et(d)),p=(u=i=e).a.b.a;do{u=_t(u)}while(u.a.b.a===p);return u=pt(e=u).a.b.c,i.a=et(d),U(t,e,(d=B(t,i,null)).c,s.b.c,u,!0),!0}return 0<=a(g,t.a,b)&&(_t(e).b=e.b=!0,m(s.b),s.a.b=t.a.b,s.a.a=t.a.a),0>=a(y,t.a,b)&&(e.b=i.b=!0,m(d.b),d.a.b=t.a.b,d.a.a=t.a.a),!1}return m(s.b),m(d.b),_(et(d),s),s.a.b=b.b,s.a.a=b.a,s.a.h=rt(t.e,s.a),s=s.a,d=[0,0,0,0],b=[u.d,g.d,p.d,y.d],s.g[0]=s.g[1]=s.g[2]=0,N(s,u,g,d,0),N(s,p,y,d,2),D(t,s,b,d,!0),_t(e).b=e.b=i.b=!0,!1}function q(t,e){for(var i=pt(e);;){for(;i.b;)e=i,i=pt(i);if(!e.b&&(i=e,null===(e=_t(e))||!e.b))break;e.b=!1;var s,n=e.a,o=i.a;if(s=n.b.a!==o.b.a)t:{var l=pt(s=e),h=s.a,c=l.a,d=void 0;if(r(h.b.a,c.b.a)){if(0>a(h.b.a,c.b.a,h.a)){s=!1;break t}_t(s).b=s.b=!0,d=m(h),_(c.b,d),d.d.c=s.d}else{if(0<a(c.b.a,h.b.a,c.a)){s=!1;break t}s.b=l.b=!0,d=m(c),_(h.e,c.b),d.b.d.c=s.d}s=!0}if(s&&(i.c?(z(i),g(o),o=(i=pt(e)).a):e.c&&(z(e),g(n),n=(e=_t(i)).a)),n.a!==o.a)if(n.b.a===o.b.a||e.c||i.c||n.b.a!==t.a&&o.b.a!==t.a)V(t,e);else if(W(t,e))break;n.a===o.a&&n.b.a===o.b.a&&(I(o,n),z(e),g(n),e=_t(i))}}function G(t,e){t.a=e;for(var i=e.c;null===i.i;)if((i=i.c)===e.c){i=t;var s=e;(h=new ft).a=s.c.b;var o=(d=i.f).a;do{o=o.a}while(null!==o.b&&!d.c(d.b,h,o.b));var l=pt(d=o.b),h=d.a;o=l.a;if(0===a(h.b.a,s,h.a))n((h=d.a).a,s)||n(h.b.a,s)||(m(h.b),d.c&&(g(h.c),d.c=!1),_(s.c,h),G(i,s));else{var c=r(o.b.a,h.b.a)?d:l;l=void 0;d.d||c.c?(l=c===d?y(s.c.b,h.e):y(o.b.c.b,s.c).b,c.c?P(c,l):(h=i,(d=E(i,d,l)).f=_t(d).f+d.a.f,d.d=M(h,d.f)),G(i,s)):U(i,d,s.c,s.c,null,!0)}return}if(d=(h=pt(i=O(i.i))).a,(h=B(t,h,null)).c===d){h=(d=h).c,o=pt(i),l=i.a,c=o.a;var d,u=!1;l.b.a!==c.b.a&&W(t,i),n(l.a,t.a)&&(_(et(h),l),h=pt(i=O(i)).a,B(t,pt(i),o),u=!0),n(c.a,t.a)&&(_(d,et(c)),d=B(t,o,null),u=!0),u?U(t,i,d.c,h,h,!0):(s=r(c.a,l.a)?et(c):l,U(t,i,s=y(d.c.b,s),s.c,s.c,!1),s.b.i.c=!0,q(t,i))}else U(t,i,h.c,d,d,!0)}function F(t,e){var i=new ft,s=p(t.b);s.a.b=R,s.a.a=e,s.b.a.b=-R,s.b.a.a=e,t.a=s.b.a,i.a=s,i.f=0,i.d=!1,i.c=!1,i.h=!0,i.b=!1,s=X(s=t.f,s.a,i),i.e=s}function Y(t){this.a=new Z,this.b=t,this.c=C}function X(t,e,i){do{e=e.c}while(null!==e.b&&!t.c(t.b,e.b,i));return t=new Z(i,e.a,e),e.a.c=t,e.a=t}function Z(t,e,i){this.b=t||null,this.a=e||this,this.c=i||this}function H(){this.d=K,this.p=this.b=this.q=null,this.j=[0,0,0],this.s=100130,this.n=!1,this.o=this.a=this.e=this.f=null,this.m=!1,this.c=this.r=this.i=this.k=this.l=this.h=null}var K=0;function $(t,e){if(t.d!==e)for(;t.d!==e;)if(t.d<e)switch(t.d){case K:Q(t,100151),t.u(null);break;case 1:Q(t,100152),t.t()}else switch(t.d){case 2:Q(t,100154),t.v();break;case 1:Q(t,100153),t.w()}}function Q(t,e){t.p&&t.p(e,t.c)}function J(t,e){this.b=t||this,this.d=e||this,this.a=null,this.c=!1}function tt(){this.h=this,this.i=this.d=this.a=this.e=this.c=this.b=null,this.f=0}function et(t){return t.b.e}function it(){this.c=new st,this.a=new J,this.b=new tt,this.d=new tt,this.b.b=this.d,this.d.b=this.b}function st(t,e){this.e=t||this,this.f=e||this,this.d=this.c=null,this.g=[0,0,0],this.h=this.a=this.b=0}function nt(){this.c=[],this.d=null,this.a=0,this.e=!1,this.b=new at}function rt(t,e){if(t.e){var i,s=t.b,n=++s.a;return 2*n>s.f&&(s.f*=2,s.c=lt(s.c,s.f+1)),0===s.b?i=n:(i=s.b,s.b=s.c[s.b]),s.e[i]=e,s.c[i]=n,s.d[n]=i,s.h&&ut(s,n),i}return s=t.a++,t.c[s]=e,-(s+1)}function ot(t){if(0===t.a)return ct(t.b);var e=t.c[t.d[t.a-1]];if(0!==t.b.a&&r(ht(t.b),e))return ct(t.b);do{--t.a}while(0<t.a&&null===t.c[t.d[t.a-1]]);return e}function at(){this.d=lt([0],33),this.e=[null,null],this.c=[0,0],this.a=0,this.f=32,this.b=0,this.h=!1,this.d[1]=1}function lt(t,e){for(var i=Array(e),s=0;s<t.length;s++)i[s]=t[s];for(;s<e;s++)i[s]=0;return i}function ht(t){return t.e[t.d[1]]}function ct(t){var e=t.d,i=t.e,s=t.c,n=e[1],r=i[n];return 0<t.a&&(e[1]=e[t.a],s[e[1]]=1,i[n]=null,s[n]=t.b,t.b=n,0<--t.a&&dt(t,1)),r}function dt(t,e){for(var i=t.d,s=t.e,n=t.c,o=e,a=i[o];;){var l=o<<1;l<t.a&&r(s[i[l+1]],s[i[l]])&&(l+=1);var h=i[l];if(l>t.a||r(s[a],s[h])){i[o]=a,n[a]=o;break}i[o]=h,n[h]=o,o=l}}function ut(t,e){for(var i=t.d,s=t.e,n=t.c,o=e,a=i[o];;){var l=o>>1,h=i[l];if(0===l||r(s[h],s[a])){i[o]=a,n[a]=o;break}i[o]=h,n[h]=o,o=l}}function ft(){this.e=this.a=null,this.f=0,this.c=this.b=this.h=this.d=!1}function pt(t){return t.e.c.b}function _t(t){return t.e.a.b}(s=H.prototype).x=function(){$(this,K)},s.B=function(t,e){switch(t){case 100142:return;case 100140:switch(e){case 100130:case 100131:case 100132:case 100133:case 100134:return void(this.s=e)}break;case 100141:return void(this.m=!!e);default:return void Q(this,100900)}Q(this,100901)},s.y=function(t){switch(t){case 100142:return 0;case 100140:return this.s;case 100141:return this.m;default:Q(this,100900)}return!1},s.A=function(t,e,i){this.j[0]=t,this.j[1]=e,this.j[2]=i},s.z=function(t,e){var i=e||null;switch(t){case 100100:case 100106:this.h=i;break;case 100104:case 100110:this.l=i;break;case 100101:case 100107:this.k=i;break;case 100102:case 100108:this.i=i;break;case 100103:case 100109:this.p=i;break;case 100105:case 100111:this.o=i;break;case 100112:this.r=i;break;default:Q(this,100900)}},s.C=function(t,e){var i=!1,s=[0,0,0];$(this,2);for(var n=0;3>n;++n){var r=t[n];-1e150>r&&(r=-1e150,i=!0),1e150<r&&(r=1e150,i=!0),s[n]=r}i&&Q(this,100155),null===(i=this.q)?_(i=p(this.b),i.b):(m(i),i=i.e),i.a.d=e,i.a.g[0]=s[0],i.a.g[1]=s[1],i.a.g[2]=s[2],i.f=1,i.b.f=-1,this.q=i},s.u=function(t){$(this,K),this.d=1,this.b=new it,this.c=t},s.t=function(){$(this,1),this.d=2,this.q=null},s.v=function(){$(this,2),this.d=1},s.w=function(){$(this,1),this.d=K;var t=!1,e=[h=this.j[0],i=this.j[1],o=this.j[2]];if(0===h&&0===i&&0===o){for(var i=[-2e150,-2e150,-2e150],s=[2e150,2e150,2e150],o=[],l=[],h=(t=this.b.c).e;h!==t;h=h.e)for(var c=0;3>c;++c){var f=h.g[c];f<s[c]&&(s[c]=f,l[c]=h),f>i[c]&&(i[c]=f,o[c]=h)}if(h=0,i[1]-s[1]>i[0]-s[0]&&(h=1),i[2]-s[2]>i[h]-s[h]&&(h=2),s[h]>=i[h])e[0]=0,e[1]=0,e[2]=1;else{for(i=0,s=l[h],o=o[h],l=[0,0,0],s=[s.g[0]-o.g[0],s.g[1]-o.g[1],s.g[2]-o.g[2]],c=[0,0,0],h=t.e;h!==t;h=h.e)c[0]=h.g[0]-o.g[0],c[1]=h.g[1]-o.g[1],c[2]=h.g[2]-o.g[2],l[0]=s[1]*c[2]-s[2]*c[1],l[1]=s[2]*c[0]-s[0]*c[2],l[2]=s[0]*c[1]-s[1]*c[0],(f=l[0]*l[0]+l[1]*l[1]+l[2]*l[2])>i&&(i=f,e[0]=l[0],e[1]=l[1],e[2]=l[2]);0>=i&&(e[0]=e[1]=e[2]=0,e[T(s)]=1)}t=!0}for(l=T(e),h=this.b.c,i=(l+1)%3,o=(l+2)%3,l=0<e[l]?1:-1,e=h.e;e!==h;e=e.e)e.b=e.g[i],e.a=l*e.g[o];if(t){for(e=0,h=(t=this.b.a).b;h!==t;h=h.b)if(!(0>=(i=h.a).f))do{e+=(i.a.b-i.b.a.b)*(i.a.a+i.b.a.a),i=i.e}while(i!==h.a);if(0>e)for(t=(e=this.b.c).e;t!==e;t=t.e)t.a=-t.a}for(this.n=!1,h=(e=this.b.b).h;h!==e;h=t)t=h.h,i=h.e,n(h.a,h.b.a)&&h.e.e!==h&&(j(this,i,h),g(h),i=(h=i).e),i.e===h&&(i!==h&&(i!==t&&i!==t.b||(t=t.h),g(i)),h!==t&&h!==t.b||(t=t.h),g(h));for(this.e=e=new nt,h=(t=this.b.c).e;h!==t;h=h.e)h.h=rt(e,h);for(function(t){t.d=[];for(var e=0;e<t.a;e++)t.d[e]=e;t.d.sort(function(t){return function(e,i){return r(t[e],t[i])?1:-1}}(t.c)),t.e=!0,function(t){for(var e=t.a;1<=e;--e)dt(t,e);t.h=!0}(t.b)}(e),this.f=new Y(this),F(this,-R),F(this,R);null!==(e=ot(this.e));){for(;;){t:if(h=this.e,0===h.a)t=ht(h.b);else if(t=h.c[h.d[h.a-1]],0!==h.b.a&&(h=ht(h.b),r(h,t))){t=h;break t}if(null===t||!n(t,e))break;t=ot(this.e),j(this,e.c,t.c)}G(this,e)}for(this.a=this.f.a.a.b.a.a,e=0;null!==(t=this.f.a.a.b);)t.h||++e,z(t);for(this.f=null,(e=this.e).b=null,e.d=null,this.e=e.c=null,h=(e=this.b).a.b;h!==e.a;h=t)t=h.b,(h=h.a).e.e===h&&(I(h.c,h),g(h));if(!this.n){if(e=this.b,this.m)for(h=e.b.h;h!==e.b;h=t)t=h.h,h.b.d.c!==h.d.c?h.f=h.d.c?1:-1:g(h);else for(h=e.a.b;h!==e.a;h=t)if(t=h.b,h.c){for(h=h.a;r(h.b.a,h.a);h=h.c.b);for(;r(h.a,h.b.a);h=h.e);for(i=h.c.b,o=void 0;h.e!==i;)if(r(h.b.a,i.a)){for(;i.e!==h&&(d(i.e)||0>=a(i.a,i.b.a,i.e.b.a));)i=(o=y(i.e,i)).b;i=i.c.b}else{for(;i.e!==h&&(u(h.c.b)||0<=a(h.b.a,h.a,h.c.b.a));)h=(o=y(h,h.c.b)).b;h=h.e}for(;i.e.e!==h;)i=(o=y(i.e,i)).b}if(this.h||this.i||this.k||this.l)if(this.m){for(t=(e=this.b).a.b;t!==e.a;t=t.b)if(t.c){this.h&&this.h(2,this.c),h=t.a;do{this.k&&this.k(h.a.d,this.c),h=h.e}while(h!==t.a);this.i&&this.i(this.c)}}else{for(e=this.b,t=!!this.l,h=!1,i=-1,o=e.a.d;o!==e.a;o=o.d)if(o.c){h||(this.h&&this.h(4,this.c),h=!0),l=o.a;do{t&&(i!==(s=l.b.d.c?0:1)&&(i=s,this.l&&this.l(!!i,this.c))),this.k&&this.k(l.a.d,this.c),l=l.e}while(l!==o.a)}h&&this.i&&this.i(this.c)}if(this.r){for(h=(e=this.b).a.b;h!==e.a;h=t)if(t=h.b,!h.c){o=(i=h.a).e,l=void 0;do{o=(l=o).e,l.d=null,null===l.b.d&&(l.c===l?A(l.a,null):(l.a.c=l.c,w(l,et(l))),(s=l.b).c===s?A(s.a,null):(s.a.c=s.c,w(s,et(s))),k(l))}while(l!==i);i=h.d,(h=h.b).d=i,i.b=h}return this.r(this.b),void(this.c=this.b=null)}}this.b=this.c=null},this.libtess={GluTesselator:H,windingRule:{GLU_TESS_WINDING_ODD:100130,GLU_TESS_WINDING_NONZERO:100131,GLU_TESS_WINDING_POSITIVE:100132,GLU_TESS_WINDING_NEGATIVE:100133,GLU_TESS_WINDING_ABS_GEQ_TWO:100134},primitiveType:{GL_LINE_LOOP:2,GL_TRIANGLES:4,GL_TRIANGLE_STRIP:5,GL_TRIANGLE_FAN:6},errorType:{GLU_TESS_MISSING_BEGIN_POLYGON:100151,GLU_TESS_MISSING_END_POLYGON:100153,GLU_TESS_MISSING_BEGIN_CONTOUR:100152,GLU_TESS_MISSING_END_CONTOUR:100154,GLU_TESS_COORD_TOO_LARGE:100155,GLU_TESS_NEED_COMBINE_CALLBACK:100156},gluEnum:{GLU_TESS_MESH:100112,GLU_TESS_TOLERANCE:100142,GLU_TESS_WINDING_RULE:100140,GLU_TESS_BOUNDARY_ONLY:100141,GLU_INVALID_ENUM:100900,GLU_INVALID_VALUE:100901,GLU_TESS_BEGIN:100100,GLU_TESS_VERTEX:100101,GLU_TESS_END:100102,GLU_TESS_ERROR:100103,GLU_TESS_EDGE_FLAG:100104,GLU_TESS_COMBINE:100105,GLU_TESS_BEGIN_DATA:100106,GLU_TESS_VERTEX_DATA:100107,GLU_TESS_END_DATA:100108,GLU_TESS_ERROR_DATA:100109,GLU_TESS_EDGE_FLAG_DATA:100110,GLU_TESS_COMBINE_DATA:100111}},H.prototype.gluDeleteTess=H.prototype.x,H.prototype.gluTessProperty=H.prototype.B,H.prototype.gluGetTessProperty=H.prototype.y,H.prototype.gluTessNormal=H.prototype.A,H.prototype.gluTessCallback=H.prototype.z,H.prototype.gluTessVertex=H.prototype.C,H.prototype.gluTessBeginPolygon=H.prototype.u,H.prototype.gluTessBeginContour=H.prototype.t,H.prototype.gluTessEndContour=H.prototype.v,H.prototype.gluTessEndPolygon=H.prototype.w,t.exports=this.libtess},function(t,e,i){"use strict";var s="undefined"!=typeof Uint8Array&&"undefined"!=typeof Uint16Array&&"undefined"!=typeof Int32Array;function n(t,e){return Object.prototype.hasOwnProperty.call(t,e)}e.assign=function(t){for(var e=Array.prototype.slice.call(arguments,1);e.length;){var i=e.shift();if(i){if("object"!=typeof i)throw new TypeError(i+"must be non-object");for(var s in i)n(i,s)&&(t[s]=i[s])}}return t},e.shrinkBuf=function(t,e){return t.length===e?t:t.subarray?t.subarray(0,e):(t.length=e,t)};var r={arraySet:function(t,e,i,s,n){if(e.subarray&&t.subarray)t.set(e.subarray(i,i+s),n);else for(var r=0;r<s;r++)t[n+r]=e[i+r]},flattenChunks:function(t){var e,i,s,n,r,o;for(s=0,e=0,i=t.length;e<i;e++)s+=t[e].length;for(o=new Uint8Array(s),n=0,e=0,i=t.length;e<i;e++)r=t[e],o.set(r,n),n+=r.length;return o}},o={arraySet:function(t,e,i,s,n){for(var r=0;r<s;r++)t[n+r]=e[i+r]},flattenChunks:function(t){return[].concat.apply([],t)}};e.setTyped=function(t){t?(e.Buf8=Uint8Array,e.Buf16=Uint16Array,e.Buf32=Int32Array,e.assign(e,r)):(e.Buf8=Array,e.Buf16=Array,e.Buf32=Array,e.assign(e,o))},e.setTyped(s)},function(t,e,i){"use strict";(function(t){var s=e;function n(t,e,i){for(var s=Object.keys(e),n=0;n<s.length;++n)void 0!==t[s[n]]&&i||(t[s[n]]=e[s[n]]);return t}function r(t){function e(t,i){if(!(this instanceof e))return new e(t,i);Object.defineProperty(this,"message",{get:function(){return t}}),Error.captureStackTrace?Error.captureStackTrace(this,e):Object.defineProperty(this,"stack",{value:(new Error).stack||""}),i&&n(this,i)}return(e.prototype=Object.create(Error.prototype)).constructor=e,Object.defineProperty(e.prototype,"name",{get:function(){return t}}),e.prototype.toString=function(){return this.name+": "+this.message},e}s.asPromise=i(19),s.base64=i(20),s.EventEmitter=i(21),s.float=i(22),s.inquire=i(23),s.utf8=i(24),s.pool=i(25),s.LongBits=i(26),s.global="undefined"!=typeof window&&window||void 0!==t&&t||"undefined"!=typeof self&&self||this,s.emptyArray=Object.freeze?Object.freeze([]):[],s.emptyObject=Object.freeze?Object.freeze({}):{},s.isNode=Boolean(s.global.process&&s.global.process.versions&&s.global.process.versions.node),s.isInteger=Number.isInteger||function(t){return"number"==typeof t&&isFinite(t)&&Math.floor(t)===t},s.isString=function(t){return"string"==typeof t||t instanceof String},s.isObject=function(t){return t&&"object"==typeof t},s.isset=s.isSet=function(t,e){var i=t[e];return!(null==i||!t.hasOwnProperty(e))&&("object"!=typeof i||(Array.isArray(i)?i.length:Object.keys(i).length)>0)},s.Buffer=function(){try{var t=s.inquire("buffer").Buffer;return t.prototype.utf8Write?t:null}catch(e){return null}}(),s._Buffer_from=null,s._Buffer_allocUnsafe=null,s.newBuffer=function(t){return"number"==typeof t?s.Buffer?s._Buffer_allocUnsafe(t):new s.Array(t):s.Buffer?s._Buffer_from(t):"undefined"==typeof Uint8Array?t:new Uint8Array(t)},s.Array="undefined"!=typeof Uint8Array?Uint8Array:Array,s.Long=s.global.dcodeIO&&s.global.dcodeIO.Long||s.global.Long||s.inquire("long"),s.key2Re=/^true|false|0|1$/,s.key32Re=/^-?(?:0|[1-9][0-9]*)$/,s.key64Re=/^(?:[\\\\x00-\\\\xff]{8}|-?(?:0|[1-9][0-9]*))$/,s.longToHash=function(t){return t?s.LongBits.from(t).toHash():s.LongBits.zeroHash},s.longFromHash=function(t,e){var i=s.LongBits.fromHash(t);return s.Long?s.Long.fromBits(i.lo,i.hi,e):i.toNumber(Boolean(e))},s.merge=n,s.lcFirst=function(t){return t.charAt(0).toLowerCase()+t.substring(1)},s.newError=r,s.ProtocolError=r("ProtocolError"),s.oneOfGetter=function(t){for(var e={},i=0;i<t.length;++i)e[t[i]]=1;return function(){for(var t=Object.keys(this),i=t.length-1;i>-1;--i)if(1===e[t[i]]&&void 0!==this[t[i]]&&null!==this[t[i]])return t[i]}},s.oneOfSetter=function(t){return function(e){for(var i=0;i<t.length;++i)t[i]!==e&&delete this[t[i]]}},s.toJSONOptions={longs:String,enums:String,bytes:String,json:!0},s._configure=function(){var t=s.Buffer;t?(s._Buffer_from=t.from!==Uint8Array.from&&t.from||function(e,i){return new t(e,i)},s._Buffer_allocUnsafe=t.allocUnsafe||function(e){return new t(e)}):s._Buffer_from=s._Buffer_allocUnsafe=null}}).call(this,i(18))},function(t,e,i){"use strict";var s,n,r,o,a,l,h,c,d,u,f,p,_,g,m=i(16),y=m.Reader,b=m.util,w=m.roots.default||(m.roots.default={});w.yandex=((g={}).maps=((_={}).proto=((p={}).renderer=((c={}).vmap2=((s={}).Tile=function(){function t(t){if(this.presentation=[],this.layers=[],this.indoorPlanId=[],t)for(var e=Object.keys(t),i=0;i<e.length;++i)null!=t[e[i]]&&(this[e[i]]=t[e[i]])}return t.prototype.presentation=b.emptyArray,t.prototype.points=null,t.prototype.polylines=null,t.prototype.polygons=null,t.prototype.pointLabels=null,t.prototype.polylineLabels=null,t.prototype.layers=b.emptyArray,t.prototype.indoorPlanId=b.emptyArray,t.decode=function(t,e){t instanceof y||(t=y.create(t));for(var i=void 0===e?t.len:t.pos+e,s=new w.yandex.maps.proto.renderer.vmap2.Tile;t.pos<i;){var n=t.uint32();switch(n>>>3){case 1:s.presentation&&s.presentation.length||(s.presentation=[]),s.presentation.push(w.yandex.maps.proto.renderer.vmap2.Presentation.decode(t,t.uint32()));break;case 2:s.points=w.yandex.maps.proto.renderer.vmap2.Tile.PointObjects.decode(t,t.uint32());break;case 3:s.polylines=w.yandex.maps.proto.renderer.vmap2.Tile.PolylineObjects.decode(t,t.uint32());break;case 4:s.polygons=w.yandex.maps.proto.renderer.vmap2.Tile.PolygonObjects.decode(t,t.uint32());break;case 5:s.pointLabels=w.yandex.maps.proto.renderer.vmap2.Tile.StraightLabels.decode(t,t.uint32());break;case 6:s.polylineLabels=w.yandex.maps.proto.renderer.vmap2.Tile.CurvedLabels.decode(t,t.uint32());break;case 8:s.layers&&s.layers.length||(s.layers=[]),s.layers.push(w.yandex.maps.proto.renderer.vmap2.Tile.Layer.decode(t,t.uint32()));break;case 9:s.indoorPlanId&&s.indoorPlanId.length||(s.indoorPlanId=[]),s.indoorPlanId.push(t.string());break;default:t.skipType(7&n)}}return s},t.PointObjects=function(){function t(t){if(this.coordsx=[],this.coordsy=[],this.classId=[],this.zOrder=[],this.metadata=[],t)for(var e=Object.keys(t),i=0;i<e.length;++i)null!=t[e[i]]&&(this[e[i]]=t[e[i]])}return t.prototype.coordsx=b.emptyArray,t.prototype.coordsy=b.emptyArray,t.prototype.classId=b.emptyArray,t.prototype.zOrder=b.emptyArray,t.prototype.metadata=b.emptyArray,t.decode=function(t,e){t instanceof y||(t=y.create(t));for(var i=void 0===e?t.len:t.pos+e,s=new w.yandex.maps.proto.renderer.vmap2.Tile.PointObjects;t.pos<i;){var n=t.uint32();switch(n>>>3){case 1:if(s.coordsx&&s.coordsx.length||(s.coordsx=[]),2==(7&n))for(var r=t.uint32()+t.pos;t.pos<r;)s.coordsx.push(t.sint32());else s.coordsx.push(t.sint32());break;case 2:if(s.coordsy&&s.coordsy.length||(s.coordsy=[]),2==(7&n))for(r=t.uint32()+t.pos;t.pos<r;)s.coordsy.push(t.sint32());else s.coordsy.push(t.sint32());break;case 3:if(s.classId&&s.classId.length||(s.classId=[]),2==(7&n))for(r=t.uint32()+t.pos;t.pos<r;)s.classId.push(t.uint32());else s.classId.push(t.uint32());break;case 4:if(s.zOrder&&s.zOrder.length||(s.zOrder=[]),2==(7&n))for(r=t.uint32()+t.pos;t.pos<r;)s.zOrder.push(t.sint32());else s.zOrder.push(t.sint32());break;case 5:s.metadata&&s.metadata.length||(s.metadata=[]),s.metadata.push(w.yandex.maps.proto.renderer.common.FeatureMetadata.decode(t,t.uint32()));break;default:t.skipType(7&n)}}return s},t}(),t.PolylineObjects=function(){function t(t){if(this.coordsx=[],this.coordsy=[],this.lineSize=[],this.distance=[],this.classId=[],this.pointVisibility=[],this.zOrderBegin=[],this.zOrderEnd=[],this.metadata=[],t)for(var e=Object.keys(t),i=0;i<e.length;++i)null!=t[e[i]]&&(this[e[i]]=t[e[i]])}return t.prototype.coordsx=b.emptyArray,t.prototype.coordsy=b.emptyArray,t.prototype.lineSize=b.emptyArray,t.prototype.distance=b.emptyArray,t.prototype.classId=b.emptyArray,t.prototype.pointVisibility=b.emptyArray,t.prototype.zOrderBegin=b.emptyArray,t.prototype.zOrderEnd=b.emptyArray,t.prototype.metadata=b.emptyArray,t.decode=function(t,e){t instanceof y||(t=y.create(t));for(var i=void 0===e?t.len:t.pos+e,s=new w.yandex.maps.proto.renderer.vmap2.Tile.PolylineObjects;t.pos<i;){var n=t.uint32();switch(n>>>3){case 1:if(s.coordsx&&s.coordsx.length||(s.coordsx=[]),2==(7&n))for(var r=t.uint32()+t.pos;t.pos<r;)s.coordsx.push(t.sint32());else s.coordsx.push(t.sint32());break;case 2:if(s.coordsy&&s.coordsy.length||(s.coordsy=[]),2==(7&n))for(r=t.uint32()+t.pos;t.pos<r;)s.coordsy.push(t.sint32());else s.coordsy.push(t.sint32());break;case 3:if(s.lineSize&&s.lineSize.length||(s.lineSize=[]),2==(7&n))for(r=t.uint32()+t.pos;t.pos<r;)s.lineSize.push(t.uint32());else s.lineSize.push(t.uint32());break;case 4:if(s.distance&&s.distance.length||(s.distance=[]),2==(7&n))for(r=t.uint32()+t.pos;t.pos<r;)s.distance.push(t.uint64());else s.distance.push(t.uint64());break;case 5:if(s.classId&&s.classId.length||(s.classId=[]),2==(7&n))for(r=t.uint32()+t.pos;t.pos<r;)s.classId.push(t.uint32());else s.classId.push(t.uint32());break;case 6:if(s.pointVisibility&&s.pointVisibility.length||(s.pointVisibility=[]),2==(7&n))for(r=t.uint32()+t.pos;t.pos<r;)s.pointVisibility.push(t.uint32());else s.pointVisibility.push(t.uint32());break;case 7:if(s.zOrderBegin&&s.zOrderBegin.length||(s.zOrderBegin=[]),2==(7&n))for(r=t.uint32()+t.pos;t.pos<r;)s.zOrderBegin.push(t.sint32());else s.zOrderBegin.push(t.sint32());break;case 8:if(s.zOrderEnd&&s.zOrderEnd.length||(s.zOrderEnd=[]),2==(7&n))for(r=t.uint32()+t.pos;t.pos<r;)s.zOrderEnd.push(t.sint32());else s.zOrderEnd.push(t.sint32());break;case 9:s.metadata&&s.metadata.length||(s.metadata=[]),s.metadata.push(w.yandex.maps.proto.renderer.common.FeatureMetadata.decode(t,t.uint32()));break;default:t.skipType(7&n)}}return s},t}(),t.PolygonObjects=function(){function t(t){if(this.coordsx=[],this.coordsy=[],this.classId=[],this.ringCount=[],this.ringSize=[],this.contourIndex=[],this.contourCount=[],this.pointVisibility=[],this.height=[],this.zOrder=[],this.mesh=[],this.metadata=[],t)for(var e=Object.keys(t),i=0;i<e.length;++i)null!=t[e[i]]&&(this[e[i]]=t[e[i]])}return t.prototype.coordsx=b.emptyArray,t.prototype.coordsy=b.emptyArray,t.prototype.classId=b.emptyArray,t.prototype.ringCount=b.emptyArray,t.prototype.ringSize=b.emptyArray,t.prototype.contourIndex=b.emptyArray,t.prototype.contourCount=b.emptyArray,t.prototype.pointVisibility=b.emptyArray,t.prototype.height=b.emptyArray,t.prototype.zOrder=b.emptyArray,t.prototype.mesh=b.emptyArray,t.prototype.metadata=b.emptyArray,t.decode=function(t,e){t instanceof y||(t=y.create(t));for(var i=void 0===e?t.len:t.pos+e,s=new w.yandex.maps.proto.renderer.vmap2.Tile.PolygonObjects;t.pos<i;){var n=t.uint32();switch(n>>>3){case 1:if(s.coordsx&&s.coordsx.length||(s.coordsx=[]),2==(7&n))for(var r=t.uint32()+t.pos;t.pos<r;)s.coordsx.push(t.sint32());else s.coordsx.push(t.sint32());break;case 2:if(s.coordsy&&s.coordsy.length||(s.coordsy=[]),2==(7&n))for(r=t.uint32()+t.pos;t.pos<r;)s.coordsy.push(t.sint32());else s.coordsy.push(t.sint32());break;case 3:if(s.classId&&s.classId.length||(s.classId=[]),2==(7&n))for(r=t.uint32()+t.pos;t.pos<r;)s.classId.push(t.uint32());else s.classId.push(t.uint32());break;case 4:if(s.ringCount&&s.ringCount.length||(s.ringCount=[]),2==(7&n))for(r=t.uint32()+t.pos;t.pos<r;)s.ringCount.push(t.uint32());else s.ringCount.push(t.uint32());break;case 5:if(s.ringSize&&s.ringSize.length||(s.ringSize=[]),2==(7&n))for(r=t.uint32()+t.pos;t.pos<r;)s.ringSize.push(t.uint32());else s.ringSize.push(t.uint32());break;case 6:if(s.contourIndex&&s.contourIndex.length||(s.contourIndex=[]),2==(7&n))for(r=t.uint32()+t.pos;t.pos<r;)s.contourIndex.push(t.sint32());else s.contourIndex.push(t.sint32());break;case 7:if(s.contourCount&&s.contourCount.length||(s.contourCount=[]),2==(7&n))for(r=t.uint32()+t.pos;t.pos<r;)s.contourCount.push(t.sint32());else s.contourCount.push(t.sint32());break;case 8:if(s.pointVisibility&&s.pointVisibility.length||(s.pointVisibility=[]),2==(7&n))for(r=t.uint32()+t.pos;t.pos<r;)s.pointVisibility.push(t.uint32());else s.pointVisibility.push(t.uint32());break;case 9:if(s.height&&s.height.length||(s.height=[]),2==(7&n))for(r=t.uint32()+t.pos;t.pos<r;)s.height.push(t.sint32());else s.height.push(t.sint32());break;case 10:if(s.zOrder&&s.zOrder.length||(s.zOrder=[]),2==(7&n))for(r=t.uint32()+t.pos;t.pos<r;)s.zOrder.push(t.sint32());else s.zOrder.push(t.sint32());break;case 11:s.mesh&&s.mesh.length||(s.mesh=[]),s.mesh.push(w.yandex.maps.proto.renderer.vmap2.Tile.PolygonObjects.Mesh.decode(t,t.uint32()));break;case 12:s.metadata&&s.metadata.length||(s.metadata=[]),s.metadata.push(w.yandex.maps.proto.renderer.common.FeatureMetadata.decode(t,t.uint32()));break;default:t.skipType(7&n)}}return s},t.BBox=function(){function t(t){if(t)for(var e=Object.keys(t),i=0;i<e.length;++i)null!=t[e[i]]&&(this[e[i]]=t[e[i]])}return t.prototype.minX=0,t.prototype.minY=0,t.prototype.maxX=0,t.prototype.maxY=0,t.decode=function(t,e){t instanceof y||(t=y.create(t));for(var i=void 0===e?t.len:t.pos+e,s=new w.yandex.maps.proto.renderer.vmap2.Tile.PolygonObjects.BBox;t.pos<i;){var n=t.uint32();switch(n>>>3){case 1:s.minX=t.sint32();break;case 2:s.minY=t.sint32();break;case 3:s.maxX=t.sint32();break;case 4:s.maxY=t.sint32();break;default:t.skipType(7&n)}}return s},t}(),t.Mesh=function(){function t(t){if(t)for(var e=Object.keys(t),i=0;i<e.length;++i)null!=t[e[i]]&&(this[e[i]]=t[e[i]])}return t.prototype.polygonId=0,t.prototype.meshId="",t.prototype.bbox=null,t.prototype.objectId="",t.decode=function(t,e){t instanceof y||(t=y.create(t));for(var i=void 0===e?t.len:t.pos+e,s=new w.yandex.maps.proto.renderer.vmap2.Tile.PolygonObjects.Mesh;t.pos<i;){var n=t.uint32();switch(n>>>3){case 1:s.polygonId=t.uint32();break;case 2:s.meshId=t.string();break;case 3:s.bbox=w.yandex.maps.proto.renderer.vmap2.Tile.PolygonObjects.BBox.decode(t,t.uint32());break;case 4:s.objectId=t.string();break;default:t.skipType(7&n)}}return s},t}(),t}(),t.ShapedString=function(){function t(t){if(this.glyphs=[],t)for(var e=Object.keys(t),i=0;i<e.length;++i)null!=t[e[i]]&&(this[e[i]]=t[e[i]])}return t.prototype.glyphs=b.emptyArray,t.decode=function(t,e){t instanceof y||(t=y.create(t));for(var i=void 0===e?t.len:t.pos+e,s=new w.yandex.maps.proto.renderer.vmap2.Tile.ShapedString;t.pos<i;){var n=t.uint32();switch(n>>>3){case 1:if(s.glyphs&&s.glyphs.length||(s.glyphs=[]),2==(7&n))for(var r=t.uint32()+t.pos;t.pos<r;)s.glyphs.push(t.uint32());else s.glyphs.push(t.uint32());break;default:t.skipType(7&n)}}return s},t}(),t.ShapedText=function(){function t(t){if(this.strings=[],t)for(var e=Object.keys(t),i=0;i<e.length;++i)null!=t[e[i]]&&(this[e[i]]=t[e[i]])}return t.prototype.strings=b.emptyArray,t.decode=function(t,e){t instanceof y||(t=y.create(t));for(var i=void 0===e?t.len:t.pos+e,s=new w.yandex.maps.proto.renderer.vmap2.Tile.ShapedText;t.pos<i;){var n=t.uint32();switch(n>>>3){case 1:s.strings&&s.strings.length||(s.strings=[]),s.strings.push(w.yandex.maps.proto.renderer.vmap2.Tile.ShapedString.decode(t,t.uint32()));break;default:t.skipType(7&n)}}return s},t}(),t.StraightLabels=function(){function t(t){if(this.classId=[],this.centerX=[],this.centerY=[],this.offsetX=[],this.offsetY=[],this.text=[],this.textAlt=[],this.priority=[],this.align=[],this.metadata=[],t)for(var e=Object.keys(t),i=0;i<e.length;++i)null!=t[e[i]]&&(this[e[i]]=t[e[i]])}var e,i;return t.prototype.classId=b.emptyArray,t.prototype.centerX=b.emptyArray,t.prototype.centerY=b.emptyArray,t.prototype.offsetX=b.emptyArray,t.prototype.offsetY=b.emptyArray,t.prototype.text=b.emptyArray,t.prototype.textAlt=b.emptyArray,t.prototype.priority=b.emptyArray,t.prototype.align=b.emptyArray,t.prototype.metadata=b.emptyArray,t.decode=function(t,e){t instanceof y||(t=y.create(t));for(var i=void 0===e?t.len:t.pos+e,s=new w.yandex.maps.proto.renderer.vmap2.Tile.StraightLabels;t.pos<i;){var n=t.uint32();switch(n>>>3){case 1:if(s.classId&&s.classId.length||(s.classId=[]),2==(7&n))for(var r=t.uint32()+t.pos;t.pos<r;)s.classId.push(t.uint32());else s.classId.push(t.uint32());break;case 2:if(s.centerX&&s.centerX.length||(s.centerX=[]),2==(7&n))for(r=t.uint32()+t.pos;t.pos<r;)s.centerX.push(t.sint32());else s.centerX.push(t.sint32());break;case 3:if(s.centerY&&s.centerY.length||(s.centerY=[]),2==(7&n))for(r=t.uint32()+t.pos;t.pos<r;)s.centerY.push(t.sint32());else s.centerY.push(t.sint32());break;case 4:if(s.offsetX&&s.offsetX.length||(s.offsetX=[]),2==(7&n))for(r=t.uint32()+t.pos;t.pos<r;)s.offsetX.push(t.sint32());else s.offsetX.push(t.sint32());break;case 5:if(s.offsetY&&s.offsetY.length||(s.offsetY=[]),2==(7&n))for(r=t.uint32()+t.pos;t.pos<r;)s.offsetY.push(t.sint32());else s.offsetY.push(t.sint32());break;case 6:s.text&&s.text.length||(s.text=[]),s.text.push(w.yandex.maps.proto.renderer.vmap2.Tile.ShapedText.decode(t,t.uint32()));break;case 7:s.textAlt&&s.textAlt.length||(s.textAlt=[]),s.textAlt.push(w.yandex.maps.proto.renderer.vmap2.Tile.ShapedText.decode(t,t.uint32()));break;case 8:if(s.priority&&s.priority.length||(s.priority=[]),2==(7&n))for(r=t.uint32()+t.pos;t.pos<r;)s.priority.push(t.sint32());else s.priority.push(t.sint32());break;case 9:if(s.align&&s.align.length||(s.align=[]),2==(7&n))for(r=t.uint32()+t.pos;t.pos<r;)s.align.push(t.int32());else s.align.push(t.int32());break;case 10:s.metadata&&s.metadata.length||(s.metadata=[]),s.metadata.push(w.yandex.maps.proto.renderer.common.FeatureMetadata.decode(t,t.uint32()));break;default:t.skipType(7&n)}}return s},t.AlignType=(e={},(i=Object.create(e))[e[0]="Left"]=0,i[e[1]="Center"]=1,i[e[2]="Right"]=2,i),t}(),t.CurvedLabels=function(){function t(t){if(this.classId=[],this.text=[],this.textAlt=[],this.priority=[],this.verticesCount=[],this.vertexX=[],this.vertexY=[],this.metadata=[],t)for(var e=Object.keys(t),i=0;i<e.length;++i)null!=t[e[i]]&&(this[e[i]]=t[e[i]])}return t.prototype.classId=b.emptyArray,t.prototype.text=b.emptyArray,t.prototype.textAlt=b.emptyArray,t.prototype.priority=b.emptyArray,t.prototype.verticesCount=b.emptyArray,t.prototype.vertexX=b.emptyArray,t.prototype.vertexY=b.emptyArray,t.prototype.metadata=b.emptyArray,t.decode=function(t,e){t instanceof y||(t=y.create(t));for(var i=void 0===e?t.len:t.pos+e,s=new w.yandex.maps.proto.renderer.vmap2.Tile.CurvedLabels;t.pos<i;){var n=t.uint32();switch(n>>>3){case 1:if(s.classId&&s.classId.length||(s.classId=[]),2==(7&n))for(var r=t.uint32()+t.pos;t.pos<r;)s.classId.push(t.uint32());else s.classId.push(t.uint32());break;case 2:s.text&&s.text.length||(s.text=[]),s.text.push(w.yandex.maps.proto.renderer.vmap2.Tile.ShapedString.decode(t,t.uint32()));break;case 3:s.textAlt&&s.textAlt.length||(s.textAlt=[]),s.textAlt.push(w.yandex.maps.proto.renderer.vmap2.Tile.ShapedString.decode(t,t.uint32()));break;case 4:if(s.priority&&s.priority.length||(s.priority=[]),2==(7&n))for(r=t.uint32()+t.pos;t.pos<r;)s.priority.push(t.sint32());else s.priority.push(t.sint32());break;case 5:if(s.verticesCount&&s.verticesCount.length||(s.verticesCount=[]),2==(7&n))for(r=t.uint32()+t.pos;t.pos<r;)s.verticesCount.push(t.uint32());else s.verticesCount.push(t.uint32());break;case 6:if(s.vertexX&&s.vertexX.length||(s.vertexX=[]),2==(7&n))for(r=t.uint32()+t.pos;t.pos<r;)s.vertexX.push(t.sint32());else s.vertexX.push(t.sint32());break;case 7:if(s.vertexY&&s.vertexY.length||(s.vertexY=[]),2==(7&n))for(r=t.uint32()+t.pos;t.pos<r;)s.vertexY.push(t.sint32());else s.vertexY.push(t.sint32());break;case 8:s.metadata&&s.metadata.length||(s.metadata=[]),s.metadata.push(w.yandex.maps.proto.renderer.common.FeatureMetadata.decode(t,t.uint32()));break;default:t.skipType(7&n)}}return s},t}(),t.Layer=function(){function t(t){if(this.ids=[],this.objectIndices=[],this.keys=[],this.values=[],t)for(var e=Object.keys(t),i=0;i<e.length;++i)null!=t[e[i]]&&(this[e[i]]=t[e[i]])}return t.prototype.name="",t.prototype.ids=b.emptyArray,t.prototype.objectIndices=b.emptyArray,t.prototype.keys=b.emptyArray,t.prototype.values=b.emptyArray,t.decode=function(t,e){t instanceof y||(t=y.create(t));for(var i=void 0===e?t.len:t.pos+e,s=new w.yandex.maps.proto.renderer.vmap2.Tile.Layer;t.pos<i;){var n=t.uint32();switch(n>>>3){case 1:s.name=t.string();break;case 2:s.ids&&s.ids.length||(s.ids=[]),s.ids.push(t.string());break;case 3:if(s.objectIndices&&s.objectIndices.length||(s.objectIndices=[]),2==(7&n))for(var r=t.uint32()+t.pos;t.pos<r;)s.objectIndices.push(t.uint32());else s.objectIndices.push(t.uint32());break;case 4:s.keys&&s.keys.length||(s.keys=[]),s.keys.push(t.string());break;case 5:s.values&&s.values.length||(s.values=[]),s.values.push(t.string());break;default:t.skipType(7&n)}}return s},t}(),t}(),s.Presentation=function(){function t(t){if(this.classes=[],t)for(var e=Object.keys(t),i=0;i<e.length;++i)null!=t[e[i]]&&(this[e[i]]=t[e[i]])}return t.prototype.classes=b.emptyArray,t.prototype.name="",t.prototype.params=null,t.decode=function(t,e){t instanceof y||(t=y.create(t));for(var i=void 0===e?t.len:t.pos+e,s=new w.yandex.maps.proto.renderer.vmap2.Presentation;t.pos<i;){var n=t.uint32();switch(n>>>3){case 1:s.classes&&s.classes.length||(s.classes=[]),s.classes.push(w.yandex.maps.proto.renderer.vmap2.Presentation.Class.decode(t,t.uint32()));break;case 2:s.name=t.string();break;case 3:s.params=w.yandex.maps.proto.renderer.vmap2.Presentation.Parameters.decode(t,t.uint32());break;default:t.skipType(7&n)}}return s},t.Class=function(){function t(t){if(this.slices=[],t)for(var e=Object.keys(t),i=0;i<e.length;++i)null!=t[e[i]]&&(this[e[i]]=t[e[i]])}return t.prototype.id=0,t.prototype.name="",t.prototype.slices=b.emptyArray,t.decode=function(t,e){t instanceof y||(t=y.create(t));for(var i=void 0===e?t.len:t.pos+e,s=new w.yandex.maps.proto.renderer.vmap2.Presentation.Class;t.pos<i;){var n=t.uint32();switch(n>>>3){case 1:s.id=t.uint32();break;case 2:s.name=t.string();break;case 3:s.slices&&s.slices.length||(s.slices=[]),s.slices.push(w.yandex.maps.proto.renderer.vmap2.Presentation.Class.ZoomSlice.decode(t,t.uint32()));break;default:t.skipType(7&n)}}return s},t.ZoomRange=function(){function t(t){if(t)for(var e=Object.keys(t),i=0;i<e.length;++i)null!=t[e[i]]&&(this[e[i]]=t[e[i]])}return t.prototype.min=0,t.prototype.max=0,t.decode=function(t,e){t instanceof y||(t=y.create(t));for(var i=void 0===e?t.len:t.pos+e,s=new w.yandex.maps.proto.renderer.vmap2.Presentation.Class.ZoomRange;t.pos<i;){var n=t.uint32();switch(n>>>3){case 1:s.min=t.sint32();break;case 2:s.max=t.sint32();break;default:t.skipType(7&n)}}return s},t}(),t.Image=function(){function t(t){if(t)for(var e=Object.keys(t),i=0;i<e.length;++i)null!=t[e[i]]&&(this[e[i]]=t[e[i]])}return t.prototype.id="",t.prototype.width=0,t.prototype.scale=0,t.decode=function(t,e){t instanceof y||(t=y.create(t));for(var i=void 0===e?t.len:t.pos+e,s=new w.yandex.maps.proto.renderer.vmap2.Presentation.Class.Image;t.pos<i;){var n=t.uint32();switch(n>>>3){case 1:s.id=t.string();break;case 2:s.width=t.float();break;case 3:s.scale=t.float();break;default:t.skipType(7&n)}}return s},t}(),t.PointStyle=function(){function t(t){if(t)for(var e=Object.keys(t),i=0;i<e.length;++i)null!=t[e[i]]&&(this[e[i]]=t[e[i]])}return t.prototype.icon=null,t.prototype.anchorX=0,t.prototype.anchorY=0,t.prototype.selectedIcon=null,t.prototype.selectedAnchorX=0,t.prototype.selectedAnchorY=0,t.decode=function(t,e){t instanceof y||(t=y.create(t));for(var i=void 0===e?t.len:t.pos+e,s=new w.yandex.maps.proto.renderer.vmap2.Presentation.Class.PointStyle;t.pos<i;){var n=t.uint32();switch(n>>>3){case 1:s.icon=w.yandex.maps.proto.renderer.vmap2.Presentation.Class.Image.decode(t,t.uint32());break;case 2:s.anchorX=t.float();break;case 3:s.anchorY=t.float();break;case 4:s.selectedIcon=w.yandex.maps.proto.renderer.vmap2.Presentation.Class.Image.decode(t,t.uint32());break;case 5:s.selectedAnchorX=t.float();break;case 6:s.selectedAnchorY=t.float();break;default:t.skipType(7&n)}}return s},t}(),t.DashItem=function(){function t(t){if(t)for(var e=Object.keys(t),i=0;i<e.length;++i)null!=t[e[i]]&&(this[e[i]]=t[e[i]])}return t.prototype.fill=0,t.prototype.gap=0,t.decode=function(t,e){t instanceof y||(t=y.create(t));for(var i=void 0===e?t.len:t.pos+e,s=new w.yandex.maps.proto.renderer.vmap2.Presentation.Class.DashItem;t.pos<i;){var n=t.uint32();switch(n>>>3){case 1:s.fill=t.float();break;case 2:s.gap=t.float();break;default:t.skipType(7&n)}}return s},t}(),t.DashStyle=function(){function t(t){if(this.dashes=[],t)for(var e=Object.keys(t),i=0;i<e.length;++i)null!=t[e[i]]&&(this[e[i]]=t[e[i]])}return t.prototype.dashes=b.emptyArray,t.decode=function(t,e){t instanceof y||(t=y.create(t));for(var i=void 0===e?t.len:t.pos+e,s=new w.yandex.maps.proto.renderer.vmap2.Presentation.Class.DashStyle;t.pos<i;){var n=t.uint32();switch(n>>>3){case 1:s.dashes&&s.dashes.length||(s.dashes=[]),s.dashes.push(w.yandex.maps.proto.renderer.vmap2.Presentation.Class.DashItem.decode(t,t.uint32()));break;default:t.skipType(7&n)}}return s},t}(),t.LineStyle=function(){function t(t){if(t)for(var e=Object.keys(t),i=0;i<e.length;++i)null!=t[e[i]]&&(this[e[i]]=t[e[i]])}var e,i;return t.prototype.color=0,t.prototype.width=0,t.prototype.caps=0,t.prototype.joins=1,t.prototype.dash=null,t.prototype.pattern=null,t.decode=function(t,e){t instanceof y||(t=y.create(t));for(var i=void 0===e?t.len:t.pos+e,s=new w.yandex.maps.proto.renderer.vmap2.Presentation.Class.LineStyle;t.pos<i;){var n=t.uint32();switch(n>>>3){case 1:s.color=t.fixed32();break;case 2:s.width=t.float();break;case 3:s.caps=t.int32();break;case 4:s.joins=t.int32();break;case 5:s.dash=w.yandex.maps.proto.renderer.vmap2.Presentation.Class.DashStyle.decode(t,t.uint32());break;case 6:s.pattern=w.yandex.maps.proto.renderer.vmap2.Presentation.Class.Image.decode(t,t.uint32());break;default:t.skipType(7&n)}}return s},t.CapStyle=(e={},(i=Object.create(e))[e[0]="CapRound"]=0,i[e[1]="CapButt"]=1,i[e[2]="CapSquare"]=2,i),t.JoinStyle=function(){var t={},e=Object.create(t);return e[t[0]="JoinMiter"]=0,e[t[1]="JoinRound"]=1,e[t[2]="JoinBevel"]=2,e}(),t}(),t.PolylineStyle=function(){function t(t){if(t)for(var e=Object.keys(t),i=0;i<e.length;++i)null!=t[e[i]]&&(this[e[i]]=t[e[i]])}return t.prototype.line=null,t.prototype.outline=null,t.prototype.equidistantOffset=0,t.decode=function(t,e){t instanceof y||(t=y.create(t));for(var i=void 0===e?t.len:t.pos+e,s=new w.yandex.maps.proto.renderer.vmap2.Presentation.Class.PolylineStyle;t.pos<i;){var n=t.uint32();switch(n>>>3){case 1:s.line=w.yandex.maps.proto.renderer.vmap2.Presentation.Class.LineStyle.decode(t,t.uint32());break;case 2:s.outline=w.yandex.maps.proto.renderer.vmap2.Presentation.Class.LineStyle.decode(t,t.uint32());break;case 3:s.equidistantOffset=t.float();break;default:t.skipType(7&n)}}return s},t}(),t.PolygonStyle=function(){function t(t){if(t)for(var e=Object.keys(t),i=0;i<e.length;++i)null!=t[e[i]]&&(this[e[i]]=t[e[i]])}return t.prototype.pattern=null,t.prototype.color=0,t.prototype.extrusion=null,t.prototype.contour=null,t.decode=function(t,e){t instanceof y||(t=y.create(t));for(var i=void 0===e?t.len:t.pos+e,s=new w.yandex.maps.proto.renderer.vmap2.Presentation.Class.PolygonStyle;t.pos<i;){var n=t.uint32();switch(n>>>3){case 1:s.pattern=w.yandex.maps.proto.renderer.vmap2.Presentation.Class.Image.decode(t,t.uint32());break;case 2:s.color=t.fixed32();break;case 3:s.extrusion=w.yandex.maps.proto.renderer.vmap2.Presentation.Class.PolygonStyle.Extrusion.decode(t,t.uint32());break;case 4:s.contour=w.yandex.maps.proto.renderer.vmap2.Presentation.Class.LineStyle.decode(t,t.uint32());break;default:t.skipType(7&n)}}return s},t.Extrusion=function(){function t(t){if(t)for(var e=Object.keys(t),i=0;i<e.length;++i)null!=t[e[i]]&&(this[e[i]]=t[e[i]])}return t.prototype.enabled=!1,t.prototype.height=0,t.decode=function(t,e){t instanceof y||(t=y.create(t));for(var i=void 0===e?t.len:t.pos+e,s=new w.yandex.maps.proto.renderer.vmap2.Presentation.Class.PolygonStyle.Extrusion;t.pos<i;){var n=t.uint32();switch(n>>>3){case 1:s.enabled=t.bool();break;case 3:s.height=t.float();break;default:t.skipType(7&n)}}return s},t}(),t}(),t.TextStyle=function(){function t(t){if(t)for(var e=Object.keys(t),i=0;i<e.length;++i)null!=t[e[i]]&&(this[e[i]]=t[e[i]])}return t.prototype.color=0,t.prototype.fontId="",t.prototype.fontSize=0,t.prototype.outlineColor=0,t.decode=function(t,e){t instanceof y||(t=y.create(t));for(var i=void 0===e?t.len:t.pos+e,s=new w.yandex.maps.proto.renderer.vmap2.Presentation.Class.TextStyle;t.pos<i;){var n=t.uint32();switch(n>>>3){case 1:s.color=t.fixed32();break;case 2:s.fontId=t.string();break;case 3:s.fontSize=t.float();break;case 4:s.outlineColor=t.fixed32();break;default:t.skipType(7&n)}}return s},t}(),t.LabelStyle=function(){function t(t){if(t)for(var e=Object.keys(t),i=0;i<e.length;++i)null!=t[e[i]]&&(this[e[i]]=t[e[i]])}return t.prototype.text=null,t.prototype.textAlt=null,t.prototype.hdistance=0,t.prototype.vdistance=0,t.prototype.background=null,t.decode=function(t,e){t instanceof y||(t=y.create(t));for(var i=void 0===e?t.len:t.pos+e,s=new w.yandex.maps.proto.renderer.vmap2.Presentation.Class.LabelStyle;t.pos<i;){var n=t.uint32();switch(n>>>3){case 1:s.text=w.yandex.maps.proto.renderer.vmap2.Presentation.Class.TextStyle.decode(t,t.uint32());break;case 2:s.textAlt=w.yandex.maps.proto.renderer.vmap2.Presentation.Class.TextStyle.decode(t,t.uint32());break;case 3:s.hdistance=t.float();break;case 4:s.vdistance=t.float();break;case 5:s.background=w.yandex.maps.proto.renderer.vmap2.Presentation.Class.LabelBackgroundStyle.decode(t,t.uint32());break;default:t.skipType(7&n)}}return s},t}(),t.LabelBackgroundStyle=function(){function t(t){if(t)for(var e=Object.keys(t),i=0;i<e.length;++i)null!=t[e[i]]&&(this[e[i]]=t[e[i]])}return t.prototype.hPadding=0,t.prototype.vPadding=0,t.prototype.color=0,t.prototype.outline=null,t.decode=function(t,e){t instanceof y||(t=y.create(t));for(var i=void 0===e?t.len:t.pos+e,s=new w.yandex.maps.proto.renderer.vmap2.Presentation.Class.LabelBackgroundStyle;t.pos<i;){var n=t.uint32();switch(n>>>3){case 1:s.hPadding=t.float();break;case 2:s.vPadding=t.float();break;case 3:s.color=t.fixed32();break;case 4:s.outline=w.yandex.maps.proto.renderer.vmap2.Presentation.Class.LineStyle.decode(t,t.uint32());break;default:t.skipType(7&n)}}return s},t}(),t.ZoomSlice=function(){function t(t){if(t)for(var e=Object.keys(t),i=0;i<e.length;++i)null!=t[e[i]]&&(this[e[i]]=t[e[i]])}return t.prototype.zIndex=0,t.prototype.visibility=null,t.prototype.line=null,t.prototype.poly=null,t.prototype.point=null,t.prototype.label=null,t.decode=function(t,e){t instanceof y||(t=y.create(t));for(var i=void 0===e?t.len:t.pos+e,s=new w.yandex.maps.proto.renderer.vmap2.Presentation.Class.ZoomSlice;t.pos<i;){var n=t.uint32();switch(n>>>3){case 1:s.zIndex=t.sint32();break;case 2:s.visibility=w.yandex.maps.proto.renderer.vmap2.Presentation.Class.ZoomRange.decode(t,t.uint32());break;case 3:s.line=w.yandex.maps.proto.renderer.vmap2.Presentation.Class.PolylineStyle.decode(t,t.uint32());break;case 4:s.poly=w.yandex.maps.proto.renderer.vmap2.Presentation.Class.PolygonStyle.decode(t,t.uint32());break;case 5:s.point=w.yandex.maps.proto.renderer.vmap2.Presentation.Class.PointStyle.decode(t,t.uint32());break;case 6:s.label=w.yandex.maps.proto.renderer.vmap2.Presentation.Class.LabelStyle.decode(t,t.uint32());break;default:t.skipType(7&n)}}return s},t}(),t}(),t.Parameters=function(){function t(t){if(t)for(var e=Object.keys(t),i=0;i<e.length;++i)null!=t[e[i]]&&(this[e[i]]=t[e[i]])}return t.prototype.extrusion=null,t.decode=function(t,e){t instanceof y||(t=y.create(t));for(var i=void 0===e?t.len:t.pos+e,s=new w.yandex.maps.proto.renderer.vmap2.Presentation.Parameters;t.pos<i;){var n=t.uint32();switch(n>>>3){case 1:s.extrusion=w.yandex.maps.proto.renderer.vmap2.Presentation.Parameters.Extrusion.decode(t,t.uint32());break;default:t.skipType(7&n)}}return s},t.Extrusion=function(){function t(t){if(t)for(var e=Object.keys(t),i=0;i<e.length;++i)null!=t[e[i]]&&(this[e[i]]=t[e[i]])}return t.prototype.adjustMeshHeightK=0,t.prototype.adjustMeshHeightPow=0,t.prototype.adjustBoxHeightK=0,t.prototype.adjustBoxHeightPow=0,t.decode=function(t,e){t instanceof y||(t=y.create(t));for(var i=void 0===e?t.len:t.pos+e,s=new w.yandex.maps.proto.renderer.vmap2.Presentation.Parameters.Extrusion;t.pos<i;){var n=t.uint32();switch(n>>>3){case 1:s.adjustMeshHeightK=t.float();break;case 2:s.adjustMeshHeightPow=t.float();break;case 3:s.adjustBoxHeightK=t.float();break;case 4:s.adjustBoxHeightPow=t.float();break;default:t.skipType(7&n)}}return s},t}(),t}(),t}(),s),c.common=((n={}).FeatureMetadata=function(){function t(t){if(t)for(var e=Object.keys(t),i=0;i<e.length;++i)null!=t[e[i]]&&(this[e[i]]=t[e[i]])}return t.prototype[".yandex.maps.proto.renderer.common.TAG_METADATA_DEPRECATED"]=null,t.prototype[".yandex.maps.proto.renderer.common.TAG_METADATA"]=null,t.decode=function(t,e){t instanceof y||(t=y.create(t));for(var i=void 0===e?t.len:t.pos+e,s=new w.yandex.maps.proto.renderer.common.FeatureMetadata;t.pos<i;){var n=t.uint32();switch(n>>>3){case 10:s[".yandex.maps.proto.renderer.common.TAG_METADATA_DEPRECATED"]=w.yandex.maps.proto.renderer.common.TagMetadata.decode(t,t.uint32());break;case 12:s[".yandex.maps.proto.renderer.common.TAG_METADATA"]=w.yandex.maps.proto.renderer.common.TagMetadata.decode(t,t.uint32());break;default:t.skipType(7&n)}}return s},t}(),n.TagMetadata=function(){function t(t){if(this.tags=[],t)for(var e=Object.keys(t),i=0;i<e.length;++i)null!=t[e[i]]&&(this[e[i]]=t[e[i]])}return t.prototype.tags=b.emptyArray,t.decode=function(t,e){t instanceof y||(t=y.create(t));for(var i=void 0===e?t.len:t.pos+e,s=new w.yandex.maps.proto.renderer.common.TagMetadata;t.pos<i;){var n=t.uint32();switch(n>>>3){case 10:if(s.tags&&s.tags.length||(s.tags=[]),2==(7&n))for(var r=t.uint32()+t.pos;t.pos<r;)s.tags.push(t.uint32());else s.tags.push(t.uint32());break;default:t.skipType(7&n)}}return s},t}(),n),c.layers=((l={}).basemap=((a={}).Tag=(r={},(o=Object.create(r))[r[0]="ROAD"]=0,o[r[1]="ROAD_1"]=1,o[r[2]="ROAD_2"]=2,o[r[3]="ROAD_3"]=3,o[r[4]="ROAD_4"]=4,o[r[5]="ROAD_5"]=5,o[r[6]="ROAD_6"]=6,o[r[7]="ROAD_7"]=7,o[r[8]="ROAD_LIMITED"]=8,o[r[9]="ROAD_UNCLASSIFIED"]=9,o[r[10]="ROAD_MINOR"]=10,o[r[11]="ROAD_CONSTRUCTION"]=11,o[r[12]="PATH"]=12,o[r[13]="CROSSWALK"]=13,o[r[34]="IS_TUNNEL"]=34,o[r[33]="TRAFFIC_LIGHT"]=33,o[r[14]="WATER"]=14,o[r[15]="LANDSCAPE"]=15,o[r[42]="NATIONAL_PARK"]=42,o[r[35]="LAND"]=35,o[r[16]="LANDCOVER"]=16,o[r[17]="VEGETATION"]=17,o[r[18]="URBAN_AREA"]=18,o[r[19]="RESIDENTIAL"]=19,o[r[43]="INDUSTRIAL"]=43,o[r[44]="CEMETERY"]=44,o[r[21]="PARK"]=21,o[r[45]="SPORTS_GROUND"]=45,o[r[46]="CONSTRUCTION_SITE"]=46,o[r[47]="MEDICAL"]=47,o[r[48]="BEACH"]=48,o[r[20]="POI"]=20,o[r[22]="ADMIN"]=22,o[r[23]="COUNTRY"]=23,o[r[24]="REGION"]=24,o[r[25]="LOCALITY"]=25,o[r[26]="DISTRICT"]=26,o[r[27]="ADDRESS"]=27,o[r[28]="TRANSPORT"]=28,o.TRANSIT=28,o[r[36]="TRANSIT_LOCATION"]=36,o[r[37]="TRANSIT_STOP"]=37,o[r[38]="TRANSIT_ENTRANCE"]=38,o[r[39]="IS_UNCLASSIFIED_TRANSIT"]=39,o[r[40]="TRANSIT_LINE"]=40,o[r[41]="TRANSIT_SCHEMA"]=41,o[r[29]="STRUCTURE"]=29,o[r[30]="BUILDING"]=30,o[r[31]="ENTRANCE"]=31,o[r[32]="FENCE"]=32,o[r[49]="MAJOR_LANDMARK"]=49,o[r[50]="OUTDOOR"]=50,o[r[51]="SHOPPING"]=51,o[r[52]="COMMERCIAL_SERVICES"]=52,o[r[53]="FOOD_AND_DRINK"]=53,o),a),l),c.glyphs=((h={}).Glyph=function(){function t(t){if(t)for(var e=Object.keys(t),i=0;i<e.length;++i)null!=t[e[i]]&&(this[e[i]]=t[e[i]])}return t.prototype.id=0,t.prototype.bitmap=b.newBuffer([]),t.prototype.width=0,t.prototype.height=0,t.prototype.bearingX=0,t.prototype.bearingY=0,t.prototype.advance=0,t.decode=function(t,e){t instanceof y||(t=y.create(t));for(var i=void 0===e?t.len:t.pos+e,s=new w.yandex.maps.proto.renderer.glyphs.Glyph;t.pos<i;){var n=t.uint32();switch(n>>>3){case 1:s.id=t.uint32();break;case 2:s.bitmap=t.bytes();break;case 3:s.width=t.uint32();break;case 4:s.height=t.uint32();break;case 5:s.bearingX=t.sint32();break;case 6:s.bearingY=t.sint32();break;case 7:s.advance=t.uint32();break;default:t.skipType(7&n)}}if(!s.hasOwnProperty("id"))throw b.ProtocolError("missing required \'id\'",{instance:s});if(!s.hasOwnProperty("bitmap"))throw b.ProtocolError("missing required \'bitmap\'",{instance:s});if(!s.hasOwnProperty("width"))throw b.ProtocolError("missing required \'width\'",{instance:s});if(!s.hasOwnProperty("height"))throw b.ProtocolError("missing required \'height\'",{instance:s});if(!s.hasOwnProperty("bearingX"))throw b.ProtocolError("missing required \'bearingX\'",{instance:s});if(!s.hasOwnProperty("bearingY"))throw b.ProtocolError("missing required \'bearingY\'",{instance:s});if(!s.hasOwnProperty("advance"))throw b.ProtocolError("missing required \'advance\'",{instance:s});return s},t}(),h.FontDescription=function(){function t(t){if(t)for(var e=Object.keys(t),i=0;i<e.length;++i)null!=t[e[i]]&&(this[e[i]]=t[e[i]])}return t.prototype.fontId="",t.prototype.xheight=0,t.prototype.margin=3,t.prototype.height=0,t.prototype.ascender=0,t.prototype.descender=0,t.prototype.capHeight=0,t.decode=function(t,e){t instanceof y||(t=y.create(t));for(var i=void 0===e?t.len:t.pos+e,s=new w.yandex.maps.proto.renderer.glyphs.FontDescription;t.pos<i;){var n=t.uint32();switch(n>>>3){case 1:s.fontId=t.string();break;case 2:s.xheight=t.uint32();break;case 3:s.margin=t.sint32();break;case 4:s.height=t.uint32();break;case 5:s.ascender=t.uint32();break;case 6:s.descender=t.int32();break;case 7:s.capHeight=t.uint32();break;default:t.skipType(7&n)}}if(!s.hasOwnProperty("fontId"))throw b.ProtocolError("missing required \'fontId\'",{instance:s});if(!s.hasOwnProperty("xheight"))throw b.ProtocolError("missing required \'xheight\'",{instance:s});if(!s.hasOwnProperty("margin"))throw b.ProtocolError("missing required \'margin\'",{instance:s});return s},t}(),h.GlyphList=function(){function t(t){if(this.glyphs=[],t)for(var e=Object.keys(t),i=0;i<e.length;++i)null!=t[e[i]]&&(this[e[i]]=t[e[i]])}return t.prototype.font=null,t.prototype.glyphs=b.emptyArray,t.decode=function(t,e){t instanceof y||(t=y.create(t));for(var i=void 0===e?t.len:t.pos+e,s=new w.yandex.maps.proto.renderer.glyphs.GlyphList;t.pos<i;){var n=t.uint32();switch(n>>>3){case 1:s.font=w.yandex.maps.proto.renderer.glyphs.FontDescription.decode(t,t.uint32());break;case 2:s.glyphs&&s.glyphs.length||(s.glyphs=[]),s.glyphs.push(w.yandex.maps.proto.renderer.glyphs.Glyph.decode(t,t.uint32()));break;default:t.skipType(7&n)}}if(!s.hasOwnProperty("font"))throw b.ProtocolError("missing required \'font\'",{instance:s});return s},t}(),h),c),p.indoor=((d={}).Level=function(){function t(t){if(t)for(var e=Object.keys(t),i=0;i<e.length;++i)null!=t[e[i]]&&(this[e[i]]=t[e[i]])}return t.prototype.id="",t.prototype.name="",t.prototype.isUnderground=!1,t.decode=function(t,e){t instanceof y||(t=y.create(t));for(var i=void 0===e?t.len:t.pos+e,s=new w.yandex.maps.proto.indoor.Level;t.pos<i;){var n=t.uint32();switch(n>>>3){case 1:s.id=t.string();break;case 2:s.name=t.string();break;case 3:s.isUnderground=t.bool();break;default:t.skipType(7&n)}}if(!s.hasOwnProperty("id"))throw b.ProtocolError("missing required \'id\'",{instance:s});if(!s.hasOwnProperty("name"))throw b.ProtocolError("missing required \'name\'",{instance:s});return s},t}(),d.Plan=function(){function t(t){if(this.levels=[],t)for(var e=Object.keys(t),i=0;i<e.length;++i)null!=t[e[i]]&&(this[e[i]]=t[e[i]])}return t.prototype.levels=b.emptyArray,t.prototype.defaultLevelId="0",t.prototype.boundary=null,t.decode=function(t,e){t instanceof y||(t=y.create(t));for(var i=void 0===e?t.len:t.pos+e,s=new w.yandex.maps.proto.indoor.Plan;t.pos<i;){var n=t.uint32();switch(n>>>3){case 1:s.levels&&s.levels.length||(s.levels=[]),s.levels.push(w.yandex.maps.proto.indoor.Level.decode(t,t.uint32()));break;case 2:s.defaultLevelId=t.string();break;case 3:s.boundary=w.yandex.maps.proto.common2.geometry.BoundingBox.decode(t,t.uint32());break;default:t.skipType(7&n)}}return s},t}(),d),p.common2=((f={}).geometry=((u={}).Point=function(){function t(t){if(t)for(var e=Object.keys(t),i=0;i<e.length;++i)null!=t[e[i]]&&(this[e[i]]=t[e[i]])}return t.prototype.lon=0,t.prototype.lat=0,t.decode=function(t,e){t instanceof y||(t=y.create(t));for(var i=void 0===e?t.len:t.pos+e,s=new w.yandex.maps.proto.common2.geometry.Point;t.pos<i;){var n=t.uint32();switch(n>>>3){case 1:s.lon=t.double();break;case 2:s.lat=t.double();break;default:t.skipType(7&n)}}if(!s.hasOwnProperty("lon"))throw b.ProtocolError("missing required \'lon\'",{instance:s});if(!s.hasOwnProperty("lat"))throw b.ProtocolError("missing required \'lat\'",{instance:s});return s},t}(),u.CoordSequence=function(){function t(t){if(this.deltas=[],t)for(var e=Object.keys(t),i=0;i<e.length;++i)null!=t[e[i]]&&(this[e[i]]=t[e[i]])}return t.prototype.first=0,t.prototype.deltas=b.emptyArray,t.decode=function(t,e){t instanceof y||(t=y.create(t));for(var i=void 0===e?t.len:t.pos+e,s=new w.yandex.maps.proto.common2.geometry.CoordSequence;t.pos<i;){var n=t.uint32();switch(n>>>3){case 1:s.first=t.sint32();break;case 2:if(s.deltas&&s.deltas.length||(s.deltas=[]),2==(7&n))for(var r=t.uint32()+t.pos;t.pos<r;)s.deltas.push(t.sint32());else s.deltas.push(t.sint32());break;default:t.skipType(7&n)}}return s},t}(),u.Polyline=function(){function t(t){if(t)for(var e=Object.keys(t),i=0;i<e.length;++i)null!=t[e[i]]&&(this[e[i]]=t[e[i]])}return t.prototype.lons=null,t.prototype.lats=null,t.decode=function(t,e){t instanceof y||(t=y.create(t));for(var i=void 0===e?t.len:t.pos+e,s=new w.yandex.maps.proto.common2.geometry.Polyline;t.pos<i;){var n=t.uint32();switch(n>>>3){case 1:s.lons=w.yandex.maps.proto.common2.geometry.CoordSequence.decode(t,t.uint32());break;case 2:s.lats=w.yandex.maps.proto.common2.geometry.CoordSequence.decode(t,t.uint32());break;default:t.skipType(7&n)}}if(!s.hasOwnProperty("lons"))throw b.ProtocolError("missing required \'lons\'",{instance:s});if(!s.hasOwnProperty("lats"))throw b.ProtocolError("missing required \'lats\'",{instance:s});return s},t}(),u.PolylinePosition=function(){function t(t){if(t)for(var e=Object.keys(t),i=0;i<e.length;++i)null!=t[e[i]]&&(this[e[i]]=t[e[i]])}return t.prototype.segmentIndex=0,t.prototype.segmentPosition=0,t.decode=function(t,e){t instanceof y||(t=y.create(t));for(var i=void 0===e?t.len:t.pos+e,s=new w.yandex.maps.proto.common2.geometry.PolylinePosition;t.pos<i;){var n=t.uint32();switch(n>>>3){case 1:s.segmentIndex=t.uint32();break;case 2:s.segmentPosition=t.double();break;default:t.skipType(7&n)}}if(!s.hasOwnProperty("segmentIndex"))throw b.ProtocolError("missing required \'segmentIndex\'",{instance:s});if(!s.hasOwnProperty("segmentPosition"))throw b.ProtocolError("missing required \'segmentPosition\'",{instance:s});return s},t}(),u.Subpolyline=function(){function t(t){if(t)for(var e=Object.keys(t),i=0;i<e.length;++i)null!=t[e[i]]&&(this[e[i]]=t[e[i]])}return t.prototype.begin=null,t.prototype.end=null,t.decode=function(t,e){t instanceof y||(t=y.create(t));for(var i=void 0===e?t.len:t.pos+e,s=new w.yandex.maps.proto.common2.geometry.Subpolyline;t.pos<i;){var n=t.uint32();switch(n>>>3){case 1:s.begin=w.yandex.maps.proto.common2.geometry.PolylinePosition.decode(t,t.uint32());break;case 2:s.end=w.yandex.maps.proto.common2.geometry.PolylinePosition.decode(t,t.uint32());break;default:t.skipType(7&n)}}if(!s.hasOwnProperty("begin"))throw b.ProtocolError("missing required \'begin\'",{instance:s});if(!s.hasOwnProperty("end"))throw b.ProtocolError("missing required \'end\'",{instance:s});return s},t}(),u.LinearRing=function(){function t(t){if(t)for(var e=Object.keys(t),i=0;i<e.length;++i)null!=t[e[i]]&&(this[e[i]]=t[e[i]])}return t.prototype.lons=null,t.prototype.lats=null,t.decode=function(t,e){t instanceof y||(t=y.create(t));for(var i=void 0===e?t.len:t.pos+e,s=new w.yandex.maps.proto.common2.geometry.LinearRing;t.pos<i;){var n=t.uint32();switch(n>>>3){case 1:s.lons=w.yandex.maps.proto.common2.geometry.CoordSequence.decode(t,t.uint32());break;case 2:s.lats=w.yandex.maps.proto.common2.geometry.CoordSequence.decode(t,t.uint32());break;default:t.skipType(7&n)}}if(!s.hasOwnProperty("lons"))throw b.ProtocolError("missing required \'lons\'",{instance:s});if(!s.hasOwnProperty("lats"))throw b.ProtocolError("missing required \'lats\'",{instance:s});return s},t}(),u.Polygon=function(){function t(t){if(this.innerRings=[],t)for(var e=Object.keys(t),i=0;i<e.length;++i)null!=t[e[i]]&&(this[e[i]]=t[e[i]])}return t.prototype.outerRing=null,t.prototype.innerRings=b.emptyArray,t.decode=function(t,e){t instanceof y||(t=y.create(t));for(var i=void 0===e?t.len:t.pos+e,s=new w.yandex.maps.proto.common2.geometry.Polygon;t.pos<i;){var n=t.uint32();switch(n>>>3){case 1:s.outerRing=w.yandex.maps.proto.common2.geometry.LinearRing.decode(t,t.uint32());break;case 2:s.innerRings&&s.innerRings.length||(s.innerRings=[]),s.innerRings.push(w.yandex.maps.proto.common2.geometry.LinearRing.decode(t,t.uint32()));break;default:t.skipType(7&n)}}if(!s.hasOwnProperty("outerRing"))throw b.ProtocolError("missing required \'outerRing\'",{instance:s});return s},t}(),u.MultiPolygon=function(){function t(t){if(this.polygons=[],t)for(var e=Object.keys(t),i=0;i<e.length;++i)null!=t[e[i]]&&(this[e[i]]=t[e[i]])}return t.prototype.polygons=b.emptyArray,t.decode=function(t,e){t instanceof y||(t=y.create(t));for(var i=void 0===e?t.len:t.pos+e,s=new w.yandex.maps.proto.common2.geometry.MultiPolygon;t.pos<i;){var n=t.uint32();switch(n>>>3){case 1:s.polygons&&s.polygons.length||(s.polygons=[]),s.polygons.push(w.yandex.maps.proto.common2.geometry.Polygon.decode(t,t.uint32()));break;default:t.skipType(7&n)}}return s},t}(),u.Geometry=function(){function t(t){if(t)for(var e=Object.keys(t),i=0;i<e.length;++i)null!=t[e[i]]&&(this[e[i]]=t[e[i]])}return t.prototype.point=null,t.prototype.polyline=null,t.prototype.polygon=null,t.prototype.multipolygon=null,t.decode=function(t,e){t instanceof y||(t=y.create(t));for(var i=void 0===e?t.len:t.pos+e,s=new w.yandex.maps.proto.common2.geometry.Geometry;t.pos<i;){var n=t.uint32();switch(n>>>3){case 1:s.point=w.yandex.maps.proto.common2.geometry.Point.decode(t,t.uint32());break;case 2:s.polyline=w.yandex.maps.proto.common2.geometry.Polyline.decode(t,t.uint32());break;case 3:s.polygon=w.yandex.maps.proto.common2.geometry.Polygon.decode(t,t.uint32());break;case 4:s.multipolygon=w.yandex.maps.proto.common2.geometry.MultiPolygon.decode(t,t.uint32());break;default:t.skipType(7&n)}}return s},t}(),u.BoundingBox=function(){function t(t){if(t)for(var e=Object.keys(t),i=0;i<e.length;++i)null!=t[e[i]]&&(this[e[i]]=t[e[i]])}return t.prototype.lowerCorner=null,t.prototype.upperCorner=null,t.decode=function(t,e){t instanceof y||(t=y.create(t));for(var i=void 0===e?t.len:t.pos+e,s=new w.yandex.maps.proto.common2.geometry.BoundingBox;t.pos<i;){var n=t.uint32();switch(n>>>3){case 1:s.lowerCorner=w.yandex.maps.proto.common2.geometry.Point.decode(t,t.uint32());break;case 2:s.upperCorner=w.yandex.maps.proto.common2.geometry.Point.decode(t,t.uint32());break;default:t.skipType(7&n)}}if(!s.hasOwnProperty("lowerCorner"))throw b.ProtocolError("missing required \'lowerCorner\'",{instance:s});if(!s.hasOwnProperty("upperCorner"))throw b.ProtocolError("missing required \'upperCorner\'",{instance:s});return s},t}(),u.Direction=function(){function t(t){if(t)for(var e=Object.keys(t),i=0;i<e.length;++i)null!=t[e[i]]&&(this[e[i]]=t[e[i]])}return t.prototype.azimuth=0,t.prototype.tilt=0,t.decode=function(t,e){t instanceof y||(t=y.create(t));for(var i=void 0===e?t.len:t.pos+e,s=new w.yandex.maps.proto.common2.geometry.Direction;t.pos<i;){var n=t.uint32();switch(n>>>3){case 1:s.azimuth=t.double();break;case 2:s.tilt=t.double();break;default:t.skipType(7&n)}}if(!s.hasOwnProperty("azimuth"))throw b.ProtocolError("missing required \'azimuth\'",{instance:s});if(!s.hasOwnProperty("tilt"))throw b.ProtocolError("missing required \'tilt\'",{instance:s});return s},t}(),u.Span=function(){function t(t){if(t)for(var e=Object.keys(t),i=0;i<e.length;++i)null!=t[e[i]]&&(this[e[i]]=t[e[i]])}return t.prototype.horizontalAngle=0,t.prototype.verticalAngle=0,t.decode=function(t,e){t instanceof y||(t=y.create(t));for(var i=void 0===e?t.len:t.pos+e,s=new w.yandex.maps.proto.common2.geometry.Span;t.pos<i;){var n=t.uint32();switch(n>>>3){case 1:s.horizontalAngle=t.double();break;case 2:s.verticalAngle=t.double();break;default:t.skipType(7&n)}}if(!s.hasOwnProperty("horizontalAngle"))throw b.ProtocolError("missing required \'horizontalAngle\'",{instance:s});if(!s.hasOwnProperty("verticalAngle"))throw b.ProtocolError("missing required \'verticalAngle\'",{instance:s});return s},t}(),u),f),p),_),g),t.exports=w},function(t,e,i){"use strict";var s={};(0,i(3).assign)(s,i(33),i(36),i(15)),t.exports=s},function(t,e,i){"use strict";t.exports={2:"need dictionary",1:"stream end",0:"","-1":"file error","-2":"stream error","-3":"data error","-4":"insufficient memory","-5":"buffer error","-6":"incompatible version"}},function(t,e,i){"use strict";function s(t,e){return e.vertexByteOffset+e.vertexByteLength===t.vertexByteOffset&&e.indexByteOffset+e.indexByteLength===t.indexByteOffset&&e.bufferId===t.bufferId&&(e.vertexByteLength+=t.vertexByteLength,e.indexByteLength+=t.indexByteLength,!0)}function*n(t,e,i,n=(()=>!0)){const r=t[Symbol.iterator]();let o=r.next().value;if(!o)return;let a=o,l=i(a);for(o=r.next().value;o;){const t=e(o);n(a,o,l)&&s(t,l)||(yield l,l=i(o)),a=o,o=r.next().value}yield l}i.d(e,"a",(function(){return n}))},function(t,e,i){"use strict";t.exports=d;var s,n=i(4),r=n.LongBits,o=n.base64,a=n.utf8;function l(t,e,i){this.fn=t,this.len=e,this.next=void 0,this.val=i}function h(){}function c(t){this.head=t.head,this.tail=t.tail,this.len=t.len,this.next=t.states}function d(){this.len=0,this.head=new l(h,0,0),this.tail=this.head,this.states=null}function u(t,e,i){e[i]=255&t}function f(t,e){this.len=t,this.next=void 0,this.val=e}function p(t,e,i){for(;t.hi;)e[i++]=127&t.lo|128,t.lo=(t.lo>>>7|t.hi<<25)>>>0,t.hi>>>=7;for(;t.lo>127;)e[i++]=127&t.lo|128,t.lo=t.lo>>>7;e[i++]=t.lo}function _(t,e,i){e[i]=255&t,e[i+1]=t>>>8&255,e[i+2]=t>>>16&255,e[i+3]=t>>>24}d.create=n.Buffer?function(){return(d.create=function(){return new s})()}:function(){return new d},d.alloc=function(t){return new n.Array(t)},n.Array!==Array&&(d.alloc=n.pool(d.alloc,n.Array.prototype.subarray)),d.prototype._push=function(t,e,i){return this.tail=this.tail.next=new l(t,e,i),this.len+=e,this},f.prototype=Object.create(l.prototype),f.prototype.fn=function(t,e,i){for(;t>127;)e[i++]=127&t|128,t>>>=7;e[i]=t},d.prototype.uint32=function(t){return this.len+=(this.tail=this.tail.next=new f((t>>>=0)<128?1:t<16384?2:t<2097152?3:t<268435456?4:5,t)).len,this},d.prototype.int32=function(t){return t<0?this._push(p,10,r.fromNumber(t)):this.uint32(t)},d.prototype.sint32=function(t){return this.uint32((t<<1^t>>31)>>>0)},d.prototype.uint64=function(t){var e=r.from(t);return this._push(p,e.length(),e)},d.prototype.int64=d.prototype.uint64,d.prototype.sint64=function(t){var e=r.from(t).zzEncode();return this._push(p,e.length(),e)},d.prototype.bool=function(t){return this._push(u,1,t?1:0)},d.prototype.fixed32=function(t){return this._push(_,4,t>>>0)},d.prototype.sfixed32=d.prototype.fixed32,d.prototype.fixed64=function(t){var e=r.from(t);return this._push(_,4,e.lo)._push(_,4,e.hi)},d.prototype.sfixed64=d.prototype.fixed64,d.prototype.float=function(t){return this._push(n.float.writeFloatLE,4,t)},d.prototype.double=function(t){return this._push(n.float.writeDoubleLE,8,t)};var g=n.Array.prototype.set?function(t,e,i){e.set(t,i)}:function(t,e,i){for(var s=0;s<t.length;++s)e[i+s]=t[s]};d.prototype.bytes=function(t){var e=t.length>>>0;if(!e)return this._push(u,1,0);if(n.isString(t)){var i=d.alloc(e=o.length(t));o.decode(t,i,0),t=i}return this.uint32(e)._push(g,e,t)},d.prototype.string=function(t){var e=a.length(t);return e?this.uint32(e)._push(a.write,e,t):this._push(u,1,0)},d.prototype.fork=function(){return this.states=new c(this),this.head=this.tail=new l(h,0,0),this.len=0,this},d.prototype.reset=function(){return this.states?(this.head=this.states.head,this.tail=this.states.tail,this.len=this.states.len,this.states=this.states.next):(this.head=this.tail=new l(h,0,0),this.len=0),this},d.prototype.ldelim=function(){var t=this.head,e=this.tail,i=this.len;return this.reset().uint32(i),i&&(this.tail.next=t.next,this.tail=e,this.len+=i),this},d.prototype.finish=function(){for(var t=this.head.next,e=this.constructor.alloc(this.len),i=0;t;)t.fn(t.val,e,i),i+=t.len,t=t.next;return e},d._configure=function(t){s=t}},function(t,e,i){"use strict";t.exports=l;var s,n=i(4),r=n.LongBits,o=n.utf8;function a(t,e){return RangeError("index out of range: "+t.pos+" + "+(e||1)+" > "+t.len)}function l(t){this.buf=t,this.pos=0,this.len=t.length}var h,c="undefined"!=typeof Uint8Array?function(t){if(t instanceof Uint8Array||Array.isArray(t))return new l(t);throw Error("illegal buffer")}:function(t){if(Array.isArray(t))return new l(t);throw Error("illegal buffer")};function d(){var t=new r(0,0),e=0;if(!(this.len-this.pos>4)){for(;e<3;++e){if(this.pos>=this.len)throw a(this);if(t.lo=(t.lo|(127&this.buf[this.pos])<<7*e)>>>0,this.buf[this.pos++]<128)return t}return t.lo=(t.lo|(127&this.buf[this.pos++])<<7*e)>>>0,t}for(;e<4;++e)if(t.lo=(t.lo|(127&this.buf[this.pos])<<7*e)>>>0,this.buf[this.pos++]<128)return t;if(t.lo=(t.lo|(127&this.buf[this.pos])<<28)>>>0,t.hi=(t.hi|(127&this.buf[this.pos])>>4)>>>0,this.buf[this.pos++]<128)return t;if(e=0,this.len-this.pos>4){for(;e<5;++e)if(t.hi=(t.hi|(127&this.buf[this.pos])<<7*e+3)>>>0,this.buf[this.pos++]<128)return t}else for(;e<5;++e){if(this.pos>=this.len)throw a(this);if(t.hi=(t.hi|(127&this.buf[this.pos])<<7*e+3)>>>0,this.buf[this.pos++]<128)return t}throw Error("invalid varint encoding")}function u(t,e){return(t[e-4]|t[e-3]<<8|t[e-2]<<16|t[e-1]<<24)>>>0}function f(){if(this.pos+8>this.len)throw a(this,8);return new r(u(this.buf,this.pos+=4),u(this.buf,this.pos+=4))}l.create=n.Buffer?function(t){return(l.create=function(t){return n.Buffer.isBuffer(t)?new s(t):c(t)})(t)}:c,l.prototype._slice=n.Array.prototype.subarray||n.Array.prototype.slice,l.prototype.uint32=(h=4294967295,function(){if(h=(127&this.buf[this.pos])>>>0,this.buf[this.pos++]<128)return h;if(h=(h|(127&this.buf[this.pos])<<7)>>>0,this.buf[this.pos++]<128)return h;if(h=(h|(127&this.buf[this.pos])<<14)>>>0,this.buf[this.pos++]<128)return h;if(h=(h|(127&this.buf[this.pos])<<21)>>>0,this.buf[this.pos++]<128)return h;if(h=(h|(15&this.buf[this.pos])<<28)>>>0,this.buf[this.pos++]<128)return h;if((this.pos+=5)>this.len)throw this.pos=this.len,a(this,10);return h}),l.prototype.int32=function(){return 0|this.uint32()},l.prototype.sint32=function(){var t=this.uint32();return t>>>1^-(1&t)|0},l.prototype.bool=function(){return 0!==this.uint32()},l.prototype.fixed32=function(){if(this.pos+4>this.len)throw a(this,4);return u(this.buf,this.pos+=4)},l.prototype.sfixed32=function(){if(this.pos+4>this.len)throw a(this,4);return 0|u(this.buf,this.pos+=4)},l.prototype.float=function(){if(this.pos+4>this.len)throw a(this,4);var t=n.float.readFloatLE(this.buf,this.pos);return this.pos+=4,t},l.prototype.double=function(){if(this.pos+8>this.len)throw a(this,4);var t=n.float.readDoubleLE(this.buf,this.pos);return this.pos+=8,t},l.prototype.bytes=function(){var t=this.uint32(),e=this.pos,i=this.pos+t;if(i>this.len)throw a(this,t);return this.pos+=t,Array.isArray(this.buf)?this.buf.slice(e,i):e===i?new this.buf.constructor(0):this._slice.call(this.buf,e,i)},l.prototype.string=function(){var t=this.bytes();return o.read(t,0,t.length)},l.prototype.skip=function(t){if("number"==typeof t){if(this.pos+t>this.len)throw a(this,t);this.pos+=t}else do{if(this.pos>=this.len)throw a(this)}while(128&this.buf[this.pos++]);return this},l.prototype.skipType=function(t){switch(t){case 0:this.skip();break;case 1:this.skip(8);break;case 2:this.skip(this.uint32());break;case 3:for(;4!=(t=7&this.uint32());)this.skipType(t);break;case 5:this.skip(4);break;default:throw Error("invalid wire type "+t+" at offset "+this.pos)}return this},l._configure=function(t){s=t;var e=n.Long?"toLong":"toNumber";n.merge(l.prototype,{int64:function(){return d.call(this)[e](!1)},uint64:function(){return d.call(this)[e](!0)},sint64:function(){return d.call(this).zzDecode()[e](!1)},fixed64:function(){return f.call(this)[e](!0)},sfixed64:function(){return f.call(this)[e](!1)}})}},function(t,e,i){"use strict";t.exports=function(t,e,i,s){for(var n=65535&t|0,r=t>>>16&65535|0,o=0;0!==i;){i-=o=i>2e3?2e3:i;do{r=r+(n=n+e[s++]|0)|0}while(--o);n%=65521,r%=65521}return n|r<<16|0}},function(t,e,i){"use strict";var s=function(){for(var t,e=[],i=0;i<256;i++){t=i;for(var s=0;s<8;s++)t=1&t?3988292384^t>>>1:t>>>1;e[i]=t}return e}();t.exports=function(t,e,i,n){var r=s,o=n+i;t^=-1;for(var a=n;a<o;a++)t=t>>>8^r[255&(t^e[a])];return-1^t}},function(t,e,i){"use strict";var s=i(3),n=!0,r=!0;try{String.fromCharCode.apply(null,[0])}catch(h){n=!1}try{String.fromCharCode.apply(null,new Uint8Array(1))}catch(h){r=!1}for(var o=new s.Buf8(256),a=0;a<256;a++)o[a]=a>=252?6:a>=248?5:a>=240?4:a>=224?3:a>=192?2:1;function l(t,e){if(e<65534&&(t.subarray&&r||!t.subarray&&n))return String.fromCharCode.apply(null,s.shrinkBuf(t,e));for(var i="",o=0;o<e;o++)i+=String.fromCharCode(t[o]);return i}o[254]=o[254]=1,e.string2buf=function(t){var e,i,n,r,o,a=t.length,l=0;for(r=0;r<a;r++)55296==(64512&(i=t.charCodeAt(r)))&&r+1<a&&56320==(64512&(n=t.charCodeAt(r+1)))&&(i=65536+(i-55296<<10)+(n-56320),r++),l+=i<128?1:i<2048?2:i<65536?3:4;for(e=new s.Buf8(l),o=0,r=0;o<l;r++)55296==(64512&(i=t.charCodeAt(r)))&&r+1<a&&56320==(64512&(n=t.charCodeAt(r+1)))&&(i=65536+(i-55296<<10)+(n-56320),r++),i<128?e[o++]=i:i<2048?(e[o++]=192|i>>>6,e[o++]=128|63&i):i<65536?(e[o++]=224|i>>>12,e[o++]=128|i>>>6&63,e[o++]=128|63&i):(e[o++]=240|i>>>18,e[o++]=128|i>>>12&63,e[o++]=128|i>>>6&63,e[o++]=128|63&i);return e},e.buf2binstring=function(t){return l(t,t.length)},e.binstring2buf=function(t){for(var e=new s.Buf8(t.length),i=0,n=e.length;i<n;i++)e[i]=t.charCodeAt(i);return e},e.buf2string=function(t,e){var i,s,n,r,a=e||t.length,h=new Array(2*a);for(s=0,i=0;i<a;)if((n=t[i++])<128)h[s++]=n;else if((r=o[n])>4)h[s++]=65533,i+=r-1;else{for(n&=2===r?31:3===r?15:7;r>1&&i<a;)n=n<<6|63&t[i++],r--;r>1?h[s++]=65533:n<65536?h[s++]=n:(n-=65536,h[s++]=55296|n>>10&1023,h[s++]=56320|1023&n)}return l(h,s)},e.utf8border=function(t,e){var i;for((e=e||t.length)>t.length&&(e=t.length),i=e-1;i>=0&&128==(192&t[i]);)i--;return i<0||0===i?e:i+o[t[i]]>e?i:e}},function(t,e,i){"use strict";t.exports=function(){this.input=null,this.next_in=0,this.avail_in=0,this.total_in=0,this.output=null,this.next_out=0,this.avail_out=0,this.total_out=0,this.msg="",this.state=null,this.data_type=2,this.adler=0}},function(t,e,i){"use strict";t.exports={Z_NO_FLUSH:0,Z_PARTIAL_FLUSH:1,Z_SYNC_FLUSH:2,Z_FULL_FLUSH:3,Z_FINISH:4,Z_BLOCK:5,Z_TREES:6,Z_OK:0,Z_STREAM_END:1,Z_NEED_DICT:2,Z_ERRNO:-1,Z_STREAM_ERROR:-2,Z_DATA_ERROR:-3,Z_BUF_ERROR:-5,Z_NO_COMPRESSION:0,Z_BEST_SPEED:1,Z_BEST_COMPRESSION:9,Z_DEFAULT_COMPRESSION:-1,Z_FILTERED:1,Z_HUFFMAN_ONLY:2,Z_RLE:3,Z_FIXED:4,Z_DEFAULT_STRATEGY:0,Z_BINARY:0,Z_TEXT:1,Z_UNKNOWN:2,Z_DEFLATED:8}},function(t,e,i){"use strict";t.exports=i(17)},function(t,e,i){"use strict";var s=e;function n(){s.Reader._configure(s.BufferReader),s.util._configure()}s.build="minimal",s.Writer=i(9),s.BufferWriter=i(27),s.Reader=i(10),s.BufferReader=i(28),s.util=i(4),s.rpc=i(29),s.roots=i(31),s.configure=n,s.Writer._configure(s.BufferWriter),n()},function(t,e){var i;i=function(){return this}();try{i=i||new Function("return this")()}catch(s){"object"==typeof window&&(i=window)}t.exports=i},function(t,e,i){"use strict";t.exports=function(t,e){var i=new Array(arguments.length-1),s=0,n=2,r=!0;for(;n<arguments.length;)i[s++]=arguments[n++];return new Promise((function(n,o){i[s]=function(t){if(r)if(r=!1,t)o(t);else{for(var e=new Array(arguments.length-1),i=0;i<e.length;)e[i++]=arguments[i];n.apply(null,e)}};try{t.apply(e||null,i)}catch(a){r&&(r=!1,o(a))}}))}},function(t,e,i){"use strict";var s=e;s.length=function(t){var e=t.length;if(!e)return 0;for(var i=0;--e%4>1&&"="===t.charAt(e);)++i;return Math.ceil(3*t.length)/4-i};for(var n=new Array(64),r=new Array(123),o=0;o<64;)r[n[o]=o<26?o+65:o<52?o+71:o<62?o-4:o-59|43]=o++;s.encode=function(t,e,i){for(var s,r=null,o=[],a=0,l=0;e<i;){var h=t[e++];switch(l){case 0:o[a++]=n[h>>2],s=(3&h)<<4,l=1;break;case 1:o[a++]=n[s|h>>4],s=(15&h)<<2,l=2;break;case 2:o[a++]=n[s|h>>6],o[a++]=n[63&h],l=0}a>8191&&((r||(r=[])).push(String.fromCharCode.apply(String,o)),a=0)}return l&&(o[a++]=n[s],o[a++]=61,1===l&&(o[a++]=61)),r?(a&&r.push(String.fromCharCode.apply(String,o.slice(0,a))),r.join("")):String.fromCharCode.apply(String,o.slice(0,a))};s.decode=function(t,e,i){for(var s,n=i,o=0,a=0;a<t.length;){var l=t.charCodeAt(a++);if(61===l&&o>1)break;if(void 0===(l=r[l]))throw Error("invalid encoding");switch(o){case 0:s=l,o=1;break;case 1:e[i++]=s<<2|(48&l)>>4,s=l,o=2;break;case 2:e[i++]=(15&s)<<4|(60&l)>>2,s=l,o=3;break;case 3:e[i++]=(3&s)<<6|l,o=0}}if(1===o)throw Error("invalid encoding");return i-n},s.test=function(t){return/^(?:[A-Za-z0-9+/]{4})*(?:[A-Za-z0-9+/]{2}==|[A-Za-z0-9+/]{3}=)?$/.test(t)}},function(t,e,i){"use strict";function s(){this._listeners={}}t.exports=s,s.prototype.on=function(t,e,i){return(this._listeners[t]||(this._listeners[t]=[])).push({fn:e,ctx:i||this}),this},s.prototype.off=function(t,e){if(void 0===t)this._listeners={};else if(void 0===e)this._listeners[t]=[];else for(var i=this._listeners[t],s=0;s<i.length;)i[s].fn===e?i.splice(s,1):++s;return this},s.prototype.emit=function(t){var e=this._listeners[t];if(e){for(var i=[],s=1;s<arguments.length;)i.push(arguments[s++]);for(s=0;s<e.length;)e[s].fn.apply(e[s++].ctx,i)}return this}},function(t,e,i){"use strict";function s(t){return"undefined"!=typeof Float32Array?function(){var e=new Float32Array([-0]),i=new Uint8Array(e.buffer),s=128===i[3];function n(t,s,n){e[0]=t,s[n]=i[0],s[n+1]=i[1],s[n+2]=i[2],s[n+3]=i[3]}function r(t,s,n){e[0]=t,s[n]=i[3],s[n+1]=i[2],s[n+2]=i[1],s[n+3]=i[0]}function o(t,s){return i[0]=t[s],i[1]=t[s+1],i[2]=t[s+2],i[3]=t[s+3],e[0]}function a(t,s){return i[3]=t[s],i[2]=t[s+1],i[1]=t[s+2],i[0]=t[s+3],e[0]}t.writeFloatLE=s?n:r,t.writeFloatBE=s?r:n,t.readFloatLE=s?o:a,t.readFloatBE=s?a:o}():function(){function e(t,e,i,s){var n=e<0?1:0;if(n&&(e=-e),0===e)t(1/e>0?0:2147483648,i,s);else if(isNaN(e))t(2143289344,i,s);else if(e>34028234663852886e22)t((n<<31|2139095040)>>>0,i,s);else if(e<11754943508222875e-54)t((n<<31|Math.round(e/1401298464324817e-60))>>>0,i,s);else{var r=Math.floor(Math.log(e)/Math.LN2);t((n<<31|r+127<<23|8388607&Math.round(e*Math.pow(2,-r)*8388608))>>>0,i,s)}}function i(t,e,i){var s=t(e,i),n=2*(s>>31)+1,r=s>>>23&255,o=8388607&s;return 255===r?o?NaN:n*(1/0):0===r?1401298464324817e-60*n*o:n*Math.pow(2,r-150)*(o+8388608)}t.writeFloatLE=e.bind(null,n),t.writeFloatBE=e.bind(null,r),t.readFloatLE=i.bind(null,o),t.readFloatBE=i.bind(null,a)}(),"undefined"!=typeof Float64Array?function(){var e=new Float64Array([-0]),i=new Uint8Array(e.buffer),s=128===i[7];function n(t,s,n){e[0]=t,s[n]=i[0],s[n+1]=i[1],s[n+2]=i[2],s[n+3]=i[3],s[n+4]=i[4],s[n+5]=i[5],s[n+6]=i[6],s[n+7]=i[7]}function r(t,s,n){e[0]=t,s[n]=i[7],s[n+1]=i[6],s[n+2]=i[5],s[n+3]=i[4],s[n+4]=i[3],s[n+5]=i[2],s[n+6]=i[1],s[n+7]=i[0]}function o(t,s){return i[0]=t[s],i[1]=t[s+1],i[2]=t[s+2],i[3]=t[s+3],i[4]=t[s+4],i[5]=t[s+5],i[6]=t[s+6],i[7]=t[s+7],e[0]}function a(t,s){return i[7]=t[s],i[6]=t[s+1],i[5]=t[s+2],i[4]=t[s+3],i[3]=t[s+4],i[2]=t[s+5],i[1]=t[s+6],i[0]=t[s+7],e[0]}t.writeDoubleLE=s?n:r,t.writeDoubleBE=s?r:n,t.readDoubleLE=s?o:a,t.readDoubleBE=s?a:o}():function(){function e(t,e,i,s,n,r){var o=s<0?1:0;if(o&&(s=-s),0===s)t(0,n,r+e),t(1/s>0?0:2147483648,n,r+i);else if(isNaN(s))t(0,n,r+e),t(2146959360,n,r+i);else if(s>17976931348623157e292)t(0,n,r+e),t((o<<31|2146435072)>>>0,n,r+i);else{var a;if(s<22250738585072014e-324)t((a=s/5e-324)>>>0,n,r+e),t((o<<31|a/4294967296)>>>0,n,r+i);else{var l=Math.floor(Math.log(s)/Math.LN2);1024===l&&(l=1023),t(4503599627370496*(a=s*Math.pow(2,-l))>>>0,n,r+e),t((o<<31|l+1023<<20|1048576*a&1048575)>>>0,n,r+i)}}}function i(t,e,i,s,n){var r=t(s,n+e),o=t(s,n+i),a=2*(o>>31)+1,l=o>>>20&2047,h=4294967296*(1048575&o)+r;return 2047===l?h?NaN:a*(1/0):0===l?5e-324*a*h:a*Math.pow(2,l-1075)*(h+4503599627370496)}t.writeDoubleLE=e.bind(null,n,0,4),t.writeDoubleBE=e.bind(null,r,4,0),t.readDoubleLE=i.bind(null,o,0,4),t.readDoubleBE=i.bind(null,a,4,0)}(),t}function n(t,e,i){e[i]=255&t,e[i+1]=t>>>8&255,e[i+2]=t>>>16&255,e[i+3]=t>>>24}function r(t,e,i){e[i]=t>>>24,e[i+1]=t>>>16&255,e[i+2]=t>>>8&255,e[i+3]=255&t}function o(t,e){return(t[e]|t[e+1]<<8|t[e+2]<<16|t[e+3]<<24)>>>0}function a(t,e){return(t[e]<<24|t[e+1]<<16|t[e+2]<<8|t[e+3])>>>0}t.exports=s(s)},function(module,exports,__webpack_require__){"use strict";function inquire(moduleName){try{var mod=eval("quire".replace(/^/,"re"))(moduleName);if(mod&&(mod.length||Object.keys(mod).length))return mod}catch(e){}return null}module.exports=inquire},function(t,e,i){"use strict";var s=e;s.length=function(t){for(var e=0,i=0,s=0;s<t.length;++s)(i=t.charCodeAt(s))<128?e+=1:i<2048?e+=2:55296==(64512&i)&&56320==(64512&t.charCodeAt(s+1))?(++s,e+=4):e+=3;return e},s.read=function(t,e,i){if(i-e<1)return"";for(var s,n=null,r=[],o=0;e<i;)(s=t[e++])<128?r[o++]=s:s>191&&s<224?r[o++]=(31&s)<<6|63&t[e++]:s>239&&s<365?(s=((7&s)<<18|(63&t[e++])<<12|(63&t[e++])<<6|63&t[e++])-65536,r[o++]=55296+(s>>10),r[o++]=56320+(1023&s)):r[o++]=(15&s)<<12|(63&t[e++])<<6|63&t[e++],o>8191&&((n||(n=[])).push(String.fromCharCode.apply(String,r)),o=0);return n?(o&&n.push(String.fromCharCode.apply(String,r.slice(0,o))),n.join("")):String.fromCharCode.apply(String,r.slice(0,o))},s.write=function(t,e,i){for(var s,n,r=i,o=0;o<t.length;++o)(s=t.charCodeAt(o))<128?e[i++]=s:s<2048?(e[i++]=s>>6|192,e[i++]=63&s|128):55296==(64512&s)&&56320==(64512&(n=t.charCodeAt(o+1)))?(s=65536+((1023&s)<<10)+(1023&n),++o,e[i++]=s>>18|240,e[i++]=s>>12&63|128,e[i++]=s>>6&63|128,e[i++]=63&s|128):(e[i++]=s>>12|224,e[i++]=s>>6&63|128,e[i++]=63&s|128);return i-r}},function(t,e,i){"use strict";t.exports=function(t,e,i){var s=i||8192,n=s>>>1,r=null,o=s;return function(i){if(i<1||i>n)return t(i);o+i>s&&(r=t(s),o=0);var a=e.call(r,o,o+=i);return 7&o&&(o=1+(7|o)),a}}},function(t,e,i){"use strict";t.exports=n;var s=i(4);function n(t,e){this.lo=t>>>0,this.hi=e>>>0}var r=n.zero=new n(0,0);r.toNumber=function(){return 0},r.zzEncode=r.zzDecode=function(){return this},r.length=function(){return 1};var o=n.zeroHash="\\0\\0\\0\\0\\0\\0\\0\\0";n.fromNumber=function(t){if(0===t)return r;var e=t<0;e&&(t=-t);var i=t>>>0,s=(t-i)/4294967296>>>0;return e&&(s=~s>>>0,i=~i>>>0,++i>4294967295&&(i=0,++s>4294967295&&(s=0))),new n(i,s)},n.from=function(t){if("number"==typeof t)return n.fromNumber(t);if(s.isString(t)){if(!s.Long)return n.fromNumber(parseInt(t,10));t=s.Long.fromString(t)}return t.low||t.high?new n(t.low>>>0,t.high>>>0):r},n.prototype.toNumber=function(t){if(!t&&this.hi>>>31){var e=1+~this.lo>>>0,i=~this.hi>>>0;return e||(i=i+1>>>0),-(e+4294967296*i)}return this.lo+4294967296*this.hi},n.prototype.toLong=function(t){return s.Long?new s.Long(0|this.lo,0|this.hi,Boolean(t)):{low:0|this.lo,high:0|this.hi,unsigned:Boolean(t)}};var a=String.prototype.charCodeAt;n.fromHash=function(t){return t===o?r:new n((a.call(t,0)|a.call(t,1)<<8|a.call(t,2)<<16|a.call(t,3)<<24)>>>0,(a.call(t,4)|a.call(t,5)<<8|a.call(t,6)<<16|a.call(t,7)<<24)>>>0)},n.prototype.toHash=function(){return String.fromCharCode(255&this.lo,this.lo>>>8&255,this.lo>>>16&255,this.lo>>>24,255&this.hi,this.hi>>>8&255,this.hi>>>16&255,this.hi>>>24)},n.prototype.zzEncode=function(){var t=this.hi>>31;return this.hi=((this.hi<<1|this.lo>>>31)^t)>>>0,this.lo=(this.lo<<1^t)>>>0,this},n.prototype.zzDecode=function(){var t=-(1&this.lo);return this.lo=((this.lo>>>1|this.hi<<31)^t)>>>0,this.hi=(this.hi>>>1^t)>>>0,this},n.prototype.length=function(){var t=this.lo,e=(this.lo>>>28|this.hi<<4)>>>0,i=this.hi>>>24;return 0===i?0===e?t<16384?t<128?1:2:t<2097152?3:4:e<16384?e<128?5:6:e<2097152?7:8:i<128?9:10}},function(t,e,i){"use strict";t.exports=o;var s=i(9);(o.prototype=Object.create(s.prototype)).constructor=o;var n=i(4),r=n.Buffer;function o(){s.call(this)}o.alloc=function(t){return(o.alloc=n._Buffer_allocUnsafe)(t)};var a=r&&r.prototype instanceof Uint8Array&&"set"===r.prototype.set.name?function(t,e,i){e.set(t,i)}:function(t,e,i){if(t.copy)t.copy(e,i,0,t.length);else for(var s=0;s<t.length;)e[i++]=t[s++]};function l(t,e,i){t.length<40?n.utf8.write(t,e,i):e.utf8Write(t,i)}o.prototype.bytes=function(t){n.isString(t)&&(t=n._Buffer_from(t,"base64"));var e=t.length>>>0;return this.uint32(e),e&&this._push(a,e,t),this},o.prototype.string=function(t){var e=r.byteLength(t);return this.uint32(e),e&&this._push(l,e,t),this}},function(t,e,i){"use strict";t.exports=r;var s=i(10);(r.prototype=Object.create(s.prototype)).constructor=r;var n=i(4);function r(t){s.call(this,t)}n.Buffer&&(r.prototype._slice=n.Buffer.prototype.slice),r.prototype.string=function(){var t=this.uint32();return this.buf.utf8Slice(this.pos,this.pos=Math.min(this.pos+t,this.len))}},function(t,e,i){"use strict";e.Service=i(30)},function(t,e,i){"use strict";t.exports=n;var s=i(4);function n(t,e,i){if("function"!=typeof t)throw TypeError("rpcImpl must be a function");s.EventEmitter.call(this),this.rpcImpl=t,this.requestDelimited=Boolean(e),this.responseDelimited=Boolean(i)}(n.prototype=Object.create(s.EventEmitter.prototype)).constructor=n,n.prototype.rpcCall=function t(e,i,n,r,o){if(!r)throw TypeError("request must be specified");var a=this;if(!o)return s.asPromise(t,a,e,i,n,r);if(a.rpcImpl)try{return a.rpcImpl(e,i[a.requestDelimited?"encodeDelimited":"encode"](r).finish(),(function(t,i){if(t)return a.emit("error",t,e),o(t);if(null!==i){if(!(i instanceof n))try{i=n[a.responseDelimited?"decodeDelimited":"decode"](i)}catch(t){return a.emit("error",t,e),o(t)}return a.emit("data",i,e),o(null,i)}a.end(!0)}))}catch(l){return a.emit("error",l,e),void setTimeout((function(){o(l)}),0)}else setTimeout((function(){o(Error("already ended"))}),0)},n.prototype.end=function(t){return this.rpcImpl&&(t||this.rpcImpl(null,null,null),this.rpcImpl=null,this.emit("end").off()),this}},function(t,e,i){"use strict";t.exports={}},function(t,e,i){"use strict";!function(t){if(t.TextEncoder&&t.TextDecoder)return!1;function e(t="utf-8"){if("utf-8"!==t)throw new RangeError(`Failed to construct \'TextEncoder\': The encoding label provided (\'${t}\') is invalid.`)}function i(t="utf-8",e={fatal:!1}){if("utf-8"!==t)throw new RangeError(`Failed to construct \'TextDecoder\': The encoding label provided (\'${t}\') is invalid.`);if(e.fatal)throw new Error("Failed to construct \'TextDecoder\': the \'fatal\' option is unsupported.")}Object.defineProperty(e.prototype,"encoding",{value:"utf-8"}),e.prototype.encode=function(t,e={stream:!1}){if(e.stream)throw new Error("Failed to encode: the \'stream\' option is unsupported.");let i=0;const s=t.length;let n=0,r=Math.max(32,s+(s>>1)+7),o=new Uint8Array(r>>3<<3);for(;i<s;){let e=t.charCodeAt(i++);if(e>=55296&&e<=56319){if(i<s){const s=t.charCodeAt(i);56320==(64512&s)&&(++i,e=((1023&e)<<10)+(1023&s)+65536)}if(e>=55296&&e<=56319)continue}if(n+4>o.length){r+=8,r*=1+i/t.length*2,r=r>>3<<3;const e=new Uint8Array(r);e.set(o),o=e}if(0!=(4294967168&e)){if(0==(4294965248&e))o[n++]=e>>6&31|192;else if(0==(4294901760&e))o[n++]=e>>12&15|224,o[n++]=e>>6&63|128;else{if(0!=(4292870144&e))continue;o[n++]=e>>18&7|240,o[n++]=e>>12&63|128,o[n++]=e>>6&63|128}o[n++]=63&e|128}else o[n++]=e}return o.slice(0,n)},Object.defineProperty(i.prototype,"encoding",{value:"utf-8"}),Object.defineProperty(i.prototype,"fatal",{value:!1}),Object.defineProperty(i.prototype,"ignoreBOM",{value:!1}),i.prototype.decode=function(t,e={stream:!1}){if(e.stream)throw new Error("Failed to decode: the \'stream\' option is unsupported.");const i=new Uint8Array(t);let s=0;const n=i.length,r=[];for(;s<n;){const t=i[s++];if(0===t)break;if(0==(128&t))r.push(t);else if(192==(224&t)){const e=63&i[s++];r.push((31&t)<<6|e)}else if(224==(240&t)){const e=63&i[s++],n=63&i[s++];r.push((31&t)<<12|e<<6|n)}else if(240==(248&t)){let e=(7&t)<<18|(63&i[s++])<<12|(63&i[s++])<<6|63&i[s++];e>65535&&(e-=65536,r.push(e>>>10&1023|55296),e=56320|1023&e),r.push(e)}}return String.fromCharCode.apply(null,r)},t.TextEncoder=e,t.TextDecoder=i}("undefined"!=typeof window?window:"undefined"!=typeof self?self:this)},function(t,e,i){"use strict";var s=i(34),n=i(3),r=i(13),o=i(7),a=i(14),l=Object.prototype.toString;function h(t){if(!(this instanceof h))return new h(t);this.options=n.assign({level:-1,method:8,chunkSize:16384,windowBits:15,memLevel:8,strategy:0,to:""},t||{});var e=this.options;e.raw&&e.windowBits>0?e.windowBits=-e.windowBits:e.gzip&&e.windowBits>0&&e.windowBits<16&&(e.windowBits+=16),this.err=0,this.msg="",this.ended=!1,this.chunks=[],this.strm=new a,this.strm.avail_out=0;var i=s.deflateInit2(this.strm,e.level,e.method,e.windowBits,e.memLevel,e.strategy);if(0!==i)throw new Error(o[i]);if(e.header&&s.deflateSetHeader(this.strm,e.header),e.dictionary){var c;if(c="string"==typeof e.dictionary?r.string2buf(e.dictionary):"[object ArrayBuffer]"===l.call(e.dictionary)?new Uint8Array(e.dictionary):e.dictionary,0!==(i=s.deflateSetDictionary(this.strm,c)))throw new Error(o[i]);this._dict_set=!0}}function c(t,e){var i=new h(e);if(i.push(t,!0),i.err)throw i.msg||o[i.err];return i.result}h.prototype.push=function(t,e){var i,o,a=this.strm,h=this.options.chunkSize;if(this.ended)return!1;o=e===~~e?e:!0===e?4:0,"string"==typeof t?a.input=r.string2buf(t):"[object ArrayBuffer]"===l.call(t)?a.input=new Uint8Array(t):a.input=t,a.next_in=0,a.avail_in=a.input.length;do{if(0===a.avail_out&&(a.output=new n.Buf8(h),a.next_out=0,a.avail_out=h),1!==(i=s.deflate(a,o))&&0!==i)return this.onEnd(i),this.ended=!0,!1;0!==a.avail_out&&(0!==a.avail_in||4!==o&&2!==o)||("string"===this.options.to?this.onData(r.buf2binstring(n.shrinkBuf(a.output,a.next_out))):this.onData(n.shrinkBuf(a.output,a.next_out)))}while((a.avail_in>0||0===a.avail_out)&&1!==i);return 4===o?(i=s.deflateEnd(this.strm),this.onEnd(i),this.ended=!0,0===i):2!==o||(this.onEnd(0),a.avail_out=0,!0)},h.prototype.onData=function(t){this.chunks.push(t)},h.prototype.onEnd=function(t){0===t&&("string"===this.options.to?this.result=this.chunks.join(""):this.result=n.flattenChunks(this.chunks)),this.chunks=[],this.err=t,this.msg=this.strm.msg},e.Deflate=h,e.deflate=c,e.deflateRaw=function(t,e){return(e=e||{}).raw=!0,c(t,e)},e.gzip=function(t,e){return(e=e||{}).gzip=!0,c(t,e)}},function(t,e,i){"use strict";var s,n=i(3),r=i(35),o=i(11),a=i(12),l=i(7);function h(t,e){return t.msg=l[e],e}function c(t){return(t<<1)-(t>4?9:0)}function d(t){for(var e=t.length;--e>=0;)t[e]=0}function u(t){var e=t.state,i=e.pending;i>t.avail_out&&(i=t.avail_out),0!==i&&(n.arraySet(t.output,e.pending_buf,e.pending_out,i,t.next_out),t.next_out+=i,e.pending_out+=i,t.total_out+=i,t.avail_out-=i,e.pending-=i,0===e.pending&&(e.pending_out=0))}function f(t,e){r._tr_flush_block(t,t.block_start>=0?t.block_start:-1,t.strstart-t.block_start,e),t.block_start=t.strstart,u(t.strm)}function p(t,e){t.pending_buf[t.pending++]=e}function _(t,e){t.pending_buf[t.pending++]=e>>>8&255,t.pending_buf[t.pending++]=255&e}function g(t,e){var i,s,n=t.max_chain_length,r=t.strstart,o=t.prev_length,a=t.nice_match,l=t.strstart>t.w_size-262?t.strstart-(t.w_size-262):0,h=t.window,c=t.w_mask,d=t.prev,u=t.strstart+258,f=h[r+o-1],p=h[r+o];t.prev_length>=t.good_match&&(n>>=2),a>t.lookahead&&(a=t.lookahead);do{if(h[(i=e)+o]===p&&h[i+o-1]===f&&h[i]===h[r]&&h[++i]===h[r+1]){r+=2,i++;do{}while(h[++r]===h[++i]&&h[++r]===h[++i]&&h[++r]===h[++i]&&h[++r]===h[++i]&&h[++r]===h[++i]&&h[++r]===h[++i]&&h[++r]===h[++i]&&h[++r]===h[++i]&&r<u);if(s=258-(u-r),r=u-258,s>o){if(t.match_start=e,o=s,s>=a)break;f=h[r+o-1],p=h[r+o]}}}while((e=d[e&c])>l&&0!=--n);return o<=t.lookahead?o:t.lookahead}function m(t){var e,i,s,r,l,h,c,d,u,f,p=t.w_size;do{if(r=t.window_size-t.lookahead-t.strstart,t.strstart>=p+(p-262)){n.arraySet(t.window,t.window,p,p,0),t.match_start-=p,t.strstart-=p,t.block_start-=p,e=i=t.hash_size;do{s=t.head[--e],t.head[e]=s>=p?s-p:0}while(--i);e=i=p;do{s=t.prev[--e],t.prev[e]=s>=p?s-p:0}while(--i);r+=p}if(0===t.strm.avail_in)break;if(h=t.strm,c=t.window,d=t.strstart+t.lookahead,u=r,f=void 0,(f=h.avail_in)>u&&(f=u),i=0===f?0:(h.avail_in-=f,n.arraySet(c,h.input,h.next_in,f,d),1===h.state.wrap?h.adler=o(h.adler,c,f,d):2===h.state.wrap&&(h.adler=a(h.adler,c,f,d)),h.next_in+=f,h.total_in+=f,f),t.lookahead+=i,t.lookahead+t.insert>=3)for(l=t.strstart-t.insert,t.ins_h=t.window[l],t.ins_h=(t.ins_h<<t.hash_shift^t.window[l+1])&t.hash_mask;t.insert&&(t.ins_h=(t.ins_h<<t.hash_shift^t.window[l+3-1])&t.hash_mask,t.prev[l&t.w_mask]=t.head[t.ins_h],t.head[t.ins_h]=l,l++,t.insert--,!(t.lookahead+t.insert<3)););}while(t.lookahead<262&&0!==t.strm.avail_in)}function y(t,e){for(var i,s;;){if(t.lookahead<262){if(m(t),t.lookahead<262&&0===e)return 1;if(0===t.lookahead)break}if(i=0,t.lookahead>=3&&(t.ins_h=(t.ins_h<<t.hash_shift^t.window[t.strstart+3-1])&t.hash_mask,i=t.prev[t.strstart&t.w_mask]=t.head[t.ins_h],t.head[t.ins_h]=t.strstart),0!==i&&t.strstart-i<=t.w_size-262&&(t.match_length=g(t,i)),t.match_length>=3)if(s=r._tr_tally(t,t.strstart-t.match_start,t.match_length-3),t.lookahead-=t.match_length,t.match_length<=t.max_lazy_match&&t.lookahead>=3){t.match_length--;do{t.strstart++,t.ins_h=(t.ins_h<<t.hash_shift^t.window[t.strstart+3-1])&t.hash_mask,i=t.prev[t.strstart&t.w_mask]=t.head[t.ins_h],t.head[t.ins_h]=t.strstart}while(0!=--t.match_length);t.strstart++}else t.strstart+=t.match_length,t.match_length=0,t.ins_h=t.window[t.strstart],t.ins_h=(t.ins_h<<t.hash_shift^t.window[t.strstart+1])&t.hash_mask;else s=r._tr_tally(t,0,t.window[t.strstart]),t.lookahead--,t.strstart++;if(s&&(f(t,!1),0===t.strm.avail_out))return 1}return t.insert=t.strstart<2?t.strstart:2,4===e?(f(t,!0),0===t.strm.avail_out?3:4):t.last_lit&&(f(t,!1),0===t.strm.avail_out)?1:2}function b(t,e){for(var i,s,n;;){if(t.lookahead<262){if(m(t),t.lookahead<262&&0===e)return 1;if(0===t.lookahead)break}if(i=0,t.lookahead>=3&&(t.ins_h=(t.ins_h<<t.hash_shift^t.window[t.strstart+3-1])&t.hash_mask,i=t.prev[t.strstart&t.w_mask]=t.head[t.ins_h],t.head[t.ins_h]=t.strstart),t.prev_length=t.match_length,t.prev_match=t.match_start,t.match_length=2,0!==i&&t.prev_length<t.max_lazy_match&&t.strstart-i<=t.w_size-262&&(t.match_length=g(t,i),t.match_length<=5&&(1===t.strategy||3===t.match_length&&t.strstart-t.match_start>4096)&&(t.match_length=2)),t.prev_length>=3&&t.match_length<=t.prev_length){n=t.strstart+t.lookahead-3,s=r._tr_tally(t,t.strstart-1-t.prev_match,t.prev_length-3),t.lookahead-=t.prev_length-1,t.prev_length-=2;do{++t.strstart<=n&&(t.ins_h=(t.ins_h<<t.hash_shift^t.window[t.strstart+3-1])&t.hash_mask,i=t.prev[t.strstart&t.w_mask]=t.head[t.ins_h],t.head[t.ins_h]=t.strstart)}while(0!=--t.prev_length);if(t.match_available=0,t.match_length=2,t.strstart++,s&&(f(t,!1),0===t.strm.avail_out))return 1}else if(t.match_available){if((s=r._tr_tally(t,0,t.window[t.strstart-1]))&&f(t,!1),t.strstart++,t.lookahead--,0===t.strm.avail_out)return 1}else t.match_available=1,t.strstart++,t.lookahead--}return t.match_available&&(s=r._tr_tally(t,0,t.window[t.strstart-1]),t.match_available=0),t.insert=t.strstart<2?t.strstart:2,4===e?(f(t,!0),0===t.strm.avail_out?3:4):t.last_lit&&(f(t,!1),0===t.strm.avail_out)?1:2}function w(t,e,i,s,n){this.good_length=t,this.max_lazy=e,this.nice_length=i,this.max_chain=s,this.func=n}function v(){this.strm=null,this.status=0,this.pending_buf=null,this.pending_buf_size=0,this.pending_out=0,this.pending=0,this.wrap=0,this.gzhead=null,this.gzindex=0,this.method=8,this.last_flush=-1,this.w_size=0,this.w_bits=0,this.w_mask=0,this.window=null,this.window_size=0,this.prev=null,this.head=null,this.ins_h=0,this.hash_size=0,this.hash_bits=0,this.hash_mask=0,this.hash_shift=0,this.block_start=0,this.match_length=0,this.prev_match=0,this.match_available=0,this.strstart=0,this.match_start=0,this.lookahead=0,this.prev_length=0,this.max_chain_length=0,this.max_lazy_match=0,this.level=0,this.strategy=0,this.good_match=0,this.nice_match=0,this.dyn_ltree=new n.Buf16(1146),this.dyn_dtree=new n.Buf16(122),this.bl_tree=new n.Buf16(78),d(this.dyn_ltree),d(this.dyn_dtree),d(this.bl_tree),this.l_desc=null,this.d_desc=null,this.bl_desc=null,this.bl_count=new n.Buf16(16),this.heap=new n.Buf16(573),d(this.heap),this.heap_len=0,this.heap_max=0,this.depth=new n.Buf16(573),d(this.depth),this.l_buf=0,this.lit_bufsize=0,this.last_lit=0,this.d_buf=0,this.opt_len=0,this.static_len=0,this.matches=0,this.insert=0,this.bi_buf=0,this.bi_valid=0}function x(t){var e;return t&&t.state?(t.total_in=t.total_out=0,t.data_type=2,(e=t.state).pending=0,e.pending_out=0,e.wrap<0&&(e.wrap=-e.wrap),e.status=e.wrap?42:113,t.adler=2===e.wrap?0:1,e.last_flush=0,r._tr_init(e),0):h(t,-2)}function k(t){var e,i=x(t);return 0===i&&((e=t.state).window_size=2*e.w_size,d(e.head),e.max_lazy_match=s[e.level].max_lazy,e.good_match=s[e.level].good_length,e.nice_match=s[e.level].nice_length,e.max_chain_length=s[e.level].max_chain,e.strstart=0,e.block_start=0,e.lookahead=0,e.insert=0,e.match_length=e.prev_length=2,e.match_available=0,e.ins_h=0),i}function A(t,e,i,s,r,o){if(!t)return-2;var a=1;if(-1===e&&(e=6),s<0?(a=0,s=-s):s>15&&(a=2,s-=16),r<1||r>9||8!==i||s<8||s>15||e<0||e>9||o<0||o>4)return h(t,-2);8===s&&(s=9);var l=new v;return t.state=l,l.strm=t,l.wrap=a,l.gzhead=null,l.w_bits=s,l.w_size=1<<l.w_bits,l.w_mask=l.w_size-1,l.hash_bits=r+7,l.hash_size=1<<l.hash_bits,l.hash_mask=l.hash_size-1,l.hash_shift=~~((l.hash_bits+3-1)/3),l.window=new n.Buf8(2*l.w_size),l.head=new n.Buf16(l.hash_size),l.prev=new n.Buf16(l.w_size),l.lit_bufsize=1<<r+6,l.pending_buf_size=4*l.lit_bufsize,l.pending_buf=new n.Buf8(l.pending_buf_size),l.d_buf=1*l.lit_bufsize,l.l_buf=3*l.lit_bufsize,l.level=e,l.strategy=o,l.method=i,k(t)}s=[new w(0,0,0,0,(function(t,e){var i=65535;for(i>t.pending_buf_size-5&&(i=t.pending_buf_size-5);;){if(t.lookahead<=1){if(m(t),0===t.lookahead&&0===e)return 1;if(0===t.lookahead)break}t.strstart+=t.lookahead,t.lookahead=0;var s=t.block_start+i;if((0===t.strstart||t.strstart>=s)&&(t.lookahead=t.strstart-s,t.strstart=s,f(t,!1),0===t.strm.avail_out))return 1;if(t.strstart-t.block_start>=t.w_size-262&&(f(t,!1),0===t.strm.avail_out))return 1}return t.insert=0,4===e?(f(t,!0),0===t.strm.avail_out?3:4):(t.strstart>t.block_start&&(f(t,!1),t.strm.avail_out),1)})),new w(4,4,8,4,y),new w(4,5,16,8,y),new w(4,6,32,32,y),new w(4,4,16,16,b),new w(8,16,32,32,b),new w(8,16,128,128,b),new w(8,32,128,256,b),new w(32,128,258,1024,b),new w(32,258,258,4096,b)],e.deflateInit=function(t,e){return A(t,e,8,15,8,0)},e.deflateInit2=A,e.deflateReset=k,e.deflateResetKeep=x,e.deflateSetHeader=function(t,e){return t&&t.state?2!==t.state.wrap?-2:(t.state.gzhead=e,0):-2},e.deflate=function(t,e){var i,n,o,l;if(!t||!t.state||e>5||e<0)return t?h(t,-2):-2;if(n=t.state,!t.output||!t.input&&0!==t.avail_in||666===n.status&&4!==e)return h(t,0===t.avail_out?-5:-2);if(n.strm=t,i=n.last_flush,n.last_flush=e,42===n.status)if(2===n.wrap)t.adler=0,p(n,31),p(n,139),p(n,8),n.gzhead?(p(n,(n.gzhead.text?1:0)+(n.gzhead.hcrc?2:0)+(n.gzhead.extra?4:0)+(n.gzhead.name?8:0)+(n.gzhead.comment?16:0)),p(n,255&n.gzhead.time),p(n,n.gzhead.time>>8&255),p(n,n.gzhead.time>>16&255),p(n,n.gzhead.time>>24&255),p(n,9===n.level?2:n.strategy>=2||n.level<2?4:0),p(n,255&n.gzhead.os),n.gzhead.extra&&n.gzhead.extra.length&&(p(n,255&n.gzhead.extra.length),p(n,n.gzhead.extra.length>>8&255)),n.gzhead.hcrc&&(t.adler=a(t.adler,n.pending_buf,n.pending,0)),n.gzindex=0,n.status=69):(p(n,0),p(n,0),p(n,0),p(n,0),p(n,0),p(n,9===n.level?2:n.strategy>=2||n.level<2?4:0),p(n,3),n.status=113);else{var g=8+(n.w_bits-8<<4)<<8;g|=(n.strategy>=2||n.level<2?0:n.level<6?1:6===n.level?2:3)<<6,0!==n.strstart&&(g|=32),g+=31-g%31,n.status=113,_(n,g),0!==n.strstart&&(_(n,t.adler>>>16),_(n,65535&t.adler)),t.adler=1}if(69===n.status)if(n.gzhead.extra){for(o=n.pending;n.gzindex<(65535&n.gzhead.extra.length)&&(n.pending!==n.pending_buf_size||(n.gzhead.hcrc&&n.pending>o&&(t.adler=a(t.adler,n.pending_buf,n.pending-o,o)),u(t),o=n.pending,n.pending!==n.pending_buf_size));)p(n,255&n.gzhead.extra[n.gzindex]),n.gzindex++;n.gzhead.hcrc&&n.pending>o&&(t.adler=a(t.adler,n.pending_buf,n.pending-o,o)),n.gzindex===n.gzhead.extra.length&&(n.gzindex=0,n.status=73)}else n.status=73;if(73===n.status)if(n.gzhead.name){o=n.pending;do{if(n.pending===n.pending_buf_size&&(n.gzhead.hcrc&&n.pending>o&&(t.adler=a(t.adler,n.pending_buf,n.pending-o,o)),u(t),o=n.pending,n.pending===n.pending_buf_size)){l=1;break}l=n.gzindex<n.gzhead.name.length?255&n.gzhead.name.charCodeAt(n.gzindex++):0,p(n,l)}while(0!==l);n.gzhead.hcrc&&n.pending>o&&(t.adler=a(t.adler,n.pending_buf,n.pending-o,o)),0===l&&(n.gzindex=0,n.status=91)}else n.status=91;if(91===n.status)if(n.gzhead.comment){o=n.pending;do{if(n.pending===n.pending_buf_size&&(n.gzhead.hcrc&&n.pending>o&&(t.adler=a(t.adler,n.pending_buf,n.pending-o,o)),u(t),o=n.pending,n.pending===n.pending_buf_size)){l=1;break}l=n.gzindex<n.gzhead.comment.length?255&n.gzhead.comment.charCodeAt(n.gzindex++):0,p(n,l)}while(0!==l);n.gzhead.hcrc&&n.pending>o&&(t.adler=a(t.adler,n.pending_buf,n.pending-o,o)),0===l&&(n.status=103)}else n.status=103;if(103===n.status&&(n.gzhead.hcrc?(n.pending+2>n.pending_buf_size&&u(t),n.pending+2<=n.pending_buf_size&&(p(n,255&t.adler),p(n,t.adler>>8&255),t.adler=0,n.status=113)):n.status=113),0!==n.pending){if(u(t),0===t.avail_out)return n.last_flush=-1,0}else if(0===t.avail_in&&c(e)<=c(i)&&4!==e)return h(t,-5);if(666===n.status&&0!==t.avail_in)return h(t,-5);if(0!==t.avail_in||0!==n.lookahead||0!==e&&666!==n.status){var y=2===n.strategy?function(t,e){for(var i;;){if(0===t.lookahead&&(m(t),0===t.lookahead)){if(0===e)return 1;break}if(t.match_length=0,i=r._tr_tally(t,0,t.window[t.strstart]),t.lookahead--,t.strstart++,i&&(f(t,!1),0===t.strm.avail_out))return 1}return t.insert=0,4===e?(f(t,!0),0===t.strm.avail_out?3:4):t.last_lit&&(f(t,!1),0===t.strm.avail_out)?1:2}(n,e):3===n.strategy?function(t,e){for(var i,s,n,o,a=t.window;;){if(t.lookahead<=258){if(m(t),t.lookahead<=258&&0===e)return 1;if(0===t.lookahead)break}if(t.match_length=0,t.lookahead>=3&&t.strstart>0&&(s=a[n=t.strstart-1])===a[++n]&&s===a[++n]&&s===a[++n]){o=t.strstart+258;do{}while(s===a[++n]&&s===a[++n]&&s===a[++n]&&s===a[++n]&&s===a[++n]&&s===a[++n]&&s===a[++n]&&s===a[++n]&&n<o);t.match_length=258-(o-n),t.match_length>t.lookahead&&(t.match_length=t.lookahead)}if(t.match_length>=3?(i=r._tr_tally(t,1,t.match_length-3),t.lookahead-=t.match_length,t.strstart+=t.match_length,t.match_length=0):(i=r._tr_tally(t,0,t.window[t.strstart]),t.lookahead--,t.strstart++),i&&(f(t,!1),0===t.strm.avail_out))return 1}return t.insert=0,4===e?(f(t,!0),0===t.strm.avail_out?3:4):t.last_lit&&(f(t,!1),0===t.strm.avail_out)?1:2}(n,e):s[n.level].func(n,e);if(3!==y&&4!==y||(n.status=666),1===y||3===y)return 0===t.avail_out&&(n.last_flush=-1),0;if(2===y&&(1===e?r._tr_align(n):5!==e&&(r._tr_stored_block(n,0,0,!1),3===e&&(d(n.head),0===n.lookahead&&(n.strstart=0,n.block_start=0,n.insert=0))),u(t),0===t.avail_out))return n.last_flush=-1,0}return 4!==e?0:n.wrap<=0?1:(2===n.wrap?(p(n,255&t.adler),p(n,t.adler>>8&255),p(n,t.adler>>16&255),p(n,t.adler>>24&255),p(n,255&t.total_in),p(n,t.total_in>>8&255),p(n,t.total_in>>16&255),p(n,t.total_in>>24&255)):(_(n,t.adler>>>16),_(n,65535&t.adler)),u(t),n.wrap>0&&(n.wrap=-n.wrap),0!==n.pending?0:1)},e.deflateEnd=function(t){var e;return t&&t.state?42!==(e=t.state.status)&&69!==e&&73!==e&&91!==e&&103!==e&&113!==e&&666!==e?h(t,-2):(t.state=null,113===e?h(t,-3):0):-2},e.deflateSetDictionary=function(t,e){var i,s,r,a,l,h,c,u,f=e.length;if(!t||!t.state)return-2;if(2===(a=(i=t.state).wrap)||1===a&&42!==i.status||i.lookahead)return-2;for(1===a&&(t.adler=o(t.adler,e,f,0)),i.wrap=0,f>=i.w_size&&(0===a&&(d(i.head),i.strstart=0,i.block_start=0,i.insert=0),u=new n.Buf8(i.w_size),n.arraySet(u,e,f-i.w_size,i.w_size,0),e=u,f=i.w_size),l=t.avail_in,h=t.next_in,c=t.input,t.avail_in=f,t.next_in=0,t.input=e,m(i);i.lookahead>=3;){s=i.strstart,r=i.lookahead-2;do{i.ins_h=(i.ins_h<<i.hash_shift^i.window[s+3-1])&i.hash_mask,i.prev[s&i.w_mask]=i.head[i.ins_h],i.head[i.ins_h]=s,s++}while(--r);i.strstart=s,i.lookahead=2,m(i)}return i.strstart+=i.lookahead,i.block_start=i.strstart,i.insert=i.lookahead,i.lookahead=0,i.match_length=i.prev_length=2,i.match_available=0,t.next_in=h,t.input=c,t.avail_in=l,i.wrap=a,0},e.deflateInfo="pako deflate (from Nodeca project)"},function(t,e,i){"use strict";var s=i(3);function n(t){for(var e=t.length;--e>=0;)t[e]=0}var r=[0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0],o=[0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13],a=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,2,3,7],l=[16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15],h=new Array(576);n(h);var c=new Array(60);n(c);var d=new Array(512);n(d);var u=new Array(256);n(u);var f=new Array(29);n(f);var p,_,g,m=new Array(30);function y(t,e,i,s,n){this.static_tree=t,this.extra_bits=e,this.extra_base=i,this.elems=s,this.max_length=n,this.has_stree=t&&t.length}function b(t,e){this.dyn_tree=t,this.max_code=0,this.stat_desc=e}function w(t){return t<256?d[t]:d[256+(t>>>7)]}function v(t,e){t.pending_buf[t.pending++]=255&e,t.pending_buf[t.pending++]=e>>>8&255}function x(t,e,i){t.bi_valid>16-i?(t.bi_buf|=e<<t.bi_valid&65535,v(t,t.bi_buf),t.bi_buf=e>>16-t.bi_valid,t.bi_valid+=i-16):(t.bi_buf|=e<<t.bi_valid&65535,t.bi_valid+=i)}function k(t,e,i){x(t,i[2*e],i[2*e+1])}function A(t,e){var i=0;do{i|=1&t,t>>>=1,i<<=1}while(--e>0);return i>>>1}function S(t,e,i){var s,n,r=new Array(16),o=0;for(s=1;s<=15;s++)r[s]=o=o+i[s-1]<<1;for(n=0;n<=e;n++){var a=t[2*n+1];0!==a&&(t[2*n]=A(r[a]++,a))}}function T(t){var e;for(e=0;e<286;e++)t.dyn_ltree[2*e]=0;for(e=0;e<30;e++)t.dyn_dtree[2*e]=0;for(e=0;e<19;e++)t.bl_tree[2*e]=0;t.dyn_ltree[512]=1,t.opt_len=t.static_len=0,t.last_lit=t.matches=0}function R(t){t.bi_valid>8?v(t,t.bi_buf):t.bi_valid>0&&(t.pending_buf[t.pending++]=t.bi_buf),t.bi_buf=0,t.bi_valid=0}function I(t,e,i,s){var n=2*e,r=2*i;return t[n]<t[r]||t[n]===t[r]&&s[e]<=s[i]}function C(t,e,i){for(var s=t.heap[i],n=i<<1;n<=t.heap_len&&(n<t.heap_len&&I(e,t.heap[n+1],t.heap[n],t.depth)&&n++,!I(e,s,t.heap[n],t.depth));)t.heap[i]=t.heap[n],i=n,n<<=1;t.heap[i]=s}function z(t,e,i){var s,n,a,l,h=0;if(0!==t.last_lit)do{s=t.pending_buf[t.d_buf+2*h]<<8|t.pending_buf[t.d_buf+2*h+1],n=t.pending_buf[t.l_buf+h],h++,0===s?k(t,n,e):(k(t,(a=u[n])+256+1,e),0!==(l=r[a])&&x(t,n-=f[a],l),k(t,a=w(--s),i),0!==(l=o[a])&&x(t,s-=m[a],l))}while(h<t.last_lit);k(t,256,e)}function P(t,e){var i,s,n,r=e.dyn_tree,o=e.stat_desc.static_tree,a=e.stat_desc.has_stree,l=e.stat_desc.elems,h=-1;for(t.heap_len=0,t.heap_max=573,i=0;i<l;i++)0!==r[2*i]?(t.heap[++t.heap_len]=h=i,t.depth[i]=0):r[2*i+1]=0;for(;t.heap_len<2;)r[2*(n=t.heap[++t.heap_len]=h<2?++h:0)]=1,t.depth[n]=0,t.opt_len--,a&&(t.static_len-=o[2*n+1]);for(e.max_code=h,i=t.heap_len>>1;i>=1;i--)C(t,r,i);n=l;do{i=t.heap[1],t.heap[1]=t.heap[t.heap_len--],C(t,r,1),s=t.heap[1],t.heap[--t.heap_max]=i,t.heap[--t.heap_max]=s,r[2*n]=r[2*i]+r[2*s],t.depth[n]=(t.depth[i]>=t.depth[s]?t.depth[i]:t.depth[s])+1,r[2*i+1]=r[2*s+1]=n,t.heap[1]=n++,C(t,r,1)}while(t.heap_len>=2);t.heap[--t.heap_max]=t.heap[1],function(t,e){var i,s,n,r,o,a,l=e.dyn_tree,h=e.max_code,c=e.stat_desc.static_tree,d=e.stat_desc.has_stree,u=e.stat_desc.extra_bits,f=e.stat_desc.extra_base,p=e.stat_desc.max_length,_=0;for(r=0;r<=15;r++)t.bl_count[r]=0;for(l[2*t.heap[t.heap_max]+1]=0,i=t.heap_max+1;i<573;i++)(r=l[2*l[2*(s=t.heap[i])+1]+1]+1)>p&&(r=p,_++),l[2*s+1]=r,s>h||(t.bl_count[r]++,o=0,s>=f&&(o=u[s-f]),a=l[2*s],t.opt_len+=a*(r+o),d&&(t.static_len+=a*(c[2*s+1]+o)));if(0!==_){do{for(r=p-1;0===t.bl_count[r];)r--;t.bl_count[r]--,t.bl_count[r+1]+=2,t.bl_count[p]--,_-=2}while(_>0);for(r=p;0!==r;r--)for(s=t.bl_count[r];0!==s;)(n=t.heap[--i])>h||(l[2*n+1]!==r&&(t.opt_len+=(r-l[2*n+1])*l[2*n],l[2*n+1]=r),s--)}}(t,e),S(r,h,t.bl_count)}function O(t,e,i){var s,n,r=-1,o=e[1],a=0,l=7,h=4;for(0===o&&(l=138,h=3),e[2*(i+1)+1]=65535,s=0;s<=i;s++)n=o,o=e[2*(s+1)+1],++a<l&&n===o||(a<h?t.bl_tree[2*n]+=a:0!==n?(n!==r&&t.bl_tree[2*n]++,t.bl_tree[32]++):a<=10?t.bl_tree[34]++:t.bl_tree[36]++,a=0,r=n,0===o?(l=138,h=3):n===o?(l=6,h=3):(l=7,h=4))}function E(t,e,i){var s,n,r=-1,o=e[1],a=0,l=7,h=4;for(0===o&&(l=138,h=3),s=0;s<=i;s++)if(n=o,o=e[2*(s+1)+1],!(++a<l&&n===o)){if(a<h)do{k(t,n,t.bl_tree)}while(0!=--a);else 0!==n?(n!==r&&(k(t,n,t.bl_tree),a--),k(t,16,t.bl_tree),x(t,a-3,2)):a<=10?(k(t,17,t.bl_tree),x(t,a-3,3)):(k(t,18,t.bl_tree),x(t,a-11,7));a=0,r=n,0===o?(l=138,h=3):n===o?(l=6,h=3):(l=7,h=4)}}n(m);var M=!1;function L(t,e,i,n){x(t,0+(n?1:0),3),function(t,e,i,n){R(t),n&&(v(t,i),v(t,~i)),s.arraySet(t.pending_buf,t.window,e,i,t.pending),t.pending+=i}(t,e,i,!0)}e._tr_init=function(t){M||(!function(){var t,e,i,s,n,l=new Array(16);for(i=0,s=0;s<28;s++)for(f[s]=i,t=0;t<1<<r[s];t++)u[i++]=s;for(u[i-1]=s,n=0,s=0;s<16;s++)for(m[s]=n,t=0;t<1<<o[s];t++)d[n++]=s;for(n>>=7;s<30;s++)for(m[s]=n<<7,t=0;t<1<<o[s]-7;t++)d[256+n++]=s;for(e=0;e<=15;e++)l[e]=0;for(t=0;t<=143;)h[2*t+1]=8,t++,l[8]++;for(;t<=255;)h[2*t+1]=9,t++,l[9]++;for(;t<=279;)h[2*t+1]=7,t++,l[7]++;for(;t<=287;)h[2*t+1]=8,t++,l[8]++;for(S(h,287,l),t=0;t<30;t++)c[2*t+1]=5,c[2*t]=A(t,5);p=new y(h,r,257,286,15),_=new y(c,o,0,30,15),g=new y(new Array(0),a,0,19,7)}(),M=!0),t.l_desc=new b(t.dyn_ltree,p),t.d_desc=new b(t.dyn_dtree,_),t.bl_desc=new b(t.bl_tree,g),t.bi_buf=0,t.bi_valid=0,T(t)},e._tr_stored_block=L,e._tr_flush_block=function(t,e,i,s){var n,r,o=0;t.level>0?(2===t.strm.data_type&&(t.strm.data_type=function(t){var e,i=4093624447;for(e=0;e<=31;e++,i>>>=1)if(1&i&&0!==t.dyn_ltree[2*e])return 0;if(0!==t.dyn_ltree[18]||0!==t.dyn_ltree[20]||0!==t.dyn_ltree[26])return 1;for(e=32;e<256;e++)if(0!==t.dyn_ltree[2*e])return 1;return 0}(t)),P(t,t.l_desc),P(t,t.d_desc),o=function(t){var e;for(O(t,t.dyn_ltree,t.l_desc.max_code),O(t,t.dyn_dtree,t.d_desc.max_code),P(t,t.bl_desc),e=18;e>=3&&0===t.bl_tree[2*l[e]+1];e--);return t.opt_len+=3*(e+1)+5+5+4,e}(t),n=t.opt_len+3+7>>>3,(r=t.static_len+3+7>>>3)<=n&&(n=r)):n=r=i+5,i+4<=n&&-1!==e?L(t,e,i,s):4===t.strategy||r===n?(x(t,2+(s?1:0),3),z(t,h,c)):(x(t,4+(s?1:0),3),function(t,e,i,s){var n;for(x(t,e-257,5),x(t,i-1,5),x(t,s-4,4),n=0;n<s;n++)x(t,t.bl_tree[2*l[n]+1],3);E(t,t.dyn_ltree,e-1),E(t,t.dyn_dtree,i-1)}(t,t.l_desc.max_code+1,t.d_desc.max_code+1,o+1),z(t,t.dyn_ltree,t.dyn_dtree)),T(t),s&&R(t)},e._tr_tally=function(t,e,i){return t.pending_buf[t.d_buf+2*t.last_lit]=e>>>8&255,t.pending_buf[t.d_buf+2*t.last_lit+1]=255&e,t.pending_buf[t.l_buf+t.last_lit]=255&i,t.last_lit++,0===e?t.dyn_ltree[2*i]++:(t.matches++,e--,t.dyn_ltree[2*(u[i]+256+1)]++,t.dyn_dtree[2*w(e)]++),t.last_lit===t.lit_bufsize-1},e._tr_align=function(t){x(t,2,3),k(t,256,h),function(t){16===t.bi_valid?(v(t,t.bi_buf),t.bi_buf=0,t.bi_valid=0):t.bi_valid>=8&&(t.pending_buf[t.pending++]=255&t.bi_buf,t.bi_buf>>=8,t.bi_valid-=8)}(t)}},function(t,e,i){"use strict";var s=i(37),n=i(3),r=i(13),o=i(15),a=i(7),l=i(14),h=i(40),c=Object.prototype.toString;function d(t){if(!(this instanceof d))return new d(t);this.options=n.assign({chunkSize:16384,windowBits:0,to:""},t||{});var e=this.options;e.raw&&e.windowBits>=0&&e.windowBits<16&&(e.windowBits=-e.windowBits,0===e.windowBits&&(e.windowBits=-15)),!(e.windowBits>=0&&e.windowBits<16)||t&&t.windowBits||(e.windowBits+=32),e.windowBits>15&&e.windowBits<48&&0==(15&e.windowBits)&&(e.windowBits|=15),this.err=0,this.msg="",this.ended=!1,this.chunks=[],this.strm=new l,this.strm.avail_out=0;var i=s.inflateInit2(this.strm,e.windowBits);if(i!==o.Z_OK)throw new Error(a[i]);if(this.header=new h,s.inflateGetHeader(this.strm,this.header),e.dictionary&&("string"==typeof e.dictionary?e.dictionary=r.string2buf(e.dictionary):"[object ArrayBuffer]"===c.call(e.dictionary)&&(e.dictionary=new Uint8Array(e.dictionary)),e.raw&&(i=s.inflateSetDictionary(this.strm,e.dictionary))!==o.Z_OK))throw new Error(a[i])}function u(t,e){var i=new d(e);if(i.push(t,!0),i.err)throw i.msg||a[i.err];return i.result}d.prototype.push=function(t,e){var i,a,l,h,d,u=this.strm,f=this.options.chunkSize,p=this.options.dictionary,_=!1;if(this.ended)return!1;a=e===~~e?e:!0===e?o.Z_FINISH:o.Z_NO_FLUSH,"string"==typeof t?u.input=r.binstring2buf(t):"[object ArrayBuffer]"===c.call(t)?u.input=new Uint8Array(t):u.input=t,u.next_in=0,u.avail_in=u.input.length;do{if(0===u.avail_out&&(u.output=new n.Buf8(f),u.next_out=0,u.avail_out=f),(i=s.inflate(u,o.Z_NO_FLUSH))===o.Z_NEED_DICT&&p&&(i=s.inflateSetDictionary(this.strm,p)),i===o.Z_BUF_ERROR&&!0===_&&(i=o.Z_OK,_=!1),i!==o.Z_STREAM_END&&i!==o.Z_OK)return this.onEnd(i),this.ended=!0,!1;u.next_out&&(0!==u.avail_out&&i!==o.Z_STREAM_END&&(0!==u.avail_in||a!==o.Z_FINISH&&a!==o.Z_SYNC_FLUSH)||("string"===this.options.to?(l=r.utf8border(u.output,u.next_out),h=u.next_out-l,d=r.buf2string(u.output,l),u.next_out=h,u.avail_out=f-h,h&&n.arraySet(u.output,u.output,l,h,0),this.onData(d)):this.onData(n.shrinkBuf(u.output,u.next_out)))),0===u.avail_in&&0===u.avail_out&&(_=!0)}while((u.avail_in>0||0===u.avail_out)&&i!==o.Z_STREAM_END);return i===o.Z_STREAM_END&&(a=o.Z_FINISH),a===o.Z_FINISH?(i=s.inflateEnd(this.strm),this.onEnd(i),this.ended=!0,i===o.Z_OK):a!==o.Z_SYNC_FLUSH||(this.onEnd(o.Z_OK),u.avail_out=0,!0)},d.prototype.onData=function(t){this.chunks.push(t)},d.prototype.onEnd=function(t){t===o.Z_OK&&("string"===this.options.to?this.result=this.chunks.join(""):this.result=n.flattenChunks(this.chunks)),this.chunks=[],this.err=t,this.msg=this.strm.msg},e.Inflate=d,e.inflate=u,e.inflateRaw=function(t,e){return(e=e||{}).raw=!0,u(t,e)},e.ungzip=u},function(t,e,i){"use strict";var s=i(3),n=i(11),r=i(12),o=i(38),a=i(39);function l(t){return(t>>>24&255)+(t>>>8&65280)+((65280&t)<<8)+((255&t)<<24)}function h(){this.mode=0,this.last=!1,this.wrap=0,this.havedict=!1,this.flags=0,this.dmax=0,this.check=0,this.total=0,this.head=null,this.wbits=0,this.wsize=0,this.whave=0,this.wnext=0,this.window=null,this.hold=0,this.bits=0,this.length=0,this.offset=0,this.extra=0,this.lencode=null,this.distcode=null,this.lenbits=0,this.distbits=0,this.ncode=0,this.nlen=0,this.ndist=0,this.have=0,this.next=null,this.lens=new s.Buf16(320),this.work=new s.Buf16(288),this.lendyn=null,this.distdyn=null,this.sane=0,this.back=0,this.was=0}function c(t){var e;return t&&t.state?(e=t.state,t.total_in=t.total_out=e.total=0,t.msg="",e.wrap&&(t.adler=1&e.wrap),e.mode=1,e.last=0,e.havedict=0,e.dmax=32768,e.head=null,e.hold=0,e.bits=0,e.lencode=e.lendyn=new s.Buf32(852),e.distcode=e.distdyn=new s.Buf32(592),e.sane=1,e.back=-1,0):-2}function d(t){var e;return t&&t.state?((e=t.state).wsize=0,e.whave=0,e.wnext=0,c(t)):-2}function u(t,e){var i,s;return t&&t.state?(s=t.state,e<0?(i=0,e=-e):(i=1+(e>>4),e<48&&(e&=15)),e&&(e<8||e>15)?-2:(null!==s.window&&s.wbits!==e&&(s.window=null),s.wrap=i,s.wbits=e,d(t))):-2}function f(t,e){var i,s;return t?(s=new h,t.state=s,s.window=null,0!==(i=u(t,e))&&(t.state=null),i):-2}var p,_,g=!0;function m(t){if(g){var e;for(p=new s.Buf32(512),_=new s.Buf32(32),e=0;e<144;)t.lens[e++]=8;for(;e<256;)t.lens[e++]=9;for(;e<280;)t.lens[e++]=7;for(;e<288;)t.lens[e++]=8;for(a(1,t.lens,0,288,p,0,t.work,{bits:9}),e=0;e<32;)t.lens[e++]=5;a(2,t.lens,0,32,_,0,t.work,{bits:5}),g=!1}t.lencode=p,t.lenbits=9,t.distcode=_,t.distbits=5}function y(t,e,i,n){var r,o=t.state;return null===o.window&&(o.wsize=1<<o.wbits,o.wnext=0,o.whave=0,o.window=new s.Buf8(o.wsize)),n>=o.wsize?(s.arraySet(o.window,e,i-o.wsize,o.wsize,0),o.wnext=0,o.whave=o.wsize):((r=o.wsize-o.wnext)>n&&(r=n),s.arraySet(o.window,e,i-n,r,o.wnext),(n-=r)?(s.arraySet(o.window,e,i-n,n,0),o.wnext=n,o.whave=o.wsize):(o.wnext+=r,o.wnext===o.wsize&&(o.wnext=0),o.whave<o.wsize&&(o.whave+=r))),0}e.inflateReset=d,e.inflateReset2=u,e.inflateResetKeep=c,e.inflateInit=function(t){return f(t,15)},e.inflateInit2=f,e.inflate=function(t,e){var i,h,c,d,u,f,p,_,g,b,w,v,x,k,A,S,T,R,I,C,z,P,O,E,M=0,L=new s.Buf8(4),B=[16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15];if(!t||!t.state||!t.output||!t.input&&0!==t.avail_in)return-2;12===(i=t.state).mode&&(i.mode=13),u=t.next_out,c=t.output,p=t.avail_out,d=t.next_in,h=t.input,f=t.avail_in,_=i.hold,g=i.bits,b=f,w=p,P=0;t:for(;;)switch(i.mode){case 1:if(0===i.wrap){i.mode=13;break}for(;g<16;){if(0===f)break t;f--,_+=h[d++]<<g,g+=8}if(2&i.wrap&&35615===_){i.check=0,L[0]=255&_,L[1]=_>>>8&255,i.check=r(i.check,L,2,0),_=0,g=0,i.mode=2;break}if(i.flags=0,i.head&&(i.head.done=!1),!(1&i.wrap)||(((255&_)<<8)+(_>>8))%31){t.msg="incorrect header check",i.mode=30;break}if(8!=(15&_)){t.msg="unknown compression method",i.mode=30;break}if(g-=4,z=8+(15&(_>>>=4)),0===i.wbits)i.wbits=z;else if(z>i.wbits){t.msg="invalid window size",i.mode=30;break}i.dmax=1<<z,t.adler=i.check=1,i.mode=512&_?10:12,_=0,g=0;break;case 2:for(;g<16;){if(0===f)break t;f--,_+=h[d++]<<g,g+=8}if(i.flags=_,8!=(255&i.flags)){t.msg="unknown compression method",i.mode=30;break}if(57344&i.flags){t.msg="unknown header flags set",i.mode=30;break}i.head&&(i.head.text=_>>8&1),512&i.flags&&(L[0]=255&_,L[1]=_>>>8&255,i.check=r(i.check,L,2,0)),_=0,g=0,i.mode=3;case 3:for(;g<32;){if(0===f)break t;f--,_+=h[d++]<<g,g+=8}i.head&&(i.head.time=_),512&i.flags&&(L[0]=255&_,L[1]=_>>>8&255,L[2]=_>>>16&255,L[3]=_>>>24&255,i.check=r(i.check,L,4,0)),_=0,g=0,i.mode=4;case 4:for(;g<16;){if(0===f)break t;f--,_+=h[d++]<<g,g+=8}i.head&&(i.head.xflags=255&_,i.head.os=_>>8),512&i.flags&&(L[0]=255&_,L[1]=_>>>8&255,i.check=r(i.check,L,2,0)),_=0,g=0,i.mode=5;case 5:if(1024&i.flags){for(;g<16;){if(0===f)break t;f--,_+=h[d++]<<g,g+=8}i.length=_,i.head&&(i.head.extra_len=_),512&i.flags&&(L[0]=255&_,L[1]=_>>>8&255,i.check=r(i.check,L,2,0)),_=0,g=0}else i.head&&(i.head.extra=null);i.mode=6;case 6:if(1024&i.flags&&((v=i.length)>f&&(v=f),v&&(i.head&&(z=i.head.extra_len-i.length,i.head.extra||(i.head.extra=new Array(i.head.extra_len)),s.arraySet(i.head.extra,h,d,v,z)),512&i.flags&&(i.check=r(i.check,h,v,d)),f-=v,d+=v,i.length-=v),i.length))break t;i.length=0,i.mode=7;case 7:if(2048&i.flags){if(0===f)break t;v=0;do{z=h[d+v++],i.head&&z&&i.length<65536&&(i.head.name+=String.fromCharCode(z))}while(z&&v<f);if(512&i.flags&&(i.check=r(i.check,h,v,d)),f-=v,d+=v,z)break t}else i.head&&(i.head.name=null);i.length=0,i.mode=8;case 8:if(4096&i.flags){if(0===f)break t;v=0;do{z=h[d+v++],i.head&&z&&i.length<65536&&(i.head.comment+=String.fromCharCode(z))}while(z&&v<f);if(512&i.flags&&(i.check=r(i.check,h,v,d)),f-=v,d+=v,z)break t}else i.head&&(i.head.comment=null);i.mode=9;case 9:if(512&i.flags){for(;g<16;){if(0===f)break t;f--,_+=h[d++]<<g,g+=8}if(_!==(65535&i.check)){t.msg="header crc mismatch",i.mode=30;break}_=0,g=0}i.head&&(i.head.hcrc=i.flags>>9&1,i.head.done=!0),t.adler=i.check=0,i.mode=12;break;case 10:for(;g<32;){if(0===f)break t;f--,_+=h[d++]<<g,g+=8}t.adler=i.check=l(_),_=0,g=0,i.mode=11;case 11:if(0===i.havedict)return t.next_out=u,t.avail_out=p,t.next_in=d,t.avail_in=f,i.hold=_,i.bits=g,2;t.adler=i.check=1,i.mode=12;case 12:if(5===e||6===e)break t;case 13:if(i.last){_>>>=7&g,g-=7&g,i.mode=27;break}for(;g<3;){if(0===f)break t;f--,_+=h[d++]<<g,g+=8}switch(i.last=1&_,g-=1,3&(_>>>=1)){case 0:i.mode=14;break;case 1:if(m(i),i.mode=20,6===e){_>>>=2,g-=2;break t}break;case 2:i.mode=17;break;case 3:t.msg="invalid block type",i.mode=30}_>>>=2,g-=2;break;case 14:for(_>>>=7&g,g-=7&g;g<32;){if(0===f)break t;f--,_+=h[d++]<<g,g+=8}if((65535&_)!=(_>>>16^65535)){t.msg="invalid stored block lengths",i.mode=30;break}if(i.length=65535&_,_=0,g=0,i.mode=15,6===e)break t;case 15:i.mode=16;case 16:if(v=i.length){if(v>f&&(v=f),v>p&&(v=p),0===v)break t;s.arraySet(c,h,d,v,u),f-=v,d+=v,p-=v,u+=v,i.length-=v;break}i.mode=12;break;case 17:for(;g<14;){if(0===f)break t;f--,_+=h[d++]<<g,g+=8}if(i.nlen=257+(31&_),_>>>=5,g-=5,i.ndist=1+(31&_),_>>>=5,g-=5,i.ncode=4+(15&_),_>>>=4,g-=4,i.nlen>286||i.ndist>30){t.msg="too many length or distance symbols",i.mode=30;break}i.have=0,i.mode=18;case 18:for(;i.have<i.ncode;){for(;g<3;){if(0===f)break t;f--,_+=h[d++]<<g,g+=8}i.lens[B[i.have++]]=7&_,_>>>=3,g-=3}for(;i.have<19;)i.lens[B[i.have++]]=0;if(i.lencode=i.lendyn,i.lenbits=7,O={bits:i.lenbits},P=a(0,i.lens,0,19,i.lencode,0,i.work,O),i.lenbits=O.bits,P){t.msg="invalid code lengths set",i.mode=30;break}i.have=0,i.mode=19;case 19:for(;i.have<i.nlen+i.ndist;){for(;S=(M=i.lencode[_&(1<<i.lenbits)-1])>>>16&255,T=65535&M,!((A=M>>>24)<=g);){if(0===f)break t;f--,_+=h[d++]<<g,g+=8}if(T<16)_>>>=A,g-=A,i.lens[i.have++]=T;else{if(16===T){for(E=A+2;g<E;){if(0===f)break t;f--,_+=h[d++]<<g,g+=8}if(_>>>=A,g-=A,0===i.have){t.msg="invalid bit length repeat",i.mode=30;break}z=i.lens[i.have-1],v=3+(3&_),_>>>=2,g-=2}else if(17===T){for(E=A+3;g<E;){if(0===f)break t;f--,_+=h[d++]<<g,g+=8}g-=A,z=0,v=3+(7&(_>>>=A)),_>>>=3,g-=3}else{for(E=A+7;g<E;){if(0===f)break t;f--,_+=h[d++]<<g,g+=8}g-=A,z=0,v=11+(127&(_>>>=A)),_>>>=7,g-=7}if(i.have+v>i.nlen+i.ndist){t.msg="invalid bit length repeat",i.mode=30;break}for(;v--;)i.lens[i.have++]=z}}if(30===i.mode)break;if(0===i.lens[256]){t.msg="invalid code -- missing end-of-block",i.mode=30;break}if(i.lenbits=9,O={bits:i.lenbits},P=a(1,i.lens,0,i.nlen,i.lencode,0,i.work,O),i.lenbits=O.bits,P){t.msg="invalid literal/lengths set",i.mode=30;break}if(i.distbits=6,i.distcode=i.distdyn,O={bits:i.distbits},P=a(2,i.lens,i.nlen,i.ndist,i.distcode,0,i.work,O),i.distbits=O.bits,P){t.msg="invalid distances set",i.mode=30;break}if(i.mode=20,6===e)break t;case 20:i.mode=21;case 21:if(f>=6&&p>=258){t.next_out=u,t.avail_out=p,t.next_in=d,t.avail_in=f,i.hold=_,i.bits=g,o(t,w),u=t.next_out,c=t.output,p=t.avail_out,d=t.next_in,h=t.input,f=t.avail_in,_=i.hold,g=i.bits,12===i.mode&&(i.back=-1);break}for(i.back=0;S=(M=i.lencode[_&(1<<i.lenbits)-1])>>>16&255,T=65535&M,!((A=M>>>24)<=g);){if(0===f)break t;f--,_+=h[d++]<<g,g+=8}if(S&&0==(240&S)){for(R=A,I=S,C=T;S=(M=i.lencode[C+((_&(1<<R+I)-1)>>R)])>>>16&255,T=65535&M,!(R+(A=M>>>24)<=g);){if(0===f)break t;f--,_+=h[d++]<<g,g+=8}_>>>=R,g-=R,i.back+=R}if(_>>>=A,g-=A,i.back+=A,i.length=T,0===S){i.mode=26;break}if(32&S){i.back=-1,i.mode=12;break}if(64&S){t.msg="invalid literal/length code",i.mode=30;break}i.extra=15&S,i.mode=22;case 22:if(i.extra){for(E=i.extra;g<E;){if(0===f)break t;f--,_+=h[d++]<<g,g+=8}i.length+=_&(1<<i.extra)-1,_>>>=i.extra,g-=i.extra,i.back+=i.extra}i.was=i.length,i.mode=23;case 23:for(;S=(M=i.distcode[_&(1<<i.distbits)-1])>>>16&255,T=65535&M,!((A=M>>>24)<=g);){if(0===f)break t;f--,_+=h[d++]<<g,g+=8}if(0==(240&S)){for(R=A,I=S,C=T;S=(M=i.distcode[C+((_&(1<<R+I)-1)>>R)])>>>16&255,T=65535&M,!(R+(A=M>>>24)<=g);){if(0===f)break t;f--,_+=h[d++]<<g,g+=8}_>>>=R,g-=R,i.back+=R}if(_>>>=A,g-=A,i.back+=A,64&S){t.msg="invalid distance code",i.mode=30;break}i.offset=T,i.extra=15&S,i.mode=24;case 24:if(i.extra){for(E=i.extra;g<E;){if(0===f)break t;f--,_+=h[d++]<<g,g+=8}i.offset+=_&(1<<i.extra)-1,_>>>=i.extra,g-=i.extra,i.back+=i.extra}if(i.offset>i.dmax){t.msg="invalid distance too far back",i.mode=30;break}i.mode=25;case 25:if(0===p)break t;if(v=w-p,i.offset>v){if((v=i.offset-v)>i.whave&&i.sane){t.msg="invalid distance too far back",i.mode=30;break}v>i.wnext?(v-=i.wnext,x=i.wsize-v):x=i.wnext-v,v>i.length&&(v=i.length),k=i.window}else k=c,x=u-i.offset,v=i.length;v>p&&(v=p),p-=v,i.length-=v;do{c[u++]=k[x++]}while(--v);0===i.length&&(i.mode=21);break;case 26:if(0===p)break t;c[u++]=i.length,p--,i.mode=21;break;case 27:if(i.wrap){for(;g<32;){if(0===f)break t;f--,_|=h[d++]<<g,g+=8}if(w-=p,t.total_out+=w,i.total+=w,w&&(t.adler=i.check=i.flags?r(i.check,c,w,u-w):n(i.check,c,w,u-w)),w=p,(i.flags?_:l(_))!==i.check){t.msg="incorrect data check",i.mode=30;break}_=0,g=0}i.mode=28;case 28:if(i.wrap&&i.flags){for(;g<32;){if(0===f)break t;f--,_+=h[d++]<<g,g+=8}if(_!==(4294967295&i.total)){t.msg="incorrect length check",i.mode=30;break}_=0,g=0}i.mode=29;case 29:P=1;break t;case 30:P=-3;break t;case 31:return-4;case 32:default:return-2}return t.next_out=u,t.avail_out=p,t.next_in=d,t.avail_in=f,i.hold=_,i.bits=g,(i.wsize||w!==t.avail_out&&i.mode<30&&(i.mode<27||4!==e))&&y(t,t.output,t.next_out,w-t.avail_out)?(i.mode=31,-4):(b-=t.avail_in,w-=t.avail_out,t.total_in+=b,t.total_out+=w,i.total+=w,i.wrap&&w&&(t.adler=i.check=i.flags?r(i.check,c,w,t.next_out-w):n(i.check,c,w,t.next_out-w)),t.data_type=i.bits+(i.last?64:0)+(12===i.mode?128:0)+(20===i.mode||15===i.mode?256:0),(0===b&&0===w||4===e)&&0===P&&(P=-5),P)},e.inflateEnd=function(t){if(!t||!t.state)return-2;var e=t.state;return e.window&&(e.window=null),t.state=null,0},e.inflateGetHeader=function(t,e){var i;return t&&t.state?0==(2&(i=t.state).wrap)?-2:(i.head=e,e.done=!1,0):-2},e.inflateSetDictionary=function(t,e){var i,s=e.length;return t&&t.state?0!==(i=t.state).wrap&&11!==i.mode?-2:11===i.mode&&n(1,e,s,0)!==i.check?-3:y(t,e,s,s)?(i.mode=31,-4):(i.havedict=1,0):-2},e.inflateInfo="pako inflate (from Nodeca project)"},function(t,e,i){"use strict";t.exports=function(t,e){var i,s,n,r,o,a,l,h,c,d,u,f,p,_,g,m,y,b,w,v,x,k,A,S,T;i=t.state,s=t.next_in,S=t.input,n=s+(t.avail_in-5),r=t.next_out,T=t.output,o=r-(e-t.avail_out),a=r+(t.avail_out-257),l=i.dmax,h=i.wsize,c=i.whave,d=i.wnext,u=i.window,f=i.hold,p=i.bits,_=i.lencode,g=i.distcode,m=(1<<i.lenbits)-1,y=(1<<i.distbits)-1;t:do{p<15&&(f+=S[s++]<<p,p+=8,f+=S[s++]<<p,p+=8),b=_[f&m];e:for(;;){if(f>>>=w=b>>>24,p-=w,0===(w=b>>>16&255))T[r++]=65535&b;else{if(!(16&w)){if(0==(64&w)){b=_[(65535&b)+(f&(1<<w)-1)];continue e}if(32&w){i.mode=12;break t}t.msg="invalid literal/length code",i.mode=30;break t}v=65535&b,(w&=15)&&(p<w&&(f+=S[s++]<<p,p+=8),v+=f&(1<<w)-1,f>>>=w,p-=w),p<15&&(f+=S[s++]<<p,p+=8,f+=S[s++]<<p,p+=8),b=g[f&y];i:for(;;){if(f>>>=w=b>>>24,p-=w,!(16&(w=b>>>16&255))){if(0==(64&w)){b=g[(65535&b)+(f&(1<<w)-1)];continue i}t.msg="invalid distance code",i.mode=30;break t}if(x=65535&b,p<(w&=15)&&(f+=S[s++]<<p,(p+=8)<w&&(f+=S[s++]<<p,p+=8)),(x+=f&(1<<w)-1)>l){t.msg="invalid distance too far back",i.mode=30;break t}if(f>>>=w,p-=w,x>(w=r-o)){if((w=x-w)>c&&i.sane){t.msg="invalid distance too far back",i.mode=30;break t}if(k=0,A=u,0===d){if(k+=h-w,w<v){v-=w;do{T[r++]=u[k++]}while(--w);k=r-x,A=T}}else if(d<w){if(k+=h+d-w,(w-=d)<v){v-=w;do{T[r++]=u[k++]}while(--w);if(k=0,d<v){v-=w=d;do{T[r++]=u[k++]}while(--w);k=r-x,A=T}}}else if(k+=d-w,w<v){v-=w;do{T[r++]=u[k++]}while(--w);k=r-x,A=T}for(;v>2;)T[r++]=A[k++],T[r++]=A[k++],T[r++]=A[k++],v-=3;v&&(T[r++]=A[k++],v>1&&(T[r++]=A[k++]))}else{k=r-x;do{T[r++]=T[k++],T[r++]=T[k++],T[r++]=T[k++],v-=3}while(v>2);v&&(T[r++]=T[k++],v>1&&(T[r++]=T[k++]))}break}}break}}while(s<n&&r<a);s-=v=p>>3,f&=(1<<(p-=v<<3))-1,t.next_in=s,t.next_out=r,t.avail_in=s<n?n-s+5:5-(s-n),t.avail_out=r<a?a-r+257:257-(r-a),i.hold=f,i.bits=p}},function(t,e,i){"use strict";var s=i(3),n=[3,4,5,6,7,8,9,10,11,13,15,17,19,23,27,31,35,43,51,59,67,83,99,115,131,163,195,227,258,0,0],r=[16,16,16,16,16,16,16,16,17,17,17,17,18,18,18,18,19,19,19,19,20,20,20,20,21,21,21,21,16,72,78],o=[1,2,3,4,5,7,9,13,17,25,33,49,65,97,129,193,257,385,513,769,1025,1537,2049,3073,4097,6145,8193,12289,16385,24577,0,0],a=[16,16,16,16,17,17,18,18,19,19,20,20,21,21,22,22,23,23,24,24,25,25,26,26,27,27,28,28,29,29,64,64];t.exports=function(t,e,i,l,h,c,d,u){var f,p,_,g,m,y,b,w,v,x=u.bits,k=0,A=0,S=0,T=0,R=0,I=0,C=0,z=0,P=0,O=0,E=null,M=0,L=new s.Buf16(16),B=new s.Buf16(16),U=null,D=0;for(k=0;k<=15;k++)L[k]=0;for(A=0;A<l;A++)L[e[i+A]]++;for(R=x,T=15;T>=1&&0===L[T];T--);if(R>T&&(R=T),0===T)return h[c++]=20971520,h[c++]=20971520,u.bits=1,0;for(S=1;S<T&&0===L[S];S++);for(R<S&&(R=S),z=1,k=1;k<=15;k++)if(z<<=1,(z-=L[k])<0)return-1;if(z>0&&(0===t||1!==T))return-1;for(B[1]=0,k=1;k<15;k++)B[k+1]=B[k]+L[k];for(A=0;A<l;A++)0!==e[i+A]&&(d[B[e[i+A]]++]=A);if(0===t?(E=U=d,y=19):1===t?(E=n,M-=257,U=r,D-=257,y=256):(E=o,U=a,y=-1),O=0,A=0,k=S,m=c,I=R,C=0,_=-1,g=(P=1<<R)-1,1===t&&P>852||2===t&&P>592)return 1;for(;;){b=k-C,d[A]<y?(w=0,v=d[A]):d[A]>y?(w=U[D+d[A]],v=E[M+d[A]]):(w=96,v=0),f=1<<k-C,S=p=1<<I;do{h[m+(O>>C)+(p-=f)]=b<<24|w<<16|v|0}while(0!==p);for(f=1<<k-1;O&f;)f>>=1;if(0!==f?(O&=f-1,O+=f):O=0,A++,0==--L[k]){if(k===T)break;k=e[i+d[A]]}if(k>R&&(O&g)!==_){for(0===C&&(C=R),m+=S,z=1<<(I=k-C);I+C<T&&!((z-=L[I+C])<=0);)I++,z<<=1;if(P+=1<<I,1===t&&P>852||2===t&&P>592)return 1;h[_=O&g]=R<<24|I<<16|m-c|0}}return 0!==O&&(h[m+O]=k-C<<24|64<<16|0),u.bits=R,0}},function(t,e,i){"use strict";t.exports=function(){this.text=0,this.time=0,this.xflags=0,this.os=0,this.extra=null,this.extra_len=0,this.name="",this.comment="",this.hcrc=0,this.done=!1}},function(t,e,i){"use strict";i.r(e);class s{constructor(){this._listeners=new Map}addListener(t,e){this._listeners.set(t,e)}removeListener(t){this._listeners.delete(t)}fire(...t){for(const[e,i]of this._listeners)e.call(i,...t)}}class n{constructor(t){this._rootCommunicator=t,this._listeners={},this._rootCommunicator.onMessage.addListener(this._onMessage,this)}destructor(){this._rootCommunicator.onMessage.removeListener(this._onMessage)}getCommunicator(t){let e=this._listeners[t];return e||(e=new s,this._listeners[t]=e),{onMessage:e,sendMessage:(e,i,...s)=>{this._rootCommunicator.sendMessage({type:t,message:e},i,...s)}}}_onMessage(t){const e=this._listeners[t.type];e&&e.fire(t.message)}}class r{constructor(t){this._worker=t,this._scheduledFlush=function(t,e=!1){let i=!1;return(...s)=>{e&&i||(Promise.resolve().then(()=>{t(...s),i=!1}),i=!0)}}(()=>t.flushMessages()),this.onMessage=this._onMessage=new s,t.onMessage(t=>{this._onMessage.fire(t)})}sendMessage(t,e,...i){this._worker.addMessage(t,i),e&&this._scheduledFlush()}}class o{constructor(){this._contentPortions=[]}destructor(){this._releaseResources()}addContent(t,e){const i={content:t,resources:e};if(this._contentPortions.push(i),i.resources)for(const s of i.resources)s.retain()}hasContent(){return 0!==this._contentPortions.length}_releaseResources(){for(const t of this._contentPortions)if(t.resources)for(const e of t.resources)e.release()}}class a extends o{constructor(t,e){super(),this.id=t.id,this.tile=t,this._state=e,this.onStateChanged=this._onStateChanged=new s}get state(){return this._state}set state(t){const e=this._state;t!==e&&(this._state=t,this._onStateChanged.fire(this,e,t))}destructor(){this.state=3,super.destructor()}}class l extends class{constructor(){this._items=new Map,this.onAdded=this._onAdded=new s,this.onRemoved=this._onRemoved=new s}get size(){return this._items.size}get items(){return this._items.values()}get(t){return this._items.get(t)}has(t){return this._items.has(t)}_add(t,e){this._items.set(t,e),this._onAdded.fire(e)}_remove(t){const e=this._items.get(t);e&&(this._items.delete(t),this._onRemoved.fire(e))}}{add(t,e){this._add(t,e)}remove(t){this._remove(t)}}class h extends l{constructor(t){super(),this._communicator=t}add(t,e,i=!1){super.add(t,e),this._communicator.sendMessage({type:0,id:t,item:this._serialize(e)},i)}remove(t,e=!1){super.remove(t),this._communicator.sendMessage({type:1,id:t},e)}}class c extends h{getOrCreate(t,e){const i=this.get(t.id);if(i)return i;{const i=new a(t,e);return this.add(t.id,i),i}}_serialize(t){return Object.assign(Object.assign({},t.tile),{id:t.id})}}function d(t,e){return t.x+"_"+t.y+"_"+t.zoom+"_"+e}function u(t,e){return Object.assign(Object.assign({},t),{id:d(t,e)})}function f(t,e){const i=[];for(const[s,n]of t)e.has(s)||i.push(n);return i}function p(t,e,i){let s=t.get(e);return s||(s=i(),t.set(e,s)),s}function _(t,e,i=1e-6){const s=t-e;return-i<s&&s<i}function g(t,e){return{x:t,y:e}}const m=g(0,0);g(1,0),g(-1,0),g(0,1),g(0,-1);function y(t,e=g(0,0)){return e.x=t.x,e.y=t.y,e}function b(t,e,i=g(0,0)){return i.x=t.x+e.x,i.y=t.y+e.y,i}function w(t,e,i=g(0,0)){return i.x=t.x-e.x,i.y=t.y-e.y,i}function v(t,e,i=g(0,0)){return i.x=t.x/e,i.y=t.y/e,i}function x(t,e,i=g(0,0)){const s=t.x,n=t.y,r=Math.cos(e),o=Math.sin(e);return i.x=r*s-o*n,i.y=o*s+r*n,i}function k(t,e=g(0,0)){const i=t.y;return e.y=t.x,e.x=-i,e}function A(t){return Math.hypot(t.x,t.y)}function S(t,e){return Math.sqrt((t.x-e.x)*(t.x-e.x)+(t.y-e.y)*(t.y-e.y))}function T(t,e=g(0,0)){return v(t,A(t),e)}function R(t,e){return t.x*e.x+t.y*e.y}const I={minX:0,maxX:0,minY:0,maxY:0};function C(t,e,i,s){return{minX:t,maxX:e,minY:i,maxY:s}}function z(t,e=C(0,0,0,0)){return e.minX=t.minX,e.maxX=t.maxX,e.minY=t.minY,e.maxY=t.maxY,e}function P(t,e,i={minX:0,maxX:0,minY:0,maxY:0}){return i.minX=Math.min(t.minX,e.minX),i.minY=Math.min(t.minY,e.minY),i.maxX=Math.max(t.maxX,e.maxX),i.maxY=Math.max(t.maxY,e.maxY),i}function O({minX:t,maxX:e,minY:i,maxY:s}){return g((t+e)/2,(i+s)/2)}function E(t,e,i){return`${t}:${e}:${i}`}function M(t){return E(t.x,t.y,t.zoom)}function L(t,e,i){return e<t?t<i?t:i:e}function B(t,e,i){const s=(t-e)/(i-e);return e+(i-e)*(s-Math.floor(s))}function U(t,e,i){return(1-i)*t+i*e}function D(t,e,i){const s=L((i-t)/(e-t),0,1);return s*s*(3-2*s)}const j={direction:g(0,-1),normal:g(-1,0),diagonal:g(-1,-1),prevSide:()=>W,nextSide:()=>V},N={direction:g(0,1),normal:g(1,0),diagonal:g(1,1),prevSide:()=>V,nextSide:()=>W},V={direction:g(1,0),normal:g(0,-1),diagonal:g(1,-1),prevSide:()=>j,nextSide:()=>N},W={direction:g(-1,0),normal:g(0,1),diagonal:g(-1,1),prevSide:()=>N,nextSide:()=>j};function q(t,e,i,s,n){t.x=s?B(t.x,0,i):t.x,t.y=n?B(t.y,0,i):t.y,0<=t.x&&t.x<i&&0<=t.y&&t.y<i&&e.set(M(t),t)}function G(t,e,i,s,n,r){for(let l=1;l<=i;l++)q({x:e.currentTile.x+l*e.currentTileSide.normal.x,y:e.currentTile.y+l*e.currentTileSide.normal.y,zoom:e.currentTile.zoom},e.beltTiles,s,n,r);const o=t.get(E(e.currentTile.x+e.currentTileSide.diagonal.x,e.currentTile.y+e.currentTileSide.diagonal.y,e.currentTile.zoom));if(o)return e.currentTile=o,void(e.currentTileSide=e.currentTileSide.prevSide());const a=t.get(E(e.currentTile.x+e.currentTileSide.direction.x,e.currentTile.y+e.currentTileSide.direction.y,e.currentTile.zoom));if(a)e.currentTile=a;else{for(let t=1;t<=i;t++)for(let o=1;o<=i;o++)q({x:e.currentTile.x+t*e.currentTileSide.diagonal.x,y:e.currentTile.y+o*e.currentTileSide.diagonal.y,zoom:e.currentTile.zoom},e.beltTiles,s,n,r);e.currentTileSide=e.currentTileSide.nextSide()}}class F{constructor(t,e){this._communicator=t,this._storage=e,this._visibleTiles=new Map,this._beltTiles=new Map,this.onViewportChanged=this._onViewportChanged=new s,this._cameraPosition={x:0,y:0,zoom:0},this._communicator.onMessage.addListener(this._onMessage,this)}get cameraPosition(){return this._cameraPosition}destructor(){this._communicator.onMessage.removeListener(this._onMessage)}_onMessage(t){switch(t.type){case 0:this._onSetup(t);break;case 1:this._onViewportUpdate(t)}}_onSetup(t){this._tileIdPrefix=t.tileIdPrefix,this._preloadedTilesBeltWidth=t.preloadedTilesBeltWidth,this._useLowPrecisionBeltTiles=t.useLowPrecisionBeltTiles,this._wrapModeX=t.wrapModeX,this._wrapModeY=t.wrapModeY}_onViewportUpdate(t){const e=this._visibleTiles;for(const o of t.visibleTilesToAdd)this._visibleTiles.set(o.id,o);for(const o of t.visibleTilesToRemove)this._visibleTiles.delete(o.id);const i=this._beltTiles,s=this._calculateBeltTiles(e),n=f(s,i),r=f(i,s);for(const o of t.visibleTilesToAdd){this._storage.getOrCreate(o,0).state=0}for(const o of n){this._storage.getOrCreate(o,1).state=1}for(const o of t.visibleTilesToRemove){const t=this._storage.getOrCreate(o,0);1!==t.state&&(t.state=2)}for(const o of r){const t=this._storage.getOrCreate(o,1);0!==t.state&&(t.state=2)}this._visibleTiles=e,this._beltTiles=s,this._cameraPosition=t.cameraPosition,this._onViewportChanged.fire({cameraPosition:t.cameraPosition,visibleAdded:t.visibleTilesToAdd,visibleRemoved:t.visibleTilesToRemove,preloadedAdded:n,preloadedRemoved:r})}_calculateBeltTiles(t){const e=new Map;let i;if(this._useLowPrecisionBeltTiles){i=this._getCoveringParents(t);for(const s of i.values())for(let i=0;i<=1;i++)for(let n=0;n<=1;n++){const r=u({x:2*s.x+i,y:2*s.y+n,zoom:s.zoom+1},this._tileIdPrefix);t.has(r.id)||e.set(r.id,r)}}else i=t;for(const s of function(t,e,i,s){const n=new Map,r=new Map;for(const a of t)n.set(M(a),a);const o=new Map(n);for(;o.size>0;){let t={x:Number.POSITIVE_INFINITY,y:0,zoom:0};for(const e of o.values())e.x<t.x&&(t=e);const n=[],a=[],l={currentTile:t,currentTileSide:j,beltTiles:r},h=Object.assign({},l),c=Math.pow(2,t.zoom);do{G(o,h,e,c,i,s);const t=h.currentTile.x-l.currentTile.x;n[t]=void 0===n[t]?h.currentTile.y:Math.max(n[t],h.currentTile.y),a[t]=void 0===a[t]?h.currentTile.y:Math.min(a[t],h.currentTile.y)}while(h.currentTile!==l.currentTile||h.currentTileSide!==l.currentTileSide);const d=t.zoom;for(let e=0;e<n.length;e++){const i=t.x+e;for(let t=a[e];t<=n[e];t++)o.delete(E(i,t,d))}}for(const a of r.keys())n.has(a)&&r.delete(a);return r.values()}(i.values(),this._preloadedTilesBeltWidth,2===this._wrapModeX,2===this._wrapModeY)){const t=u(s,this._tileIdPrefix);e.set(t.id,t)}return e}_getCoveringParents(t){const e=new Map;for(const i of t.values()){const t=i.zoom-1;if(t>=0){const s=u({x:i.x/2|0,y:i.y/2|0,zoom:t},this._tileIdPrefix);e.set(s.id,s)}}return e}}var Y=i(0),X=i(5),Z=X.yandex.maps.proto.renderer.vmap2.Presentation,H=X.yandex.maps.proto.renderer.vmap2.Tile,K=X.yandex.maps.proto.renderer.glyphs.GlyphList,$=X.yandex.maps.proto.renderer.layers.basemap.Tag,Q=X.yandex.maps.proto.indoor.Plan;X.yandex.maps.proto.common2.geometry.BoundingBox;function J(t){return t?t.classId.length:0}function tt(t,e,i,s,n,r){let o=t.get(e);o||(o=new Map,t.set(e,o));for(let a=0;a<i.length;++a)o.set(i[a],s[n+a]);o.set("objectId",r)}function et(t,e=!1){const i={points:new Map,polylines:new Map,polygons:new Map,pointLabels:new Map,curvedLabels:new Map},{points:s,polylines:n,polygons:r,pointLabels:o,layers:a}=t,l=J(s),h=l+J(n),c=h+J(r),d=c+J(o);for(const u of a){const{keys:t,values:e}=u;if(0!==t.length)for(let s=0,n=0,r=u.ids.length;s<r;++s,n+=t.length){const r=u.objectIndices[s],o=u.ids[s];switch(!0){case r>=d:tt(i.curvedLabels,r-d,t,e,n,o);break;case r>=c:tt(i.pointLabels,r-c,t,e,n,o);break;case r>=h:tt(i.polygons,r-h,t,e,n,o);break;case r>=l:tt(i.polylines,r-l,t,e,n,o);break;default:tt(i.points,r,t,e,n,o)}}}if(function(t,e){const{polygons:i}=t;if(i)for(let s=0,n=0;s<i.classId.length;s++){const t=i.contourIndex[s],r=e.polygons.get(s);if(!r||t<0)continue;const o=i.contourCount[n];for(let i=0;i<o;i++)e.polylines.set(t+i,r);n++}}(t,i),e){const e=()=>{const t=new Map([["_vector_id","0"]]);return()=>t};it(t.points,i.points,e()),it(t.polylines,i.polylines,e()),it(t.polygons,i.polygons,e()),it(t.pointLabels,i.pointLabels,e()),it(t.polylineLabels,i.curvedLabels,e())}return i}function it(t,e,i=(()=>new Map)){if(t)for(let s=0;s<t.classId.length;s++)e.has(s)||e.set(s,i())}function st(t){return 2/(1<<t)}class nt{constructor(t){this._zoom=Math.ceil(L(t,0,31)),this._tileSize=st(this._zoom)}getZoom(){return this._zoom}getTileSize(){return this._tileSize}getTileOffset(t){return{x:this.getTileSize()*t.x-1,y:1-this.getTileSize()*t.y}}toTileCoordinates(t){return{x:(t.x+1)/this._tileSize,y:(1-t.y)/this._tileSize}}}function rt(t,e){return-16384===t||16383===t||-16384===e||16383===e}class ot{constructor(t){const e=new nt(t.zoom),i=e.getTileOffset(t),s=e.getTileSize(),n=s/2;this._tileCenter=g(i.x+n,i.y-n),this._tileWorldRatio=s/32767}toWorldXCoordinate(t){return L(this._tileCenter.x+t*this._tileWorldRatio,-1,1)}toWorldYCoordinate(t){return L(this._tileCenter.y-t*this._tileWorldRatio,-1,1)}toWorldZCoordinate(t){return t*this._tileWorldRatio}toWorldCoordinates(t,e){return g(this.toWorldXCoordinate(t),this.toWorldYCoordinate(e))}}const at={minZoom:0,maxZoom:0,zIndex:0,classId:0};function*lt(t,e,i,s,n=ht(0)){const r=(t.find(t=>t.name===n)||t[0]).classes[e];if(r)for(const o of r.slices)if(o.visibility){at.minZoom=o.visibility.min===s.zoom?-1/0:o.visibility.min,at.maxZoom=o.visibility.max===s.zoom?1/0:o.visibility.max,at.zIndex=o.zIndex,at.classId=e;const t=i(o,at);t&&(yield t)}}function ht(t){switch(t){case 0:return"map";case 1:return"map.night"}}dt(0,0,0,1),dt(1,1,0,1);const ct=dt(0,0,0,0);function dt(t,e,i,s=1){return{r:t,g:e,b:i,a:s}}function ut(t){return{r:(t>>>24)/255,g:(t>>>16&255)/255,b:(t>>>8&255)/255,a:(255&t)/255}}function ft(t,e,i,s){return 255*t|255*e<<8|255*i<<16|255*s<<24}function pt(t){return ft(t.r,t.g,t.b,t.a)}const _t=/^(0x|#)?(([a-fA-F0-9]{3}){1,2}|([a-fA-F0-9]{4}){1,2})$/;function gt(t,e,i){const s=t.substring(i*e,(i+1)*e),n=(1<<4*e)-1;return parseInt(s,16)/n}function mt(t){const e=_t.exec(t);if(!e)return null;const i=e[2],s=i.length>4?2:1;return dt(gt(i,s,0),gt(i,s,1),gt(i,s,2),i.length%4?1:gt(i,s,3))}function yt(t){const e=(255*t).toString(16);return 2===e.length?e:"0"+e}function bt(t){const{r:e,g:i,b:s,a:n}=t;return yt(e)+yt(i)+yt(s)+(n<1?yt(n):"")}const wt=/^rgba?\\s*\\(\\s*(\\d+)\\s*,\\s*(\\d+)\\s*,\\s*(\\d+)\\s*,?\\s*(\\d+)?\\s*\\)$/i;const vt={min:512,max:65535},xt={min:65536,max:4294967294};const kt=new Array;function At(t){switch(t){case 1:return-1;case 2:return-2;default:return 0}}function St(t,e){return t.zoom-At(e)}function Tt(t,e){return(t&e)===e}function Rt(t,e){return 0!=(t&e)}const It=[],Ct={};function zt(t){const e=[0,0];for(const i of t)e[i/32&1]|=1<<i%32;return e}function Pt(t){const e=[];for(const i of t){const t="number"==typeof i?i:Ct[i];if(void 0===t)return console.warn(`unknown "tag": "${i}"`),null;e.push(t)}return zt(e)}function Ot(t,e){return Rt(t[0],e[0])||Rt(t[1],e[1])}function Et(t,e,i){if(void 0===t&&void 0===e&&void 0===i)return()=>!0;const s=t&&Pt(t),n=e&&Pt(e),r=i&&Pt(i);return null===s||null===n||null===r?(console.warn(`not valid "tags": all=[${t||[]}] any=[${e||[]}] none=[${i||[]}]`),()=>!1):t=>{const e=zt(t);return(!s||(o=s,Tt((i=e)[0],o[0])&&Tt(i[1],o[1])))&&(!n||Ot(e,n))&&(!r||!Ot(e,r));var i,o}}function Mt(t,e){const i=t.metadata[e],s=i&&i[".yandex.maps.proto.renderer.common.TAG_METADATA"];return s?s.tags:It}function Lt(t,e=3){const i=Math.floor(t.length/e),s=g(0,0);for(let n=0;n<e;n++)b(s,t[n*i],s);return v(s,e,s)}function*Bt(t,e,i,s){let n=0,r=0;for(let o=0;o<i;o++)n+=t.coordsx[e],r+=t.coordsy[e],yield s.toWorldCoordinates(n,r),e++}function*Ut(t,e,i,s,n){for(let r=0;r<s;r++){const s=t.ringSize[i+r];yield Bt(t,e,s,n),e+=s}}function Dt(t,e,i,s,n,r,o){if(o&&o.bbox){return{id:t,metadata:e,objectId:(1===r?"night_":"")+o.objectId,meshId:o.meshId,bbox:{minX:s.toWorldXCoordinate(o.bbox.minX),maxX:s.toWorldXCoordinate(o.bbox.maxX),minY:s.toWorldYCoordinate(o.bbox.maxY),maxY:s.toWorldYCoordinate(o.bbox.minY),minZ:i,maxZ:0},color:n[0].color}}}function jt(t,e){if(t.poly){const i=!!t.poly.extrusion&&t.poly.extrusion.enabled;return Object.assign(Object.assign({},e),{color:ut(t.poly.color),pattern:t.poly.pattern?{imageId:t.poly.pattern.id,scale:t.poly.pattern.scale}:void 0,extruded:i,height:i?t.poly.extrusion.height:0})}}function*Nt(t,e,i,s,n,r,o){const{polygons:a}=e;if(a){const l=new ot(t);let h=0,c=0,d=0;const u=a.mesh.reduce((t,e)=>(t.set(e.polygonId,e),t),new Map);for(;h<a.ringCount.length;){const f=a.ringCount[h],p=c,_=d,g=a.classId[h],m=i.polygons.get(h),y=Mt(a,h),b=[...lt(e.presentation,g,jt,t,ht(r))];o.customizePolygon(b,y,St(t,n));const w=m?s(m.get("_vector_id")):4294967295,v=b[0]&&b[0].extruded,x=v?l.toWorldZCoordinate(a.height[h]||b[0].height||0):0,k=v?Dt(w,m,x,l,b,r,u.get(h)):void 0;let A=0;for(let t=0;t<f;t++)A+=a.ringSize[c+t];const S=[...Object(Y.c)(Ut(a,_,p,f,l),t=>[...t])];if(v&&m){const t=k?O(k.bbox):Lt(S[0],3);m.set("position",`${t.x},${t.y}`)}const T=a.contourIndex[h];yield{id:w,vertexRings:S,height:x,externalMesh:k,metadata:m,styles:b,hasContour:-1===T},c+=f,d+=A,h++}}}function Vt(t,e=.5){const i=new Array(t.length);i[0]=0;for(let d=1;d<t.length;++d)i[d]=i[d-1]+S(t[d-1],t[d]);const s=e*i[t.length-1],n=i.findIndex(t=>t>=s)||1,r=function(t,e,i,s=g(0,0)){return s.x=(1-i)*t.x+i*e.x,s.y=(1-i)*t.y+i*e.y,s}(t[n-1],t[n],(s-i[n-1])/(i[n]-i[n-1]||1)),o=new Array(n+1);for(let d=0;d<n;++d)o[d]=t[d];o[n]=r;const a=function(t,e,i=1e-6){return _(t.x,e.x,i)&&_(t.y,e.y,i)}(t[n],r,1e-6*s),l=t.length-n,h=new Array(l+(a?0:1));let c=0;a||(h[c++]=y(r));for(let d=0;d<l;d++)h[c++]=t[n+d];return[o,h]}Object.keys($).forEach(t=>{Ct[t.toLowerCase()]=$[t]});const Wt={[Z.Class.LineStyle.JoinStyle.JoinMiter]:0,[Z.Class.LineStyle.JoinStyle.JoinRound]:1,[Z.Class.LineStyle.JoinStyle.JoinBevel]:2},qt={[Z.Class.LineStyle.CapStyle.CapButt]:0,[Z.Class.LineStyle.CapStyle.CapSquare]:2,[Z.Class.LineStyle.CapStyle.CapRound]:1};function Gt(t,e){return{strokeColor:t.pattern?ct:ut(t.color),strokeWidth:t.width,join:Wt[t.joins],startCap:qt[t.caps],endCap:qt[t.caps],dash:(i=t.dash,i&&i.dashes[0]&&i.dashes[0].gap>0?{fill:i.dashes[0].fill,gap:i.dashes[0].gap}:void 0),pattern:t.pattern?{imageId:t.pattern.id,scale:t.pattern.scale,height:t.width}:void 0,equidistantOffset:e};var i}function Ft(t,e){var i;const s=t.line&&t.line.line||t.poly&&t.poly.contour,n=t.line&&t.line.outline,r=null===(i=t.line)||void 0===i?void 0:i.equidistantOffset;return s||n?Object.assign(Object.assign({},e),{inline:s?Gt(s,r):void 0,outline:n?Gt(n,r):void 0}):void 0}function Yt(t,e){const i=t.poly&&t.poly.contour;return i?Object.assign(Object.assign({},e),{inline:Gt(i),outline:void 0}):void 0}function*Xt(t,e,i,s,n,r){let o=0;for(const a of i){const i=a.styles[0],l=Mt(e.polygons,o);if(++o,!a.hasContour||!i)continue;const h=[...lt(e.presentation,i.classId,Yt,t,ht(n))];if(h[0]){r.customizePolygonContour(h,l,St(t,s));for(const t of a.vertexRings)yield{vertices:t.concat(t[0]),styles:h,id:a.id,metadata:a.metadata}}}}function*Zt(t,e,i,s,n,r,o){const a=e.polylines;if(!a)return;const l=(i,s,a,l,h,c,d,u)=>{const f=[...lt(e.presentation,s,Ft,t,ht(r))];o.customizePolyline(f,h,St(t,n));for(const t of f)t.zIndex+=a,void 0!==d&&(t.inline&&(t.inline.startCap=d),t.outline&&(t.outline.startCap=d)),void 0!==u&&t.inline&&(t.inline&&(t.inline.endCap=u),t.outline&&(t.outline.endCap=u));return{vertices:i,styles:f,metadata:l,id:c}},h=new ot(t);for(let c=0,d=0;c<a.lineSize.length;++c){const t=0|a.zOrderBegin[c],e=0|a.zOrderEnd[c],n=a.lineSize[c],r=new Array(n);let o,u,f=0,p=0;for(let i=0;i<n;++i,++d)f+=a.coordsx[d],p+=a.coordsy[d],0===i&&rt(f,p)&&(o=0),i===n-1&&rt(f,p)&&(u=0),r[i]=g(h.toWorldXCoordinate(f),h.toWorldYCoordinate(p));const _=i.polylines.get(c),m=_?s(_.get("_vector_id")):4294967295,y=Mt(a,c);if(t!==e){const i=Vt(r);yield l(i[0],a.classId[c],t,_,y,m,o,u),yield l(i[1],a.classId[c],e,_,y,m,o,u)}else yield l(r,a.classId[c],t,_,y,m,o,u)}}function Ht(t){return t.styles.length>0}function Kt(t){return{color:ut(t.color),outlineColor:ut(t.outlineColor),fontId:t.fontId,fontSize:t.fontSize}}function $t(t,e){const i=[];if(t.label)return t.label.text&&i.push(Kt(t.label.text)),t.label.textAlt&&i.push(Kt(t.label.textAlt)),Object.assign(Object.assign({},e),{distance:0,styles:i,align:1,background:t.label.background?{color:ut(t.label.background.color),verticalPadding:t.label.background.vPadding,horizontalPadding:t.label.background.hPadding}:void 0})}const Qt={[H.StraightLabels.AlignType.Left]:0,[H.StraightLabels.AlignType.Right]:2,[H.StraightLabels.AlignType.Center]:1};function*Jt(t,e){t.text[e]&&t.text[e].strings.length&&(yield{textLines:t.text[e].strings.map(t=>({glyphIds:t.glyphs}))}),t.textAlt[e]&&t.textAlt[e].strings.length>0&&(yield{textLines:t.textAlt[e].strings.map(t=>({glyphIds:t.glyphs}))})}function te(t,e){const i=$t(t,e);return i&&t.label&&(i.distance=t.label.vdistance),i}function*ee(t,e,i,s,n,r,o){const{pointLabels:a}=e;if(a){const l=new ot(t);for(let h=0;h<a.text.length;h++){const c=a.classId[h],d=[...lt(e.presentation,c,te,t,ht(r))];for(const t of d)t.align=Qt[a.align[h]];const u=Mt(a,h);o.customizePointLabel(d,u,St(t,n));const f=l.toWorldCoordinates(a.centerX[h],a.centerY[h]),p=s(),_=i.pointLabels.get(h);_&&_.set("position",`${f.x},${f.y}`),yield{id:p,anchorPoint:f,offset:g(a.offsetX[h],a.offsetY[h]),texts:[...Jt(a,h)],priority:a.priority[h],styles:d,metadata:_}}}}function*ie(t,e,i,s){let n=0,r=0;for(let o=0;o<i;o++)yield s.toWorldCoordinates(n+=t.vertexX[e+o],r+=t.vertexY[e+o])}function*se(t,e){t.text[e]&&(yield{textLines:[{glyphIds:t.text[e].glyphs}]}),t.textAlt[e]&&t.textAlt[e].glyphs.length>0&&(yield{textLines:[{glyphIds:t.textAlt[e].glyphs}]})}function ne(t,e){const i=$t(t,e);return i&&t.label&&t.label.hdistance&&(i.distance=t.label.hdistance),i}function*re(t,e,i,s,n,r,o){const{polylineLabels:a}=e;if(a){const l=new ot(t);let h=0;for(let c=0;c<a.text.length;c++){const d=a.classId[c],u=a.verticesCount[c],f=s();if(u>=2){const s=[...lt(e.presentation,d,ne,t,ht(r))],p=Mt(a,c);o.customizeCurvedLabel(s,p,St(t,n)),yield{id:f,polyline:[...ie(a,h,u,l)],texts:[...se(a,c)],styles:s,metadata:i.curvedLabels.get(c),priority:a.priority[c]}}else console.warn(`Curved label with ${u} vertices extracted`);h+=u}}}function oe(t,e){return g(-t,e-1)}function ae(t){var e;return t.scale*(null!==(e=t.scaleFactor)&&void 0!==e?e:1)}const le=-1+Math.pow(2,-23),he=1-Math.pow(2,-23);function ce(t){return L(t/8388607,le,he)}function de(t,e){const i=L(t,-2097152,2097151);return L(2*((i- -2097152|e<<22)/16777215)-1,le,he)}function ue(t,e){const i=t.point;return i&&i.icon?Object.assign(Object.assign({},e),{imageId:i.icon.id,offset:oe(i.anchorX,i.anchorY),scale:i.icon.scale,selectedIcon:i.selectedIcon?{imageId:i.selectedIcon.id,offset:oe(i.selectedAnchorX,i.selectedAnchorY),scale:i.selectedIcon.scale}:void 0}):void 0}function*fe(t,e,i,s,n,r,o,a,l){var h;const{points:c}=e;if(c){const d=new ot(t);for(let u=0;u<c.classId.length;u++){const f=d.toWorldCoordinates(c.coordsx[u],c.coordsy[u]),p=i.points.get(u);p&&p.set("position",`${f.x},${f.y}`);const _=Mt(c,u),g=null==p?void 0:p.get("objectId"),m=g?n.find(t=>{var e;return(null===(e=t.metadata)||void 0===e?void 0:e.get("objectId"))===g}):n.find(t=>t.anchorPoint.x===f.x&&t.anchorPoint.y===f.y),y=m?m.id:s(),b=[...lt(e.presentation,c.classId[u],ue,t,ht(o))];if(a.customizePoint(b,_,St(t,r)),l){const t=null==m?void 0:m.metadata;p&&l(p,b),t&&l(t,b)}const w=null!==(h=null==m?void 0:m.priority)&&void 0!==h?h:2097151;yield{position:f,styles:b,priority:w,metadata:p,id:y}}}}function pe(...t){const e={};let i,s,n,r;for(const o of t)if(o){if(Object.assign(e,o.content.primitives),o.content.references&&(i=i||[],i.push(...o.content.references)),o.content.metadata){s=s||new Map;for(const[t,e]of o.content.metadata)s.set(t,e)}o.contentToRemove&&(n=n||[],n.push(...o.contentToRemove)),o.metrics&&(r=r||{},Object.assign(r,o.metrics))}return{content:{primitives:e,references:i,metadata:s},contentToRemove:n,metrics:r}}function _e(...t){const e=new Map;for(const i of t)for(const t of i)t.id&&t.metadata&&e.set(t.id,t.metadata);return e}const ge=Date.now();const me="performance"in self&&"now"in performance?performance.now.bind(performance):function(){return Date.now()-ge};class ye extends class{constructor(t,e,i){this._taskQueue=t,this._priority=e,this._contentPriority=i,this.onContentReady=this._onContentReady=new s,this._scheduleStart=void 0,this._queueWaitingTime=void 0,this._state=0,this._taskStage=0,this._subTasks=[]}get state(){return this._state}destructor(){1===this._state&&this.pause();for(const t of this._subTasks)t.destructor()}start(){0===this._state&&(this._startImpl(),this._state=1);for(const t of this._subTasks)t.start()}pause(){1===this._state&&(this._pauseImpl(),this._state=2);for(const t of this._subTasks)t.pause()}resume(){2===this._state&&(this._resumeImpl(),this._state=1);for(const t of this._subTasks)t.resume()}resetPriority(t){switch(this._priority=t,this._taskStage){case 1:this._taskQueue.remove(this._processingTask),this._processingTask=this._createTask(this._processingTask.execute),this._enqueueProcessingTask();break;case 2:this._processingTask=this._createTask(this._processingTask.execute)}for(const e of this._subTasks)e.resetPriority(t)}_pauseImpl(){switch(this._taskStage){case 1:this._taskQueue.remove(this._processingTask),this._taskStage=2}}_resumeImpl(){switch(this._taskStage){case 2:this._enqueueProcessingTask(),this._taskStage=1}}_startSubTask(t){this._subTasks.push(t),t.onContentReady.addListener(this._onSubTaskContent,this),t.start()}_onContent(t){this._onContentReady.fire(t)}_onSubTaskContent(t){console.warn("Sub task output is not handled",t)}_scheduleProcessing(t){switch(this._taskStage){case 0:this._scheduleStart=me(),this._processingTask=this._createTask(()=>{this._queueWaitingTime=me()-this._scheduleStart;const e=this._process(t);this._state=3,this._taskStage=3,e&&this._onContent(e)}),this._enqueueProcessingTask(),this._taskStage=1;break;case 2:this._enqueueProcessingTask(),this._taskStage=1}}_getTaskPriority(){return this._priority+this._contentPriority}_createTask(t){return{execute:t,priority:this._getTaskPriority()}}_enqueueProcessingTask(){this._taskQueue.enqueueSync(this._processingTask)}}{constructor(t,e,i){super(t,e,i),this._stage=0,this._loadStart=void 0,this._loadTime=void 0}resetPriority(t){super.resetPriority(t)}_startImpl(){switch(this._stage){case 0:case 2:this._load()}}_pauseImpl(){switch(super._pauseImpl(),this._stage){case 1:this._loadCancel(),this._stage=2}}_resumeImpl(){switch(super._resumeImpl(),this._stage){case 0:case 2:this._load()}}_load(){this._loadStart=me(),this._request=this._loadImpl(),this._request.then(this._onResponse.bind(this),this._onResponseError.bind(this)),this._stage=1}_onResponse(t){switch(this._stage){case 1:this._stage=3,this._loadTime=me()-this._loadStart,this._scheduleProcessing(t)}}_onResponseError(t){console.error(t),this.pause()}}var be=i(1);function we(t){return t>1e4?1:128}function ve(t,e){return t-t%e}class xe{constructor(t=[]){this._fontGlyphRanges=new Map;for(const e of t)this.addRangesForGlyphs(e[0],e[1])}addRangesForGlyphs(t,...e){let i=this._fontGlyphRanges.get(t);i||(i=new Map,this._fontGlyphRanges.set(t,i));for(const s of e){const t=we(s),e=ve(s,t);i.set(e,e+t)}}contains(t,e){const i=this._fontGlyphRanges.get(t);return!!i&&i.has(e)}containsAll(t){for(const[e,i]of t)for(const[t]of i)if(!this.contains(e,t))return!1;return!0}isEmpty(){return 0===this._fontGlyphRanges.size}clear(){this._fontGlyphRanges.clear()}*[Symbol.iterator](){yield*this._fontGlyphRanges.entries()}}function ke(t,e,i,s,n){const r=t.glyphIds,o=r.length,a=[];for(let l=0;l<o;l++){const t=s.glyphs[r[l]],o=e+(t.bearingX-s.margin)*n,h=e+(t.bearingX+t.width+s.margin)*n,c=i+(t.bearingY+s.margin)*n,d=i+(t.bearingY-t.height-s.margin)*n,u=g(o,c),f=g(h,c),p=g(h,d),_=g(o,d),m={fontId:s.id,glyphId:t.id,scale:n,topLeft:u,topRight:f,bottomRight:p,bottomLeft:_};a.push(m),e+=t.advance*n}return a}function Ae(t,e,i){const s=[],n=t.texts.map((t,s)=>{const n=e.styles[s],r=i.get(n.fontId),o=n.fontSize,a=o/r.xheight,l=r.height?r.height*a:2*o;return t.textLines.map(t=>{const e=function(t,e){return e.glyphIds.reduce((e,i)=>e+t.glyphs[i].advance,0)}(r,t)*a;return{line:t,font:r,scale:a,width:e,height:l,fontSize:o}})}),r=n.reduce((t,e)=>e.reduce((t,e)=>(t.width=Math.max(t.width,e.width),t.height+=e.height,t),t),{width:0,height:e.distance*(n.length-1)}),o=t.offset.x-r.width/2;let a=t.offset.y+r.height/2,l=!0;for(const h of n){const t=[];for(const i of h){const s=a-=i.height-(l?i.fontSize/2:0),n=o+(0===e.align?0:1===e.align?(r.width-i.width)/2:2===e.align?r.width-i.width:0),h=ke(i.line,n,s,i.font,i.scale);t.push(h),l=!1}a-=e.distance,s.push(t)}return s}function Se(t,e){return t>e?1:t<e?-1:0}function Te(t,e,i){const s=t[e];t[e]=t[i],t[i]=s}function Re(t,e=0,i=t.length){for(let s=e,n=i-1;s<n;++s,--n)Te(t,s,n)}function Ie(t,e=1,i=0,s=t.length){Re(t,i,s),Re(t,i,i+e),Re(t,i+e,s)}function Ce(t,e,i=0,s=t.length,n=0){for(let r=i,o=n;r<s;++r,++o)e[o]=t[r]}function ze(t,e,i){const s=Math.min(e.length,i.length);for(let n=0;n<s;n++){const s=t(e[n],i[n]);if(s)return s}return e.length-i.length}function Pe(t,e=Se,i=0,s=t.length){for(let n=i;n<s;++n)for(let s=n;s>i&&e(t[s-1],t[s])>0;--s)Te(t,s-1,s)}function Oe(t,e,i,s,n,r,o){let a=o,l=s,h=n;for(;l<n&&h<r;)e[a++]=i(t[l],t[h])>0?t[h++]:t[l++];Ce(t,e,l,n,a),Ce(t,e,h,r,a)}function Ee(t,e,i){const s=[];let n=0;for(const[o,a]of function(t,e,i=((t,e)=>[t,e])){const s=Math.min(t.length,e.length),n=new Array(s);for(let r=0;r<s;++r)n[r]=i(t[r],e[r]);return n}(t.texts,e.styles)){const t=[],r=i.get(a.fontId),l=a.fontSize/r.xheight,h=a.fontSize/2;for(const e of o.textLines)for(const i of e.glyphIds){const e=r.glyphs[i],s=(e.bearingY+r.margin)*l,o=(e.bearingY-e.height-r.margin)*l,a=(e.bearingX-r.margin)*l,c=(e.bearingX+e.width+r.margin)*l,d=(c-a)/2,u=a-d,f=c-d,p=s-h,_=o-h;t.push({fontId:r.id,glyphId:i,scale:l,topLeft:{x:u,y:p},topRight:{x:f,y:p},bottomRight:{x:f,y:_},bottomLeft:{x:u,y:_},lineDisplacement:n+d}),n+=e.advance*l}n+=e.distance,s.push(t)}n-=e.distance;const r=n/2;for(const o of s)for(const t of o)t.lineDisplacement-=r;return s}class Me extends ye{constructor(t,e,i,s,n,r,o,a,l,h=2e3){super(i,l,h),this._glyphAtlasRegistry=n,this._pointLabelsBufferWriter=r,this._curvedLabelsBufferWriter=o,this._pointLabels=t,this._curvedLabels=e,this._requiredGlyphs=this._getRequiredGlyphs(t,this._requiredGlyphs),this._requiredGlyphs=this._getRequiredGlyphs(e,this._requiredGlyphs),this._collisionPriority=s,this._batchingRule=a}canBeProcessedSynchronously(){return this._requiredGlyphs.isEmpty()||this._glyphAtlasRegistry.hasAllGlyphsLoaded(this._requiredGlyphs)}processSynchronously(){return this._requiredGlyphs.isEmpty()?this._createContentPortion([],[],void 0,void 0):this._process(this._glyphAtlasRegistry.getAtlasWithGlyphs(this._requiredGlyphs))}_process(t){const e=_e(this._pointLabels,this._curvedLabels);return this._createContentPortion(this._writePointLabels(t,e),this._writeCurvedLabels(t,e),this._loadTime,e)}_loadImpl(){return this._glyphAtlasRegistry.loadGlyphsAndGetAtlas(this._requiredGlyphs,Math.floor(this._getTaskPriority()))}_loadCancel(){}_createContentPortion(t,e,i,s){return{content:{primitives:{5:t,6:e},metadata:s},metrics:{glyphsAndResourcesLoadTime:i}}}_getRequiredGlyphs(t,e=new xe){for(const i of t){const{texts:t,styles:s}=i,n=s[0];for(let i=0;i<t.length;i++){const s=n.styles[i];if(s){const{fontId:n}=s,r=t[i].textLines.reduce((t,e)=>(t.push(...e.glyphIds),t),[]);e.addRangesForGlyphs(n,...r)}}}return e}_writePointLabels(t,e){const i=[];for(const n of this._pointLabels){const e=n.id,s=n.styles[0],r=Ae(n,s,this._glyphAtlasRegistry.loadedFonts),o=t.allocatedGlyphs,a=this._pointLabelsBufferWriter.writePointLabel(e,n,s,r,o,this._collisionPriority);i.push({id:e,location:a,atlasId:t.id})}const s=Object(be.c)(this._batchingRule,e);return[...Object(be.b)(i,s)]}_writeCurvedLabels(t,e){const i=[];for(const n of this._curvedLabels){const e=n.id,s=n.styles[0],r=Ee(n,s,this._glyphAtlasRegistry.loadedFonts),o=t.allocatedGlyphs,a=this._curvedLabelsBufferWriter.writeLabel(n,s,r,o,e,this._collisionPriority);i.push({id:e,location:a,atlasId:t.id})}const s=Object(be.c)(this._batchingRule,e);return[...Object(be.b)(i,s)]}}var Le=function(t,e,i,s){return new(i||(i=Promise))((function(n,r){function o(t){try{l(s.next(t))}catch(e){r(e)}}function a(t){try{l(s.throw(t))}catch(e){r(e)}}function l(t){var e;t.done?n(t.value):(e=t.value,e instanceof i?e:new i((function(t){t(e)}))).then(o,a)}l((s=s.apply(t,e||[])).next())}))};const Be={imageSize:{width:0,height:0},atlasId:-1,atlasLocation:I,data:{size:{width:0,height:0},data:new Uint8Array}};class Ue extends ye{constructor(t,e,i,s,n,r,o,a=1e3){super(e,r,a),this._iconAtlasRegistry=s,this._iconBufferWriter=n,this._icons=t,this._iconDataList=this._icons.map(t=>{const{imageId:e,transformer:i}=t.styles[0];return s.getIconData(e,ae(t.styles[0]),i)||Be}),this._collisionPriority=i,this._computeBrightnessRange=o,this._atlasRetainingIcons=[]}destructor(){this._releaseRetainedAtlases(),super.destructor()}canBeProcessedSynchronously(){return!Object(Y.d)(this._iconDataList,t=>t===Be)}processSynchronously(){return this._process()}_onContent(t){super._onContent(t),this._releaseRetainedAtlases()}_process(){return{content:{primitives:{7:this._writeIcons()},metadata:_e(this._icons)},metrics:{glyphsAndResourcesLoadTime:this._loadTime}}}_loadImpl(){return Le(this,void 0,void 0,(function*(){const t=this._iconAtlasRegistry,e=[];for(let i=0;i<this._iconDataList.length;i++)if(this._iconDataList[i]===Be){const s=i,{url:n,imageId:r,transformer:o}=this._icons[i].styles[0],a=Math.floor(this._getTaskPriority()),l=ae(this._icons[i].styles[0]),h=n||t.buildIconUrl(r,l,null==o?void 0:o.colorQuery),c=t.loadIcon(h,a).then(e=>{const i=t.addIcon(e,r,l,o);this._iconDataList[s]=i,this._retainAtlas(i)});e.push(c)}else this._retainAtlas(this._iconDataList[i]);return yield Promise.all(e),this._iconDataList}))}_loadCancel(){}_writeIcons(){const t=[];for(let e=0;e<this._icons.length;e++){const i=this._icons[e],s=this._iconDataList[e],n=i.styles[0],r=this._iconAtlasRegistry.getDpr(),o=1/r,a=n.url?ae(n)*r:1;let l=0,h=1;if(this._computeBrightnessRange){const t=new Map;for(let n=0;n<s.data.data.length;n+=4){const e=s.data.data[n+0],i=s.data.data[n+1],r=s.data.data[n+2];if(s.data.data[n+3]>=255){const s=.2126*e+.7152*i+.0722*r|0;t.set(s,(t.get(s)||0)+1)}}const e=[...t.entries()].sort((t,e)=>t[0]-e[0]),i=2;l=e[0][0],h=e[e.length-1][0];for(let s=0;s<e.length;s++)if(e[s][1]>=i){l=e[s][0]/255;break}for(let s=e.length-1;s>=0;s--)if(e[s][1]>=i){h=e[s][0]/255;break}}const c=this._iconBufferWriter.writeIcon(i,s.atlasLocation,De(s.imageSize,a),n.offset,o,this._collisionPriority,l,h);t.push({location:c,id:i.id,atlasId:s.atlasId,zIndex:n.zIndex})}return t}_retainAtlas(t){this._iconAtlasRegistry.getAtlas(t.atlasId).retain(),this._atlasRetainingIcons.push(t)}_releaseRetainedAtlases(){for(const t of this._atlasRetainingIcons){this._iconAtlasRegistry.getAtlas(t.atlasId).release()}this._atlasRetainingIcons.length=0}}function De({width:t,height:e},i){return{width:t*i,height:e*i}}function je(t){var e,i,s;return(null!==(i=null===(e=t.pattern)||void 0===e?void 0:e.scale)&&void 0!==i?i:1)*(null!==(s=t.patternScaleFactor)&&void 0!==s?s:1)}function Ne(t){return 255*t|0}function Ve(t){return 65535*t|0}function We(t){return(65535*t-1)/2|0}function qe(t,e){return e<<16|65535&t}function Ge(t){return 4294967295*(.25*(t+2))|0}function Fe(t,e){return qe(t>>>16,e>>>16)}function Ye(t,e){return qe(t,e)}function Xe(t,e){const i=Ge(e.x),s=Ge(e.y);t.writeVertexUint32(Fe(i,s)),t.writeVertexUint32(Ye(i,s))}class Ze{constructor(t){this._bufferDataProvider=t,this._currentMeshWrittenVertices=0}endMesh(){return this._currentMeshWrittenVertices=0,this._currentBufferData.endMesh()}writeIndices(t){this._ensureEnoughIndexBufferSpace(t.length),this._currentBufferData.writeIndices(t)}writeVertex(...t){return this._ensureEnoughVertexBufferSpace(),this._writeVertex(this._currentBufferData,...t),this._currentMeshWrittenVertices++}_ensureEnoughVertexBufferSpace(t=1){this._currentBufferData||this._requestNewBuffer();const e=this._currentBufferData.vertexBuffer,i=t*e.vertexByteSize;if(e.occupiedByteSize+i>e.byteSize&&(this._requestNewBuffer(),i>this._currentBufferData.vertexBuffer.byteSize))throw new Error("Mesh is too big to write its vertices")}_ensureEnoughIndexBufferSpace(t){this._currentBufferData||this._requestNewBuffer();const e=this._currentBufferData.indexBuffer;if(e.occupiedSize+t>e.size&&(this._requestNewBuffer(),t>this._currentBufferData.indexBuffer.size))throw new Error("Mesh is too big to write its indices")}_requestNewBuffer(){const t=this._currentBufferData;if(this._currentBufferData=this._bufferDataProvider(),t){if(0===t.vertexBuffer.currentMeshBaseIndex)throw new Error("Mesh is too big: tried to transfer the whole buffer");t.vertexBuffer.transferUnfinishedMesh(this._currentBufferData.vertexBuffer),t.indexBuffer.transferUnfinishedMesh(this._currentBufferData.indexBuffer,t.vertexBuffer.currentMeshBaseIndex)}}}function He(t,e=4){let i=0;return{attributes:[...Object(Y.c)(t,([t,{type:s,size:n,normalized:r}])=>{const o=[t,{type:s,size:n,normalized:r,offset:i}],a=n*function(t){switch(t){case 5120:case 5121:return 1;case 5122:case 5123:return 2;case 5124:case 5125:case 5126:return 4}}(s),l=function(t,e){return(t-1&e)-e}(i+a,-e);return i=l,o})],vertexByteSize:i}}const Ke=He([[2,{size:4,type:5121,normalized:!0}],[0,{size:2,type:5123,normalized:!1}],[1,{size:2,type:5123,normalized:!1}],[5,{size:2,type:5122,normalized:!0}],[6,{size:2,type:5122,normalized:!0}],[10,{size:1,type:5126,normalized:!1}],[4,{size:2,type:5123,normalized:!0}],[12,{size:4,type:5123,normalized:!1}],[13,{size:1,type:5126,normalized:!1}],[14,{size:2,type:5122,normalized:!0}],[15,{size:2,type:5126,normalized:!1}]]),$e={};for(const Xo of Ke.attributes)$e[Xo[0]]=Xo[1].offset/4;class Qe{constructor(){const t=new ArrayBuffer(Ke.vertexByteSize);this._uint32View=new Uint32Array(t),this._float32View=new Float32Array(t),this._displacement=g(0,0),this._equidistantOffset=0}get data(){return this._uint32View}set position({x:t,y:e}){const i=Ge(t),s=Ge(e);this._uint32View[$e[0]]=Fe(i,s),this._uint32View[$e[1]]=Ye(i,s)}set normal({x:t,y:e}){this._uint32View[$e[5]]=qe(We(t),We(e))}setDisplacement(t,e){this._displacement.x=t,this._displacement.y=e,this._writeDisplacement()}setUv(t,e){this._uint32View[$e[4]]=qe(ei(t),ei(e))}set iconLocation({minX:t,maxX:e,minY:i,maxY:s}){const n=$e[12];this._uint32View[n]=qe(t,e),this._uint32View[n+1]=qe(i,s)}set iconScale(t){this._float32View[$e[13]]=t}set id(t){this._uint32View[$e[2]]=t}set zIndex(t){this._float32View[$e[10]]=ce(t)}set zoom(t){this._zoom=t,this._writeZoomRelatedData()}set vertexZoomScaledTextureUDisplacement(t){this._zoomScaledTextureUDisplacement=t,this._writeZoomRelatedData()}set equidistantOffset(t){this._equidistantOffset=t,this._writeDisplacement()}set currentLength(t){this._float32View[$e[15]]=t}set segmentLength(t){this._float32View[$e[15]+1]=t}_writeZoomRelatedData(){this._uint32View[$e[14]]=qe(We(L(this._zoom,-64,64)/64),We(L(this._zoomScaledTextureUDisplacement,-1024,1024)/1024))}_writeDisplacement(){const t=-this._equidistantOffset,{x:e,y:i}=this._displacement,s=t*(0!==e&&0!==i?e/i:0);this._uint32View[$e[6]]=qe(ti(e+s),ti(i+t))}}class Je extends Ze{rewriteIcon(t,e,i,s){const n=new Uint32Array(t.vertexBuffer.data),r=new Float32Array(t.vertexBuffer.data),o=this._getAttribOffset(12),a=this._getAttribOffset(13),l=Ke.vertexByteSize,h=l/4,c=e.vertexByteOffset/4,d=e.vertexByteLength/l;for(let u=0;u<d;u++){const t=c+u*h;n[t+o]=qe(i.minX,i.maxX),n[t+o+1]=qe(i.minY,i.maxY),r[t+a]=s}}_getAttribOffset(t){const e=Ke.attributes,i=e.findIndex(e=>e[0]===t);return-1!==i?e[i][1].offset/4:-1}writeVertex(t){return super.writeVertex(t)}writeIndices(t){return super.writeIndices(t)}_writeVertex(t,e){for(const i of e.data)t.writeVertexUint32(i)}}function ti(t){return We(L(t,-256,256)/256)}function ei(t){return Ve(L(t,0,2048)/2048)}class ii{constructor(t){this._bufferWriter=t,this._vertexBuffer=new Qe}writePolyline({vertices:t},e,i,s,n,r,o,a,l,h,c,d=!1,u=0){const f=.5*i,p=this._vertexBuffer,_={leftVertexIndex:-1,rightVertexIndex:-1,segmentNormal:g(0,0)};p.id=e,p.iconLocation=o,p.iconScale=a,p.zoom=l,p.zIndex=h,p.vertexZoomScaledTextureUDisplacement=0,p.equidistantOffset=c;const m=u;let y=0;this._writeStartCap(t[0],t[1],s,f,m,y,p,_);for(let g=1;g<t.length-1;g++)d||(y+=S(t[g],t[g-1])),this._writeJoin(t[g],t[g+1],r,f,m,y,d,p,_);return d||(y+=S(t[t.length-1],t[t.length-2])),this._writeEndCap(t[t.length-1],n,f,m,y,p,_),this._bufferWriter.endMesh()}_writeStartCap(t,e,i,s,n,r,o,a){const l=k(T(w(e,t)));o.position=t,o.normal=l;const h=this._writeVertex(o,0,s,n,2*s,0,r),c=this._writeVertex(o,0,-s,n,0,0,r);a.segmentNormal=l,a.leftVertexIndex=h,a.rightVertexIndex=c,this._writeStartCapTypeSpecificVertices(i,o,s,n,r,h,c)}_writeJoin(t,e,i,s,n,r,o,a,l){a.position=t;const h=2*s,c=l.segmentNormal,d=S(e,t),u=function(t,e){const i=w(e,t);return T(i,i),k(i,i),i}(t,e);var f,p;const _=Math.sign((p=u,(f=c).x*p.y-f.y*p.x))>0,g=function(t,e){const i=R(t,e),s=Math.abs((1-i)/(1+i));return Math.sqrt(s)}(c,u)*s,m=-g,y=this._writeVertex(a,0,0,n,s,r);let b,v;_?(v=this._writeVertex(a,0,-s,n,0,r),b=o?this._writeVertex(a,m,s,n,h,r,d):this._writeVertexWithUDisplacement(a,m,s,n,h,m,r,d)):(b=this._writeVertex(a,0,s,n,h,r),v=o?this._writeVertex(a,m,-s,n,0,r,d):this._writeVertexWithUDisplacement(a,m,-s,n,0,m,r,d)),a.normal=u;const x=_?b:this._writeVertex(a,0,s,n,h,r),A=_?this._writeVertex(a,0,-s,n,0,r):v;this._bufferWriter.writeIndices([l.leftVertexIndex,l.rightVertexIndex,b,l.rightVertexIndex,v,b,v,y,b,A,x,y]),l.segmentNormal=u,l.leftVertexIndex=x,l.rightVertexIndex=A,0===i&&g>4*s&&(i=1),this._writeJoinTypeSpecificVertices(i,a,l,_,c,u,g,s,n,r,d,y,b,v,x,A)}_writeEndCap(t,e,i,s,n,r,o){r.position=t;const a=this._writeVertex(r,0,i,s,2*i,n),l=this._writeVertex(r,0,-i,s,0,n);this._bufferWriter.writeIndices([o.leftVertexIndex,o.rightVertexIndex,a,o.rightVertexIndex,l,a]),this._writeEndCapTypeSpecificVertices(e,r,i,s,n,a,l)}_writeStartCapTypeSpecificVertices(t,e,i,s,n,r,o){switch(t){case 2:{const t=this._writeVertex(e,0,0,s,i,n),r=this._writeVertex(e,0,i,s,0,n),a=this._writeVertex(e,-i,i,s,0,n),l=this._writeVertex(e,-i,-i,s,0,n);this._bufferWriter.writeIndices([t,l,o,t,a,l,t,r,a]);break}}}_writeJoinTypeSpecificVertices(t,e,i,s,n,r,o,a,l,h,c,d,u,f,p,_){const g=2*a;switch(t){case 0:if(s){const t=this._writeVertex(e,o,-a,l,0,h);this._bufferWriter.writeIndices([d,t,f,d,_,t])}else{const t=this._writeVertex(e,o,a,l,g,h);this._bufferWriter.writeIndices([d,u,t,d,t,p])}break;case 2:{const t=a*a,i=o*o,n=t/Math.sqrt(t+i);if(s){const t=this._writeVertex(e,0,0,l,n,h);this._bufferWriter.writeIndices([t,f,_])}else{const t=this._writeVertex(e,0,0,l,g-n,h);this._bufferWriter.writeIndices([t,p,u])}break}}}_writeEndCapTypeSpecificVertices(t,e,i,s,n,r,o){switch(t){case 2:{const t=this._writeVertex(e,0,0,s,i,n),r=this._writeVertex(e,0,i,s,0,n),a=this._writeVertex(e,i,i,s,0,n),l=this._writeVertex(e,i,-i,s,0,n);this._bufferWriter.writeIndices([t,o,l,t,l,a,t,a,r]);break}}}_writeVertex(t,e,i,s,n,r,o=32){return t.setDisplacement(e,i),t.setUv(s,n),t.segmentLength=o,t.currentLength=r,this._bufferWriter.writeVertex(t)}_writeVertexWithUDisplacement(t,e,i,s,n,r,o,a=32){t.vertexZoomScaledTextureUDisplacement=r;const l=this._writeVertex(t,e,i,s,n,o,a);return t.vertexZoomScaledTextureUDisplacement=0,l}}class si extends ii{writePolyline(t,e,i,s,n,r,o,a,l,h,c){return super.writePolyline(t,e,i,s,n,r,o,a,l,h,c,!0,i/2)}_writeStartCapTypeSpecificVertices(t,e,i,s,n,r,o){switch(t){case 1:{const t=this._writeVertex(e,-i,i,0,2*i,n),s=this._writeVertex(e,-i,-i,0,0,n);this._bufferWriter.writeIndices([r,o,t,o,s,t]);break}default:super._writeStartCapTypeSpecificVertices(t,e,i,s,n,r,o)}}_writeEndCapTypeSpecificVertices(t,e,i,s,n,r,o){switch(t){case 1:{const t=2*i,s=this._writeVertex(e,i,i,t,t,n),a=this._writeVertex(e,i,-i,t,0,n);this._bufferWriter.writeIndices([r,o,s,o,a,s]);break}case 2:{const t=this._writeVertex(e,0,0,i,i,n),s=this._writeVertex(e,0,i,i,0,n),r=this._writeVertex(e,i,i,i,0,n),a=this._writeVertex(e,i,-i,i,0,n);this._bufferWriter.writeIndices([t,o,a,t,a,r,t,r,s]);break}}}_writeJoinTypeSpecificVertices(t,e,i,s,n,r,o,a,l,h,c,d,u,f,p,_){e.normal=n;const g=2*a;switch(t){case 1:if(o<=a){const t=a+o;if(s){const i=this._writeVertex(e,o,-a,t,0,h);this._bufferWriter.writeIndices([d,f,i,d,i,_])}else{const i=this._writeVertex(e,o,a,t,g,h);this._bufferWriter.writeIndices([d,i,u,d,p,i])}}else{const t=1/o*a*a;if(s){const i=a-t,s=this._writeVertex(e,a,-a,g,0,h),n=this._writeVertex(e,a,-t,g,i,h);e.normal=r;const o=this._writeVertex(e,-a,-a,g,0,h);this._bufferWriter.writeIndices([d,f,s,d,s,n,d,n,o,d,o,_])}else{const i=a+t,s=this._writeVertex(e,a,a,g,g,h),n=this._writeVertex(e,a,t,g,i,h);e.normal=r;const o=this._writeVertex(e,-a,a,g,g,h);this._bufferWriter.writeIndices([d,u,s,d,s,n,d,n,o,d,o,p])}}break;default:super._writeJoinTypeSpecificVertices(t,e,i,s,n,r,o,a,l,h,c,d,u,f,p,_)}e.normal=r}}class ni extends ii{constructor(t){super(t),this._halfCircleVectorsCache=new Map}writePolyline(t,e,i,s,n,r,o,a,l,h,c){return super.writePolyline(t,e,i,s,n,r,o,a,l,h,c,!1,0)}_writeStartCapTypeSpecificVertices(t,e,i,s,n,r,o){switch(t){case 1:const a=this._writeVertex(e,0,0,s,i,n),l=2*i;let h=r;for(const t of this._getHalfCircleVectors(Math.floor(i))){const r=-i*t.y,o=i*t.x,c=this._writeVertex(e,r,o,s,l,n);this._bufferWriter.writeIndices([a,h,c]),h=c}break;default:super._writeStartCapTypeSpecificVertices(t,e,i,s,n,r,o)}}_writeEndCapTypeSpecificVertices(t,e,i,s,n,r,o){switch(t){case 1:const a=this._writeVertex(e,0,0,s,i,n);let l=r;for(const t of this._getHalfCircleVectors(Math.floor(i))){const r=i*t.y,o=i*t.x,h=this._writeVertex(e,r,o,s,2*i,n);this._bufferWriter.writeIndices([a,h,l]),l=h}break;default:super._writeEndCapTypeSpecificVertices(t,e,i,s,n,r,o)}}_writeJoinTypeSpecificVertices(t,e,i,s,n,r,o,a,l,h,c,d,u,f,p,_){switch(e.normal=n,s?i.leftVertexIndex=this._writeVertexWithUDisplacement(e,-o,a,l,2*a,o,h,c):i.rightVertexIndex=this._writeVertexWithUDisplacement(e,-o,-a,l,0,o,h,c),t){case 1:{const t=R(n,r);if(s){const i=[];let s=f;for(const n of this._getHalfCircleVectors(Math.floor(a))){if(!(n.x>t))break;{const t=a*n.y,r=-a*n.x,o=this._writeVertex(e,t,r,l,0,h);i.push(d,o,s),s=o}}i.push(d,_,s),this._bufferWriter.writeIndices(i)}else{const i=2*a,s=[];let n=u;for(const r of this._getHalfCircleVectors(Math.floor(a))){if(!(r.x>t))break;{const t=a*r.y,o=a*r.x,c=this._writeVertex(e,t,o,l,i,h);s.push(d,c,n),n=c}}s.push(d,p,n),this._bufferWriter.writeIndices(s)}break}default:super._writeJoinTypeSpecificVertices(t,e,i,s,n,r,o,a,l,h,c,d,u,f,p,_)}e.normal=r}_getHalfCircleVectors(t){let e=this._halfCircleVectorsCache.get(t);if(!e){e=[];const i=Math.PI/t,s=g(1,0);for(let n=0;n<t;n++)x(s,i,s),e.push(y(s));this._halfCircleVectorsCache.set(t,e)}return e}}function ri(t,e,i){const s=e<=1&&t<2,n=e<=1&&t>=2?.55:.5,{r:r,g:o,b:a}=i,l=i.a*Math.min(t,1);t=Math.max(t,1);let h=Math.ceil(t+2*n);h+=s&&h%2==0?1:0;const c=.5*h-.5,d=.5*t,u=d-n,f=d+n,p=new Uint32Array(h*h);for(let _=0;_<h;_++){const t=_-c;for(let e=0;e<h;e++){const i=e-c,n=Math.sqrt(t*t+i*i),g=s?.5+L(d-n,-.5,.5):D(f,u,n);p[e*h+_]=ft(r,o,a,l*g)}}return{size:{width:h,height:h},data:new Uint8Array(p.buffer)}}function oi(t,e,i,s,n){const r=s<=1&&t<2,o=s<=1&&t>=2?.55:.5,{r:a,g:l,b:h}=n,c=n.a*Math.min(t,1);t=Math.max(t,1);let d=Math.ceil(t+2*o);d+=r&&d%2==0?1:0;const u=Math.ceil(e+i),f=Math.ceil(e+2*o),p=new Uint32Array(u*d),_=.5*e,g=.5*f-.5,m=.5*d-.5,y=.5*t,b=_-o,w=_+o,v=y-o,x=y+o;for(let k=0;k<f;k++){const t=D(w,b,Math.abs(k-g));for(let e=0;e<d;e++){const i=Math.abs(e-m),s=r?.5+L(y-i,-.5,.5):D(x,v,i);p[e*u+k]=ft(a,l,h,c*t*s)}}return{size:{width:u,height:d},data:new Uint8Array(p.buffer)}}function ai(t,e,i,s,n,r=0){switch(r){case 0:return oi(t,e,i,s,n);case 2:return oi(t,e+t,i-t,s,n);case 1:return function(t,e,i,s,n){const r=ri(t,s,n),o=Math.ceil(e),a=Math.ceil(i),l=o+a,h=new Uint32Array(l*r.size.height),c=new Uint32Array(r.data.buffer),d=Math.ceil(r.size.width/2),u=Math.max(o+2*d-l,0),f=Math.ceil(u/2),p=d-f;for(let b=0;b<p;b++)for(let t=0;t<r.size.height;t++)h[t*l+b]=c[t*r.size.width+f+b];const _=Math.floor(r.size.width/2),g=p;for(let b=0;b<o;b++)for(let t=0;t<r.size.height;t++)h[t*l+g+b]=c[t*r.size.width+_];const m=o+p,y=r.size.width-d;for(let b=0;b<p;b++)for(let t=0;t<r.size.height;t++)h[t*l+m+b]=c[t*r.size.width+y+b];return{data:new Uint8Array(h.buffer),size:{width:l,height:r.size.height}}}(t,e,i,s,n)}}var li=function(t,e,i,s){return new(i||(i=Promise))((function(n,r){function o(t){try{l(s.next(t))}catch(e){r(e)}}function a(t){try{l(s.throw(t))}catch(e){r(e)}}function l(t){var e;t.done?n(t.value):(e=t.value,e instanceof i?e:new i((function(t){t(e)}))).then(o,a)}l((s=s.apply(t,e||[])).next())}))};class hi extends ye{constructor(t,e,i,s,n,r,o,a,l=1e3){super(e,a,l),this._pageRegistry=i,this._iconAtlasRegistry=s,this._bufferWriter=n,this._polylines=t,this._zoom=o,this._icons=function(t,e){const i={presentIcons:[],missingIcons:[]},s=function(t){return t.reduce((t,e)=>{const i=e.styles[0];return i.inline&&t.push(i.inline),i.outline&&t.push(i.outline),t},[])}(t);for(const n of s){const{pattern:t,patternTransformer:s}=n;if(t&&t.imageId){const r=e.getIconData(t.imageId,je(n),s);r?i.presentIcons.push(r):i.missingIcons.push(n)}}return i}(t,s),this._missingIconsWrittenPrimitives=[],this._atlasRetainingIcons=[],this._solidPolylinesWriter=new si(n),this._patternPolylineWriter=new ni(n),this._batchingRule=r}destructor(){this._releaseRetainedAtlases(),super.destructor()}hasAsyncContent(){return this._icons.missingIcons.length>0}processSynchronously(){const t=me(),e=_e(this._polylines),i=this._writePolylines(),s=this._batchPolylines(i,e);return this._writtenPrimitives={metadata:e,primitives:i},{content:{primitives:{4:s},metadata:e},metrics:{polylinesParsing:me()-t,glyphsAndResourcesLoadTime:this._loadTime}}}_onContent(t){super._onContent(t),this._releaseRetainedAtlases()}_process(){let t=!1;for(const e of this._missingIconsWrittenPrimitives){const i=this._pageRegistry.getPage(e.primitive.location.bufferId),s=this._iconAtlasRegistry.getIconData(e.imageId,e.scaleFactor,e.transformer),n=(s.atlasLocation.maxY-s.atlasLocation.minY)/e.widthDIPx;this._bufferWriter.rewriteIcon(i.data,e.primitive.location,s.atlasLocation,n),i.touch(e.primitive.location),e.primitive.atlasId!==s.atlasId&&(t=!0,e.primitive.atlasId=s.atlasId)}if(t){const{primitives:t,metadata:e}=this._writtenPrimitives;return{contentToRemove:[4],content:{primitives:{4:this._batchPolylines(t,e)},metadata:e},metrics:{}}}return{content:{primitives:{}},metrics:{}}}_loadImpl(){return li(this,void 0,void 0,(function*(){const t=this._iconAtlasRegistry;for(const i of this._icons.presentIcons)this._retainAtlas(i);const e=this._icons.missingIcons.map(e=>li(this,void 0,void 0,(function*(){const{pattern:i,patternTransformer:s}=e,n=je(e),r=t.buildIconUrl(i.imageId,n,null==s?void 0:s.colorQuery),o=Math.floor(this._getTaskPriority()),a=yield t.loadIcon(r,o),l=t.addIcon(a,i.imageId,n,s);this._retainAtlas(l)})));yield Promise.all(e)}))}_loadCancel(){}_batchPolylines(t,e){const i=Object(be.c)(this._batchingRule,e);return[...Object(be.b)(t,i)]}_writePolylines(){var t;const e=[],i=Object(Y.e)(Object(Y.a)(this._polylines,Ht),(t,e)=>{const i=e.styles[0];return i.inline&&!i.inline.hidden&&t.push({polyline:e,style:i.inline,zIndex:i.zIndex+.01}),i.outline&&!i.outline.hidden&&t.push({polyline:e,style:i.outline,zIndex:i.zIndex}),t},[]);!function(t,e=Se,i=0,s=t.length){if(s-i<=32)return void Pe(t,e,i,s);{let n=i,r=n+32;for(;r<s;)Pe(t,e,n,r),n=r,r+=32;Pe(t,e,n,s)}const n=new Array(s-i);for(let r=32;r<s-i;r+=r){Ce(t,n,i,s);let o=i,a=0,l=r,h=l+r;for(;h<s-i;)Oe(n,t,e,a,l,h,o),a=h,l=a+r,h=l+r,o+=2*r;Oe(n,t,e,a,Math.min(l,s-i),s-i,o)}}(i,(t,e)=>t.zIndex-e.zIndex);const s=this._iconAtlasRegistry,n=this._zoom,r=this._iconAtlasRegistry.getDpr();for(const o of i){const i=o.style,a=o.zIndex,l=i.strokeWidth,h=o.polyline.id,c=i.strokeColor,d=i.join,u=null!==(t=i.equidistantOffset)&&void 0!==t?t:0;if(i.pattern){const t=i.strokeWidth,r=s.getIconData(i.pattern.imageId,je(i),i.patternTransformer),l=!!r,c=r?r.atlasId:s.getCurrentAtlas().id,f=r?r.atlasLocation:s.getCurrentAtlas().emptyIcon,p=(f.maxY-f.minY)/t,_={id:h,location:this._patternPolylineWriter.writePolyline(o.polyline,h,t,i.startCap,i.endCap,d,f,p,n,a,u),atlasId:c};e.push(_),l||this._missingIconsWrittenPrimitives.push({primitive:_,imageId:i.pattern.imageId,widthDIPx:t,scaleFactor:je(i),transformer:i.patternTransformer})}else if(o.style.dash){const t=o.style.dash,f=l+"~"+pt(c)+"~"+t.fill+"~"+t.gap,p=s.getIconData(f)||s.addIcon(ai(l*r,o.style.dash.fill*r,o.style.dash.gap*r,r,c,t.cap),f),_=(p.atlasLocation.maxY-p.atlasLocation.minY)/r;e.push({id:h,location:this._patternPolylineWriter.writePolyline(o.polyline,h,_,i.startCap,i.endCap,d,p.atlasLocation,r,n,a,u),atlasId:p.atlasId})}else{const t=l+"_"+pt(c),f=s.getIconData(t)||s.addIcon(ri(l*r,r,c),t),p=(f.atlasLocation.maxY-f.atlasLocation.minY)/r;e.push({id:h,location:this._solidPolylinesWriter.writePolyline(o.polyline,h,p,i.startCap,i.endCap,d,f.atlasLocation,r,n,a,u),atlasId:f.atlasId})}}return e}_retainAtlas(t){this._iconAtlasRegistry.getAtlas(t.atlasId).retain(),this._atlasRetainingIcons.push(t)}_releaseRetainedAtlases(){for(const t of this._atlasRetainingIcons){this._iconAtlasRegistry.getAtlas(t.atlasId).release()}this._atlasRetainingIcons.length=0}}function ci(t){return t.objectId+t.meshId+pt(t.color)}class di extends ye{constructor(t,e,i,n,r,o,a,l,h,c,d,u,f,p){super(i,n,2e3),this._options=t,this._zoom=e,this._opaquePolygonBufferWriter=r,this._transparentPolygonBufferWriter=o,this._extrudedPolygonBufferWriter=a,this._polylineBufferWriter=l,this._pointLabelsBufferWriter=h,this._curvedLabelsBufferWriter=c,this._iconBufferWriter=d,this._pageRegistry=u,this._glyphAtlasRegistry=f,this._iconAtlasRegistry=p,this.onModelRequired=this._onModelRequired=new s}_writePolygons(t){const e=me(),i=[],s=[],n=[],r=[];for(const h of t){const t=h.styles[0];t.pattern||(1===t.color.a?i.push({id:h.id,location:this._opaquePolygonBufferWriter.writePolygon(h,t.zIndex,t.color,h.id,t.fillRule)}):n.push({id:h.id,location:this._transparentPolygonBufferWriter.writePolygon(h,t.zIndex,t.color,h.id,t.fillRule)})),h.height>0&&(h.externalMesh?(this._onModelRequired.fire(h.externalMesh),r.push(ci(h.externalMesh))):s.push({id:h.id,location:this._extrudedPolygonBufferWriter.writePolygon(h,h.height,h.styles[0].color,h.id)}))}const o=_e(t),a=Object(be.c)(this._options.polygonsBatchingRule,o),l=Object(be.c)(this._options.modelsBatchingRule,o);return{content:{primitives:{0:[...Object(be.a)(i,a)],1:[...Object(be.a)(n,a)],3:[...Object(be.a)(s,l)]},references:r,metadata:o},metrics:{polygonsParsing:me()-e}}}_writePolylines(t){const e=this._zoom,i=new hi(t,this._taskQueue,this._pageRegistry,this._iconAtlasRegistry,this._polylineBufferWriter,this._options.polylinesBatchingRule,e,this._priority,1e3),s=i.processSynchronously();return i.hasAsyncContent()?this._startSubTask(i):i.destructor(),s}_writeLabels(t,e){const i=new Me(t,e,this._taskQueue,this._options.objectsCollisionPriority,this._glyphAtlasRegistry,this._pointLabelsBufferWriter,this._curvedLabelsBufferWriter,this._options.labelsBatchingRule,this._priority,2e3);if(i.canBeProcessedSynchronously()){const t=i.processSynchronously();return i.destructor(),t}this._startSubTask(i)}_writeIcons(t){const e=new Ue(t,this._taskQueue,this._options.objectsCollisionPriority,this._iconAtlasRegistry,this._iconBufferWriter,this._priority,this._options.computeIconBrightnessRange,1e3);if(e.canBeProcessedSynchronously()){const t=e.processSynchronously();return e.destructor(),t}this._startSubTask(e)}}function ui(t){return Ht(t)&&!t.styles[0].hidden}function fi(t){return ui(t)&&t.texts.length>0}class pi extends di{constructor(t,e,i,s,n,r,o,a,l,h,c,d,u,f,p,_,g,m=(t=>et(t,e.allObjectsInteractive))){super(e,t.tile.zoom-At(e.tileSize),i,n,r,o,a,l,h,c,d,u,f,p),this._tile=t,this._tileSpecificOptions=e,this._tileLoader=s,this._metadataPreprocessor=m,this._objectIdProvider=_,this._stylesCustomizer=g,this._modifyIconMetadata=this._modifyIconMetadata.bind(this)}_onSubTaskContent(t){this._onContentReady.fire(t)}_process(t){const e=me(),i=H.decode(new Uint8Array(t)),s=me(),n=this._metadataPreprocessor(i,this._tile),r=this._tile.tile,o=this._extractPointLabels(r,i,n),a=this._extractCurvedLabels(r,i,n),l=this._extractPolygons(r,i,n),h=this._extractPolylines(r,i,n),c=this._extractContours(r,i,l),d=this._exractIcons(r,i,n,o);return pe(this._writeLabels(o,a),this._writeIcons(d),this._writePolygons(l),this._writePolylines([...h,...c]),{content:{primitives:{}},metrics:{tileUnpack:s-e,tileLoadTime:this._loadTime,workerQueueDelay:this._queueWaitingTime}})}_loadImpl(){const t=Math.floor(this._getTaskPriority());return this._tileLoader.load(this._tile,t)}_loadCancel(){this._tileLoader.cancel(this._request)}_extractPolygons(t,e,i){return[...Object(Y.a)(Nt(t,e,i,this._objectIdProvider.idGenerator,this._tileSpecificOptions.tileSize,this._tileSpecificOptions.mapMode,this._stylesCustomizer),ui)]}_extractPolylines(t,e,i){return[...Zt(t,e,i,this._objectIdProvider.idGenerator,this._tileSpecificOptions.tileSize,this._tileSpecificOptions.mapMode,this._stylesCustomizer)]}_extractContours(t,e,i){return[...Xt(t,e,i,this._tileSpecificOptions.tileSize,this._tileSpecificOptions.mapMode,this._stylesCustomizer)]}_extractPointLabels(t,e,i){return[...Object(Y.a)(ee(t,e,i,this._objectIdProvider.collidingIdGenerator,this._tileSpecificOptions.tileSize,this._tileSpecificOptions.mapMode,this._stylesCustomizer),fi)]}_extractCurvedLabels(t,e,i){return[...Object(Y.a)(re(t,e,i,this._objectIdProvider.collidingIdGenerator,this._tileSpecificOptions.tileSize,this._tileSpecificOptions.mapMode,this._stylesCustomizer),ui)]}_exractIcons(t,e,i,s){return[...Object(Y.a)(fe(t,e,i,this._objectIdProvider.collidingIdGenerator,s,this._tileSpecificOptions.tileSize,this._tileSpecificOptions.mapMode,this._stylesCustomizer,this._modifyIconMetadata),ui)]}_modifyIconMetadata(t,e){const i=e[0];if(i&&i.selectedIcon){const e=!1,{imageId:s}=i.selectedIcon,n=function(t){var e,i,s;return(null!==(i=null===(e=t.selectedIcon)||void 0===e?void 0:e.scale)&&void 0!==i?i:1)*(null!==(s=t.scaleFactor)&&void 0!==s?s:1)}(i),r=this._iconAtlasRegistry.buildIconUrl(s,n,void 0,e);t.set("_vector_selectedIconUrl",r)}}}class _i{constructor(t){this._task=t,this.onContentReady=this._onContentReady=new s,this._onWrappedTaskContentReady=this._onWrappedTaskContentReady.bind(this),this._task.onContentReady.addListener(this._onWrappedTaskContentReady)}destructor(){this._task.onContentReady.removeListener(this._onWrappedTaskContentReady)}start(){this._task.resetPriority(this._calculateTaskPriority()),this._task.start()}_onWrappedTaskContentReady(t){this._onContentReady.fire(t)}}class gi extends _i{constructor(t,e,i,s){super(e),this._tile=t,this._viewport=i,this._taskExtraPriority=s,this._tileCenterPosition=function(t){const e=st(t.zoom);return{x:e*(t.x+.5)-1,y:1-e*(t.y+.5)}}(t.tile),this._onTileStateChanged=this._onTileStateChanged.bind(this),this._tile.onStateChanged.addListener(this._onTileStateChanged),this._onViewportUpdated=this._onViewportUpdated.bind(this),this._viewport.onViewportChanged.addListener(this._onViewportUpdated)}destructor(){this._task.destructor(),this._tile.onStateChanged.removeListener(this._onTileStateChanged),this._viewport.onViewportChanged.removeListener(this._onViewportUpdated)}start(){2!==this._tile.state&&super.start()}_calculateTaskPriority(){return mi[this._tile.state]+(1-S(this._viewport.cameraPosition,this._tileCenterPosition)/2)+this._taskExtraPriority}_onTileStateChanged(t){switch(t.state){case 2:case 3:this._task.pause();break;case 0:case 1:this._resetTaskPriority(),0===this._task.state?this._task.start():this._task.resume()}}_onViewportUpdated(){this._resetTaskPriority()}_resetTaskPriority(){this._task.resetPriority(this._calculateTaskPriority())}}const mi={0:3e4,1:2e4,2:1e4,3:1e4};class yi extends gi{constructor(t,e,i,n,r,o,a,l,h,c,d,u,f,p,_,g,m,y,b){const w=new pi(t,e,i,n,o,a,l,h,c,d,u,f,p,_,g,m,y,b);super(t,w,r,o),this.onModelRequired=this._onModelRequired=new s,w.onModelRequired.addListener(t=>this._onModelRequired.fire(t))}}function bi(t,e="something that is supposed to be defined is undefined"){if(!(void 0!==t))throw new Error(e);return void 0!==t}function wi(t){let e=0;for(let i=0;i<t.length;i++)e+=t.charCodeAt(i);return(e%4+1).toString()}class vi extends ye{constructor(t,e,i,s,n,r,o=1e3,a=!1){super(e,r,o),this._model=t,this._loadManager=i,this._trimeshModelBufferWriter=s,this._meshTemplateUrl=n,this._requestWithCredentials=a}_process(t){const e=this._model.mesh,i=this._trimeshModelBufferWriter.writeModel(t,e).map(t=>({id:e.id,metadata:e.metadata,location:t}));return{metadata:_e(i),primitives:{3:i}}}_loadImpl(){const t=this._model.mesh.meshId;return this._loadManager.load(this._meshTemplateUrl.replace("{{hostAlias}}",wi(t)).replace("{{id}}",t),Math.floor(this._getTaskPriority()),{withCredentials:this._requestWithCredentials})}_loadCancel(){this._loadManager.cancel(this._request)}}class xi extends a{constructor(){super({id:"_NO_ID_",x:-1,y:-1,zoom:-1},2),this._tiles=[],this._onSubTileStateChanged=this._onSubTileStateChanged.bind(this)}addTile(t){this._tiles.find(e=>e===t)||(this._tiles.push(t),t.onStateChanged.addListener(this._onSubTileStateChanged,this),this._recalculateState())}_onSubTileStateChanged(){this._recalculateState()}_recalculateState(){this.state=this._calculateState()}_calculateState(){for(const t of this._tiles)if(0===t.state)return 0;for(const t of this._tiles)if(1===t.state)return 1;return 2}}class ki extends gi{constructor(t,e,i,s,n,r,o,a=!1){const l=new xi;super(l,new vi(t,e,i,r,o,n,1e3,a),s,n),this._combinedTile=l}addTile(t){this._combinedTile.addTile(t)}}class Ai{constructor(){this.onReleased=this._onReleased=new s,this.onRetain=this._onRetain=new s,this._clients=0}get isRetained(){return 0!==this._clients}retain(){++this._clients,this._onRetain.fire(this)}release(){this._clients>0&&(--this._clients,0===this._clients&&this._onReleased.fire(this))}}class Si extends Ai{constructor(t,e){super(),this.id=t,this.mesh=e,this._contentHolder=new o}destructor(){this._contentHolder.destructor()}addContent(t,e){return this._contentHolder.addContent(t,e)}hasContent(){return this._contentHolder.hasContent()}}class Ti{constructor(t,e){this._loadManager=t,this._storage=e,this._cache=new Map,this._storage.onRemoved.addListener(this._onTileRemoved,this),this._tileUrlTemplate="",this._tileSize=0,this._tileRequestWithCredentials=!1}destructor(){this._storage.onRemoved.removeListener(this._onTileRemoved)}update(t,e,i){let s=!1;this._tileUrlTemplate!==t&&(this._tileUrlTemplate=t,s=!0),this._tileSize!==e&&(this._tileSize=e,s=!0),i!==this._tileRequestWithCredentials&&(this._tileRequestWithCredentials=i,s=!0),s&&(this._cache.clear(),this._cache=new Map)}load(t,e){const i=this._cache,s=M(t.tile),n=i.get(s);if(n)return n.count++,Promise.resolve(n.data);const r=this._buildTileUrl(t.tile,s),o=this._tileRequestWithCredentials,a=this._loadManager.load(r,e,{withCredentials:o});return a.then(t=>{i.set(s,{count:1,data:t})}),a}cancel(t){this._loadManager.cancel(t)}_onTileRemoved(t){const e=M(t.tile),i=this._cache.get(e);i&&(i.count--,0===i.count&&this._cache.delete(e))}_buildTileUrl(t,e){const{x:i,y:s,zoom:n}=t,r=St(t,this._tileSize);return this._tileUrlTemplate.replace("{{hostAlias}}",wi(e)).replace("{{x}}",i+"").replace("{{y}}",s+"").replace("{{z}}",n+"").replace("{{zmin}}",r+"").replace("{{zmax}}",r+"")}}function Ri(t){return Array.isArray(t)?t:[t]}function Ii(t,e){console.warn(`not valid "${t}": "${e}"`)}function Ci(t,e){return t^e+2654435769+(t<<6)+(t>>2)}function zi(t,e,i,s){if(void 0!==t)return function(t){let e=0;for(const i of[t.r,t.g,t.b,t.a])e=Ci(e,255*i|0);return e}(t);let n=0;return void 0!==e&&(n=Ci(n,e/6*255|0)),void 0!==i&&(n=Ci(n,function(t){let e=0;for(let i=0;i<t.length;++i)e=Ci(e,255*t[i]|0);return e}(i))),void 0!==s&&(n=Ci(n,255*s|0)),n}function Pi(t,e,i,s){return n=>{let r=n;return void 0!==t?r=t:(void 0!==e&&(r=function(t,e){const i=Math.min(t.r,t.g,t.b),s=Math.max(t.r,t.g,t.b)-i,n=s*(1-Math.abs(e%2-1));let r=0,o=0,a=0;switch(Math.floor(e)){case 0:r=s,o=n;break;case 1:r=n,o=s;break;case 2:o=s,a=n;break;case 3:o=n,a=s;break;case 4:a=s,r=n;break;case 5:a=n,r=s}return dt(r+i,o+i,a+i,t.a)}(r,e)),void 0!==i&&(r=function({r:t,g:e,b:i,a:s},n){const r=dt(L(n[0]*t+n[1]*e+n[2]*i+n[3],0,1),L(n[4]*t+n[5]*e+n[6]*i+n[7],0,1),L(n[8]*t+n[9]*e+n[10]*i+n[11],0,1),L(n[12]*t+n[13]*e+n[14]*i+n[15],0,1));return r.a*=s,r}(r,i))),void 0!==s&&(r=dt(r.r,r.g,r.b,r.a*s)),r}}function Oi(t,e,i,s,n,r){const o=zi(t,e,i,s),a=function(t,e,i){return(t?"&c1="+bt(t):"")+(e?"&c2="+bt(e):"")+(i?"&c3="+bt(i):"")}(t,n,r);if(0!==o||""!==a)return{key:o,colorQuery:a,transform:Pi(t,e,i,s),transformImage:({size:t,data:n})=>(function(t,e){for(let i=0;i<t.length;i+=4){const{r:s,g:n,b:r,a:o}=e(dt(t[i+0]/255,t[i+1]/255,t[i+2]/255,1));t[i+0]=255*s,t[i+1]=255*n,t[i+2]=255*r,t[i+3]=t[i+3]*o}}(n,Pi(void 0,e,i,s)),{size:t,data:n})}}var Ei;!function(t){t[t.None=0]="None",t[t.Point=1]="Point",t[t.Polyline=2]="Polyline",t[t.Polygon=4]="Polygon",t[t.All=7]="All"}(Ei||(Ei={}));const Mi={point:Ei.Point,polyline:Ei.Polyline,polygon:Ei.Polygon};var Li;!function(t){t[t.None=0]="None",t[t.GeometryFillRaw=1]="GeometryFillRaw",t[t.GeometryFillPattern=2]="GeometryFillPattern",t[t.GeometryOutline=4]="GeometryOutline",t[t.GeometryFill=3]="GeometryFill",t[t.Geometry=7]="Geometry",t[t.LabelIcon=8]="LabelIcon",t[t.LabelTextFill=16]="LabelTextFill",t[t.LabelTextOutline=32]="LabelTextOutline",t[t.LabelText=48]="LabelText",t[t.Label=56]="Label",t[t.All=63]="All"}(Li||(Li={}));const Bi={"geometry.fill":Li.GeometryFill,"geometry.fill.pattern":Li.GeometryFillPattern,"geometry.outline":Li.GeometryOutline,geometry:Li.Geometry,"label.icon":Li.LabelIcon,"label.text.fill":Li.LabelTextFill,"label.text.outline":Li.LabelTextOutline,"label.text":Li.LabelText,label:Li.Label};function Ui(){return new Array(9)}Ui();function Di(t,e,i){return{x:t,y:e,z:i}}Di(0,0,0),Di(1,0,0),Di(-1,0,0),Di(0,1,0),Di(0,-1,0),Di(0,0,1),Di(0,0,-1);function ji(t,e=Di(0,0,0)){return e.x=t.x,e.y=t.y,e.z=t.z,e}function Ni(t,e,i=Di(0,0,0)){return i.x=t.x+e.x,i.y=t.y+e.y,i.z=t.z+e.z,i}function Vi(t,e,i=Di(0,0,0)){return i.x=t.x-e.x,i.y=t.y-e.y,i.z=t.z-e.z,i}function Wi(){return new Array(16)}!function(t,e=Wi()){for(let i=0;i<16;++i)e[i]=t[i]}([1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]);function qi(t,e,i=Wi()){for(let s=0;s<16;s+=4){const n=t[s],r=t[s+1],o=t[s+2],a=t[s+3];for(let t=0;t<4;++t)i[s+t]=n*e[t]+r*e[4+t]+o*e[8+t]+a*e[12+t]}return i}function Gi(t,e){return e?qi(t,e):t}function Fi(t,e){if(void 0!==t.visibility&&("off"===t.visibility?e.isHidden=!0:Ii("styler.visibility",t.visibility)),void 0!==t.scale&&(t.scale>=0?e.scale=t.scale:Ii("styler.scale",t.scale)),void 0!==t.color){const i=mt(t.color);i?e.color=i:Ii("styler.color",t.color)}if(void 0!==t["secondary-color"]){const i=mt(t["secondary-color"]);i?e.secondaryColor=i:Ii("styler.secondary-color",t["secondary-color"])}if(void 0!==t["tertiary-color"]){const i=mt(t["tertiary-color"]);i?e.tertiaryColor=i:Ii("styler.tertiary-color",t["tertiary-color"])}if(void 0!==t.hue){const i=mt(t.hue),s=i?function({r:t,g:e,b:i}){const s=Math.min(t,e,i),n=Math.max(t,e,i),r=n-s;if(_(r,0))return;let o;switch(!0){case _(n,t):o=0+(e-i)/r;break;case _(n,e):o=2+(i-t)/r;break;case _(n,i):o=4+(t-e)/r}return(o+6)%6}(i):void 0;void 0!==s?e.hue=s:Ii("styler.hue",t.hue)}void 0!==t.saturation&&(-1<=t.saturation&&t.saturation<=1?e.colorTransform=Gi(function(t){const e=.2125*(1-t),i=.7154*(1-t),s=.0721*(1-t);return[e+t,i,s,0,e,i+t,s,0,e,i,s+t,0,0,0,0,1]}(t.saturation+1),e.colorTransform):Ii("styler.saturation",t.saturation)),void 0!==t.lightness&&(-1<=t.lightness&&t.lightness<=1?e.colorTransform=Gi(function(t){const e=1-Math.abs(t),i=Math.max(0,t);return[e,0,0,i,0,e,0,i,0,0,e,i,0,0,0,1]}(t.lightness),e.colorTransform):Ii("styler.lightness",t.lightness)),void 0!==t.opacity&&(0<=t.opacity&&t.opacity<=1?e.opacity=t.opacity:Ii("styler.opacity",t.opacity))}function Yi(t){const e=function(t){if(void 0===t)return()=>!0;const e=Ri(t);return e.length>1?(s=e[0],n=e[1],t=>s<=t&&t<=n):(i=e[0],t=>t===i);var i,s,n}(t.zoom),i={};return Fi(t,i),{matchZoom:e,properties:i}}function Xi(t,e,i){if(i.isHidden)return void t.hide(e);void 0!==i.scale&&t.changeScale(e,i.scale);const s=Oi(i.color,i.hue,i.colorTransform,i.opacity,i.secondaryColor,i.tertiaryColor);void 0!==s&&t.changeColor(e,s)}class Zi{constructor(t){var e;this._types=function(t){if(void 0===t)return Ei.All;let e=Ei.None;for(const i of Ri(t)){const s=Mi[i];if(!s)return Ii("types",t),Ei.None;e|=s}return e}(t.types),this._elements=function(t){if(void 0===t)return Li.All;let e=Li.None;for(const i of Ri(t)){const s=Bi[i];if(!s)return Ii("elements",t),Li.None;e|=s}return e}(t.elements),this._matchTags=function(t){let e,i,s;return"string"==typeof t?e=Ri(t):t&&(t.all&&(e=Ri(t.all)),t.any&&(i=Ri(t.any)),t.none&&(s=Ri(t.none))),Et(e,i,s)}(t.tags),this._stylers=void 0!==(e=t.stylers)?Ri(e).map(Yi):[]}match(t,e,i){return Rt(this._types,t)&&Rt(this._elements,e)&&this._matchTags(i)}pickStylers(t){const e=[];for(const i of this._stylers)i.matchZoom(t)&&e.push(i.properties);return e}}const Hi={hide(t){t.hidden=!0},changeScale(t,e){t.scaleFactor=e},changeColor(t,e){t.transformer=e}};function Ki(t,e){return{hide(i){const s=t(i);s&&e.hide(s)},changeScale(i,s){const n=t(i);n&&e.changeScale(n,s)},changeColor(i,s){const n=t(i);n&&e.changeColor(n,s)}}}const $i={hide(t){t.hidden=!0},changeScale(t,e){t.strokeWidth*=e},changeColor(t,e){t.strokeColor=e.transform(t.strokeColor)}},Qi=Ki((function(t){return t.inline&&!t.inline.pattern?t.inline:void 0}),$i),Ji=Ki((function(t){return t.outline}),$i),ts=Ki((function(t){return t.inline&&t.inline.pattern?t.inline:void 0}),{hide:$i.hide,changeScale(t,e){$i.changeScale(t,e),t.patternScaleFactor=e},changeColor(t,e){t.patternTransformer=e}}),es={hide(t){t.hidden=!0},changeScale(){},changeColor(t,e){t.color=e.transform(t.color)}},is=Qi,ss={hide(){},changeScale(){},changeColor(t,e){t.pattern&&(t.patternTransformer=e)}};function ns(t){return{hide(e){for(const i of e.styles)i[t]=ct},changeScale(t,e){for(const i of t.styles)i.fontSize*=e},changeColor(e,i){for(const s of e.styles)s[t]=i.transform(s[t])}}}const rs=ns("color"),os=ns("outlineColor");os.changeScale=()=>{},os.hide=t=>{for(const e of t.styles){if(e.color===ct)return void(t.hidden=!0);e.outlineColor=ct}};const as=[{element:Li.LabelIcon,adapter:Hi}],ls=[{element:Li.GeometryFillRaw,adapter:Qi},{element:Li.GeometryOutline,adapter:Ji},{element:Li.GeometryFillPattern,adapter:ts}],hs=[{element:Li.GeometryFill,adapter:es},{element:Li.GeometryFillPattern,adapter:ss}],cs=[{element:Li.GeometryOutline,adapter:is}],ds=[{element:Li.LabelTextFill,adapter:rs},{element:Li.LabelTextOutline,adapter:os}];class us{constructor(){this._blocks=[]}update(t){this._blocks=t.map(t=>new Zi(t)),console.log(`styles customization config update: ${this._blocks.length} blocks`)}customizePoint(t,e,i){this._customize(t,e,Ei.Point,i,as)}customizePolyline(t,e,i){this._customize(t,e,Ei.Polyline,i,ls)}customizePolygon(t,e,i){this._customize(t,e,Ei.Polygon,i,hs)}customizePolygonContour(t,e,i){this._customize(t,e,Ei.Polygon,i,cs)}customizePointLabel(t,e,i){this._customize(t,e,Ei.Point,i,ds)}customizeCurvedLabel(t,e,i){this._customize(t,e,Ei.Polyline,i,ds)}_customize(t,e,i,s,n){var r;if(this._blocks.length)for(const o of t)for(const{element:t,adapter:a}of n){const n=[];for(const r of this._blocks)r.match(i,t,e)&&n.push(...r.pickStylers(s));if(n.length){Xi(a,o,(r=n,Object.assign({},...r)))}}}}var fs=i(2),ps=i.n(fs);class _s{constructor(){const t=this._tess=new ps.a.GluTesselator;t.gluTessNormal(0,0,1),t.gluTessCallback(ps.a.gluEnum.GLU_TESS_VERTEX_DATA,(t,e)=>{e.indices.push(t)}),t.gluTessCallback(ps.a.gluEnum.GLU_TESS_ERROR,t=>{const e=Object.keys(ps.a.errorType).find(e=>ps.a.errorType[e]===t)||"UNKNOWN";throw new Error(`${t}: ${e}`)}),t.gluTessCallback(ps.a.gluEnum.GLU_TESS_COMBINE_DATA,(t,e,i,s)=>{const n=g(t[0],t[1]);return s.vertices.push(n)-1})}triangulate(t,e=0){const i=this._tess,s=1===e?ps.a.windingRule.GLU_TESS_WINDING_NONZERO:ps.a.windingRule.GLU_TESS_WINDING_ODD;i.gluTessProperty(ps.a.gluEnum.GLU_TESS_WINDING_RULE,s);const n={vertices:[],indices:[]};i.gluTessBeginPolygon(n);for(const r of t){i.gluTessBeginContour();for(const t of r){const e=n.vertices.push(t)-1;i.gluTessVertex([t.x,t.y,0],e)}i.gluTessEndContour()}return i.gluTessEndPolygon(),n}}class gs extends Ze{constructor(t){super(t),this._tessellator=new _s}writePolygon(t,e,i,s,n){const r=ce(e),o=pt(i),{vertices:a,indices:l}=this._tessellator.triangulate(t.vertexRings,n);for(const h of a)this.writeVertex(h,o,s,r);return this.writeIndices(l),this.endMesh()}_writeVertex(t,e,i,s,n){Xe(t,e),t.writeVertexUint32(i),t.writeVertexUint32(s),t.writeVertexFloat32(n)}}class ms extends Ze{writePointLabel(t,e,i,s,n,r){const o=e.anchorPoint,a=de(e.priority,r);for(const[l,h]of Object(Y.f)(s,i.styles)){const e=pt(h.color),i=pt(h.outlineColor),s=[];for(let r=0;r<l.length;r++){const h=l[r],c=[];for(const s of h){const r=n.get(s.fontId)[s.glyphId],l=this.writeVertex(t,o,s.topLeft,{x:r.minX,y:r.minY},e,i,a,s.scale),h=this.writeVertex(t,o,s.topRight,{x:r.maxX,y:r.minY},e,i,a,s.scale),d=this.writeVertex(t,o,s.bottomRight,{x:r.maxX,y:r.maxY},e,i,a,s.scale),u=this.writeVertex(t,o,s.bottomLeft,{x:r.minX,y:r.maxY},e,i,a,s.scale);this.writeIndices([l,h,d,l,d,u]),c.push({topLeft:l,topRight:h,bottomRight:d,bottomLeft:u})}s.push(c)}this._writeHitTestLabelFillings(s)}return this.endMesh()}_writeHitTestLabelFillings(t){if(1!==t.length)for(let e=0;e<t.length-1;e++)this._writeHitTestFillingIndices(t[e],t[e+1]);else this._writeHitTestFillingIndices(t[0],t[0])}_writeHitTestFillingIndices(t,e){const[i,s,n,r]=[t[0].topLeft,t[t.length-1].topRight,e[e.length-1].bottomRight,e[0].bottomLeft];this.writeIndices([i,r,n,i,n,s])}_writeVertex(t,e,i,s,n,r,o,a,l){t.writeVertexUint32(e),Xe(t,i),t.writeVertexFloat32(s.x),t.writeVertexFloat32(s.y),t.writeVertexUint32(qe(n.x,n.y)),t.writeVertexUint32(r),t.writeVertexUint32(o),t.writeVertexFloat32(a),t.writeVertexFloat32(l)}}class ys extends Ze{writeLabel(t,e,i,s,n,r){const o=de(t.priority,r),a=Vt(t.polyline),l=a[1][0];a[0].reverse();for(const h of a)for(let t=1;t<h.length;t++)w(h[t],l,h[t]);for(const[h,c]of Object(Y.f)(i,e.styles)){const t=pt(c.color),e=pt(c.outlineColor);for(const i of h){const r=s.get(i.fontId)[i.glyphId],h=this.writeVertex(n,l,i.topLeft,{x:r.minX,y:r.minY},t,e,o,i.lineDisplacement,a,i.scale),c=this.writeVertex(n,l,i.topRight,{x:r.maxX,y:r.minY},t,e,o,i.lineDisplacement,a,i.scale),d=this.writeVertex(n,l,i.bottomRight,{x:r.maxX,y:r.maxY},t,e,o,i.lineDisplacement,a,i.scale),u=this.writeVertex(n,l,i.bottomLeft,{x:r.minX,y:r.maxY},t,e,o,i.lineDisplacement,a,i.scale);this.writeIndices([h,c,d,h,d,u])}}return this.endMesh()}_writeVertex(t,e,i,s,n,r,o,a,l,h,c){t.writeVertexUint32(e),Xe(t,i),t.writeVertexFloat32(s.x),t.writeVertexFloat32(s.y),t.writeVertexFloat32(l),t.writeVertexUint32(qe(n.x,n.y)),t.writeVertexUint32(r),t.writeVertexUint32(o),t.writeVertexFloat32(a);const d=this._computePolylineLength(h);for(const u of h)this._writePolylinePart(t,u,d);t.writeVertexFloat32(d),t.writeVertexFloat32(c)}_writePolylinePart(t,e,i){const s=[];for(let a=1;a<=4;a++)s.push(this._encodePoint(e[a],i));for(let a=0;a<4;a+=4)t.writeVertexUint32((n=Ne(s[a].ratio),r=Ne(s[a+1].ratio),o=Ne(s[a+2].ratio),Ne(s[a+3].ratio)<<24|(255&o)<<16|(255&r)<<8|255&n));var n,r,o;for(let a=0;a<4;a+=2)t.writeVertexUint32(qe(Ve(s[a].angle),Ve(s[a+1].angle)))}_encodePoint(t=g(0,0),e){return{ratio:A(t)/e,angle:(Math.atan2(t.y,t.x)+Math.PI)/(2*Math.PI)}}_computePolylineLength(t){let e=0;for(const i of t)for(let t=1;t<=4;t++)i[t]&&(e+=A(i[t]));return e}}class bs extends Ze{writeIcon(t,e,i,s,n,r,o,a){const l=i.height*n*32,h=i.width*n*32,c=(s.x+.5)*h,d=(s.y+.5)*l,u=.5*-l,f=.5*l,p=.5*-h,_=.5*h,g=de(t.priority,r),m=this.writeVertex(t.position,p,f,c,d,e.minX,e.minY,t.id,g,o,a),y=this.writeVertex(t.position,p,u,c,d,e.minX,e.maxY,t.id,g,o,a),b=this.writeVertex(t.position,_,f,c,d,e.maxX,e.minY,t.id,g,o,a),w=this.writeVertex(t.position,_,u,c,d,e.maxX,e.maxY,t.id,g,o,a);return this.writeIndices([m,b,y,y,b,w]),this.endMesh()}_writeVertex(t,e,i,s,n,r,o,a,l,h,c,d){Xe(t,e),t.writeVertexUint32(qe(i,s)),t.writeVertexUint32(qe(n,r)),t.writeVertexUint32(qe(o,a)),t.writeVertexUint32(l),t.writeVertexFloat32(h),t.writeVertexUint32(qe(Ve(c),Ve(d)))}}const ws=He([[0,{size:2,type:5123,normalized:!1}],[1,{size:2,type:5123,normalized:!1}],[7,{size:4,type:5121,normalized:!0}],[2,{size:4,type:5121,normalized:!0}],[10,{size:1,type:5126,normalized:!1}]]),vs=He([[2,{size:4,type:5121,normalized:!1}],[0,{size:2,type:5123,normalized:!1}],[1,{size:2,type:5123,normalized:!1}],[6,{size:2,type:5126,normalized:!1}],[4,{size:2,type:5123,normalized:!1}],[7,{size:4,type:5121,normalized:!0}],[8,{size:4,type:5121,normalized:!0}],[9,{size:1,type:5126,normalized:!1}],[11,{size:1,type:5126,normalized:!1}]]),xs=He([[2,{size:4,type:5121,normalized:!1}],[0,{size:2,type:5123,normalized:!1}],[1,{size:2,type:5123,normalized:!1}],[6,{size:3,type:5126,normalized:!1}],[4,{size:2,type:5123,normalized:!1}],[7,{size:4,type:5121,normalized:!0}],[8,{size:4,type:5121,normalized:!0}],[9,{size:1,type:5126,normalized:!1}],[12,{size:4,type:5121,normalized:!0}],[13,{size:4,type:5123,normalized:!0}],[14,{size:4,type:5121,normalized:!0}],[15,{size:4,type:5123,normalized:!0}],[11,{size:2,type:5126,normalized:!1}]]),ks=He([[0,{size:2,type:5123,normalized:!1}],[1,{size:2,type:5123,normalized:!1}],[6,{size:2,type:5122,normalized:!1}],[11,{size:2,type:5122,normalized:!1}],[4,{size:2,type:5123,normalized:!1}],[2,{size:4,type:5121,normalized:!1}],[9,{size:1,type:5126,normalized:!1}],[12,{size:2,type:5123,normalized:!0}]]),As=He([[0,{size:2,type:5123,normalized:!1}],[1,{size:2,type:5123,normalized:!1}],[3,{size:1,type:5126,normalized:!1}],[7,{size:4,type:5121,normalized:!0}],[2,{size:4,type:5121,normalized:!0}]]);function*Ss(t,e){const i=new Set;for(const s of function*(t){for(const e in t)yield Number(e)}(e))for(const t of e[s])i.add(t.location.bufferId);for(const s of i){const e=t.getPage(s);bi(e)&&(yield e)}}function*Ts(t,e){const i=new Set,s=e[5];s&&s.forEach(t=>i.add(t.atlasId));const n=e[6];n&&n.forEach(t=>i.add(t.atlasId));for(const r of i){const e=t.getAtlas(r);bi(e)&&(yield e)}}function*Rs(t,e){const i=new Set,s=e[7];s&&s.forEach(t=>{i.add(t.atlasId)});const n=e[4];n&&n.forEach(t=>{i.add(t.atlasId)});for(const r of i){const e=t.getAtlas(r);bi(e)&&(yield e)}}class Is extends Ze{_writeVertex(t,e,i,s){Xe(t,e),t.writeVertexFloat32(e.z),t.writeVertexUint32(i),t.writeVertexUint32(s)}}function Cs(t,e){return(e+1)%t.length}function zs(t,e){return(e||t.length)-1}function Ps(t,e){return t[Cs(t,e)]}function Os(t,e){return t[zs(t,e)]}const Es={0:3,1:3,2:1,3:1};class Ms{constructor(t){this._view=new DataView(t),this.header={signature:this._view.getUint32(0,!0),nCmdAdd:this._view.getUint32(4,!0),nCmdEtc:this._view.getUint16(8,!0),nAux:this._view.getUint16(10,!0),precision:this._view.getUint8(12)},this._auxOffset=13,this._cmdOffset=this._auxOffset+2*this.header.nAux,this._diffOffset=this._cmdOffset+this.header.nCmdAdd+this.header.nCmdEtc,this._cmdEnd=this._diffOffset}readCommand(t={type:0,valence:0,shift:0}){const e=this._view.getUint8(this._cmdOffset++),i=3&e;let s=e>>2;s=0!==s?s-1:this._readAux()+62,s+=Es[i];const n=2===i||3===i?this._readAux():0;return t.type=i,t.valence=s,t.shift=n,t}readDiff(t=Di(0,0,0)){return t.x=this._readDiff(this._diffOffset+3*this.header.nCmdAdd,this._diffOffset+0*this.header.nCmdAdd),t.y=this._readDiff(this._diffOffset+4*this.header.nCmdAdd,this._diffOffset+1*this.header.nCmdAdd),t.z=this._readDiff(this._diffOffset+5*this.header.nCmdAdd,this._diffOffset+2*this.header.nCmdAdd),this._diffOffset++,t}hasCommands(){return this._cmdOffset<this._cmdEnd}_readAux(){const t=this._view.getUint8(this._auxOffset),e=this._view.getUint8(this._auxOffset+this.header.nAux)<<8|t;return this._auxOffset++,e}_readDiff(t,e){return(i=this._view.getUint8(t)<<8|this._view.getUint8(e))>>1^-(1&i);var i}}class Ls{constructor(t,e,i){this.vertex=e,this.index=i,this._neighbours=new Array(t).fill(void 0)}calculateSpan(t,e){const i=this._neighbours.indexOf(t),s=this._neighbours.indexOf(e);return(this._neighbours.length+(s-i))%this._neighbours.length}setNeighbors(t,e,i=0,s){let n=(this._neighbours.indexOf(s)+i)%this._neighbours.length;this._neighbours[n]=t,n=Cs(this._neighbours,n),this._neighbours[n]=e}setBefore(t,e){const i=this._neighbours.indexOf(t);this._neighbours[zs(this._neighbours,i)]=e}setAfter(t,e){const i=this._neighbours.indexOf(t);this._neighbours[Cs(this._neighbours,i)]=e}getPrevNeighbor(t){const e=this._neighbours.indexOf(t);return Os(this._neighbours,e)}getNextNeighbor(t){const e=this._neighbours.indexOf(t);return Ps(this._neighbours,e)}}const Bs=Di(-1,-1,-1);class Us extends Ls{constructor(t){super(t,Bs,-1)}static isHoleNode(t){return t instanceof Us}}const Ds=Di(0,0,0),js=Di(0,0,0),Ns={type:0,valence:0,shift:0};function Vs(t,e,i,s){Us.isHoleNode(t)||Us.isHoleNode(e)||Us.isHoleNode(i)||s.writeIndices([t.index,e.index,i.index])}const Ws=(t,e)=>t-e;function qs(t,e){const i=new Array(t.length);for(let r=0,o=t.length;o>0;){if(i[r]=t[r].calculateSpan(Os(t,r),Ps(t,r)),i[r]>1)r=Cs(t,r),o--;else if(1===i[r]){const s=t[r],n=Os(t,r),a=Ps(t,r);a.setAfter(s,n),n.setBefore(s,a),Vs(s,n,a,e);for(let t=r;t<i.length-1;t++)i[t]=i[t+1];t.splice(r,1),r=zs(t,r),o++}else Ie(t,t.length-Cs(t,r)),t.splice(t.length-2,2),r=0,o=t.length;if(t.length<3)return}let s=0,n=[i[s],i[zs(t,s)],i[Cs(t,s)]];for(let r=1;r<t.length;r++){const e=[i[r],i[zs(t,r)],i[Cs(t,r)]];ze(Ws,e,n)<0&&(n=e,s=r)}Ie(t,t.length-s)}function Gs(t,e,i,s,n,r){s.setNeighbors(e,i,n,r),e.setAfter(i,s),i.setBefore(e,s),Vs(s,e,i,t)}function Fs(t,e,i,s,n){const r=e[0],o=r[0],a=r[r.length-1];switch(t.type){case 0:{const e=o.getPrevNeighbor(a);let l;Us.isHoleNode(o)||Us.isHoleNode(a)||Us.isHoleNode(e)?l=Us.isHoleNode(o)?a.vertex:o.vertex:(Ni(a.vertex,o.vertex,js),Vi(js,e.vertex,js),s.clamp(js,js),l=js),i.readDiff(Ds),Ni(l,Ds,js);const h=ji(js),c=s.decode(h),d=new Ls(t.valence,h,n.writeVertex(c));Gs(n,o,a,d,0),r.push(d);break}case 1:{const e=new Us(t.valence);Gs(n,o,a,e,0),r.push(e);break}case 2:{const i=t.shift;Gs(n,o,a,r[i],t.valence,r[i-1]),e.push(r.slice(0,i+1)),r.splice(0,i);break}case 3:{let i=1;for(;i!==e.length&&e[i].length<=t.shift;i++)t.shift-=e[i].length;Ie(e[i],e[i].length-t.shift),Gs(n,o,a,e[i][0],t.valence,e[i][e[i].length-1]),e[i].push(e[i][0]),r.splice(0,0,...e[i]),e.splice(i,1);break}}}function Ys(t,e,i){const s=[function(t,e,i){const s=Di(0,0,0),n=new Array(3);for(let r=0;r<3;r++){const o=t.readCommand();1===o.type?n[r]=new Us(o.valence):0===o.type&&(t.readDiff(Ds),Ni(s,Ds,s),n[r]=new Ls(o.valence,ji(s),i.writeVertex(e.decode(s))))}for(let r=0;r<n.length;r++)n[r].setNeighbors(Ps(n,r),Os(n,r));return Vs(n[0],n[1],n[2],i),n}(t,e,i)];for(;0!==s.length;){for(qs(s[0],i);s[0].length>2;)Fs(t.readCommand(Ns),s,t,e,i),qs(s[0],i);s.shift()}return i.flush()}class Xs{constructor(t){this._precisionXY=15&t,this._precisionZ=t>>4,this._shiftXY=16-this._precisionXY,this._shiftZ=16-this._precisionZ,this._maxXY=(1<<this._precisionXY)-1,this._maxZ=(1<<this._precisionZ)-1}clamp(t,e=Di(0,0,0)){return e.x=L(t.x,0,this._maxXY),e.y=L(t.y,0,this._maxXY),e.z=L(t.z,0,this._maxZ),e}decode(t,e=Di(0,0,0)){return e.x=Xs._decode(t.x,this._precisionXY,this._shiftXY),e.y=Xs._decode(t.y,this._precisionXY,this._shiftXY),e.z=Xs._decode(t.z,this._precisionZ,this._shiftZ),e}static _decode(t,e,i){return t<<=i,t=(t|=t>>e)/65535}}class Zs extends Is{constructor(t){super(t),this._trimeshWriter={writeVertex:t=>{const e=this._currentMesh;if(e){const i=e.bbox;return t.x=U(i.minX,i.maxX,t.x),t.y=U(i.minY,i.maxY,t.y),t.z=U(i.maxZ,i.minZ,t.z),this.writeVertex(t,this._currentColor,e.id)}return-1},writeIndices:t=>this.writeIndices(t),flush:()=>this.endMesh()}}writeModel(t,e){this._currentMesh=e,this._currentColor=pt(e.color);const i=[];let s;for(const n of function*(t,e){const i=new Ms(t),s=new Xs(i.header.precision);for(;i.hasCommands();)yield Ys(i,s,e)}(t,this._trimeshWriter))s?s.bufferId===n.bufferId?(s.vertexByteLength+=n.vertexByteLength,s.indexByteLength+=n.indexByteLength):(i.push(s),s=n):s=n;return i.push(s),i}}class Hs extends Is{constructor(t){super(t),this._tessellator=new _s}writePolygon(t,e,i,s){const n=pt(i),{vertices:r,indices:o}=this._tessellator.triangulate(t.vertexRings);for(const a of r)this.writeVertex(Object.assign(Object.assign({},a),{z:e}),n,s);for(const a of r)this.writeVertex(Object.assign(Object.assign({},a),{z:0}),n,s);return this.writeIndices(o),this._buildWall(t.vertexRings,r.length),this.endMesh()}_buildWall(t,e){let i=0;for(const s of t){for(let t=0;t<s.length;t++){const n=i+t,r=i+(t+1)%s.length;this.writeIndices([n+e,r,n,n+e,r+e,r])}i+=s.length}}}function Ks(t,e){let i;return()=>{i&&setTimeout(t=>t.release(),0,i),i=t.getFreeOrCreatePage(e),i.retain();const s=t=>{t.release(),t.onRetain.removeListener(s)};return i.retain(),i.onRetain.addListener(s),i.data}}class $s{constructor(t,e,i,s,n,r,o){this._registry=t,this._glyphAtlasRegistry=e,this._iconAtlasRegistry=i,this._taskQueue=n,this._loadManager=r,this._taskPriority=o,this._objectIdProvider=s,this._opaquePolygonBufferWriter=new gs(Ks(t,ws)),this._transparentPolygonBufferWriter=new gs(Ks(t,ws)),this._extrudedPolygonWriter=new Hs(Ks(t,As)),this._trimeshBufferWriter=new Zs(Ks(t,As)),this._polylineBufferWriter=new Je(Ks(t,Ke)),this._pointLabelBufferWriter=new ms(Ks(t,vs)),this._curvedLabelBufferWriter=new ys(Ks(t,xs)),this._iconBufferWriter=new bs(Ks(t,ks)),this._sharedResourcesExtractors=[Ss.bind(void 0,this._registry),Ts.bind(void 0,this._glyphAtlasRegistry),Rs.bind(void 0,this._iconAtlasRegistry)]}_extractSharedResources(t){const e=[];for(const i of this._sharedResourcesExtractors)e.push(...i(t));return e}}class Qs{constructor(t){this._objectIdProvider=t,this._ids=new Map,this._tileIds=new Map}createSharedIdProvider(t){return{idGenerator:e=>this._getObjectId(t,e),collidingIdGenerator:e=>this._getCollidingObjectId(t,e)}}releaseTileObjectIds(t){const e=this._tileIds.get(t);if(e){this._tileIds.delete(t);for(const t of e)this._releaseId(t)}}_getObjectId(t,e){return this._getId(t,e,this._objectIdProvider.idGenerator)}_getCollidingObjectId(t,e){return this._getId(t,e,this._objectIdProvider.collidingIdGenerator)}_getId(t,e,i){if(!e)return i();return this._addIdToTile(t,e),this._retainId(e,i).id}_addIdToTile(t,e){let i=this._tileIds.get(t);i||(i=[],this._tileIds.set(t,i)),i.push(e)}_retainId(t,e){let i=this._ids.get(t);return i?i.count++:(i={id:e(),count:1},this._ids.set(t,i)),i}_releaseId(t){const e=this._ids.get(t);e?(e.count--,0===e.count&&this._ids.delete(t)):console.warn("Tried to release non-existing id")}}function Js(t){if("function"!=typeof t)throw new Error("Predicate must be a function");return`(${t.toString()})`}const tn=Js((t,e)=>(null==t?void 0:t.get("objectId"))===(null==e?void 0:e.get("objectId"))),en=Js((t,e)=>(null==t?void 0:t.get("objectId"))===(null==e?void 0:e.get("objectId"))&&(null==t?void 0:t.get("indoor_covered"))===(null==e?void 0:e.get("indoor_covered"))),sn={tileUrlTemplate:"no tileUrlTemplate specified",meshUrlTemplate:"no meshUrlTemplate specified",tileSize:0,tileCacheSize:300,mapMode:0,customizationConfig:[],objectsCollisionPriority:1,polygonsBatchingRule:tn,modelsBatchingRule:en,polylinesBatchingRule:tn,labelsBatchingRule:tn,tileRequestWithCredentials:!1,meshRequestWithCredentials:!1,allObjectsInteractive:!1,computeIconBrightnessRange:!1};class nn extends $s{constructor(t,e,i,s,n,r,o,a,l,h,c){super(s,n,r,a,l,h,c),this._communicator=t,this._storage=e,this._modelStorage=i,this._viewport=o,this._requests=new Map,this._modelRequests=new Map,this._options=Object.assign({},sn),this._tileLoader=new Ti(this._loadManager,this._storage),this._stylesCustomizer=new us,this._objectIdManager=new Qs(a),this._communicator.onMessage.addListener(this._onMessage,this),this._storage.onAdded.addListener(this._onTileAdded,this),this._storage.onRemoved.addListener(this._onTileRemoved,this),this._modelStorage.onRemoved.addListener(this._onModelRemoved,this)}destructor(){this._modelStorage.onRemoved.removeListener(this._onModelRemoved),this._storage.onRemoved.removeListener(this._onTileRemoved),this._storage.onAdded.removeListener(this._onTileAdded),this._communicator.onMessage.removeListener(this._onMessage)}_createTileRequest(t,e){const i=this._objectIdManager.createSharedIdProvider(t.id);return new yi(t,e,this._taskQueue,this._tileLoader,this._viewport,this._taskPriority,this._opaquePolygonBufferWriter,this._transparentPolygonBufferWriter,this._extrudedPolygonWriter,this._polylineBufferWriter,this._pointLabelBufferWriter,this._curvedLabelBufferWriter,this._iconBufferWriter,this._registry,this._glyphAtlasRegistry,this._iconAtlasRegistry,i,this._stylesCustomizer)}_onMessage(t){switch(t.type){case 0:this._onSetup(t);break;case 2:this._onCustomize(t)}}_setOptions(t){this._options=Object.assign(Object.assign({},sn),t)}_onTileAdded(t){const e=this._createTileRequest(t,this._options);this._requests.set(t.id,e),e.onContentReady.addListener(e=>this._onTileContentReady(t,e)),e.onModelRequired.addListener(e=>this._onModelRequired(t,e)),e.start()}_onTileRemoved(t){const e=this._requests.get(t.id);bi(e)&&(e.destructor(),this._requests.delete(t.id)),this._objectIdManager.releaseTileObjectIds(t.id)}_onSetup(t){this._setOptions(t.options),this._tileLoader.update(this._options.tileUrlTemplate,this._options.tileSize,this._options.tileRequestWithCredentials)}_onCustomize(t){this._stylesCustomizer.update(t.customizationConfig)}_onModelRemoved(t){const e=this._modelRequests.get(t.id);bi(e)&&(e.destructor(),this._modelRequests.delete(t.id))}_onTileContentReady(t,e){e.contentToRemove&&this._communicator.sendMessage({type:4,tileId:t.id,content:e.contentToRemove},!1),t.addContent(e.content,this._extractSharedResources(e.content.primitives)),this._registry.flushBackendUpdates(),this._iconAtlasRegistry.flushAtlasesUpdates(),this._communicator.sendMessage({type:3,tileId:t.id,content:e.content,metrics:e.metrics},!0)}_onModelContentReady(t,e){const i=[];for(const s of this._sharedResourcesExtractors)i.push(...s(e.primitives));t.addContent({content:e,resources:i}),this._registry.flushBackendUpdates(),this._communicator.sendMessage({type:5,modelId:t.id,content:e},!0)}_onModelRequired(t,e){if(this._options.meshUrlTemplate){const i=ci(e);let s=this._modelStorage.get(i);s||(s=new Si(i,e),this._modelStorage.add(i,s));let n=this._modelRequests.get(i);n||(n=new ki(s,this._taskQueue,this._loadManager,this._viewport,this._taskPriority,this._trimeshBufferWriter,this._options.meshUrlTemplate,this._options.meshRequestWithCredentials),this._modelRequests.set(s.id,n),n.onContentReady.addListener(t=>this._onModelContentReady(s,t)),n.start()),n.addTile(t),t.addContent(s,[s])}}}var rn;!function(t){t[t.FROM_BACKEND_ADD_PAGE=0]="FROM_BACKEND_ADD_PAGE",t[t.FROM_BACKEND_UPDATE_PAGE=1]="FROM_BACKEND_UPDATE_PAGE",t[t.FROM_BACKEND_REMOVE_PAGE=2]="FROM_BACKEND_REMOVE_PAGE"}(rn||(rn={}));Error;class on{constructor(t,e){this._wordByteSize=e,this._nextWordOffset=0,this._currentMeshByteOffset=0,this._uint8View=new Uint8Array(t)}get data(){return this._uint8View.buffer}get byteSize(){return this._uint8View.byteLength}get occupiedByteSize(){return this._nextWordOffset*this._wordByteSize}endMesh(){const t=this._currentMeshByteOffset,e=this.occupiedByteSize,i=e-t;return this._currentMeshByteOffset=e,{byteOffset:t,byteSize:i}}transferUnfinishedMesh(t){const e=this.occupiedByteSize,i=e-this._currentMeshByteOffset,s=this._uint8View.subarray(this._currentMeshByteOffset,e);t._uint8View.set(s,0),t._nextWordOffset=i/this._wordByteSize,this._nextWordOffset=this._currentMeshByteOffset/this._wordByteSize}reset(){this._nextWordOffset=0,this._currentMeshByteOffset=0}}class an extends on{constructor(t,e){super(t*e,Uint32Array.BYTES_PER_ELEMENT),this.vertexByteSize=e,this._uint32View=new Uint32Array(this._uint8View.buffer),this._float32View=new Float32Array(this._uint8View.buffer),this._currentMeshBaseIndex=0}get currentMeshBaseIndex(){return this._currentMeshBaseIndex}get isFull(){return this._nextWordOffset>=this._uint32View.length}pushUint32(t){this._uint32View[this._nextWordOffset++]=t}pushFloat32(t){this._float32View[this._nextWordOffset++]=t}asUint32Array(){return this._uint32View.subarray(0,this._nextWordOffset)}endMesh(){return this._currentMeshBaseIndex=this.occupiedByteSize/this.vertexByteSize,super.endMesh()}reset(){this._currentMeshBaseIndex=0,super.reset()}}class ln extends on{constructor(t){const e=Uint16Array.BYTES_PER_ELEMENT;super(t*e,e),this._uint16View=new Uint16Array(this._uint8View.buffer)}get size(){return this._uint16View.length}get occupiedSize(){return this._nextWordOffset}push(t){this._uint16View[this._nextWordOffset++]=t}asUint16Array(){return this._uint16View.subarray(0,this._nextWordOffset)}transferUnfinishedMesh(t,e=0){if(super.transferUnfinishedMesh(t),e)for(let i=0;i<t._nextWordOffset;i++)t._uint16View[i]-=e}}class hn{constructor(t,e,i,n){this.id=t,this.vertexBuffer=new an(e,i),this.indexBuffer=new ln(n),this.onMeshWritten=this._onMeshWritten=new s}writeVertexUint32(t){this.vertexBuffer.pushUint32(t)}writeVertexFloat32(t){this.vertexBuffer.pushFloat32(t)}writeIndices(t){const e=this.vertexBuffer.currentMeshBaseIndex;for(const i of t)this.indexBuffer.push(e+i)}endMesh(){const t=this.vertexBuffer.endMesh(),e=this.indexBuffer.endMesh(),i={vertexByteOffset:t.byteOffset,vertexByteLength:t.byteSize,indexByteOffset:e.byteOffset,indexByteLength:e.byteSize,indexType:5123,bufferId:this.id};return this._onMeshWritten.fire(i),i}reset(){this.vertexBuffer.reset(),this.indexBuffer.reset()}}const cn={vertexMinByte:Number.MAX_SAFE_INTEGER,vertexMaxByte:Number.MIN_SAFE_INTEGER,indexMinByte:Number.MAX_SAFE_INTEGER,indexMaxByte:Number.MIN_SAFE_INTEGER};class dn extends Ai{constructor(t,e,i,n,r){super(),this.id=t,this.attribMapping=e,this.data=new hn(t,i,n,r),this.data.onMeshWritten.addListener(this._onMeshWritten,this),this.onUpdate=this._onUpdate=new s,this._updatedRegion=Object.assign({},cn)}reset(){this.data.reset(),this.flushUpdatedRegion()}touch(t){this._onMeshWritten(t)}flushUpdatedRegion(){const t=this._updatedRegion;return this._updatedRegion=Object.assign({},cn),t}_onMeshWritten(t){t.vertexByteOffset<this._updatedRegion.vertexMinByte&&(this._updatedRegion.vertexMinByte=t.vertexByteOffset);const e=t.vertexByteOffset+t.vertexByteLength;e>this._updatedRegion.vertexMaxByte&&(this._updatedRegion.vertexMaxByte=e),t.indexByteOffset<this._updatedRegion.indexMinByte&&(this._updatedRegion.indexMinByte=t.indexByteOffset);const i=t.indexByteOffset+t.indexByteLength;i>this._updatedRegion.indexMaxByte&&(this._updatedRegion.indexMaxByte=i),this._onUpdate.fire(this)}}class un{constructor(t){this._communicator=t,this._updatedPages=new Set,this._pages=new Map,this._freePages=new Map,this._lastGeneratedPageId=0}getPage(t){return this._pages.get(t)}getFreeOrCreatePage(t){const e=this._freePages.get(t),i=e&&e.pop();if(i)return i.reset(),i;{const e=this._generateId(),i=new dn(e,t,65536,t.vertexByteSize,131072);return i.onUpdate.addListener(this._onPageUpdated,this),i.onReleased.addListener(this._onPageReleased,this),this._pages.set(e,i),this._communicator.sendMessage({type:rn.FROM_BACKEND_ADD_PAGE,id:e,attribMapping:t,vertexDataByteSize:i.data.vertexBuffer.byteSize,indexDataByteSize:i.data.indexBuffer.byteSize},!1),i}}flushBackendUpdates(){for(const t of this._updatedPages){const{vertexMinByte:e,vertexMaxByte:i,indexMinByte:s,indexMaxByte:n}=t.flushUpdatedRegion(),r=t.data.vertexBuffer.data.slice(e,i),o=t.data.indexBuffer.data.slice(s,n);this._communicator.sendMessage({type:rn.FROM_BACKEND_UPDATE_PAGE,id:t.id,vertexData:r,vertexByteOffset:e,indexData:o,indexByteOffset:s},!1,r,o)}this._updatedPages.clear()}_onPageUpdated(t){this._updatedPages.add(t)}_onPageReleased(t){const e=this._freePages.get(t.attribMapping);e?e.push(t):this._freePages.set(t.attribMapping,[t])}_generateId(){return this._lastGeneratedPageId++}}function fn(t){return(t+1>>1)-1}function pn(t){return(t+1<<1)-1}class _n{constructor(t=Se){this._items=[],this._comparator=t}insert(t){const e=this._items,i=this._comparator;let s=e.push(t)-1,n=fn(s);for(;n>-1&&i(e[s],e[n])>0;)Te(e,s,n),s=n,n=fn(s)}pop(){const t=this._items;if(0===t.length)return;const e=t[0];return this._removeByIndex(0),e}peek(){return this._items[0]}*[Symbol.iterator](){for(const t of this._items)yield t}get size(){return this._items.length}remove(t){const e=this._items.findIndex(t);-1!=e&&this._removeByIndex(e)}_restoreOrderDownward(t){let e=t,i=pn(e);const s=this._items.length,n=this._comparator,r=this._items;for(;i<s&&(i+1<s&&n(r[i],r[i+1])<0&&(i+=1),!(n(r[e],r[i])>0));)Te(r,e,i),e=i,i=pn(i)}_removeByIndex(t){Te(this._items,t,this._items.length-1),this._items.pop(),this._restoreOrderDownward(t)}}function gn(t,e){return t.priority-e.priority}class mn{constructor(){this._heap=new _n(gn)}enqueue(t){this._heap.insert(t)}dequeue(){return this._heap.pop()}peek(){return this._heap.peek()}isEmpty(){return 0===this._heap.size}get size(){return this._heap.size}remove(t){this._heap.remove(t)}}class yn{constructor(t=50){this._queue=new mn,this._frozen=!1,this._dequeueTimeoutHandle=0,this.onEmpty=this._onEmpty=new s,this.onAdd=this._onAdd=new s,this._maxDequeueDuration=t}destroy(){clearTimeout(this._dequeueTimeoutHandle)}enqueue(t){return this._onAdd.fire(),this._frozen||this._setDequeueTimeout(),new Promise((e,i)=>{this._queue.enqueue({execute(){try{t.execute(),e()}catch(s){i(s)}},priority:t.priority})})}enqueueSync(t){this._queue.enqueue(t),this._setDequeueTimeout()}remove(t){this._queue.remove(e=>e===t)}isEmpty(){return this._queue.isEmpty()}freeze(){this._dequeueTimeoutHandle&&(clearTimeout(this._dequeueTimeoutHandle),this._dequeueTimeoutHandle=0),this._frozen=!0}unfreeze(){this._frozen=!1,this._queue.isEmpty()||this._setDequeueTimeout()}_dequeue(){if(this._dequeueTimeoutHandle=0,null===this._maxDequeueDuration)for(;this._queue.size;)this._queue.dequeue().execute();else{const t=me();for(;this._queue.size&&(this._queue.dequeue().execute(),!(me()-t>this._maxDequeueDuration)););}this._queue.isEmpty()?this._onEmpty.fire():this._setDequeueTimeout()}_setDequeueTimeout(){this._dequeueTimeoutHandle||(this._dequeueTimeoutHandle=setTimeout(()=>this._dequeue(),0))}}var bn;function wn(t=0,e=0){return{width:t,height:e}}!function(t){t[t.TO_BACKEND_SETUP=0]="TO_BACKEND_SETUP",t[t.FROM_BACKEND_ADD_ATLAS=1]="FROM_BACKEND_ADD_ATLAS",t[t.FROM_BACKEND_UPDATE_ATLAS=2]="FROM_BACKEND_UPDATE_ATLAS",t[t.FROM_BACKEND_REMOVE_ATLAS=3]="FROM_BACKEND_REMOVE_ATLAS"}(bn||(bn={}));class vn{constructor(t,e){this.width=t,this.height=e,this._cursor={x:0,y:0,lineHeight:0}}createRestorePoint(){return Object.assign({},this._cursor)}resetToRestorePoint(t){Object.assign(this._cursor,t)}allocate(t,e){const{x:i,y:s,lineHeight:n}=this._cursor,r=this.width-i,o=this.height-s;if(t<=r&&e<=o)return this._cursor.x=i+t,this._cursor.lineHeight=Math.max(n,e),{minX:i,maxX:i+t,minY:s,maxY:s+e};const a=this.height-(s+n);return t<=this.width&&e<=a?(this._cursor.x=t,this._cursor.y=s+n,this._cursor.lineHeight=e,{minY:this._cursor.y,maxY:this._cursor.y+e,minX:0,maxX:t}):void 0}}const xn={minX:Number.MAX_SAFE_INTEGER,maxX:Number.MIN_SAFE_INTEGER,minY:Number.MAX_SAFE_INTEGER,maxY:Number.MIN_SAFE_INTEGER};class kn extends Ai{constructor(t,e,i){super(),this.id=t,this.width=e,this.height=i,this.data=this._data=new Uint8Array(e*i),this.allocatedGlyphs=this._allocatedGlyphs=new Map,this.allocatedRanges=new xe,this._allocator=new vn(e,i),this._initAllocatorState=this._allocator.createRestorePoint(),this._updatedRegion=Object.assign({},xn)}allocate(t,e){const i=this._allocator.createRestorePoint(),s=new Map;for(const[n,r]of t){const t=e.get(n);if(bi(t)){const e=p(s,n,()=>new Set);for(const[s,o]of r)if(!this.allocatedRanges.contains(n,s)){const n=Math.min(o,t.glyphs.length);for(let r=s;r<n;++r){const s=t.glyphs[r];if(bi(s)){const n=this._allocator.allocate(s.width+2*t.margin,s.height+2*t.margin);if(!n)return this._allocator.resetToRestorePoint(i),!1;e.add({glyph:s,location:n})}}}}}for(const[n,r]of s){const t=p(this._allocatedGlyphs,n,()=>[]);for(const i of r)t[i.glyph.id]=i.location,this._insertGlyphBitmap(i.location,i.glyph.bitmap);this.allocatedRanges.addRangesForGlyphs(n,...Object(Y.c)(r,t=>t.glyph.id));const e=this._computeUpdatedRegion(Object(Y.c)(r,t=>t.location));e&&(this._updatedRegion=this._computeUpdatedRegion([e,this._updatedRegion]))}return!0}flushUpdates(){if(this._updatedRegion.minX!==xn.minX){const t=this._updatedRegion.maxX-this._updatedRegion.minX,e=this._updatedRegion.maxY-this._updatedRegion.minY,i=new Uint8Array(t*e);let s=0;for(let a=this._updatedRegion.minY;a<this._updatedRegion.maxY;++a)for(let t=this._updatedRegion.minX;t<this._updatedRegion.maxX;++t)i[s]=this._data[a*this.width+t],++s;const n=this._updatedRegion,r=g(n.minX,n.minY),o=wn(n.maxX-n.minX,n.maxY-n.minY);return this._updatedRegion=Object.assign({},xn),{offset:r,size:o,data:i}}}reset(){this._allocatedGlyphs.clear(),this.allocatedRanges.clear(),this._allocator.resetToRestorePoint(this._initAllocatorState),this._updatedRegion=Object.assign({},xn)}_insertGlyphBitmap(t,e){const i=this.width;let s=0;for(let n=t.minY;n<t.maxY;++n)for(let r=t.minX;r<t.maxX;++r)this._data[n*i+r]=e[s],++s}_computeUpdatedRegion(t){const e=function(t){let e;for(const i of t)e?(i.minX<e.minX&&(e.minX=i.minX),i.maxX>e.maxX&&(e.maxX=i.maxX),i.minY<e.minY&&(e.minY=i.minY),i.maxY>e.maxY&&(e.maxY=i.maxY)):e=Object.assign({},i);return e}(t);return e?{minY:e.minY,maxY:e.maxY,minX:4*Math.floor(e.minX/4),maxX:4*Math.ceil(e.maxX/4)}:void 0}}const An={glyphRangeUrlTemplate:"no url for glyph ranges",glyphRequestWithCredentials:!1};class Sn{constructor(t,e,i=2048,s=2048){this._communicator=t,this._fontLoader=e,this._atlasWidth=i,this._atlasHeight=s,this._loadedFontsAsRanges=new xe,this._atlases=[],this._freeAtlases=[],this.loadedFonts=this._loadedFonts=new Map,this._options=Object.assign({},An),this._communicator.onMessage.addListener(this._onMessage,this)}destructor(){this._communicator.onMessage.removeListener(this._onMessage)}getAtlas(t){return this._atlases[t]}hasAllGlyphsLoaded(t){return this._loadedFontsAsRanges.containsAll(t)}getAtlasWithGlyphs(t){return this._getAtlas(t)}loadGlyphsAndGetAtlas(t,e){const i=[];for(const[s,n]of t)for(const[t,r]of n)this._loadedFontsAsRanges.contains(s,t)||i.push(this._loadRange(s,t,r,e));return Promise.all(i).then(()=>this._getAtlas(t))}_onMessage(t){switch(t.type){case bn.TO_BACKEND_SETUP:this._onSetup(t)}}_onSetup(t){Object.assign(this._options,t.options)}_loadRange(t,e,i,s){let n=this._loadedFonts.get(t);n||(n={id:t,xheight:-1,margin:-1,glyphs:[]},this._loadedFonts.set(t,n));const r=this._options.glyphRangeUrlTemplate.replace("{{hostAlias}}",wi(t+e)).replace("{{fontId}}",t).replace("{{range}}",e+","+i),o=this._options.glyphRequestWithCredentials;return this._fontLoader.fillFont(r,n,e,s,{withCredentials:o}).then(()=>{this._loadedFontsAsRanges.addRangesForGlyphs(t,e)})}_getAtlas(t){for(const i of this._atlases)if(i.allocatedRanges.containsAll(t))return i;const e=this._atlases[this._atlases.length-1];if(e&&e.allocate(t,this._loadedFonts)){const t=e.flushUpdates();return bi(t)&&this._communicator.sendMessage(Object.assign({type:bn.FROM_BACKEND_UPDATE_ATLAS,atlasId:e.id},t),!1,t.data.buffer),e}{let e=this._freeAtlases.pop();if(!e){const t=new kn(this._atlases.length,this._atlasWidth,this._atlasHeight);t.onReleased.addListener(()=>{t.reset(),this._freeAtlases.push(t)}),this._atlases.push(t),this._communicator.sendMessage({type:bn.FROM_BACKEND_ADD_ATLAS,atlasId:t.id,width:t.width,height:t.height},!1),e=t}if(e.allocate(t,this._loadedFonts)){const t=e.flushUpdates();return t&&this._communicator.sendMessage(Object.assign({type:bn.FROM_BACKEND_UPDATE_ATLAS,atlasId:e.id},t),!1),e}throw new Error("Couldnt allocate glyphs in atlas")}}}i(32);const Tn=new TextDecoder("utf-8");const Rn=new TextEncoder;class In{constructor(t=8192,e={}){let i=!1;"number"==typeof t?t=new ArrayBuffer(t):(i=!0,this.lastWrittenByte=t.byteLength);const s=e.offset?e.offset>>>0:0,n=t.byteLength-s;let r=s;(ArrayBuffer.isView(t)||t instanceof In)&&(t.byteLength!==t.buffer.byteLength&&(r=t.byteOffset+s),t=t.buffer),this.lastWrittenByte=i?n:0,this.buffer=t,this.length=n,this.byteLength=n,this.byteOffset=r,this.offset=0,this.littleEndian=!0,this._data=new DataView(this.buffer,r,n),this._mark=0,this._marks=[]}available(t=1){return this.offset+t<=this.length}isLittleEndian(){return this.littleEndian}setLittleEndian(){return this.littleEndian=!0,this}isBigEndian(){return!this.littleEndian}setBigEndian(){return this.littleEndian=!1,this}skip(t=1){return this.offset+=t,this}seek(t){return this.offset=t,this}mark(){return this._mark=this.offset,this}reset(){return this.offset=this._mark,this}pushMark(){return this._marks.push(this.offset),this}popMark(){const t=this._marks.pop();if(void 0===t)throw new Error("Mark stack empty");return this.seek(t),this}rewind(){return this.offset=0,this}ensureAvailable(t=1){if(!this.available(t)){const e=2*(this.offset+t),i=new Uint8Array(e);i.set(new Uint8Array(this.buffer)),this.buffer=i.buffer,this.length=this.byteLength=e,this._data=new DataView(this.buffer)}return this}readBoolean(){return 0!==this.readUint8()}readInt8(){return this._data.getInt8(this.offset++)}readUint8(){return this._data.getUint8(this.offset++)}readByte(){return this.readUint8()}readBytes(t=1){const e=new Uint8Array(t);for(let i=0;i<t;i++)e[i]=this.readByte();return e}readInt16(){const t=this._data.getInt16(this.offset,this.littleEndian);return this.offset+=2,t}readUint16(){const t=this._data.getUint16(this.offset,this.littleEndian);return this.offset+=2,t}readInt32(){const t=this._data.getInt32(this.offset,this.littleEndian);return this.offset+=4,t}readUint32(){const t=this._data.getUint32(this.offset,this.littleEndian);return this.offset+=4,t}readFloat32(){const t=this._data.getFloat32(this.offset,this.littleEndian);return this.offset+=4,t}readFloat64(){const t=this._data.getFloat64(this.offset,this.littleEndian);return this.offset+=8,t}readChar(){return String.fromCharCode(this.readInt8())}readChars(t=1){let e="";for(let i=0;i<t;i++)e+=this.readChar();return e}readUtf8(t=1){return e=this.readBytes(t),Tn.decode(e);var e}writeBoolean(t){return this.writeUint8(t?255:0),this}writeInt8(t){return this.ensureAvailable(1),this._data.setInt8(this.offset++,t),this._updateLastWrittenByte(),this}writeUint8(t){return this.ensureAvailable(1),this._data.setUint8(this.offset++,t),this._updateLastWrittenByte(),this}writeByte(t){return this.writeUint8(t)}writeBytes(t){this.ensureAvailable(t.length);for(let e=0;e<t.length;e++)this._data.setUint8(this.offset++,t[e]);return this._updateLastWrittenByte(),this}writeInt16(t){return this.ensureAvailable(2),this._data.setInt16(this.offset,t,this.littleEndian),this.offset+=2,this._updateLastWrittenByte(),this}writeUint16(t){return this.ensureAvailable(2),this._data.setUint16(this.offset,t,this.littleEndian),this.offset+=2,this._updateLastWrittenByte(),this}writeInt32(t){return this.ensureAvailable(4),this._data.setInt32(this.offset,t,this.littleEndian),this.offset+=4,this._updateLastWrittenByte(),this}writeUint32(t){return this.ensureAvailable(4),this._data.setUint32(this.offset,t,this.littleEndian),this.offset+=4,this._updateLastWrittenByte(),this}writeFloat32(t){return this.ensureAvailable(4),this._data.setFloat32(this.offset,t,this.littleEndian),this.offset+=4,this._updateLastWrittenByte(),this}writeFloat64(t){return this.ensureAvailable(8),this._data.setFloat64(this.offset,t,this.littleEndian),this.offset+=8,this._updateLastWrittenByte(),this}writeChar(t){return this.writeUint8(t.charCodeAt(0))}writeChars(t){for(let e=0;e<t.length;e++)this.writeUint8(t.charCodeAt(e));return this}writeUtf8(t){return this.writeBytes(function(t){return Rn.encode(t)}(t))}toArray(){return new Uint8Array(this.buffer,this.byteOffset,this.lastWrittenByte)}_updateLastWrittenByte(){this.offset>this.lastWrittenByte&&(this.lastWrittenByte=this.offset)}}var Cn=i(6);const zn=[137,80,78,71,13,10,26,10],Pn=[];for(let Xo=0;Xo<256;Xo++){let t=Xo;for(let e=0;e<8;e++)1&t?t=3988292384^t>>>1:t>>>=1;Pn[Xo]=t}function On(t,e){return(4294967295^function(t,e,i){let s=t;for(let n=0;n<i;n++)s=Pn[255&(s^e[n])]^s>>>8;return s}(4294967295,t,e))>>>0}var En,Mn,Ln,Bn;!function(t){t[t.UNKNOWN=-1]="UNKNOWN",t[t.GREYSCALE=0]="GREYSCALE",t[t.TRUECOLOUR=2]="TRUECOLOUR",t[t.INDEXED_COLOUR=3]="INDEXED_COLOUR",t[t.GREYSCALE_ALPHA=4]="GREYSCALE_ALPHA",t[t.TRUECOLOUR_ALPHA=6]="TRUECOLOUR_ALPHA"}(En||(En={})),function(t){t[t.UNKNOWN=-1]="UNKNOWN",t[t.DEFLATE=0]="DEFLATE"}(Mn||(Mn={})),function(t){t[t.UNKNOWN=-1]="UNKNOWN",t[t.ADAPTIVE=0]="ADAPTIVE"}(Ln||(Ln={})),function(t){t[t.UNKNOWN=-1]="UNKNOWN",t[t.NO_INTERLACE=0]="NO_INTERLACE",t[t.ADAM7=1]="ADAM7"}(Bn||(Bn={}));const Un=new Uint8Array(0),Dn=new Uint16Array([255]),jn=255===new Uint8Array(Dn.buffer)[0];class Nn extends In{constructor(t,e={}){super(t);const{checkCrc:i=!1}=e;this._checkCrc=i,this._inflator=new Cn.Inflate,this._png={width:-1,height:-1,channels:-1,data:new Uint8Array(0),depth:1,text:{}},this._end=!1,this._hasPalette=!1,this._palette=[],this._compressionMethod=Mn.UNKNOWN,this._filterMethod=Ln.UNKNOWN,this._interlaceMethod=Bn.UNKNOWN,this._colorType=-1,this.setBigEndian()}decode(){for(this.decodeSignature();!this._end;)this.decodeChunk();return this.decodeImage(),this._png}decodeSignature(){for(let t=0;t<zn.length;t++)if(this.readUint8()!==zn[t])throw new Error(`wrong PNG signature. Byte at ${t} should be ${zn[t]}.`)}decodeChunk(){const t=this.readUint32(),e=this.readChars(4),i=this.offset;switch(e){case"IHDR":this.decodeIHDR();break;case"PLTE":this.decodePLTE(t);break;case"IDAT":this.decodeIDAT(t);break;case"IEND":this._end=!0;break;case"tRNS":this.decodetRNS(t);break;case"tEXt":this.decodetEXt(t);break;case"pHYs":this.decodepHYs();break;default:this.skip(t)}if(this.offset-i!==t)throw new Error("Length mismatch while decoding chunk "+e);if(this._checkCrc){const i=this.readUint32(),s=t+4,n=On(new Uint8Array(this.buffer,this.byteOffset+this.offset-s-4,s),s);if(n!==i)throw new Error(`CRC mismatch for chunk ${e}. Expected ${i}, found ${n}`)}else this.skip(4)}decodeIHDR(){const t=this._png;t.width=this.readUint32(),t.height=this.readUint32(),t.depth=function(t){if(1!==t&&2!==t&&4!==t&&8!==t&&16!==t)throw new Error("invalid bit depth: "+t);return t}(this.readUint8());const e=this.readUint8();let i;switch(this._colorType=e,e){case En.GREYSCALE:i=1;break;case En.TRUECOLOUR:i=3;break;case En.INDEXED_COLOUR:i=1;break;case En.GREYSCALE_ALPHA:i=2;break;case En.TRUECOLOUR_ALPHA:i=4;break;default:throw new Error("Unknown color type: "+e)}if(this._png.channels=i,this._compressionMethod=this.readUint8(),this._compressionMethod!==Mn.DEFLATE)throw new Error("Unsupported compression method: "+this._compressionMethod);this._filterMethod=this.readUint8(),this._interlaceMethod=this.readUint8()}decodePLTE(t){if(t%3!=0)throw new RangeError("PLTE field length must be a multiple of 3. Got "+t);const e=t/3;this._hasPalette=!0;const i=[];this._palette=i;for(let s=0;s<e;s++)i.push([this.readUint8(),this.readUint8(),this.readUint8()])}decodeIDAT(t){this._inflator.push(new Uint8Array(this.buffer,this.offset+this.byteOffset,t),!1),this.skip(t)}decodetRNS(t){if(3===this._colorType){if(t>this._palette.length)throw new Error(`tRNS chunk contains more alpha values than there are palette colors (${t} vs ${this._palette.length})`);let e=0;for(;e<t;e++){const t=this.readByte();this._palette[e].push(t)}for(;e<this._palette.length;e++)this._palette[e].push(255)}}decodetEXt(t){let e,i="";for(;"\\0"!==(e=this.readChar());)i+=e;this._png.text[i]=this.readChars(t-i.length-1)}decodepHYs(){const t=this.readUint32(),e=this.readUint32(),i=this.readByte();this._png.resolution={x:t,y:e,unit:i}}decodeImage(){if(this._inflator.push(Un,!0),this._inflator.err)throw new Error("Error while decompressing the data: "+this._inflator.err);const t=this._inflator.result;if(this._filterMethod!==Ln.ADAPTIVE)throw new Error(`Filter method ${this._filterMethod} not supported`);if(this._interlaceMethod!==Bn.NO_INTERLACE)throw new Error(`Interlace method ${this._interlaceMethod} not supported`);this.decodeInterlaceNull(t)}decodeInterlaceNull(t){const e=this._png.height,i=this._png.channels*this._png.depth/8,s=this._png.width*i,n=new Uint8Array(this._png.height*s);let r,o,a=Un,l=0;for(let c=0;c<e;c++){switch(r=t.subarray(l+1,l+1+s),o=n.subarray(c*s,(c+1)*s),t[l]){case 0:Vn(r,o,s);break;case 1:Wn(r,o,s,i);break;case 2:qn(r,o,a,s);break;case 3:Gn(r,o,a,s,i);break;case 4:Fn(r,o,a,s,i);break;default:throw new Error("Unsupported filter: "+t[l])}a=o,l+=s+1}if(this._hasPalette&&(this._png.palette=this._palette),16===this._png.depth){const t=new Uint16Array(n.buffer);if(jn)for(let e=0;e<t.length;e++)t[e]=(255&(h=t[e]))<<8|h>>8&255;this._png.data=t}else this._png.data=n;var h}}function Vn(t,e,i){for(let s=0;s<i;s++)e[s]=t[s]}function Wn(t,e,i,s){let n=0;for(;n<s;n++)e[n]=t[n];for(;n<i;n++)e[n]=t[n]+e[n-s]&255}function qn(t,e,i,s){let n=0;if(0===i.length)for(;n<s;n++)e[n]=t[n];else for(;n<s;n++)e[n]=t[n]+i[n]&255}function Gn(t,e,i,s,n){let r=0;if(0===i.length){for(;r<n;r++)e[r]=t[r];for(;r<s;r++)e[r]=t[r]+(e[r-n]>>1)&255}else{for(;r<n;r++)e[r]=t[r]+(i[r]>>1)&255;for(;r<s;r++)e[r]=t[r]+(e[r-n]+i[r]>>1)&255}}function Fn(t,e,i,s,n){let r=0;if(0===i.length){for(;r<n;r++)e[r]=t[r];for(;r<s;r++)e[r]=t[r]+e[r-n]&255}else{for(;r<n;r++)e[r]=t[r]+i[r]&255;for(;r<s;r++)e[r]=t[r]+Yn(e[r-n],i[r],i[r-n])&255}}function Yn(t,e,i){const s=t+e-i,n=Math.abs(s-t),r=Math.abs(s-e),o=Math.abs(s-i);return n<=r&&n<=o?t:r<=o?e:i}var Xn;!function(t){t[t.UNKNOWN=0]="UNKNOWN",t[t.METRE=1]="METRE"}(Xn||(Xn={}));class Zn{constructor(t){this._comparator=t,this._size=0}get root(){return this._root}get size(){return this._size}get min(){if(this._root)return this._min(this._root).value}get max(){if(this._root)return this._max(this._root).value}insert(t){if(this._size++,!this._root)return this._root={value:t},this._root;let e=this._root;for(;e;)if(this._comparator(t,e.value)<0){if(!e.left)return e.left={parent:e,value:t};e=e.left}else{if(!e.right)return e.right={parent:e,value:t};e=e.right}throw new Error}remove(t){if(this._size--,t.left&&t.right){const e=this._min(t.right);this._replaceSubtree(t,e),t.left&&(e.left=t.left,t.left.parent=e),t.right&&(e.right=t.right,t.right.parent=e)}else t.left?this._replaceSubtree(t,t.left):t.right?this._replaceSubtree(t,t.right):this._replaceSubtree(t,void 0)}*values(t){t&&(yield*this.values(t.left),yield t.value,yield*this.values(t.right))}[Symbol.iterator](){return this.values(this._root)}_min(t){let e=t;for(;e.left;)e=e.left;return e}_max(t){let e=t;for(;e.right;)e=e.right;return e}_replaceSubtree(t,e){t.parent?t.parent.left===t?t.parent.left=e:t.parent.right===t&&(t.parent.right=e):this._root=e,e&&(e.parent&&(e.parent.left===e?e.parent.left=void 0:e.parent.right===e&&(e.parent.right=void 0)),e.parent=t.parent)}}class Hn{constructor(){this._nodes=new Map}get begin(){return this._begin&&this._begin.value}get end(){return this._end&&this._end.value}insert(t){if(!this._nodes.has(t)){const e={value:t};this._end?this.insertAfter(this._end.value,t):(this._begin=this._end=e,this._nodes.set(t,e))}}insertBefore(t,e){const i=this._nodes.get(t);if(i&&!this._nodes.has(e)){const t={value:e};i.prev&&(i.prev.next=t,t.prev=i.prev),t.next=i,i.prev=t,this._nodes.set(e,t),i===this._begin&&(this._begin=t)}}insertAfter(t,e){const i=this._nodes.get(t);if(i&&!this._nodes.has(e)){const t={value:e};i.next&&(i.next.prev=t,t.next=i.next),t.prev=i,i.next=t,this._nodes.set(e,t),i===this._end&&(this._end=t)}}remove(t){const e=this._nodes.get(t);e&&(e===this._begin&&(this._begin=e.next),e===this._end&&(this._end=e.prev),e.next&&(e.next.prev=e.prev),e.prev&&(e.prev.next=e.next),this._nodes.delete(t))}getPrev(t){const e=this._nodes.get(t);if(e&&e.prev)return e.prev.value}getNext(t){const e=this._nodes.get(t);if(e&&e.next)return e.next.value}*values(){let t=this._begin;for(;t;)yield t.value,t=t.next}[Symbol.iterator](){return this.values()}}class Kn{constructor(t,e=1){this._size=t,this._alignment=e,this._freeOffset=0,this._allocatedOffsets=new Set}get size(){return this._size}get maxAllocableSize(){return this._size-this._freeOffset}get isEmpty(){return 0===this._allocatedOffsets.size}allocate(t){if(this._size>=this._freeOffset+t){const e=this._freeOffset;return this._freeOffset=function(t,e){return e*Math.ceil(t/e)}(e+t,this._alignment),this._allocatedOffsets.add(e),e}return-1}deallocate(t){this._allocatedOffsets.delete(t)}isAllocated(t){return t<this._freeOffset}extend(t){if(t<this._freeOffset)throw new Error("Could not reduce the size because it conflicts with already allocated region.");this._size=t}}class $n{constructor(t){this._size=t,this._allRegions=new Hn,this._occupiedRegions=new Map,this._freeRegions=new Zn((t,e)=>t.size-e.size);const e={offset:0,size:t};this._allRegions.insert(e),e._freeNode=this._freeRegions.insert(e)}get size(){return this._size}get maxAllocableSize(){const t=this._freeRegions.max;return t?t.size:0}get isEmpty(){return 0===this._occupiedRegions.size}allocate(t){const e=this._findMinSuitable(t);if(!e)return-1;const i=e.value;this._freeRegions.remove(e);const s={offset:i.offset,size:t};if(this._occupiedRegions.set(i.offset,s),this._allRegions.insertAfter(i,s),this._allRegions.remove(i),i.size>t){const e={offset:i.offset+t,size:i.size-t};e._freeNode=this._freeRegions.insert(e),this._allRegions.insertAfter(s,e)}return s.offset}deallocate(t){let e=this._occupiedRegions.get(t);if(e){const i=this._allRegions.getPrev(e);if(i&&i._freeNode){const t={offset:i.offset,size:i.size+e.size};this._allRegions.insertAfter(i,t),this._allRegions.remove(e),this._allRegions.remove(i),this._freeRegions.remove(i._freeNode),e=t}const s=this._allRegions.getNext(e);if(s&&s._freeNode){const t={offset:e.offset,size:e.size+s.size};this._allRegions.insertBefore(s,t),this._allRegions.remove(e),this._allRegions.remove(s),this._freeRegions.remove(s._freeNode),e=t}this._occupiedRegions.delete(t),e._freeNode=this._freeRegions.insert(e)}}isAllocated(t){return this._occupiedRegions.has(t)}extend(t){if(t<this._size)throw new Error("Size reducing is not allowed in free list allocator");const e=t-this._size,i=this._allRegions.end;if(i&&i._freeNode){this._freeRegions.remove(i._freeNode);const t={offset:i.offset,size:i.size+e,isFree:!0};this._allRegions.insertAfter(i,t),this._allRegions.remove(i),this._freeRegions.insert(t)}else{const t={offset:this._size,size:e,isFree:!0};this._allRegions.insert(t),this._freeRegions.insert(t)}this._size=t}_findMinSuitable(t){let e,i=this._freeRegions.root;for(;i;){if(i.value.size===t){e=i;break}i.value.size<t?i=i.right:(e=i,i=i.left)}return e}}class Qn{constructor(t,e){this.width=t,this.height=e,this._allocator=new $n(this.width)}allocate(t){return this._allocator.allocate(t)}deallocate(t){this._allocator.deallocate(t)}isAllocated(t){return this._allocator.isAllocated(t)}canAllocate(t){return this._allocator.maxAllocableSize>=t}resize(t){this._allocator.extend(t),this.width=t}}class Jn{constructor(t,e){this.width=t,this.height=e,this._shelves=new Map,this._shelfAllocator=new Kn(e)}allocate(t){let e,i=-1,s=-1;for(const[n,r]of this._shelves.entries()){const o=t.height/r.height;if(1===o&&r.canAllocate(t.width)){e=r,i=n;break}o<1&&o>s&&r.canAllocate(t.width)&&(e=r,i=n,s=o)}if(!e&&this._shelfAllocator.maxAllocableSize>=t.height&&this.width>=t.width){const s=this._shelfAllocator.allocate(t.height);e=new Qn(this.width,t.height),i=s,this._shelves.set(s,e)}if(e){const s=e.allocate(t.width),n=i;return{minX:s,maxX:s+t.width,minY:n,maxY:n+t.height}}return null}deallocate(t){const e=this._shelves.get(t.minY);e&&e.deallocate(t.minX)}isAllocated(t){const e=this._shelves.get(t.minY);return!!e&&e.isAllocated(t.minX)}resize(t,e){this._shelfAllocator.extend(e);for(const i of this._shelves.values())i.resize(t);this.width=t,this.height=e}}const tr=C(Number.MAX_SAFE_INTEGER,Number.MIN_SAFE_INTEGER,Number.MAX_SAFE_INTEGER,Number.MIN_SAFE_INTEGER);function er(t,e,i){return 4*(e*(t.y+i)+t.x)}function ir(t,e,i,s,n,r,{width:o,height:a}){for(let l=0;l<a;++l){const a=er(i,n,l),h=er(s,r,l);for(let i=0;i<4*o;++i)e[h+i]=t[a+i]}}function sr(t,e){return new Uint8Array(4*t*e)}class nr extends Ai{constructor(t,e,i){super(),this.id=t,this.width=e,this.height=i,this.emptyIcon={minX:0,maxX:0,minY:0,maxY:0},this._data=sr(e,i),this._updatedRegion=C(0,0,0,0),this._resetAllocator(),this._resetUpdatedRegion()}allocate(t,e){const i=this._allocator.allocate(wn((s=t).width+1,s.height+1));var s;if(!i)return;const n=function(t){const e=z(t);return e.maxX-=1,e.maxY-=1,e}(i);return this._insertIcon(n,e),P(this._updatedRegion,i,this._updatedRegion),n}flushUpdates(){if(this._updatedRegion.minX===tr.minX)return;const{minX:t,minY:e,maxX:i,maxY:s}=this._updatedRegion;this._resetUpdatedRegion();const n=i-t,r=s-e,o=sr(n,r);return ir(this._data,o,g(t,e),m,this.width,n,wn(n,r)),{offset:g(t,e),size:wn(n,r),data:o}}reset(){this._resetUpdatedRegion(),this._resetAllocator(),this._data.fill(0)}_insertIcon(t,e){const{minX:i,minY:s,maxX:n,maxY:r}=t;ir(e,this._data,m,g(i,s),n-i,this.width,wn(n-i,r-s))}_resetAllocator(){this._allocator=new Jn(this.width,this.height)}_resetUpdatedRegion(){z(tr,this._updatedRegion)}}var rr;!function(t){t[t.TO_BACKEND_SETUP=0]="TO_BACKEND_SETUP",t[t.FROM_BACKEND_ADD_ATLAS=1]="FROM_BACKEND_ADD_ATLAS",t[t.FROM_BACKEND_UPDATE_ATLAS=2]="FROM_BACKEND_UPDATE_ATLAS",t[t.FROM_BACKEND_REMOVE_ATLAS=3]="FROM_BACKEND_REMOVE_ATLAS"}(rr||(rr={}));var or=function(t,e,i,s){return new(i||(i=Promise))((function(n,r){function o(t){try{l(s.next(t))}catch(e){r(e)}}function a(t){try{l(s.throw(t))}catch(e){r(e)}}function l(t){var e;t.done?n(t.value):(e=t.value,e instanceof i?e:new i((function(t){t(e)}))).then(o,a)}l((s=s.apply(t,e||[])).next())}))};const ar={iconUrlTemplate:"no url for icons",iconRequestWithCredentials:!1,dpr:1};function lr(t,e){const i=e&&t.byteLength%Uint32Array.BYTES_PER_ELEMENT==0&&new Uint32Array(t);if(i&&i[0]===cr)return{size:wn(i[1],i[2]),data:new Uint8Array(t,3*Uint32Array.BYTES_PER_ELEMENT)};{const e=new Nn(t,s).decode();return{size:wn(e.width,e.height),data:e.data}}var s}const hr={key:0,colorQuery:"",transform:t=>t,transformImage:t=>t},cr=2537892953;class dr{constructor(t,e,i=1024,s=1024){this._communicator=t,this._atlasWidth=i,this._atlasHeight=s,this._loadManager=e,this._options=Object.assign({},ar),this._atlases=[],this._freeAtlases=[],this._currentAtlas=null,this._iconDataMap=new Map,this._iconUrlGeneration=0,this._communicator.onMessage.addListener(this._onMessage,this)}destructor(){this._communicator.onMessage.removeListener(this._onMessage)}getAtlas(t){return this._atlases[t]}getIconData(t,e=1,i=hr){const s=this._makeUniqueIconId(t,e,i);return this._iconDataMap.get(s)}getCurrentAtlas(){return this._currentAtlas||(this._currentAtlas=this._getNextAtlas()),this._currentAtlas}getDpr(){return this._options.dpr}loadIcon(t,e){return or(this,void 0,void 0,(function*(){const i=this._options.iconRequestWithCredentials;return lr(yield this._loadManager.load(t,e,{withCredentials:i}),this._isBMP)}))}addIcon(t,e,i=1,s=hr){const n=this._makeUniqueIconId(e,i,s),r=this._iconDataMap.get(n);if(r)return r;const o=s.transformImage(t),a=this._assignIconToAtlas(o),l={atlasId:this._currentAtlas.id,imageSize:o.size,atlasLocation:a,data:t};return this._iconDataMap.set(n,l),l}buildIconUrl(t,e=1,i="",s=this._isBMP){return this._options.iconUrlTemplate.replace("{{hostAlias}}",wi(t)).replace(/\\{\\{id\\}\\}/g,t).replace("{{scale}}",L(this._options.dpr*e,.1,10).toString())+i+(s?"&format=bmp":"")}flushAtlasesUpdates(){for(const t of this._atlases){const e=t.flushUpdates();e&&this._communicator.sendMessage({type:rr.FROM_BACKEND_UPDATE_ATLAS,atlasId:t.id,atlasRegion:e},!1,e.data.buffer)}}_onMessage(t){switch(t.type){case rr.TO_BACKEND_SETUP:this._onSetup(t)}}_onSetup(t){Object.assign(this._options,t.options),this._iconUrlGeneration++}_makeUniqueIconId(t,e,i){return t+"_"+e+"_"+this._iconUrlGeneration+"_"+i.key+"_"+i.colorQuery}get _isBMP(){return"bmp"===this._options.iconFormat}_getNextAtlas(){if(this._freeAtlases.length>0){const t=this._freeAtlases.shift();return t.retain(),t}const t=this._atlases.length,e=new nr(t,this._atlasWidth,this._atlasHeight);return e.retain(),e.onReleased.addListener(()=>{this._clearAtlas(e),this._freeAtlases.push(e)}),this._atlases.push(e),this._communicator.sendMessage({type:rr.FROM_BACKEND_ADD_ATLAS,atlasId:t,atlasWidth:this._atlasWidth,atlasHeight:this._atlasHeight},!1),e}_assignIconToAtlas({size:t,data:e}){const i=this.getCurrentAtlas();let s=i.allocate(t,e);if(!s&&(i.release(),this._currentAtlas=this._getNextAtlas(),s=this._currentAtlas.allocate(t,e),!s))throw new Error("Couldn\'t allocate icon in atlas");return s}_clearAtlas(t){t.reset();for(const[e,i]of this._iconDataMap)i.atlasId===t.id&&this._iconDataMap.delete(e)}}function ur(t,e){return t.finally?t.finally(e):t.then(t=>Promise.resolve(e()).then(()=>t),t=>Promise.resolve(e()).then(()=>Promise.reject(t)))}class fr{constructor(t){this._loadManager=t,this._requests=new Map}fillFont(t,e,i,s,n){const r=e.id+"_"+i;let o=this._requests.get(r);return o||(o=this._loadManager.load(t,s,n).then(t=>{const i=K.decode(new Uint8Array(t));-1===e.xheight&&(e.xheight=i.font.xheight),-1===e.margin&&(e.margin=i.font.margin),void 0===e.height&&void 0!==i.font.height&&(e.height=i.font.height),void 0===e.ascender&&void 0!==i.font.ascender&&(e.ascender=i.font.ascender),void 0===e.descender&&void 0!==i.font.descender&&(e.descender=i.font.descender);for(const s of i.glyphs)e.glyphs[s.id]=s;return e}),ur(o,()=>this._requests.delete(r)),this._requests.set(r,o)),o}}class pr{constructor(t,e,i,s=300){this._storage=t,this._modelStorage=e,this._taskQueue=i,this._size=s,this._cache=new Set,this._storage.onAdded.addListener(this._onTileAdded,this),this._storage.onRemoved.addListener(this._onTileRemoved,this),this._modelStorage.onAdded.addListener(this._onModelAdded,this),this._modelStorage.onRemoved.addListener(this._onModelRemoved,this)}destructor(){this._modelStorage.onRemoved.removeListener(this._onModelRemoved),this._modelStorage.onAdded.removeListener(this._onModelAdded),this._storage.onRemoved.removeListener(this._onTileRemoved),this._storage.onAdded.removeListener(this._onTileAdded)}_cleaning(){this._cleaningIsScheduled=!1;const t=this._cache.size-this._size;if(t>0){const e=new Array(t);let i=0;for(const s of this._cache){if(!(i<t))break;e[i]=s,++i}for(const t of e)this._destroyTile(t)}}_destroyTile(t){this._storage.remove(t.id)}_onTileAdded(t){t.onStateChanged.addListener(this._onTileStateChanged,this),this._onTileStateChanged(t)}_onTileRemoved(t){this._cache.delete(t),t.onStateChanged.removeListener(this._onTileStateChanged),t.destructor()}_onTileStateChanged(t){2===t.state?this._onTileCached(t):0!==t.state&&1!==t.state||this._onTileUse(t)}_onTileUse(t){this._cache.delete(t)}_onTileCached(t){t.hasContent()?(this._cache.add(t),this._cache.size>this._size&&!this._cleaningIsScheduled&&(this._cleaningIsScheduled=!0,this._taskQueue.enqueueSync({execute:this._cleaning.bind(this),priority:3e4}))):this._destroyTile(t)}_onModelAdded(t){t.onReleased.addListener(this._onModelReleased,this)}_onModelRemoved(t){t.onReleased.removeListener(this._onModelReleased),t.destructor()}_onModelReleased(t){this._modelStorage.remove(t.id)}}class _r extends h{_serialize(t){return t.id}}class gr{constructor(t,e,i="GET",s={}){this._url=t,this._method=i,this._xhr=new XMLHttpRequest,this._xhr.responseType=e,s.withCredentials&&(this._xhr.withCredentials=!0)}get isCanceled(){return this._xhr.readyState===XMLHttpRequest.DONE&&0===this._xhr.status}send(){const t=this._xhr;return t.readyState!==XMLHttpRequest.UNSENT?Promise.reject(new Error("already sent")):new Promise((e,i)=>{t.open(this._method,this._url),t.onload=()=>{this.isCanceled||(200<=t.status&&t.status<300?e(this._prepareResponse(t.response)):i(new Error(`Failed request: ${t.status} ${t.statusText}, ${this._url}`)))},this._xhr.onerror=()=>{i(new Error("Failed request: "+this._url))},this._xhr.send()})}cancel(){this._xhr.readyState===XMLHttpRequest.UNSENT||this.isCanceled||this._xhr.abort()}}class mr extends gr{constructor(t,e="GET",i={}){super(t,"arraybuffer",e,i)}_prepareResponse(t){return t instanceof ArrayBuffer?t:new ArrayBuffer(0)}}class yr extends gr{constructor(t,e="GET",i={}){super(t,"blob",e,i)}_prepareResponse(t){return t}}class br extends gr{constructor(t,e="GET",i={}){super(t,"json",e,i)}_prepareResponse(t){return t}}class wr{constructor(){this._requests=new Map,this._queue=new mn}load(t,e,i={}){return vr(this._makeLoadRequest(t,e,new mr(t,"GET",i)))}loadBlob(t,e,i={}){return vr(this._makeLoadRequest(t,e,new yr(t,"GET",i)))}loadJson(t,e,i={}){return vr(this._makeLoadRequest(t,e,new br(t,"GET",i)))}cancel(t){const e=Object(Y.b)(this._requests.values(),e=>e.subs.has(t));e&&(!function(t,e){t.subs.get(e)&&t.subs.delete(e)}(e,t),0===e.subs.size&&(this._requests.delete(e.url),e.isRunning?e.httpRequest.cancel():this._queue.remove(t=>t===e),this._checkLoadingQueue()))}_checkLoadingQueue(){if(!this._queue.size)return;let t=Number.NEGATIVE_INFINITY;this._requests.forEach(e=>{e.isRunning&&e.priority>t&&(t=e.priority)});const e=this._queue.peek().priority;if(!(e<t))for(;this._queue.size&&this._queue.peek().priority===e;)this._startLoading(this._queue.dequeue())}_makeLoadRequest(t,e,i){let s=this._requests.get(t);return s&&(s.isRunning||s.priority>=e)||(s?(this._queue.remove(t=>t===s),s.priority=e):(s={url:t,priority:e,httpRequest:i,isRunning:!1,subs:new Map},this._requests.set(t,s)),this._queue.enqueue(s),this._checkLoadingQueue()),s}_startLoading(t){ur(t.httpRequest.send().then(e=>t.subs.forEach(t=>t.onData(e)),e=>t.subs.forEach(t=>t.onError(e))),()=>{this._requests.delete(t.url),this._checkLoadingQueue()}),t.isRunning=!0}}function vr(t){let e;const i=new Promise((t,i)=>{e={onData:t,onError:i}});return t.subs.set(i,e),i}class xr{constructor(t,e,i=new yn,s=new wr,r=100,o){this._commutator=new n(t),this._objectIdProvider=e,this._taskQueue=i,this._loadManager=s,this._taskPriority=r,this._tileStorage=new c(this._commutator.getCommunicator(1)),this._modelStorage=new _r(this._commutator.getCommunicator(2)),this._viewport=new F(this._commutator.getCommunicator(0),this._tileStorage),this._registry=new un(this._commutator.getCommunicator(4)),this._glyphAtlasRegistry=new Sn(this._commutator.getCommunicator(5),new fr(this._loadManager)),this._iconAtlasRegistry=new dr(this._commutator.getCommunicator(6),this._loadManager),this._tileContentManager=this._createTileVectorContentManagerBackend(),this._gc=new pr(this._tileStorage,this._modelStorage,i,o),this._stylesCustomizer=new us}destructor(){this._gc.destructor(),this._tileContentManager.destructor(),this._iconAtlasRegistry.destructor(),this._glyphAtlasRegistry.destructor(),this._viewport.destructor(),this._commutator.destructor()}_createTileVectorContentManagerBackend(){return new nn(this._commutator.getCommunicator(3),this._tileStorage,this._modelStorage,this._registry,this._glyphAtlasRegistry,this._iconAtlasRegistry,this._viewport,this._objectIdProvider,this._taskQueue,this._loadManager,this._taskPriority)}}function kr({min:t,max:e}){let i=0;return()=>i++%(e-t+1)+t}var Ar;!function(t){t[t.SETUP=0]="SETUP",t[t.ADD=1]="ADD",t[t.DESTROY=2]="DESTROY"}(Ar||(Ar={}));class Sr extends Ai{constructor(t){super(),this.id=t}addContent(t){this.content=t}}const Tr={indoorPlanUrlTemplate:"No url provided"};class Rr{constructor(t,e){this._communicator=t,this._loader=e,this._plans=new Map,this._options=Object.assign({},Tr),this._communicator.onMessage.addListener(this._onMessage,this)}destructor(){for(const t of this._plans.values())t.onReleased.removeListener(this._onPlanReleased);this._communicator.onMessage.removeListener(this._onMessage)}getPlan(t){return this._plans.get(t)}getOrCreatePlan(t){let e=this._plans.get(t);return e||(e=new Sr(t),e.onReleased.addListener(this._onPlanReleased,this),this._loader.loadPlan(t).then(e=>this._onLoad(t,e)),this._plans.set(t,e)),e}_onPlanReleased(t){this._plans.delete(t.id),this._communicator.sendMessage({type:Ar.DESTROY,planId:t.id},!1)}_onLoad(t,e){const i=this._plans.get(t);i&&(i.addContent(e),this._communicator.sendMessage(Object.assign({type:Ar.ADD,planId:t},e),!0))}_onMessage(t){switch(t.type){case Ar.SETUP:this._options=t.options,this._loader.setUrlProvider(t=>this._options.indoorPlanUrlTemplate.replace("{{id}}",t).replace("{{hostAlias}}",wi(t)))}}}const Ir=Js((t,e)=>(null==t?void 0:t.get("indoor_plan_id"))===(null==e?void 0:e.get("indoor_plan_id"))&&(null==t?void 0:t.get("indoor_level_id"))===(null==e?void 0:e.get("indoor_level_id"))),Cr=Object.assign(Object.assign({},sn),{polygonsBatchingRule:Ir,polylinesBatchingRule:Ir});class zr extends nn{constructor(t,e,i,s,n,r,o,a,l,h,c,d){super(t,e,i,s,n,r,o,a,l,h,c),this._indoorPlanRegistry=d,this._metadataPreprocessor=(t,e)=>this._preprocessMetadata(t,e)}_setOptions(t){this._options=Object.assign(Object.assign({},Cr),t)}_createTileRequest(t,e){const i=this._objectIdManager.createSharedIdProvider(t.id);return new yi(t,e,this._taskQueue,this._tileLoader,this._viewport,this._taskPriority,this._opaquePolygonBufferWriter,this._transparentPolygonBufferWriter,this._extrudedPolygonWriter,this._polylineBufferWriter,this._pointLabelBufferWriter,this._curvedLabelBufferWriter,this._iconBufferWriter,this._registry,this._glyphAtlasRegistry,this._iconAtlasRegistry,i,this._stylesCustomizer,this._metadataPreprocessor)}_preprocessMetadata(t,e){const i=et(t,this._options.allObjectsInteractive);for(const s of[i.points,i.polylines,i.polygons,i.pointLabels,i.curvedLabels]){const t=s;for(const i of t.values()){const t=i.get("indoor_plan_id");if(t){const i=this._indoorPlanRegistry.getOrCreatePlan(t);e.addContent({primitives:{}},[i])}}}return i}}var Pr=function(t,e,i,s){return new(i||(i=Promise))((function(n,r){function o(t){try{l(s.next(t))}catch(e){r(e)}}function a(t){try{l(s.throw(t))}catch(e){r(e)}}function l(t){var e;t.done?n(t.value):(e=t.value,e instanceof i?e:new i((function(t){t(e)}))).then(o,a)}l((s=s.apply(t,e||[])).next())}))};class Or{constructor(t,e){this._loadManager=t,this._urlProvider=e,this._loadings=new Map}setUrlProvider(t){this._urlProvider=t}loadPlan(t){return Pr(this,void 0,void 0,(function*(){let e=this._loadings.get(t);return e||(e=ur(this._createRequest(t),()=>this._loadings.delete(t)),this._loadings.set(t,e)),e}))}_createRequest(t){return Pr(this,void 0,void 0,(function*(){const e=yield this._loadManager.load(this._urlProvider(t),32e3),{levels:i,defaultLevelId:s,boundary:n}=Q.decode(new Uint8Array(e));if(!n)throw new Error("No indoor plan boundary provided");return{levels:i,defaultLevelId:s,boundary:n}}))}}class Er extends xr{destructor(){this._planRegistry&&this._planRegistry.destructor(),super.destructor()}_createTileVectorContentManagerBackend(){const t=this._getOrCreatePlanRegistry();return new zr(this._commutator.getCommunicator(3),this._tileStorage,this._modelStorage,this._registry,this._glyphAtlasRegistry,this._iconAtlasRegistry,this._viewport,this._objectIdProvider,this._taskQueue,this._loadManager,this._taskPriority,t)}_getOrCreatePlanRegistry(){if(!this._planRegistry){const t=new Or(this._loadManager,()=>{throw new Error("No url for indoor plans provided")});this._planRegistry=new Rr(this._commutator.getCommunicator(7),t)}return this._planRegistry}}class Mr extends _i{constructor(t,e,i,s){super(e),this._detalizationLevel=t,this._viewport=i,this._taskExtraPriority=s,this._detalizationLevel.onStateChanged.addListener(this._onLevelStateChanged,this),this._onViewportUpdate=this._onViewportUpdate.bind(this),this._viewport.onUpdate.addListener(this._onViewportUpdate)}destructor(){this._task.destructor(),this._detalizationLevel.onStateChanged.removeListener(this._onLevelStateChanged),this._viewport.onUpdate.removeListener(this._onViewportUpdate)}start(){3!==this._detalizationLevel.state&&4!==this._detalizationLevel.state&&super.start()}_calculateTaskPriority(){return Lr[this._detalizationLevel.state]+(1-(0===this._detalizationLevel.state?0:Math.abs(this._viewport.zoom-this._detalizationLevel.zoom))/Br)+this._taskExtraPriority}_onLevelStateChanged(t){switch(t.state){case 3:case 4:this._task.pause();break;case 0:case 1:case 2:this._resetTaskPriority(),0===this._task.state?this._task.start():this._task.resume()}}_onViewportUpdate(){1!==this._detalizationLevel.state&&2!==this._detalizationLevel.state||this._resetTaskPriority()}_resetTaskPriority(){this._task.resetPriority(this._calculateTaskPriority())}}const Lr={0:3e4,1:3e4,2:2e4,3:1e4,4:1e4},Br=64;function Ur(t,e){const i=t&&function(t){const e=wt.exec(t);if(e){const[,t,i,s,n]=e;return dt(parseInt(t,10)/255,parseInt(i,10)/255,parseInt(s,10)/255,void 0===n?1:parseFloat(n))}return mt(t)}(t);return i?(void 0!==e&&(i.a=e),i):dt(0,0,0,0)}const Dr=-2,jr=2,Nr=-2,Vr=2;function Wr(t,e=!0,i=!1){const{minX:s,maxX:n,minY:r,maxY:o}=function(t,e={minX:0,maxX:0,minY:0,maxY:0}){if(0===t.length)return e;e.minX=e.maxX=t[0].x,e.minY=e.maxY=t[0].y;for(let i=1;i<t.length;++i){const{x:s,y:n}=t[i];s<e.minX&&(e.minX=s),s>e.maxX&&(e.maxX=s),n<e.minY&&(e.minY=n),n>e.maxY&&(e.maxY=n)}return e}(t),a=e?s<Dr?1:n>jr?-1:0:0,l=i?r<Nr?1:o>Vr?-1:0:0;if(0===a&&0===l)return t;if(0!==a&&n-s>2||0!==l&&o-r>2)throw new Error("Cannot cycle restrict world primitive coordinates: primitive bbox is bigger than world (has dimension > 2)");return t.map(({x:t,y:e})=>({x:t+2*a,y:e+2*l}))}function qr(t,e){if(t.length<e)return[t];t.length%e==1&&(e-=1);const i=[];let s=0;for(;s<t.length;)i.push(t.slice(s,s+e)),s+=e;return i}function Gr(t){let e=t[0];const i=[e];for(let r=1;r<t.length;r++)s=e,n=t[r],(s.x!==n.x||s.y!==n.y)&&(i.push(t[r]),e=t[r]);var s,n;return i}function Fr(t,e,i,s,n=[]){const r=function(t){const e=t["line-width"],i=t["line-color"],s=t["line-cap"]?(r=t["line-cap"],"square"===r?2:"round"===r?1:0):0,n=t["line-join"]?function(t){return"miter"===t?0:"round"===t?1:2}(t["line-join"]):2;var r;if(!e||!i)return;return{classId:0,maxZoom:30,minZoom:0,zIndex:0,inline:{startCap:s,endCap:s,join:n,strokeColor:Ur(i,t["line-opacity"]),strokeWidth:e,dash:Xr(t["line-dasharray"],s)}}}(e);if(!r)return n;const o="LineString"===t.type?[t.coordinates]:t.coordinates;for(const a of o)for(const t of qr(a,4096)){const e=Gr(t);e.length>1&&n.push(Yr(e,r,i,s))}return n}function Yr(t,e,i,s){return{id:i,metadata:s,styles:[e],vertices:Wr(t)}}function Xr(t,e){return t&&t.length>=2?{fill:t[0],gap:t[1],cap:e}:void 0}function Zr(t,e,i,s,n=[]){const r=function(t){return{classId:0,color:Ur(t["fill-color"],t["fill-opacity"]),fillRule:$r(t["fill-rule"]),extruded:!1,height:0,maxZoom:30,minZoom:0,zIndex:0}}(e),o="Polygon"===t.type?[t.coordinates]:t.coordinates;for(const a of o)a[0]&&a[0].length>2&&n.push(Kr(a,r,i,s));return n}function Hr(t,e,i,s,n=[]){const r=function(t){const e=t["fill-contour-width"],i=t["fill-contour-color"];if(!e||!i)return;return{classId:0,maxZoom:30,minZoom:0,zIndex:0,inline:{startCap:Qr,endCap:Qr,join:0,strokeColor:Ur(i,t["fill-contour-opacity"]),strokeWidth:e,dash:Xr(t["fill-contour-dasharray"],Qr)}}}(e);if(!r)return n;const o="Polygon"===t.type?[t.coordinates]:t.coordinates;for(const a of o)for(const t of a){const e=Gr(t.concat(t[0]));e.length>3&&n.push({id:i,styles:[r],metadata:s,vertices:Wr(e)})}return n}function Kr(t,e,i,s){return{id:i,metadata:s,styles:[e],height:0,hasContour:!1,vertexRings:t.map(t=>Wr(t))}}function $r(t){switch(t){case"nonzero":return 1;case"evenodd":default:return 0}}const Qr=0;function Jr(t,e,i,s,n=[]){const r=function(t){var e;const i=t["icon-image"],s=t["icon-offset"]||[0,0];if(!i)return;return{classId:1,imageId:t["icon-image"],maxZoom:30,minZoom:0,offset:oe(s[0],s[1]),scale:null!==(e=t["icon-scale"])&&void 0!==e?e:1,zIndex:0,url:i}}(e);if(!r)return n;const o=("Point"===t.type?[t.coordinates]:t.coordinates).map(t=>function(t,e,i,s){return{id:i,metadata:s,styles:[e],position:Wr([t])[0],priority:0}}(t,r,i,s));return n.push(...o),n}function to(t,e){if(t.length<3||e<=0)return[...t];const i=new Uint8Array(t.length);i[0]=1,i[t.length-1]=1,function t(e,i,s,n,r){const o=e[s],a=e[n];let l=a.x-o.x,h=a.y-o.y;if(0!==l||0!==h){const t=Math.sqrt(Math.pow(l,2)+Math.pow(h,2));l/=t,h/=t}let c=0,d=0,u=-1/0,f=-1;for(let p=s+1;p<n;p++){c=e[p].x-o.x,d=e[p].y-o.y;let t=0;if(0===l&&0===h)t=Math.pow(c,2)+Math.pow(d,2);else{const e=l*c+h*d;t=Math.pow(l*e-c,2)+Math.pow(h*e-d,2)}t>u&&(u=t,f=p)}u>r&&(i[f]=1,t(e,i,s,f,r),t(e,i,f,n,r))}(t,i,0,t.length-1,Math.pow(e,2));const s=[];for(let n=0;n<t.length;n++)i[n]&&s.push(t[n]);return s}function eo(t,e,i,s){let{geometry:n}=t;const{properties:r}=t,o=r&&r.style;if(!r||!o)return;const a=r.metadata&&"object"==typeof r.metadata?new Map(Object.entries(r.metadata)):void 0;switch(n.type){case"LineString":n={type:"LineString",coordinates:to(n.coordinates,i)};break;case"MultiLineString":n={type:"MultiLineString",coordinates:n.coordinates.map(t=>to(t,i))};break;case"Polygon":n={type:"Polygon",coordinates:n.coordinates.map(t=>to(t,i))};break;case"MultiPolygon":n={type:"MultiPolygon",coordinates:n.coordinates.map(t=>t.map(t=>to(t,i)))}}switch(n.type){case"LineString":case"MultiLineString":Fr(n,o,e.idGenerator(),a,s.polylines);break;case"Polygon":case"MultiPolygon":const t=e.idGenerator();Zr(n,o,t,a,s.polygons),Hr(n,o,t,a,s.polylines);break;case"Point":case"MultiPoint":Jr(n,o,e.collidingIdGenerator(),a,s.icons)}}class io extends di{constructor(t,e,i,s,n,r,o,a,l,h,c,d,u,f,p){super(e,0,i,s,n,r,o,a,l,h,c,d,u,f),this._detalizationLevel=t,this._objectIdProvider=p}_onContent(t){this._content=pe(this._content,t),[...this._subTasks,this].every(t=>3===t.state)&&super._onContent(this._content)}_onSubTaskContent(t){this._onContent(t)}_startImpl(){this._scheduleProcessing(this._detalizationLevel)}_resumeImpl(){this._scheduleProcessing(this._detalizationLevel)}_process(t){const e=function(t,e){kt[t]||(kt[t]=[]);let i=kt[t][e];return i||(i=2/(function(t){switch(t){case 1:return 512;case 2:return 1024;default:return 256}}(t)*Math.pow(2,e)),kt[t][e]=i),i}(0,t.zoom),i=t.object.style.simplificationRate*e,s=function(t,e,i=0,s={polygons:[],polylines:[],icons:[]}){const n="Feature"===t.type?[t]:t.features;for(const r of n)eo(r,e,i,s);return s}(t.object.feature,this._objectIdProvider,i);return pe(this._writePolygons(s.polygons),this._writePolylines(s.polylines),this._writeIcons(s.icons),{content:{primitives:{}},metrics:{}})}_loadImpl(){throw new Error("Loading is not supported")}_loadCancel(){throw new Error("Loading is not supported")}}const so={objectsCollisionPriority:1,polygonsBatchingRule:tn,modelsBatchingRule:en,polylinesBatchingRule:tn,labelsBatchingRule:tn,computeIconBrightnessRange:!1};class no extends $s{constructor(t,e,i,n,r,o,a,l,h,c){super(n,r,o,a,l,h,c),this.onContentReady=new s,this._communicator=t,this._viewport=i,this._detalizationStorage=e,this._tasks=new Map,this._options=Object.assign({},so),this._communicator.onMessage.addListener(this._onMessage,this),this._detalizationStorage.onAdded.addListener(this._onLevelAdded,this),this._detalizationStorage.onRemoved.addListener(this._onLevelRemoved,this)}destructor(){this._detalizationStorage.onAdded.removeListener(this._onLevelAdded),this._detalizationStorage.onRemoved.removeListener(this._onLevelRemoved),this._communicator.onMessage.removeListener(this._onMessage)}_onMessage(t){switch(t.type){case 0:this._onSetup(t)}}_onSetup(t){this._options=Object.assign(Object.assign({},so),t.options)}_onContentReady(t,e){const{content:i,contentToRemove:s,metrics:n}=e;s&&this._communicator.sendMessage({type:3,levelId:t.id,content:s},!1);const r=this._extractSharedResources(i.primitives);t.addContent(i,r),this._detalizationStorage.has(t.id)||(console.warn("Content ready event on the missing graphics LOD: "+t.id),this._detalizationStorage.add(t.id,t)),this._registry.flushBackendUpdates(),this._iconAtlasRegistry.flushAtlasesUpdates(),this._communicator.sendMessage({type:2,levelId:t.id,content:i,metrics:n},!0)}_onLevelAdded(t){this._createTask(t).start()}_onLevelRemoved(t){this._destroyTask(t.id)}_createTask(t){const e=new io(t,this._options,this._taskQueue,this._taskPriority,this._opaquePolygonBufferWriter,this._transparentPolygonBufferWriter,this._extrudedPolygonWriter,this._polylineBufferWriter,this._pointLabelBufferWriter,this._curvedLabelBufferWriter,this._iconBufferWriter,this._registry,this._glyphAtlasRegistry,this._iconAtlasRegistry,this._objectIdProvider),i=new Mr(t,e,this._viewport,this._taskPriority);return i.onContentReady.addListener(e=>this._onContentReady(t,e)),this._tasks.set(t.id,i),i}_destroyTask(t){const e=this._tasks.get(t);e&&(e.destructor(),this._tasks.delete(t))}}class ro extends h{_serialize({id:t,parent:e}){return{id:t,parentId:e.id}}_add(t,e){e.parent.addChild(e),super._add(t,e)}_remove(t){const e=this.get(t);e&&e.parent.removeChild(e),super._remove(t)}}class oo extends h{_serialize({id:t,style:e,parent:i}){return{id:t,style:e,parentId:null===i?null:i.id}}_add(t,e){e.parent&&e.parent.addChild(e),super._add(t,e)}_remove(t){const e=this.get(t);e&&e.parent&&e.parent.removeChild(e),super._remove(t)}}class ao extends o{constructor(t,e,i,n){super(),this.id=t,this.object=e,this.zIndex=e.style.zIndex,this.version=e.version,this.zoom=i,this._state=n,this._onStateChanged=new s,this._onContentAdded=new s}get state(){return this._state}set state(t){if(t!==this._state){const e=this._state;this._state=t,this._onStateChanged.fire(this,e,t)}}get onStateChanged(){return this._onStateChanged}get onContentAdded(){return this._onContentAdded}addContent(t,e){super.addContent(t,e),this._onContentAdded.fire(this)}}class lo{constructor(t,e,i){this.type=1,this.id=t,this.parent=i,this.style=e,this._children=new Set}get children(){return this._children}addChild(t){this._children.add(t)}removeChild(t){this._children.delete(t)}}class ho{constructor(t,e,i,s){this.type=0,this.id=t,this._feature=e,this._style=i,this.parent=s,this._version=0,this._detalizationLevels=new Set}get feature(){return this._feature}get style(){return this._style}get version(){return this._version}get detalizationLevels(){return this._detalizationLevels}update(t,e){this._feature=t,this._style=e,this._version++}addDetalizationLevel(t){this._detalizationLevels.add(t)}removeDetalizationLevel(t){this._detalizationLevels.delete(t)}}class co{constructor(t,e,i,s,n){this._communicator=t,this._viewport=e,this._groupStorage=i,this._objectStorage=s,this._detalizationStorage=n,this._options=fo,this._simplifiedObjects=new Set,this._communicator.onMessage.addListener(this._onMessage,this),this._viewport.onUpdate.addListener(this._onViewportUpdate,this)}destructor(){this._communicator.onMessage.removeListener(this._onMessage)}_onMessage(t){switch(t.type){case 0:this._onSetup(t);break;case 1:this._onAddObject(t);break;case 2:this._onUpdateObject(t);break;case 3:this._onRemoveObject(t);break;case 4:this._onAddGroup(t);break;case 5:this._onRemoveGroupAndChildren(t)}}_onSetup(t){this._options=Object.assign(Object.assign({},fo),t.options)}_onAddObject(t){const{id:e,feature:i,style:s,parentId:n}=t,r=this._groupStorage.get(n);if(!r)throw new Error(`Parent ${n} is not found for object ${e}`);const o=new ho(e,i,s,r);this._objectStorage.add(e,o),s.simplificationRate>0&&this._simplifiedObjects.add(o),this._createCurrentZoomObjectDetalizations(o)}_onUpdateObject(t){const{id:e,feature:i,style:s}=t,n=this._objectStorage.get(e);if(bi(n,`Object update error: Object ${e} is not in the storage`)){n.update(i,s),s.simplificationRate>0?this._simplifiedObjects.add(n):this._simplifiedObjects.delete(n);for(const t of n.detalizationLevels)t.state=4;this._createCurrentZoomObjectDetalizations(n)}}_onRemoveObject(t){const e=this._objectStorage.get(t.id);e&&this._removeObject(e)}_onAddGroup(t){const{id:e,style:i,parentId:s}=t,n=null===s?null:this._groupStorage.get(s);if(void 0===n)throw new Error(`Parent ${s} is not found for group ${e}`);this._groupStorage.add(e,new lo(e,i,n))}_onRemoveGroupAndChildren(t){const e=this._groupStorage.get(t.id);e&&this._removeGroupAndChildren(e)}_onViewportUpdate(){this._recalculateDetalizationState();for(const t of this._simplifiedObjects)this._createCurrentZoomObjectDetalizations(t)}_removeObject(t){this._removeObjectDetalizations(t),this._simplifiedObjects.delete(t),this._objectStorage.remove(t.id,!0)}_removeGroupAndChildren(t){this._groupStorage.remove(t.id,!0);for(const e of t.children)0===e.type?this._removeObject(e):this._removeGroupAndChildren(e)}_createCurrentZoomObjectDetalizations(t){if(t.style.simplificationRate<=0)return this._createNonSimplifiedObjectDetalization(t);const{minSimplificationZoom:e,maxSimplificationZoom:i,simplificationPreloadedZooms:s}=this._options,{zoom:n}=this._viewport,r=Math.max(n-s,e),o=Math.min(n+s,i);for(let a=r;a<=o;a++){const e=uo(t,a);if(!this._detalizationStorage.has(e)){const i=new ao(e,t,a,a===n?1:2);this._detalizationStorage.add(e,i)}}}_createNonSimplifiedObjectDetalization(t){const e=uo(t,po);if(!this._detalizationStorage.has(e)){const i=new ao(e,t,po,0);this._detalizationStorage.add(e,i)}}_removeObjectDetalizations(t){for(const e of t.detalizationLevels)this._detalizationStorage.remove(e.id)}_recalculateDetalizationState(){const{zoom:t}=this._viewport;for(const e of this._simplifiedObjects)for(const i of e.detalizationLevels)4!==i.state&&0!==i.state&&(i.zoom===t?i.state=1:Math.abs(i.zoom-t)<=this._options.simplificationPreloadedZooms?i.state=2:i.state=3)}}function uo(t,e){return`${t.id}~${e}~${t.version}`}const fo={minSimplificationZoom:-1/0,maxSimplificationZoom:1/0,simplificationPreloadedZooms:0},po=-1;class _o extends h{_serialize({id:t,object:e,zoom:i,zIndex:s,version:n}){return{id:t,objectId:e.id,zoom:i,zIndex:s,version:n}}_add(t,e){e.object.addDetalizationLevel(e),super._add(t,e)}_remove(t){const e=this.get(t);e&&e.object.removeDetalizationLevel(e),super._remove(t)}}class go{constructor(t){this._detalizationStorage=t,this._detalizationStorage.onAdded.addListener(this._onLevelAdded,this),this._detalizationStorage.onRemoved.addListener(this._onLevelRemoved,this)}destructor(){this._detalizationStorage.onAdded.removeListener(this._onLevelAdded),this._detalizationStorage.onRemoved.removeListener(this._onLevelRemoved)}_onLevelAdded(t){t.onStateChanged.addListener(this._onLevelStateChanged,this),t.onContentAdded.addListener(this._onLevelContentAdded,this)}_onLevelRemoved(t){t.onStateChanged.removeListener(this._onLevelStateChanged),t.onContentAdded.removeListener(this._onLevelContentAdded),t.destructor()}_onLevelStateChanged(t){4===t.state&&(t.object[mo]=!0)}_onLevelContentAdded(t){const{object:e}=t;if(4!==t.state&&e[mo]){for(const t of e.detalizationLevels)4===t.state&&this._detalizationStorage.remove(t.id);e[mo]=!1}}}const mo=Symbol();class yo{constructor(t){this._communicator=t,this._zoom=0,this.onUpdate=this._onUpdate=new s,this._communicator.onMessage.addListener(this._onMessage,this)}destructor(){this._communicator.onMessage.removeListener(this._onMessage)}get zoom(){return this._zoom}_updateZoom(t){this._zoom=t,this._onUpdate.fire()}_onMessage(t){switch(t.type){case 0:this._onSetZoom(t)}}_onSetZoom(t){this._updateZoom(t.zoom)}}class bo{constructor(t,e,i,s=new wr,r=100){this._objectIdProvider=e,this._taskQueue=i,this._loadManager=s,this._taskPriority=r,this._commutator=new n(t),this._objectStorage=new ro(this._commutator.getCommunicator(2)),this._groupStorage=new oo(this._commutator.getCommunicator(3)),this._detalizationStorage=new _o(this._commutator.getCommunicator(4)),this._registry=new un(this._commutator.getCommunicator(6)),this._glyphAtlasRegistry=new Sn(this._commutator.getCommunicator(8),new fr(this._loadManager)),this._iconAtlasRegistry=new dr(this._commutator.getCommunicator(7),this._loadManager),this._viewport=new yo(this._commutator.getCommunicator(5)),this._graphicsManager=new co(this._commutator.getCommunicator(1),this._viewport,this._groupStorage,this._objectStorage,this._detalizationStorage),this._graphicsContentManager=new no(this._commutator.getCommunicator(0),this._detalizationStorage,this._viewport,this._registry,this._glyphAtlasRegistry,this._iconAtlasRegistry,e,i,s,this._taskPriority),this._garbageCollector=new go(this._detalizationStorage)}destructor(){this._graphicsContentManager.destructor(),this._iconAtlasRegistry.destructor(),this._glyphAtlasRegistry.destructor(),this._commutator.destructor(),this._graphicsManager.destructor(),this._viewport.destructor(),this._garbageCollector.destructor()}}class wo extends h{_serialize(t){return{id:t.id,bbox:t.bbox}}}class vo extends di{constructor(t,e,i,s,n,r,o,a,l,h,c,d,u,f,p,_,g){super(i,s,n,r,o,a,l,h,c,d,u,f,p,_),this._object=t,this._data=e,this._objectIdProvider=g}_onSubTaskContent(t){this._onContentReady.fire({object:this._object,content:t})}_startImpl(){this._scheduleProcessing(this._data)}_process(t){return{object:this._object,content:pe(this._writePolygons(this._extractPolygons(t)),{content:{primitives:{}},metrics:{loadTime:this._loadTime}})}}_loadImpl(){throw new Error("TODO: implement geo content loading")}_loadCancel(){throw new Error("TODO: implement geo content loading cancel")}_extractPolygons(t){const e=[];if("FeatureCollection"===t.type)for(const i of t.features)"Feature"===i.type&&"Polygon"===i.geometry.type&&e.push({id:this._objectIdProvider.idGenerator(),styles:[{color:dt(1,0,0,1),extruded:!1,height:0,minZoom:0,maxZoom:0,zIndex:0,classId:1}],height:0,hasContour:!1,vertexRings:i.geometry.coordinates});return e}}class xo extends o{constructor(t,e){super(),this.id=t,this.bbox=e}}class ko extends ye{constructor(t,e,i,s,n,r,o,a,l,h,c,d,u,f,p,_){super(s,i,2e3),this._url=t,this._options=e,this._loadManager=n,this._opaquePolygonBufferWriter=r,this._transparentPolygonBufferWriter=o,this._extrudedPolygonBufferWriter=a,this._polylineBufferWriter=l,this._pointLabelsBufferWriter=h,this._curvedLabelsBufferWriter=c,this._iconBufferWriter=d,this._pageRegistry=u,this._glyphAtlasRegistry=f,this._iconAtlasRegistry=p,this._objectIdProvider=_}_process(t){const e=[t];for(const[i,s]of e.entries()){const t=this._url+"_"+i,e=-1,n=new xo(t,{minX:.20893428,maxX:.20993428,minY:.37293635,maxY:.37393635}),r=new vo(n,s,this._options,e,this._taskQueue,this._priority,this._opaquePolygonBufferWriter,this._transparentPolygonBufferWriter,this._extrudedPolygonBufferWriter,this._polylineBufferWriter,this._pointLabelsBufferWriter,this._curvedLabelsBufferWriter,this._iconBufferWriter,this._pageRegistry,this._glyphAtlasRegistry,this._iconAtlasRegistry,this._objectIdProvider);this._startSubTask(r)}}_onSubTaskContent(t){this._onContentReady.fire(t)}_loadImpl(){return this._loadManager.loadJson(this._url,this._priority).then(()=>{throw new Error("tmp")},()=>({type:"FeatureCollection",features:[{type:"Feature",geometry:{type:"Polygon",coordinates:[[{x:.20893428,y:.37293635},{x:.20893428,y:.37393635},{x:.20993428,y:.37393635},{x:.20993428,y:.37293635}]]},properties:{tags:["animated_polygon"]},id:"Polygon_${tileId.x}_${tileId.y}_${tileId.z}"}]}))}_loadCancel(){this._loadManager.cancel(this._request)}}class Ao{constructor(t){this.id=t,this._geoObjects=new Set,this.onBBoxExtended=this._onBBoxExtended=new s}get bbox(){return this._bbox||Object.assign({},I)}get geoObjects(){return this._geoObjects}get isEmpty(){return 0===this._geoObjects.size}destructor(){for(const t of this._geoObjects)t.destructor()}addGeoObject(t){this._geoObjects.add(t),this._bbox?P(this._bbox,t.bbox):this._bbox=Object.assign({},t.bbox),this._onBBoxExtended.fire(this)}hasGeoObject(t){return this._geoObjects.has(t)}}const So={contentUrlTemplate:"no contentUtlTemplate specified",objectsCollisionPriority:1,polygonsBatchingRule:Js(()=>!0),modelsBatchingRule:Js(()=>!0),polylinesBatchingRule:Js(()=>!0),labelsBatchingRule:Js(()=>!0),computeIconBrightnessRange:!1};class To extends $s{constructor(t,e,i,s,n,r,o,a,l){super(s,n,r,o,a,l,0),this._communicator=t,this._storage=e,this._batchStorage=i,this._requests=new Map,this._options=Object.assign({},So),this._communicator.onMessage.addListener(this._onMessage,this),this._batchStorage.onRemoved.addListener(this._onBatchRemoved,this)}destructor(){this._communicator.onMessage.removeListener(this._onMessage),this._batchStorage.onRemoved.removeListener(this._onBatchRemoved)}fetch(t){if(!this._requests.has(t)){const e=new Ao(t),i=new ko(t,this._options,0,this._taskQueue,this._loadManager,this._opaquePolygonBufferWriter,this._transparentPolygonBufferWriter,this._extrudedPolygonWriter,this._polylineBufferWriter,this._pointLabelBufferWriter,this._curvedLabelBufferWriter,this._iconBufferWriter,this._registry,this._glyphAtlasRegistry,this._iconAtlasRegistry,this._objectIdProvider);i.onContentReady.addListener(t=>this._onContentReady(e,t)),i.start(),this._requests.set(t,i),this._batchStorage.add(t,e)}}_onMessage(t){switch(t.type){case 0:this._onSetup(t)}}_onSetup(t){this._options=Object.assign(Object.assign({},So),t.options)}_onContentReady(t,e){const{object:i,content:s}=e;i.addContent(e.content,this._extractSharedResources(s.content.primitives)),t.hasGeoObject(i)||t.addGeoObject(i),this._batchStorage.has(t.id)||this._batchStorage.add(t.id,t),this._storage.has(i.id)||this._storage.add(i.id,i),this._registry.flushBackendUpdates(),this._iconAtlasRegistry.flushAtlasesUpdates(),this._communicator.sendMessage({type:2,objectId:i.id,content:s.content},!0)}_onBatchRemoved(t){const e=this._requests.get(t.id);e&&(e.destructor(),this._requests.delete(t.id))}}class Ro extends l{}class Io{constructor(t,e,i=6e4){this._communicator=t,this._storage=e,this._longAgoThreshold=i,this._lastNearnessTimeKey=Symbol("geo_gc_nearness_time"),this._currentExtendedViewportBBox=Object.assign({},I),this._communicator.onMessage.addListener(this._onMessage,this),this._storage.onAdded.addListener(this._onBatchAdded,this),this._storage.onRemoved.addListener(this._onBatchRemoved,this);for(const s of e.items)this._onBatchAdded(s)}destructor(){this._communicator.onMessage.removeListener(this._onMessage),this._storage.onAdded.removeListener(this._onBatchAdded),this._storage.onRemoved.removeListener(this._onBatchRemoved);for(const t of this._storage.items)this._onBatchRemoved(t)}_onBatchAdded(t){t[this._lastNearnessTimeKey]=me(),t.onBBoxExtended.addListener(this._onBatchBBoxExtended,this)}_onBatchRemoved(t){delete t[this._lastNearnessTimeKey],t.onBBoxExtended.removeListener(this._onBatchBBoxExtended)}_onMessage(t){switch(t.type){case 0:this._onCameraUpdate(t)}}_onCameraUpdate(t){const e=me(),i=t.viewportBBox,s=i.maxX-i.minX,n=i.maxY-i.minY;this._currentExtendedViewportBBox=C(i.minX-=2*s,i.maxX+=2*s,i.minY-=2*n,i.maxY+=2*n);for(const r of this._storage.items)this._updateNearnessTime(r,e);this._garbageCollect()}_onBatchBBoxExtended(t){this._updateNearnessTime(t)}_updateNearnessTime(t,e=me()){(function(t,e){let i,s,n,r;return t.minX<e.minX?(i=t,s=e):(i=e,s=t),t.maxY>e.maxY?(n=t,r=e):(n=e,r=t),s.minX<i.maxX&&r.maxY>n.minY})(this._currentExtendedViewportBBox,t.bbox)&&(t[this._lastNearnessTimeKey]=e)}_isGarbage(t,e=me()){return e-t[this._lastNearnessTimeKey]>this._longAgoThreshold}_garbageCollect(t=me()){const e=[];for(const i of this._storage.items)this._isGarbage(i,t)&&e.push(i);for(const i of e)this._storage.remove(i.id),i.destructor()}}class Co{constructor(t,e,i,s=new wr,r=100){this._objectIdProvider=e,this._taskQueue=i,this._loadManager=s,this._taskPriority=r,this._commutator=new n(t),this._communicator=this._commutator.getCommunicator(0),this._storage=new wo(this._commutator.getCommunicator(2)),this._batchStorage=new Ro,this._registry=new un(this._commutator.getCommunicator(3)),this._glyphAtlasRegistry=new Sn(this._commutator.getCommunicator(5),new fr(this._loadManager)),this._iconAtlasRegistry=new dr(this._commutator.getCommunicator(4),this._loadManager),this._geoContentManager=new To(this._commutator.getCommunicator(1),this._storage,this._batchStorage,this._registry,this._glyphAtlasRegistry,this._iconAtlasRegistry,e,i,s),this._gc=new Io(this._commutator.getCommunicator(6),this._batchStorage),this._communicator.onMessage.addListener(this._onMessage,this)}destructor(){this._geoContentManager.destructor(),this._iconAtlasRegistry.destructor(),this._glyphAtlasRegistry.destructor(),this._gc.destructor(),this._commutator.destructor(),this._communicator.onMessage.removeListener(this._onMessage)}_onMessage(t){switch(t.type){case 0:this._onCameraChanged(t)}}_onCameraChanged(t){t.center.x>.208&&t.center.x<.209&&t.center.y>.372&&t.center.y<.375&&(console.log("fetching, ",t.center),this._geoContentManager.fetch("http://whatever.whh"))}}const zo=He([[0,{size:2,type:5123,normalized:!1}],[1,{size:2,type:5123,normalized:!1}],[4,{size:2,type:5123,normalized:!0}],[10,{size:1,type:5126,normalized:!1}]]);function Po(){return"createImageBitmap"in self}class Oo extends ye{constructor(t,e,i,s,n,r,o){super(e,n,r),this._tile=t,this._loadManager=i,this._tileTemplateUrl=s,this._bufferWriter=o}_process(t){return{primitive:{location:this._bufferWriter.writeTile(this._tile.tile)},image:t}}_loadImpl(){const t=this._tile.tile,e=this._loadManager.loadBlob(this._tileTemplateUrl.replace("{{x}}",t.x+"").replace("{{y}}",t.y+"").replace("{{z}}",t.zoom+""),Math.floor(this._getTaskPriority()));return Po()?e.then(t=>createImageBitmap(t)):e}_loadCancel(){this._loadManager.cancel(this._request)}}class Eo extends gi{constructor(t,e,i,s,n,r,o){super(t,new Oo(t,e,i,o,r,2e3,n),s,r)}}class Mo extends Ze{constructor(t){super(t)}_writeVertex(t,e,i,s){Xe(t,e),t.writeVertexUint32(qe(Ve(i.x),Ve(i.y))),t.writeVertexFloat32(s)}}const Lo=function(t){let e,i;return function(s){return e===s&&void 0!==e||(e=s,i=t(s)),i}}(t=>2/(256*Math.pow(2,t)));class Bo extends Mo{constructor(t){super(t)}writeTile(t,e=0){const i=1.4*Lo(t.zoom),s=new nt(t.zoom),n=s.getTileSize(),r=s.getTileOffset(t),o=Vo;return y(r,o),o.x-=i,o.y+=i,this.writeVertex(o,Uo,e),o.x+=n,o.x+=2*i,this.writeVertex(o,Do,e),o.y-=n,o.y-=2*i,this.writeVertex(o,jo,e),o.x-=n,o.x-=2*i,this.writeVertex(Vo,No,e),this.writeIndices([0,1,3,1,2,3]),this.endMesh()}}const Uo=g(0,0),Do=g(1,0),jo=g(1,1),No=g(0,1),Vo=g(0,0);var Wo;!function(t){t[t.TO_BACKEND_SETUP=0]="TO_BACKEND_SETUP",t[t.FROM_BACKEND_ADD_RASTER_TILE_CONTENT=1]="FROM_BACKEND_ADD_RASTER_TILE_CONTENT"}(Wo||(Wo={}));const qo=Object.assign(Object.assign({},sn),{rasterTileUrlTemplate:"no tileUrlTemplate specified"});class Go extends nn{constructor(t,e,i,s,n,r,o,a,l,h,c,d){super(t,i,s,n,r,o,a,l,h,c,d),this._extCommunicator=e,this._extOptions=Object.assign({},qo),this._extCommunicator.onMessage.addListener(this._onExtMessage,this),this._rasterTileRequests=new Map,this._tileBufferWriter=new Bo(Ks(n,zo))}destructor(){this._extCommunicator.onMessage.removeListener(this._onExtMessage),super.destructor()}_onExtMessage(t){switch(t.type){case Wo.TO_BACKEND_SETUP:this._onExtSetup(t)}}_onExtSetup(t){Object.assign(this._extOptions,t.options)}_onTileAdded(t){super._onTileAdded(t);const e=new Eo(t,this._taskQueue,this._loadManager,this._viewport,this._tileBufferWriter,this._taskPriority,this._extOptions.rasterTileUrlTemplate);this._rasterTileRequests.set(t.id,e),e.onContentReady.addListener(e=>this._onRasterTileContent(t,e)),e.start()}_onTileRemoved(t){super._onTileRemoved(t);const e=this._rasterTileRequests.get(t.id);bi(e)&&(e.destructor(),this._rasterTileRequests.delete(t.id))}_onRasterTileContent(t,e){this._registry.flushBackendUpdates(),this._iconAtlasRegistry.flushAtlasesUpdates();const i=Po()?[e.image]:[];this._extCommunicator.sendMessage({type:Wo.FROM_BACKEND_ADD_RASTER_TILE_CONTENT,tileId:t.id,content:{2:[e.primitive]},images:[e.image]},!0,...i)}}class Fo extends xr{_createTileVectorContentManagerBackend(){return new Go(this._commutator.getCommunicator(3),this._commutator.getCommunicator(7),this._tileStorage,this._modelStorage,this._registry,this._glyphAtlasRegistry,this._iconAtlasRegistry,this._viewport,this._objectIdProvider,this._taskQueue,this._loadManager,this._taskPriority)}}class Yo{constructor(t){this._addressee=t,this._messageQueue=[],this._transferableQueue=[],this._listeners=[]}addMessage(t,e=[]){this._messageQueue.push(t),this._transferableQueue.push(...e)}onMessage(t){this._listeners.push(t)}flushMessages(){0!==this._messageQueue.length&&this._addressee.postMessage(this._messageQueue,this._transferableQueue),this._messageQueue.length=0,this._transferableQueue.length=0}listen(){this._addressee.onmessage=({data:t})=>{for(const e of t)for(const t of this._listeners)t(e)}}}e.default=new class{constructor(t){var e;this._commutator=new n(new r(t)),this._communicator=this._commutator.getCommunicator(0),this._contentProviders=new Map,this._objectIdProvider=(e=vt,{idGenerator:kr(xt),collidingIdGenerator:kr(e)}),this._taskQueue=new yn,this._loadManager=new wr,this._communicator.onMessage.addListener(this._onMessage,this),this._communicator.sendMessage({type:3},!0)}destructor(){for(const t of this._contentProviders.values())t.destructor();this._taskQueue.destroy(),this._commutator.destructor()}_onMessage(t){switch(t.type){case 0:this._onInitContentProvider(t);break;case 2:this._onDestroyContentProvider(t)}}_onInitContentProvider(t){let e;switch(t.providerType){case 0:e=new xr(this._commutator.getCommunicator(t.id),this._objectIdProvider,this._taskQueue,this._loadManager,t.options.basePriority,t.options.tileCacheSize);break;case 2:e=new Fo(this._commutator.getCommunicator(t.id),this._objectIdProvider,this._taskQueue,this._loadManager,t.options.basePriority,t.options.tileCacheSize);break;case 3:e=new Er(this._commutator.getCommunicator(t.id),this._objectIdProvider,this._taskQueue,this._loadManager,t.options.basePriority,t.options.tileCacheSize);break;case 4:e=new bo(this._commutator.getCommunicator(t.id),this._objectIdProvider,this._taskQueue,this._loadManager,t.options.basePriority);break;case 5:e=new Co(this._commutator.getCommunicator(t.id),this._objectIdProvider,this._taskQueue,this._loadManager,t.options.basePriority);break;default:throw new Error("Unknown content provider backend type: "+t.providerType)}this._contentProviders.set(t.id,e)}_onDestroyContentProvider(t){const{id:e}=t,i=this._contentProviders.get(e);i&&(i.destructor(),this._contentProviders.delete(e))}}(new class extends Yo{run(){return this.listen(),this}}(self).run())}]);',null)}},function(t,e){t.exports="#version 100\nattribute vec2 position;uniform sampler2D directPriorityGrid;uniform sampler2D reversePriorityGrid;uniform vec2 idHalfPxSize;uniform vec2 gridHalfPxSize;varying lowp vec4 id;const vec2 A=vec2(0,0);const vec4 B=vec4(2,2,2,1);const float C=255./256.;const float D=0.01;const float E=0.25;const float F=0.5;void main(){vec4 G=texture2D(reversePriorityGrid,position);if(G.rg!=A){vec4 H=texture2D(directPriorityGrid,position);vec2 I=G.rg*C+idHalfPxSize;bool J=G!=H;gl_Position=vec4(I*2.-1.,E,1);id=vec4(A,0,0);if(J&&H.a>=D){gl_Position.z=F;id=vec4(H.rg,0,1);}gl_PointSize=1.;}else{gl_Position=B;}}"},function(t,e){t.exports="#version 100\nattribute vec4 position;varying vec2 idTexCoordinates;void main(){gl_Position=vec4(position.xy,0,1);idTexCoordinates=position.zw;}"},function(t,e){t.exports="#version 100\nprecision mediump float;uniform sampler2D prevVisibility;uniform sampler2D overlaps;uniform sampler2D scene;uniform float fadeAnimationAmount;uniform float currentZoom;uniform float currentTilt;uniform float currentAzimuth;varying vec2 idTexCoordinates;const float A=1./256.;void main(){vec4 B=texture2D(prevVisibility,idTexCoordinates);vec4 C=texture2D(overlaps,idTexCoordinates);vec4 D=texture2D(scene,idTexCoordinates);bool E=D.a>=A;if(E){gl_FragColor=B;bool F=C.a>=A;if(F){if(gl_FragColor.b<A){gl_FragColor.b=currentZoom;gl_FragColor.r=currentTilt;gl_FragColor.g=currentAzimuth;}gl_FragColor.a=clamp(gl_FragColor.a-fadeAnimationAmount,0.,1.);}else{gl_FragColor.a=clamp(gl_FragColor.a+fadeAnimationAmount,0.,1.);gl_FragColor.rgb=vec3(0,0,0);}}else{gl_FragColor=vec4(0,0,0,0);}}"},function(t,e){t.exports="#version 100\nattribute vec4 position;void main(){gl_Position=vec4(position.xy,0,1);}"},function(t,e){t.exports="#version 100\nvoid main(){gl_FragColor=vec4(0,0,0,1);}"},function(t,e){t.exports="#version 100\nattribute vec2 vertexId;uniform vec2 idHalfPxSize;void main(){vec2 A=vertexId.xy/256.+idHalfPxSize;vec4 B=vec4(A*2.-1.,0,1);gl_Position=B;gl_PointSize=1.;}"},function(t,e){t.exports="#version 100\nvoid main(){gl_FragColor=vec4(0,0,0,1);}"},function(t,e){t.exports="#version 100\nuniform lowp vec4 color;void main(){gl_FragColor=color;}"},function(t,e){t.exports="#version 100\nprecision mediump float;uniform vec2 pixelSize;uniform sampler2D texture;uniform float dpr;const float A=0.75;const float B=0.063;const float C=0.0625;const float D=0.0001;float E(vec4 F){return dot(F.xyz,vec3(0.299,0.587,0.114));}vec4 G(vec2 H,sampler2D I,vec2 J,float K,float L,float M){vec2 N;N.x=H.x;N.y=H.y;vec4 O=texture2D(I,N);float P=E(O);float Q=E(texture2D(I,N+vec2(0,1)*J.xy));float R=E(texture2D(I,N+vec2(1,0)*J.xy));float S=E(texture2D(I,N+vec2(0,-1)*J.xy));float T=E(texture2D(I,N+vec2(-1,0)*J.xy));float U=max(Q,P);float V=min(Q,P);float W=max(R,U);float X=min(R,V);float Y=max(S,T);float Z=min(S,T);float a=max(Y,W);float b=min(Z,X);float c=a*L;float d=a-b;float e=max(M,c);bool f=d<e;if(f)return O;float g=E(texture2D(I,N+vec2(-1,-1)*J.xy));float h=E(texture2D(I,N+vec2(1,1)*J.xy));float i=E(texture2D(I,N+vec2(1,-1)*J.xy));float j=E(texture2D(I,N+vec2(-1,1)*J.xy));float k=S+Q;float l=T+R;float m=1./d;float n=k+l;float o=(-2.*P)+k;float p=(-2.*P)+l;float q=i+h;float r=g+i;float s=(-2.*R)+q;float t=(-2.*S)+r;float u=g+j;float v=j+h;float w=(abs(o)*2.)+abs(s);float x=(abs(p)*2.)+abs(t);float y=(-2.*T)+u;float z=(-2.*Q)+v;float AA=abs(y)+w;float AB=abs(z)+x;float AC=u+q;float AD=J.x;bool AE=AA>=AB;float AF=n*2.+AC;if(AE){AD=J.y;}else{S=T;Q=R;}float AG=(AF*(1./12.))-P;float AH=S-P;float AI=Q-P;float AJ=S+P;float AK=Q+P;bool AL=abs(AH)>=abs(AI);float AM=max(abs(AH),abs(AI));if(AL){AD=-AD;}else{AJ=AK;}float AN=clamp(abs(AG)*m,0.,1.);vec2 AO=N;vec2 AP;vec2 AQ;if(AE){AP=vec2(J.x,0.);AQ=vec2(0.,AD);}else{AP=vec2(0.,J.y);AQ=vec2(AD,0.);}vec2 AR=AO-AP*2.;vec2 AS=AO+AP*2.;float AT=((-2.)*AN)+3.;float AU=E(mix(texture2D(I,AR),texture2D(I,AR+AQ),0.5));float AV=AN*AN;float AW=E(mix(texture2D(I,AS),texture2D(I,AS+AQ),0.5));float AX=AM*0.25;float AY=P-AJ*0.5;float AZ=AT*AV;bool Aa=AY<0.;AU-=AJ*0.5;AW-=AJ*0.5;bool Ab=abs(AU)>=AX;bool Ac=abs(AW)>=AX;if(!Ab){AR-=AP*3.;}bool Ad=(!Ab)||(!Ac);if(!Ac){AS+=AP*3.;}if(Ad){if(!Ab){AU=E(mix(texture2D(I,AR),texture2D(I,AR+AQ),0.5));AU=AU-AJ*0.5;}if(!Ac){AW=E(mix(texture2D(I,AS.xy),texture2D(I,AS.xy+AQ),0.5));AW=AW-AJ*0.5;}Ab=abs(AU)>=AX;Ac=abs(AW)>=AX;if(!Ab){AR-=AP*12.;}if(!Ac){AS+=AP*12.;}}float Ae=N.x-AR.x;float Af=AS.x-N.x;if(!AE){Ae=N.y-AR.y;Af=AS.y-N.y;}bool Ag=(AU<0.)!=Aa;float Ah=(Af+Ae);bool Ai=(AW<0.)!=Aa;float Aj=1./Ah;bool Ak=Ae<Af;float Al=min(Ae,Af);bool Am=Ak?Ag:Ai;float An=AZ*AZ;float Ao=(Al*(-Aj))+0.5;float Ap=An*K;float Aq=Am?Ao:0.;float Ar=max(Aq,Ap);vec4 As;float At=Ar;if(AE){As=mix(texture2D(I,N),texture2D(I,N+vec2(0.,AD)),At);}else{As=mix(texture2D(I,N),texture2D(I,N+vec2(AD,0.)),At);}return As;}void main(){vec2 H=gl_FragCoord.xy*pixelSize;vec4 As=G(H,texture,pixelSize,A,B,C);if(As.a>D){As.xyz/=As.a;}gl_FragColor=As;}"},function(t,e){t.exports="#version 100\nprecision mediump float;attribute vec2 vertexPosition;attribute vec2 vertexUV;varying vec2 uv;void main(){gl_Position=vec4(vertexPosition,0,1);uv=vertexUV;}"},function(t,e){t.exports="#version 100\nprecision mediump float;uniform sampler2D texture;varying vec2 uv;void main(){gl_FragColor=texture2D(texture,uv);}"},function(t,e){t.exports="#version 100\nattribute vec2 vertexPosHigh;attribute vec2 vertexPosLow;attribute float vertexHeight;attribute vec2 vertexUV;uniform vec2 lookAtHigh;uniform vec2 lookAtLow;uniform mat4 viewProjMatrix;varying vec2 uv;varying vec3 globalPosition;const float A=pow(2.,16.);const float B=pow(2.,-30.);void main(void){vec4 C=vec4((A*(vertexPosHigh.xy-lookAtHigh)+(vertexPosLow.xy-lookAtLow))*B,vertexHeight,1);uv=vertexUV;globalPosition=C.xyz;gl_Position=viewProjMatrix*C;}"},function(t,e){t.exports="#version 100\n#extension GL_OES_standard_derivatives : require\nprecision highp float;uniform sampler2D image;uniform vec4 diffuseColor;uniform float texturingProgress;varying vec2 uv;varying vec3 globalPosition;const vec3 A=vec3(0.2,0.2,1.);const float B=length(A);const float C=0.4;const float D=1.-C;const float E=D+0.5*C*(A.z+1.);vec4 F(vec4 diffuseColor,vec3 G,float H,float I){float J=dot(G,A)/I/B/H;vec3 K=diffuseColor.rgb*(D+0.5*C*(J+1.))/E;return vec4(K,diffuseColor.a);}void main(void){vec3 L=dFdx(globalPosition);vec3 M=dFdy(globalPosition);vec3 N=cross(L,M);vec4 O=F(diffuseColor,N,length(L),length(M));gl_FragColor=mix(O,texture2D(image,uv),texturingProgress);}"},function(t,e){t.exports="#version 100\nuniform sampler2D texture;uniform lowp float opacity;varying mediump vec2 uv;void main(){gl_FragColor=texture2D(texture,uv);gl_FragColor*=opacity;gl_FragColor.rgb/=gl_FragColor.a;}"},function(t,e){t.exports="#version 100\nprecision mediump float;varying highp vec2 textureCoordinates;varying highp vec4 iconLocation;uniform sampler2D atlas;uniform vec2 atlasSize;uniform bool isColorTransformed;uniform mat4 colorTransform;vec4 A(vec4 B,mat4 C){return C*vec4(B.rgb,1)*vec4(1,1,1,B.a);}vec4 D(vec4 B,mat4 colorTransform){vec4 E=A(vec4(B.rgb/B.a,B.a),colorTransform);return vec4(E.rgb*B.a,B.a)*E.a;}void main(void){vec2 F=iconLocation.yw-iconLocation.xz;vec2 G=textureCoordinates;G.x=mod(G.x,F.x);vec2 H=iconLocation.xz+G;vec4 B=texture2D(atlas,H/atlasSize);gl_FragColor=isColorTransformed?D(B,colorTransform):B;}"},function(t,e){t.exports="#version 100\nprecision mediump float;uniform sampler2D atlas;uniform bool isColorTransformed;uniform mat4 colorTransform;varying vec2 uv;varying float alpha;varying float minBrightness;varying float maxBrightness;vec4 A(vec4 B,mat4 C){return C*vec4(B.rgb,1)*vec4(1,1,1,B.a);}const vec3 D=vec3(1.);vec4 E(vec4 B,vec4 F){float G=(0.2126*B.r+0.7152*B.g+0.0722*B.b)/B.a;float H=clamp((G-minBrightness)/(maxBrightness-minBrightness),0.,1.);vec3 I=mix(F.rgb,D,H)*B.a;return vec4(I,B.a);}void main(){vec4 B=texture2D(atlas,uv);gl_FragColor=isColorTransformed?E(B,A(B,colorTransform)):B;gl_FragColor*=alpha;}"},function(t,e){t.exports="#version 100\nattribute vec2 vertexPosHigh;attribute vec2 vertexPosLow;attribute vec2 vertexUV;uniform vec2 lookAtHigh;uniform vec2 lookAtLow;uniform mat4 viewProjMatrix;varying vec2 uv;const float A=1.999969482421875;const float B=0.000030517112463712692;void main(){vec4 C=viewProjMatrix*vec4(A*(vertexPosHigh-lookAtHigh)+B*(vertexPosLow-lookAtLow),0,1);gl_Position=C;uv=vertexUV;}"},function(t,e){t.exports="#version 100\nprecision mediump float;uniform sampler2D atlas;uniform vec2 atlasSize;varying vec2 uv;void main(){gl_FragColor=texture2D(atlas,uv/atlasSize);if(gl_FragColor.a==0.){discard;}}"},function(t,e){t.exports="#version 100\nvarying lowp vec4 color;void main(void){gl_FragColor=color;}"},function(t,e){t.exports="#version 100\n#extension GL_OES_standard_derivatives : require\nprecision highp float;varying vec4 diffuseColor;varying vec4 globalPosition;const vec3 A=vec3(0.2,0.2,1.);const float B=length(A);const float C=0.4;const float D=1.-C;const float E=D+0.5*C*(A.z+1.);vec4 F(vec4 diffuseColor,vec3 G,float H,float I){float J=dot(G,A)/I/B/H;vec3 K=diffuseColor.rgb*(D+0.5*C*(J+1.))/E;return vec4(K,diffuseColor.a);}void main(void){vec3 L=globalPosition.xyz;vec3 M=dFdx(L);vec3 N=dFdy(L);vec3 O=cross(M,N);gl_FragColor=F(diffuseColor,O,length(M),length(N));}"},function(t,e){t.exports="#version 100\nattribute vec4 vertexId;attribute vec2 vertexPosHigh;attribute vec2 vertexPosLow;attribute vec2 vertexDisplacement;attribute vec2 vertexUV;attribute float vertexPriority;uniform vec2 lookAtHigh;uniform vec2 lookAtLow;uniform mat4 viewProjMatrix;uniform vec2 pixelSize;uniform sampler2D visibility;uniform sampler2D overlap;uniform sampler2D scene;uniform vec2 idHalfPxSize;uniform vec2 shift;uniform lowp float currentZoom;uniform lowp float currentTilt;uniform lowp float currentAzimuth;varying lowp vec4 id;const vec4 A=vec4(2,2,2,1);const float B=pow(2.,16.);const float C=pow(2.,-30.);vec4 D(mat4 viewProjMatrix,vec2 lookAtHigh,vec2 lookAtLow,vec2 E,vec2 F,vec2 G,vec2 H){vec4 I=viewProjMatrix*vec4((B*(E-lookAtHigh)+(F-lookAtLow))*C,0,1);I=vec4(I.xy/I.w,0.,1.);return I+vec4(G*H,0.,0.);}const vec4 J=vec4(0,0,0,0);const vec2 K=vec2(0,0);const float L=255./256.;const float M=0.05;const float N=0.15;const float O=0.02;bool P(vec2 Q,vec2 idHalfPxSize,sampler2D overlap,sampler2D scene){vec2 R=texture2D(overlap,Q).rg;return R!=K&&texture2D(scene,R*L+idHalfPxSize)!=J;}float S(vec2 id,vec2 idHalfPxSize,sampler2D visibility,sampler2D overlap,sampler2D scene,float currentZoom,float currentTilt,float currentAzimuth){vec2 Q=id/256.+idHalfPxSize;vec4 T=texture2D(visibility,Q);float U=T.b;float V=T.r;float W=T.g;float X=U-currentZoom;float Y=abs(V-currentTilt);float Z=abs(W-currentAzimuth);if((X>M||(abs(X)<=M&&Y<N&&Z<O))&&P(Q,idHalfPxSize,overlap,scene)){return-1.;}return T.a;}void main(void){float a=S(vertexId.xy,idHalfPxSize,visibility,overlap,scene,currentZoom,currentTilt,currentAzimuth);if(a<0.){gl_Position=A;}else{gl_Position=D(viewProjMatrix,lookAtHigh,lookAtLow,vertexPosHigh,vertexPosLow,vertexDisplacement,pixelSize);gl_Position.xy+=shift;gl_Position.z=vertexPriority;id=vec4(vertexId.xy/255.,0,a);}}"},function(t,e){t.exports="#version 100\nattribute vec2 vertexId;attribute vec2 vertexPosHigh;attribute vec2 vertexPosLow;attribute vec3 vertexDisplacements;attribute vec2 vertexUV;attribute float vertexPriority;attribute lowp vec4 vertexColor;attribute lowp vec4 vertexOutlineColor;attribute vec2 polylineLength_vertexScale;attribute vec4 leftPolylineRatios;attribute vec4 leftPolylineAngles;attribute vec4 rightPolylineRatios;attribute vec4 rightPolylineAngles;uniform vec2 lookAtHigh;uniform vec2 lookAtLow;uniform mat4 viewProjMatrix;uniform vec2 pixelSize;uniform sampler2D visibility;uniform sampler2D overlap;uniform sampler2D scene;uniform vec2 idHalfPxSize;uniform vec2 shift;uniform lowp float currentZoom;uniform lowp float currentTilt;uniform lowp float currentAzimuth;varying lowp vec4 id;const vec4 A=vec4(2,2,2,1);const float B=pow(2.,16.);const float C=pow(2.,-30.);const float D=3.1415927410125732;const int E=4;const float F=1000000.;const float G=1./256.;vec2 H(mat4 viewProjMatrix,vec2 lookAtHigh,vec2 lookAtLow,vec2 pixelSize,vec2 I,vec2 J,vec2 K){vec4 L=viewProjMatrix*vec4((B*(I-lookAtHigh)+(J-lookAtLow))*C+K,0,1);vec2 M=L.xy/L.w;return M/pixelSize;}vec2 N(float O,float P,float Q){float R=P*2.*D-D;float S=O*Q;return vec2(cos(R),sin(R))*S;}float T(vec4 R,int U){if(U==0)return R[0];if(U==1)return R[1];if(U==2)return R[2];return R[3];}vec4 V(mat4 viewProjMatrix,vec2 lookAtHigh,vec2 lookAtLow,vec2 W,vec2 X,vec2 Y,vec2 Z,float a,float Q,vec4 leftPolylineRatios,vec4 leftPolylineAngles,vec4 rightPolylineRatios,vec4 rightPolylineAngles){vec2 L=H(viewProjMatrix,lookAtHigh,lookAtLow,W,X,Y,vec2(0,0));vec2 b=N(rightPolylineRatios[0],rightPolylineAngles[0],Q);vec2 c=H(viewProjMatrix,lookAtHigh,lookAtLow,W,X,Y,b);bool d=a>0.;bool e=c.x<L.x;bool f=d^^e;if(d==e){b=f?N(rightPolylineRatios[0],rightPolylineAngles[0],Q):N(leftPolylineRatios[0],leftPolylineAngles[0],Q);c=H(viewProjMatrix,lookAtHigh,lookAtLow,W,X,Y,b);}float g=abs(a);for(int U=1;U<=E;U++){vec2 h=c-L;bool i=U==E||T(f?rightPolylineRatios:leftPolylineRatios,U)<G;float j=i?F:length(h);if(j>g){float k=a>0.?1.:-1.;vec2 l=normalize(h);vec2 m=vec2(-l.y,l.x);L+=l*g;L+=k*l*Z.x;L+=k*m*Z.y;break;}else{g-=j;L+=h;vec2 n=f?N(T(rightPolylineRatios,U),T(rightPolylineAngles,U),Q):N(T(leftPolylineRatios,U),T(leftPolylineAngles,U),Q);c=H(viewProjMatrix,lookAtHigh,lookAtLow,W,X,Y,n);}}return vec4(L*W,0.,1.);}const vec4 o=vec4(0,0,0,0);const vec2 p=vec2(0,0);const float q=255./256.;const float r=0.05;const float s=0.15;const float t=0.02;bool u(vec2 v,vec2 idHalfPxSize,sampler2D overlap,sampler2D scene){vec2 w=texture2D(overlap,v).rg;return w!=p&&texture2D(scene,w*q+idHalfPxSize)!=o;}float x(vec2 id,vec2 idHalfPxSize,sampler2D visibility,sampler2D overlap,sampler2D scene,float currentZoom,float currentTilt,float currentAzimuth){vec2 v=id/256.+idHalfPxSize;vec4 y=texture2D(visibility,v);float z=y.b;float AA=y.r;float AB=y.g;float AC=z-currentZoom;float AD=abs(AA-currentTilt);float AE=abs(AB-currentAzimuth);if((AC>r||(abs(AC)<=r&&AD<s&&AE<t))&&u(v,idHalfPxSize,overlap,scene)){return-1.;}return y.a;}void main(void){float AF=x(vertexId.xy,idHalfPxSize,visibility,overlap,scene,currentZoom,currentTilt,currentAzimuth);if(AF<0.){gl_Position=A;}else{vec2 AG=vertexDisplacements.xy;float AH=vertexDisplacements.z;float Q=polylineLength_vertexScale[0];gl_Position=V(viewProjMatrix,lookAtHigh,lookAtLow,pixelSize,vertexPosHigh,vertexPosLow,AG,AH,Q,leftPolylineRatios,leftPolylineAngles,rightPolylineRatios,rightPolylineAngles);gl_Position.xy+=shift;gl_Position.z=vertexPriority;id=vec4(vertexId.xy/255.,0,AF);}}"},function(t,e){t.exports="#version 100\nattribute vec2 vertexPosHigh;attribute vec2 vertexPosLow;attribute vec2 vertexDisplacement;attribute vec2 vertexOffset;attribute vec4 vertexId;attribute float vertexPriority;uniform vec2 lookAtHigh;uniform vec2 lookAtLow;uniform mat4 viewProjMatrix;uniform vec2 pixelSize;uniform vec2 shift;uniform sampler2D visibility;uniform sampler2D overlap;uniform sampler2D scene;uniform vec2 idHalfPxSize;uniform lowp float currentZoom;uniform lowp float currentTilt;uniform lowp float currentAzimuth;varying vec4 id;const float A=pow(2.,16.);const float B=pow(2.,-30.);const float C=32.;const vec4 D=vec4(2,2,2,1);const vec4 E=vec4(0,0,0,0);const vec2 F=vec2(0,0);const float G=255./256.;const float H=0.05;const float I=0.15;const float J=0.02;bool K(vec2 L,vec2 idHalfPxSize,sampler2D overlap,sampler2D scene){vec2 M=texture2D(overlap,L).rg;return M!=F&&texture2D(scene,M*G+idHalfPxSize)!=E;}float N(vec2 id,vec2 idHalfPxSize,sampler2D visibility,sampler2D overlap,sampler2D scene,float currentZoom,float currentTilt,float currentAzimuth){vec2 L=id/256.+idHalfPxSize;vec4 O=texture2D(visibility,L);float P=O.b;float Q=O.r;float R=O.g;float S=P-currentZoom;float T=abs(Q-currentTilt);float U=abs(R-currentAzimuth);if((S>H||(abs(S)<=H&&T<I&&U<J))&&K(L,idHalfPxSize,overlap,scene)){return-1.;}return O.a;}void main(){float V=N(vertexId.xy,idHalfPxSize,visibility,overlap,scene,currentZoom,currentTilt,currentAzimuth);if(V<0.){gl_Position=D;}else{vec4 W=viewProjMatrix*vec4((A*(vertexPosHigh-lookAtHigh)+(vertexPosLow-lookAtLow))*B,0,1);vec2 X=(vertexDisplacement+vertexOffset)/C;gl_Position=vec4(W.xy/W.w+X*pixelSize,vertexPriority,1.);gl_Position.xy+=shift;id=vec4(vertexId.xy/255.,0,V);}}"},function(t,e,i){"use strict";var r=window.URL||window.webkitURL;t.exports=function(t,e){try{try{var i;try{(i=new(window.BlobBuilder||window.WebKitBlobBuilder||window.MozBlobBuilder||window.MSBlobBuilder)).append(t),i=i.getBlob()}catch(s){i=new Blob([t])}return new Worker(r.createObjectURL(i))}catch(s){return new Worker("data:application/javascript,"+encodeURIComponent(t))}}catch(s){if(!e)throw Error("Inline worker is not supported");return new Worker(e)}}},function(t,e,i){"use strict";i.r(e);var r={};i.r(r),i.d(r,"createContentProvider",(function(){return Oc})),i.d(r,"Engine",(function(){return sn})),i.d(r,"Camera",(function(){return on})),i.d(r,"Context",(function(){return An})),i.d(r,"EventTrigger",(function(){return s})),i.d(r,"YMapContentProvider",(function(){return hr})),i.d(r,"VectorMapContentProvider",(function(){return Oe})),i.d(r,"IndoorContentProvider",(function(){return Ge})),i.d(r,"VECTOR_METADATA_PREFIX",(function(){return me})),i.d(r,"IndoorPlan",(function(){return Le})),i.d(r,"CoveredByIndoorFilter",(function(){return Xe})),i.d(r,"GraphicsContentProvider",(function(){return li})),i.d(r,"Tile3DContentProvider",(function(){return Ji})),i.d(r,"Cesium3DTile",(function(){return go})),i.d(r,"Cesium3DTileSet",(function(){return yo})),i.d(r,"BackgroundRenderUnit",(function(){return Po})),i.d(r,"BackgroundColor",(function(){return So})),i.d(r,"LayerRenderUnit",(function(){return Mo})),i.d(r,"FxaaRenderUnit",(function(){return Lo})),i.d(r,"BuildingsRenderUnit",(function(){return No})),i.d(r,"GlTFPrimitiveRenderUnit",(function(){return Yo})),i.d(r,"createColorTransform",(function(){return He})),i.d(r,"ModelsAnimationManager",(function(){return Qo})),i.d(r,"GraphicsRenderUnit",(function(){return ia})),i.d(r,"ContentPortionPrimitiveProvider",(function(){return ra})),i.d(r,"GraphicsScenePrimitiveProvider",(function(){return sa})),i.d(r,"PolylineRenderUnit",(function(){return ga})),i.d(r,"PointLabelRenderUnit",(function(){return Ra})),i.d(r,"IconRenderUnit",(function(){return Na})),i.d(r,"TransparentPolygonRenderUnit",(function(){return tc})),i.d(r,"PolygonRenderUnit",(function(){return $a})),i.d(r,"ModelRenderUnit",(function(){return hc})),i.d(r,"CurvedLabelRenderUnit",(function(){return _c})),i.d(r,"DebugFakePrimitiveRenderUnit",(function(){return mc})),i.d(r,"ColorIdPointLabelRenderer",(function(){return bc})),i.d(r,"LabelResetRemovedRenderer",(function(){return wc})),i.d(r,"ColorIdCurvedLabelRenderer",(function(){return Rc})),i.d(r,"ColorIdIconRenderer",(function(){return zc})),i.d(r,"CollidingPrimitiveColorIdRenderer",(function(){return Ws})),i.d(r,"CollidingPrimitivesResetRemovedRenderer",(function(){return Js}));class s{constructor(){this._listeners=new Map}addListener(t,e){this._listeners.set(t,e)}removeListener(t){this._listeners.delete(t)}fire(...t){for(const[e,i]of this._listeners)e.call(i,...t)}}class n{constructor(t){this._rootCommunicator=t,this._listeners={},this._rootCommunicator.onMessage.addListener(this._onMessage,this)}destructor(){this._rootCommunicator.onMessage.removeListener(this._onMessage)}getCommunicator(t){let e=this._listeners[t];return e||(e=new s,this._listeners[t]=e),{onMessage:e,sendMessage:(e,i,...r)=>{this._rootCommunicator.sendMessage({type:t,message:e},i,...r)}}}_onMessage(t){const e=this._listeners[t.type];e&&e.fire(t.message)}}function o(t,e="something that is supposed to be defined is undefined"){if(void 0===t)throw new Error(e);return void 0!==t}function a(t,e,i,r){const s=[];for(const n of e){const e=t.getPage(n.location.bufferId);if(o(e)){const{location:t,id:o}=n,a=void 0!==o?null==r?void 0:r.get(o):void 0;s.push(new i(e.vao,t,o,a))}}return s}function*c(t){for(const e in t)yield Number(e)}class h{constructor(t,e,i,r){this.id=i,this.vao=t,this.location=e,this.metadata=r}}class l extends h{constructor(t,e,i,r,s){super(t,e,r,s),this.texture=i}}class d extends l{constructor(t,e,i,r,s){super(t,e,i,r,s)}}function u(t,e,i,r){const s=[];for(const n of i){const i=t.getPage(n.location.bufferId),a=e.getAtlas(n.atlasId);if(o(i)&&o(a)){const{location:t,id:e}=n,o=void 0!==e?null==r?void 0:r.get(e):void 0;s.push(new d(i.vao,t,a.texture,e,o))}}return s}class f extends l{constructor(t,e,i,r,s,n){super(t.vao,e,i,s,n),this.page=t,this.minZoom=r}}function _(t,e,i,r,s){const n=[];for(const a of i){const i=t.getPage(a.location.bufferId),c=e.getAtlas(a.atlasId);if(o(i)&&o(c)){const{location:t,id:e}=a,o=void 0!==e?null==s?void 0:s.get(e):void 0;n.push(new f(i,t,c.texture,r,e,o))}}return n}class p extends l{constructor(t,e,i,r,s,n,o){super(t,e,i,n,o),this.zIndex=r,this.minZoom=s}}function m(t,e,i,r,s){const n=[];for(const a of i){const i=t.getPage(a.location.bufferId),c=e.getAtlas(a.atlasId);if(o(i)&&o(c)){const{location:t,zIndex:e,id:o}=a,h=void 0!==o?null==s?void 0:s.get(o):void 0;n.push(new p(i.vao,t,c.texture,e,r,o,h))}}return n}class g extends h{constructor(t,e,i,r){super(t,e,i,r)}}class y{constructor(t,e,i,r){this._registry=t,this._glyphAtlasRegistry=e,this._iconAtlasRegistry=i,this._additionalMetadata=r}destructor(){}_instantiatePrimitives(t,e){const i={primitives:{},references:[]};t.metadata&&(i.metadata=t.metadata,this._applyAdditionalMetadata(t.metadata)),t.references&&(i.references=i.references||[],i.references.push(...t.references));for(const r of c(t.primitives))switch(r){case 0:case 1:case 3:i.primitives[r]=a(this._registry,t.primitives[r],g,t.metadata);break;case 4:i.primitives[r]=u(this._registry,this._iconAtlasRegistry,t.primitives[r],t.metadata);break;case 5:case 6:{const s=Math.max(e-2,0);i.primitives[r]=_(this._registry,this._glyphAtlasRegistry,t.primitives[r],s,t.metadata);break}case 7:{const s=Math.max(e-1,0);i.primitives[r]=m(this._registry,this._iconAtlasRegistry,t.primitives[r],s,t.metadata);break}}return i}_applyAdditionalMetadata(t){if(t&&this._additionalMetadata)for(const e of t.values())for(const[t,i]of this._additionalMetadata)e.set(t,i)}}class v extends y{constructor(t,e,i,r,n,o,a,c){super(r,n,o,c),this._communicator=t,this._options=a,this._storage=e,this._modelStorage=i,this._onTileContentAdded=this.onTileContentAdded=new s,this._communicator.onMessage.addListener(this._onMessage,this),this._communicator.sendMessage({type:0,options:this._options},!1),this._options.customizationConfig&&this._options.customizationConfig.length&&this._updateCustomizationConfig()}destructor(){this._communicator.onMessage.removeListener(this._onMessage),super.destructor()}updateOption(t,e){this._options[t]=e,this._communicator.sendMessage({type:0,options:this._options},!1)}updateCustomizationConfig(t){this._options.customizationConfig=t,this._updateCustomizationConfig()}_onMessage(t){switch(t.type){case 3:this._onAddPrimitives(t);break;case 5:this._onAddModelPrimitives(t);break;case 4:this._onRemovePrimitives(t)}}_onAddPrimitives(t){const e=this._storage.get(t.tileId);if(o(e)){const i=this._instantiatePrimitives(t.content,e.tile.zoom);e.addContent(i),this._onTileContentAdded.fire(e,i,t.metrics)}}_onRemovePrimitives(t){const e=this._storage.get(t.tileId);if(o(e)){const n={primitives:{},references:[]};for(const o of t.content){const t=e.content.primitives[o];i=n.primitives,r=o,s=t&&[...t],i[r]=s}e.removeContent(n)}var i,r,s}_onAddModelPrimitives(t){const e=this._modelStorage.get(t.modelId),i=t.content.primitives[3],r=t.content.metadata;if(o(e)&&o(i)){const s=a(this._registry,i,g,t.content.metadata);this._applyAdditionalMetadata(r),e.addContent({primitives:{3:s},metadata:r})}}_updateCustomizationConfig(){this._communicator.sendMessage({type:2,customizationConfig:this._options.customizationConfig},!1)}}function b(t,e){return t.x+"_"+t.y+"_"+t.zoom+"_"+e}function x(t,e){return Object.assign(Object.assign({},t),{id:b(t,e)})}function w(t,e){const i=[];for(const[r,s]of t)e.has(r)||i.push(s);return i}function A(t,e,i){let r=t.get(e);return r||(r=i(),t.set(e,r)),r}new Array;const T={x:0,y:0,zoom:0};function S(t,e,i){return{x:t,y:e,z:i}}function P(t,e,i,r){return r.x=t,r.y=e,r.z=i,r}new Array(9);const R=S(0,0,0),M=(S(1,0,0),S(-1,0,0),S(0,1,0)),C=(S(0,-1,0),S(0,0,1));function z(t,e=S(0,0,0)){return e.x=t.x,e.y=t.y,e.z=t.z,e}function O(t,e,i=S(0,0,0)){return i.x=t.x+e.x,i.y=t.y+e.y,i.z=t.z+e.z,i}function L(t,e,i=S(0,0,0)){return i.x=t.x*e.x,i.y=t.y*e.y,i.z=t.z*e.z,i}function k(t,e,i=S(0,0,0)){return i.x=t.x*e,i.y=t.y*e,i.z=t.z*e,i}function I(t,e=S(0,0,0)){return function(t,e,i=S(0,0,0)){return i.x=t.x/e,i.y=t.y/e,i.z=t.z/e,i}(t,function(t){return Math.hypot(t.x,t.y,t.z)}(t),e)}function E(t,e){return t.x*e.x+t.y*e.y+t.z*e.z}function B(t,e,i=S(0,0,0)){const r=t.y*e.z-t.z*e.y,s=t.z*e.x-t.x*e.z,n=t.x*e.y-t.y*e.x;return i.x=r,i.y=s,i.z=n,i}function U(t,e,i=S(0,0,0)){const r=Math.cos(e),s=Math.sin(e),n=t.y;return i.x=t.x,i.y=n*r-t.z*s,i.z=n*s+t.z*r,i}function D(t,e,i=S(0,0,0)){const r=Math.cos(e),s=Math.sin(e);return t=t===i?z(t):t,i.x=t.x*r-t.y*s,i.y=t.x*s+t.y*r,i.z=t.z,i}S(0,0,-1);const j={normal:C,distance:0};function V(t,e,i=S(0,0,0)){const r=E(e.direction,t.normal);if(0===r)return null;const s=(t.distance-E(t.normal,e.origin))/r;return s<0?null:(z(e.direction,i),k(i,s,i),O(i,e.origin,i),i)}function F(t){let e,i;return function(r){return e===r&&void 0!==e||(e=r,i=t(r)),i}}function N(t){return Math.min(t.zoom,19)}function q(t){return t.zoom<=19?t.fov:H(W(t.zoom)*G(t.fov))}const H=F(t=>2*Math.atan(t)),W=F(t=>Math.pow(2,-(t-19))),G=F(t=>Math.tan(.5*t));function X(t,e,i){return t*Z(i)*K(e)*Y}const Y=1/256,Z=F(t=>Math.pow(2,-t)),K=F(t=>1/Math.tan(.5*t));function Q(t,e,i,r){return z($(t,e,i),r),r}const $=function(t){let e,i;return function(...t){let r=void 0===e;if(r||(r=e.length!==t.length),!r)for(let i=0;i<t.length;++i)if(e[i]!==t[i]){r=!0;break}return r&&(e=t,i=((t,e,i)=>{const r=k(C,t,J);return U(r,i,r),D(r,e,r),r})(...t)),i}}(),J=S(0,0,0),tt=Math.PI/180;function et(t){return t*tt}function it(t,e,i){const r=e/2;return!i||t<=r?t:Math.max(t-rt,r)}const rt=et(20);function st(t,e="key_"+Math.random().toFixed(10)){const i=Symbol(e);return function(e){let r=e[i];return r||(r={cameraUpdateVersion:e.updateVersion,data:t(e)},e[i]=r),r.cameraUpdateVersion<e.updateVersion&&(r.data=t(e,r.data),r.cameraUpdateVersion=e.updateVersion),r.data}}const nt=st((t,e={origin:S(0,0,0),planes:[{normal:S(0,0,0),distance:0},{normal:S(0,0,0),distance:0},{normal:S(0,0,0),distance:0},{normal:S(0,0,0),distance:0}],edges:[S(0,0,0),S(0,0,0),S(0,0,0),S(0,0,0)]})=>{const{origin:i,planes:r,edges:s}=e,{screenSize:n,fov:o,azimuth:a,tilt:c,aspectRatio:h}=t,l=q(t),d=N(t),u=Q(X(n.height,o,d),a,c,ht);P(t.center.x,t.center.y,0,i),O(i,u,i);const f=ct(l),_=S(f*h,f,1);for(let p=0;p<4;++p){const t=s[p];L(at[p],_,t),U(t,it(c,o,-1===at[p].y),t),D(t,a,t)}return ot(s[0],s[3],i,r[0]),ot(s[1],s[0],i,r[1]),ot(s[2],s[1],i,r[2]),ot(s[3],s[2],i,r[3]),e});function ot(t,e,i,r){B(t,e,r.normal),I(r.normal,r.normal),r.distance=-E(r.normal,i)}const at=[S(-1,1,-1),S(1,1,-1),S(1,-1,-1),S(-1,-1,-1)],ct=F(t=>Math.tan(.5*t)),ht=S(0,0,0),lt=st((t,e=[S(0,0,0),S(0,0,0),S(0,0,0),S(0,0,0)])=>{const i=nt(t),r=dt;z(i.origin,r.origin);for(let s=0;s<e.length;++s)if(z(i.edges[s],r.direction),!V(j,r,e[s]))throw new Error("Visible quadrilateral is unbounded, engine can't handle that case (yet)");return e}),dt={origin:S(0,0,0),direction:S(0,0,0)};function ut(t,e){return{x:t,y:e}}const ft=ut(0,0);function _t(t,e=ut(0,0)){return e.x=t.x,e.y=t.y,e}function pt(t,e,i=ut(0,0)){return i.x=t.x+e.x,i.y=t.y+e.y,i}function mt(t,e,i=ut(0,0)){return i.x=t.x*e,i.y=t.y*e,i}function gt(t,e,i=ut(0,0)){return i.x=e(t.x),i.y=e(t.y),i}ut(1,0),ut(-1,0),ut(0,1),ut(0,-1);const yt={minX:0,maxX:0,minY:0,maxY:0};function vt(t,e={minX:0,maxX:0,minY:0,maxY:0}){if(0===t.length)return e;e.minX=e.maxX=t[0].x,e.minY=e.maxY=t[0].y;for(let i=1;i<t.length;++i){const{x:r,y:s}=t[i];r<e.minX&&(e.minX=r),r>e.maxX&&(e.maxX=r),s<e.minY&&(e.minY=s),s>e.maxY&&(e.maxY=s)}return e}const bt=st((t,e=Object.assign({},yt))=>vt(lt(t),e));class xt{constructor(t,e,i=.5,r=1/0){this._camera=t,this._zoomShift=function(t){switch(t){case 1:return-1;case 2:return-2;default:return 0}}(e),this._targetZoomShift=i,this._maxZoomWithTilesLoading=r}recalculateVisibleTiles(){const t=this._camera,e=Math.min(this._getTargetZoom(),this._maxZoomWithTilesLoading);return function*(t,e,i,r,s){if(0===s)return void(yield T);const n=1<<s,o=n-1,{minX:a,maxX:c,minY:h,maxY:l}=e,d=Math.floor((a+1)*n/2),u=Math.floor((c+1)*n/2),f=u-d+1,_=new Array(f),p=new Array(f);_.fill(Math.floor((1-h)*n/2)),p.fill(Math.floor((1-l)*n/2));const m=t.length;let g=t[m-1].x+1,y=1-t[m-1].y,v=Math.floor(g*n/2),b=Math.floor(y*n/2);for(let x=0;x<m;++x){const e=t[x].x+1,i=1-t[x].y,r=Math.floor(e*n/2),s=Math.floor(i*n/2),o=Math.abs(r-v)+Math.abs(s-b),a=e-g,c=i-y,h=a>0?1:-1,l=c>0?1:-1,u=2*h*c,f=-2*h*a,m=h*n*(a*y-c*g)+u*(~h>>>31);for(let t=0,n=v,g=b;t<o;++t){const t=u*n+f*g+m;0<=t&&t<=-f?n+=h:g+=l;const e=n-d;p[e]<g&&(p[e]=g),_[e]>g&&(_[e]=g)}g=e,y=i,v=r,b=s}if(2===i&&f>n)for(let x=0;x<n;++x)for(let t=x+n;t<f;t+=n)p[x]<p[t]&&(p[x]=p[t]),_[x]>_[t]&&(_[x]=_[t]);if(2===r)for(let x=0;x<f&&x<n;++x){const t=p[x]-_[x];if(t>n)_[x]=0,p[x]=o;else{const e=_[x]&=o;p[x]=e+t}}else for(let x=0;x<f&&x<n;++x)_[x]=Math.max(_[x],0),p[x]=Math.min(p[x],o);if(2===i)for(let x=0;x<f&&x<n;++x){const t=x+d&o;for(let e=_[x];e<=p[x];++e)yield{x:t,y:e&o,zoom:s}}else for(let x=Math.max(d,0),w=Math.min(u,o);x<=w;++x){const t=x-d;for(let e=_[t];e<=p[t];++e)yield{x:x,y:e&o,zoom:s}}}(lt(t),bt(t),t.options.wrapModeX,t.options.wrapModeY,Math.max(0,e+this._zoomShift))}_getTargetZoom(){return Math.floor(this._camera.zoom+this._targetZoomShift)}}class wt{constructor(t,e,i,r=new xt(e,i.tileSize,i.targetZoomShift,i.maxZoomWithTilesLoading),n=""){this._camera=e,this._communicator=t,this._options=i,this._visibleTilesCalculator=r,this._tileIdPrefix=n,this._visibleTiles=new Map,this.onViewportChanged=this._onViewportChanged=new s,this._onCameraUpdateWrapper=this._onCameraUpdate.bind(this),this._camera.onUpdate.addListener(this._onCameraUpdateWrapper),this._syncOptions()}get visibleTiles(){return this._visibleTiles.values()}set tileIdPrefix(t){this._tileIdPrefix=t,this._syncOptions()}destructor(){this.pause(),this._camera.onUpdate.removeListener(this._onCameraUpdateWrapper)}forceCameraStateRecalculation(){this._onCameraUpdate()}pause(){this._camera.onUpdate.removeListener(this._onCameraUpdateWrapper),this._fireUpdates([],[...this._visibleTiles.values()]),this._visibleTiles.clear()}resume(){this._camera.onUpdate.addListener(this._onCameraUpdateWrapper,this),this.forceCameraStateRecalculation()}_onCameraUpdate(){const t=new Map;for(const s of this._visibleTilesCalculator.recalculateVisibleTiles()){const e=x(s,this._tileIdPrefix);t.set(e.id,e)}const e=this._visibleTiles;this._visibleTiles=t;const i=w(t,e),r=w(e,t);(i.length>0||r.length>0)&&this._fireUpdates(i,r)}_syncOptions(){var t;this._communicator.sendMessage({type:0,tileIdPrefix:this._tileIdPrefix,preloadedTilesBeltWidth:this._options.preloadedTilesBeltWidth,useLowPrecisionBeltTiles:null===(t=this._options.useLowPrecisionBeltTiles)||void 0===t||t,wrapModeX:this._camera.options.wrapModeX,wrapModeY:this._camera.options.wrapModeY},!1)}_fireUpdates(t,e){this._onViewportChanged.fire({visibleAdded:t,visibleRemoved:e}),this._communicator.sendMessage({type:1,cameraPosition:{x:this._camera.center.x,y:this._camera.center.y,zoom:this._camera.zoom},visibleTilesToAdd:t,visibleTilesToRemove:e},!0)}}class At extends class{constructor(){this._items=new Map,this.onAdded=this._onAdded=new s,this.onRemoved=this._onRemoved=new s}get size(){return this._items.size}get items(){return this._items.values()}get(t){return this._items.get(t)}has(t){return this._items.has(t)}_add(t,e){this._items.set(t,e),this._onAdded.fire(e)}_remove(t){const e=this._items.get(t);e&&(this._items.delete(t),this._onRemoved.fire(e))}}{constructor(t){super(),this._communicator=t,this._communicator.onMessage.addListener(this._onMessage,this)}destructor(){this._communicator.onMessage.removeListener(this._onMessage)}_onMessage(t){switch(t.type){case 0:this._onAdd(t);break;case 1:this._onRemove(t)}}_onAdd(t){this._add(t.id,this._deserialize(t.item))}_onRemove(t){this._remove(t.id)}}function Tt(t,e){return t>e?1:t<e?-1:0}function St(t,e,i){const r=t[e];t[e]=t[i],t[i]=r}function Pt(t,e,i=0,r=t.length,s=0){for(let n=i,o=s;n<r;++n,++o)e[o]=t[n]}function Rt(t,e=Tt,i=0,r=t.length){for(let s=i;s<r;++s)for(let r=s;r>i&&e(t[r-1],t[r])>0;--r)St(t,r-1,r)}function Mt(t,e,i,r,s,n,o){let a=o,c=r,h=s;for(;c<s&&h<n;)e[a++]=i(t[c],t[h])>0?t[h++]:t[c++];Pt(t,e,c,s,a),Pt(t,e,h,n,a)}function Ct(t,e){let i=0;for(let r=0;r<t.length;r++)e.has(t[r])||(t[i]=t[r],i++);t.length=i}class zt{constructor(t){this.content=this._content=t,this.onContentAdded=this._onContentAdded=new s,this.onContentRemoved=this._onContentRemoved=new s}addContent(t){for(const e of c(t.primitives))this._content.primitives[e]||(this._content.primitives[e]=[]),this._content.primitives[e].push(...t.primitives[e]);if(t.references&&(this._content.references=this._content.references||[],this._content.references.push(...t.references)),t.metadata){this._content.metadata=this._content.metadata||new Map;for(const[e,i]of t.metadata)this._content.metadata.set(e,i)}this._onContentAdded.fire(this,t)}removeContent(t){for(const e of c(t.primitives)){const i=this._content.primitives[e];i&&Ct(i,new Set(t.primitives[e]))}if(t.references&&this._content.references){const e=new Set(t.references);Ct(this._content.references,e)}if(t.metadata&&this._content.metadata)for(const e of t.metadata.keys())this._content.metadata.delete(e);this._onContentRemoved.fire(this,t)}}class Ot extends zt{constructor(t){super({primitives:{},references:[]}),this.id=t.id,this.tile=t}}class Lt extends At{_deserialize(t){return new Ot(t)}}class kt{constructor(t,e,i,r){this._context=t,this.layout=e,this.vertexBuffer=this._context.createVertexBuffer(i),this.indexBuffer=this._context.createIndexBuffer(r),this.vao=this._context.createVao([{attributeMapping:e,buffer:this.vertexBuffer}],this.indexBuffer)}destructor(){this.vertexBuffer.destroy(),this.indexBuffer.destroy(),this.vao.destroy()}updateVertexContent(t,e){this._context.bindVao(null),this._context.uploadDataToBuffer(this.vertexBuffer,t,e)}updateIndexContent(t,e){this._context.bindVao(null),this._context.uploadDataToBuffer(this.indexBuffer,t,e)}}var It;!function(t){t[t.FROM_BACKEND_ADD_PAGE=0]="FROM_BACKEND_ADD_PAGE",t[t.FROM_BACKEND_UPDATE_PAGE=1]="FROM_BACKEND_UPDATE_PAGE",t[t.FROM_BACKEND_REMOVE_PAGE=2]="FROM_BACKEND_REMOVE_PAGE"}(It||(It={}));class Et{constructor(t,e){this._communicator=t,this._context=e,this._pages=new Map,this.memoryUsage=this._memoryUsage={memoryForBuffers:0,memoryForVertices:0,memoryForIndices:0},this.onMemoryUsageChanged=this._onMemoryUsageChanged=new s,this._communicator.onMessage.addListener(this._onMessage,this)}destructor(){this._communicator.onMessage.removeListener(this._onMessage)}getPage(t){return this._pages.get(t)}_onMessage(t){switch(t.type){case It.FROM_BACKEND_ADD_PAGE:this._onPageAdd(t);break;case It.FROM_BACKEND_UPDATE_PAGE:this._onPageUpdate(t);break;case It.FROM_BACKEND_REMOVE_PAGE:this._onPageRemove(t)}}_onPageAdd(t){this._pages.set(t.id,new kt(this._context,t.attribMapping,t.vertexDataByteSize,t.indexDataByteSize))}_onPageUpdate(t){const e=this.getPage(t.id);o(e)&&(e.updateVertexContent(t.vertexData,t.vertexByteOffset),e.updateIndexContent(t.indexData,t.indexByteOffset))}_onPageRemove(t){const e=this._pages.get(t.id);o(e)&&(this._pages.delete(t.id),e.destructor())}}function*Bt(t,e){for(const i of t)yield e(i)}function*Ut(t,e){for(const i of t)e(i)&&(yield i)}function Dt(t,e){for(const i of t)if(!e(i))return!1;return!0}function jt(t,e){let i=0;for(const r of t)e&&!e(r)||i++;return i}function Vt(t){let e="";for(let i=t.zoom;i>0;i--){let r="0";const s=1<<i-1;0!=(t.x&s)&&(r="1"),0!=(t.y&s)&&(r="1"===r?"3":"2"),e+=r}return e}function Ft(t,e,i){return e<t?t<i?t:i:e}function Nt(t,e,i){const r=(t-e)/(i-e);return e+(i-e)*(r-Math.floor(r))}function qt(t,e){const i=e.zoom-t.zoom;return i>0&&e.x>>i===t.x&&e.y>>i===t.y}const Ht=Date.now(),Wt="performance"in self&&"now"in performance?performance.now.bind(performance):function(){return Date.now()-Ht};class Gt{constructor(){this._marks=new Map}mark(t){this._marks.set(t,Wt())}unmark(t){this._marks.delete(t)}measure(t,e=!1){const i=this._marks.get(t);return void 0!==i?(e||this.unmark(t),Wt()-i):Gt.UNMEASURED}}Gt.UNMEASURED=-1;const Xt={postfix:"",reduce:t=>t[0]},Yt={postfix:"Avg",reduce:t=>t.reduce((t,e)=>t+e,0)/t.length};class Zt{constructor(t,e,i=1,r=[Xt],s){this._transport=t,this._name=e,this._maxItems=i,this._reducers=r,this._additionalParams=s,this._values={},this._marker=new Gt}mark(t){this._marker.mark(t)}unmark(t){this._marker.unmark(t)}putMeasuredValue(t,e=t,i){const r=this._marker.measure(t,i);r!==Gt.UNMEASURED&&this.putValue(e,r)}putValue(t,e){let i=this._values[t];i||(i=this._values[t]=[]),i.length<this._maxItems&&i.push(e)}putValues(t){for(const e of Object.keys(t)){const i=e,r=t[i];void 0!==r&&this.putValue(i,r)}}submit(){this._transport.submit(this._name,this._getReducedValues())}_getReducedValues(){const t=Object.assign({},this._additionalParams);for(const e of Object.keys(this._values)){const i=e,r=this._values[i];if(r&&r.length>0){r.sort((t,e)=>t-e);for(const e of this._reducers)t[i+e.postfix]=e.reduce(r).toFixed(2)}}return t}}function Kt(t){return!(!t.content.primitives[0]&&!t.content.primitives[1]||!t.content.primitives[5]&&!t.content.primitives[6])}var Qt,$t,Jt;!function(t){t[t.FULL=0]="FULL",t[t.IMMEDIATE=1]="IMMEDIATE"}(Qt||(Qt={}));class te{constructor(t,e,i,r,n,o,a=Kt){this._viewport=t,this._storage=e,this._tileContentVisibilityManager=i,this._modelVisibilityManager=r,this._isTileVisualizable=a,this._allTileNodes=new Map,this._visualizableTileNodeByQuadKey=new Map,this._visibleTileNodes=new Map,this._visualizedTileNodes=new Map,this._mode=Qt.FULL,this.onViewportStateChanged=this._onViewportStateChanged=new s,this.viewportState=this._viewportState={visibleTileNumber:0,visualizableTileNumber:0},this._viewport.onViewportChanged.addListener(this._onViewportUpdate,this),this._storage.onAdded.addListener(this._onTileAdd,this),this._storage.onRemoved.addListener(this._onTileRemove,this),this._metrics=new Zt(n,"vector."+o+".viewport",1024,[Yt])}submitMetrics(){this._metrics.submit()}destructor(){this._viewport.onViewportChanged.removeListener(this._onViewportUpdate),this._storage.onAdded.removeListener(this._onTileAdd),this._storage.onRemoved.removeListener(this._onTileRemove),clearTimeout(this._changeModeTimer)}_onTileAdd(t){const e=this._isTileVisualizable(t),i=this._getTileNode(t.tile);i.tile=t,i.isVisualizable=e,e&&this._visualizableTileNodeByQuadKey.set(i.quadKey,i),i.isVisible&&i.isVisualizable&&!i.isVisualized&&this._tryToVisualizeViewport(),t.onContentAdded.addListener(this._onTileContentAdded,this)}_onTileContentAdded(t){const e=this._getTileNode(t.tile);e.isVisualizable=e.isVisualizable||this._isTileVisualizable(t),e.isVisualizable&&this._visualizableTileNodeByQuadKey.set(e.quadKey,e),e.isVisible&&e.isVisualizable&&this._tryToVisualizeViewport()}_onTileRemove(t){const e=this._getTileNode(t.tile);e.isVisible||(this._allTileNodes.delete(e.tileItem.id),this._visualizableTileNodeByQuadKey.delete(e.quadKey)),e.isVisualized&&this._makeNotVisualized(e),delete e.tile,t.onContentAdded.removeListener(this._onTileContentAdded)}_onViewportUpdate({visibleAdded:t,visibleRemoved:e}){for(const i of t){const t=this._getTileNode(i);this._makeVisible(t)}for(const i of e){const t=this._getTileNode(i);this._makeNotVisible(t)}if(t.length>0){const e=new Set,i=t[0].zoom;for(const t of this._visualizedTileNodes.values())e.add(t.tileItem.zoom);if(e.size<=2&&e.has(i+1))for(const t of this._visibleTileNodes.values())if(t.isVisualizable)this._makeVisualized(t);else for(let e=0;e<4;e++){const i=this._visualizableTileNodeByQuadKey.get(t.quadKey+e);i&&this._makeVisualized(i)}else if(e.size<=2&&e.has(i))for(const t of this._visibleTileNodes.values())if(t.isVisualizable)this._makeVisualized(t);else{const e=t.quadKey.slice(0,-1),i=this._visualizableTileNodeByQuadKey.get(e);if(i){let t=!0;for(let i=0;i<4;i++)this._visualizableTileNodeByQuadKey.get(e+i)&&(t=!1);t&&this._makeVisualized(i)}}}this._changeModeTimer||this._mode!==Qt.FULL||(this._changeModeTimer=setTimeout(()=>{this._mode=Qt.IMMEDIATE,this._tryToVisualizeViewport()},800)),this._tryToVisualizeViewport()}_tryToVisualizeViewport(){const t=this._visibleTileNodes.size;if(t===jt(this._visibleTileNodes.values(),t=>t.isVisualizable)){clearTimeout(this._changeModeTimer),this._changeModeTimer=0,this._mode=Qt.FULL;for(const t of this._visualizedTileNodes.values())t.isVisible||this._makeNotVisualized(t);for(const t of this._visibleTileNodes.values())this._makeVisualized(t)}else if(this._mode===Qt.IMMEDIATE)for(const i of this._visibleTileNodes.values())if(!i.isVisualized&&i.isVisualizable){let t=!1;for(const e of this._visualizedTileNodes.values())if(qt(i.tileItem,e.tileItem))this._makeNotVisualized(e);else if(qt(e.tileItem,i.tileItem)){const i=e,r=[];for(const t of this._visibleTileNodes.values())qt(i.tileItem,t.tileItem)&&r.push(t);Dt(r,t=>t.isVisualizable)?this._makeNotVisualized(i):t=!0}t||this._makeVisualized(i)}const e=jt(this._visibleTileNodes.values(),t=>t.isVisualized);t===this._viewportState.visibleTileNumber&&e===this._viewportState.visualizableTileNumber||(this._viewportState.visibleTileNumber=t,this._viewportState.visualizableTileNumber=e,this._onViewportStateChanged.fire(this._viewportState))}_makeVisible(t){t.isVisible||(t.isVisible=!0,this._visibleTileNodes.set(t.id,t),this._metrics.mark(t.id))}_makeNotVisible(t){t.isVisible&&(t.isVisible=!1,this._visibleTileNodes.delete(t.id),this._metrics.unmark(t.id))}_makeVisualized(t){const e=t.tile;t.isVisualizable&&!t.isVisualized&&e&&(this._tileContentVisibilityManager.showObject(e),this._modelVisibilityManager.showTileModels(e),t.isVisualized=!0,this._visualizedTileNodes.set(t.id,t),this._metrics.putMeasuredValue(t.id,"tileVisualizationReady"))}_makeNotVisualized(t){const e=t.tile;t.isVisualized&&e&&(this._tileContentVisibilityManager.hideObject(e),this._modelVisibilityManager.hideTileModels(e),t.isVisualized=!1,this._visualizedTileNodes.delete(t.id))}_getTileNode(t){const e=this._allTileNodes.get(t.id);if(e)return e;{const e={id:t.id,tileItem:t,quadKey:Vt(t),isVisualizable:!1,isVisible:!1,isVisualized:!1};return this._allTileNodes.set(t.id,e),e}}}function ee(){return devicePixelRatio>1?devicePixelRatio:1}function ie(t=0,e=0){return{width:t,height:e}}function re(t,e=ie()){return e.width=t.width,e.height=t.height,e}function se(t,e){return t.width===e.width&&t.height===e.height}!function(t){t[t.TO_BACKEND_SETUP=0]="TO_BACKEND_SETUP",t[t.FROM_BACKEND_ADD_ATLAS=1]="FROM_BACKEND_ADD_ATLAS",t[t.FROM_BACKEND_UPDATE_ATLAS=2]="FROM_BACKEND_UPDATE_ATLAS",t[t.FROM_BACKEND_REMOVE_ATLAS=3]="FROM_BACKEND_REMOVE_ATLAS"}($t||($t={}));class ne{constructor(t,e,i){this._context=t,this.texture=t.createEmpty2DTexture(e,i,6406,5121,{wrapS:33071,wrapT:33071,magnificationFilter:9729,minificationFilter:9729,premultipliedAlpha:!1,unpackAlignment:1}),"string"==typeof navigator.vendor&&navigator.vendor.match(/^Apple/)&&this.updateContent(ut(0,0),ie(1,1),new Uint8Array(1))}destructor(){this.texture.destroy()}updateContent(t,e,i){this._context.setTextureData(this.texture,i,t,e)}}class oe{constructor(t,e,i){this._communicator=t,this._context=i,this._atlases=[],this.memoryUsage=this._memoryUsage={memoryForGlyphs:0},this.onMemoryUsageChanged=this._onMemoryUsageChanged=new s,this._communicator.onMessage.addListener(this._onMessage,this),this._communicator.sendMessage({type:$t.TO_BACKEND_SETUP,options:e},!1)}destructor(){this._communicator.onMessage.removeListener(this._onMessage)}getAtlas(t){return this._atlases[t]}_onMessage(t){switch(t.type){case $t.FROM_BACKEND_ADD_ATLAS:this._onAtlasAdd(t);break;case $t.FROM_BACKEND_UPDATE_ATLAS:this._onAtlasUpdate(t);break;case $t.FROM_BACKEND_REMOVE_ATLAS:this._onAtlasRemove(t)}}_onAtlasAdd(t){this._atlases[t.atlasId]=new ne(this._context,t.width,t.height)}_onAtlasUpdate(t){const{atlasId:e,data:i,offset:r,size:s}=t,n=this._atlases[e];o(n)&&n.updateContent(r,s,i)}_onAtlasRemove(t){const e=this._atlases[t.atlasId];o(e)&&(e.destructor(),delete this._atlases[t.atlasId])}}!function(t){t[t.TO_BACKEND_SETUP=0]="TO_BACKEND_SETUP",t[t.FROM_BACKEND_ADD_ATLAS=1]="FROM_BACKEND_ADD_ATLAS",t[t.FROM_BACKEND_UPDATE_ATLAS=2]="FROM_BACKEND_UPDATE_ATLAS",t[t.FROM_BACKEND_REMOVE_ATLAS=3]="FROM_BACKEND_REMOVE_ATLAS"}(Jt||(Jt={}));class ae{constructor(t,e,i){this._context=t,this.texture=t.createEmpty2DTexture(e,i,6408,5121,{wrapS:33071,wrapT:33071,magnificationFilter:9728,minificationFilter:9728,premultipliedAlpha:!0,unpackAlignment:1}),this.onContentUpdated=this._onContentUpdated=new s}destructor(){this.texture.destroy()}updateContent(t){this._context.setTextureData(this.texture,t.data,t.offset,t.size),this._onContentUpdated.fire()}}Symbol.iterator,Symbol.iterator,Number.MAX_SAFE_INTEGER,Number.MIN_SAFE_INTEGER,Number.MAX_SAFE_INTEGER,Number.MIN_SAFE_INTEGER;class ce{constructor(t,e,i){this._communicator=t,this._context=i,this._options=e,this._atlases=[],this.memoryUsage=this._memoryUsage={memoryForIcons:0},this.onMemoryUsageChanged=this._onMemoryUsageChanged=new s,this._communicator.onMessage.addListener(this._onMessage,this),this._syncOptions()}destructor(){this._communicator.onMessage.removeListener(this._onMessage)}getAtlas(t){return this._atlases[t]}updateOption(t,e){this._options[t]=e,this._syncOptions()}_onMessage(t){switch(t.type){case Jt.FROM_BACKEND_ADD_ATLAS:this._onAddAtlas(t);break;case Jt.FROM_BACKEND_UPDATE_ATLAS:this._onUpdateAtlas(t);break;case Jt.FROM_BACKEND_REMOVE_ATLAS:this._onRemoveAtlas(t)}}_onAddAtlas(t){this._atlases[t.atlasId]=new ae(this._context,t.atlasWidth,t.atlasHeight)}_onUpdateAtlas(t){const e=this._atlases[t.atlasId];o(e)&&e.updateContent(t.atlasRegion)}_onRemoveAtlas(t){const e=this._atlases[t.atlasId];o(e)&&(e.destructor(),delete this._atlases[t.atlasId])}_syncOptions(){this._communicator.sendMessage({type:Jt.TO_BACKEND_SETUP,options:this._options},!1)}}class he extends zt{constructor(t){super({primitives:{}}),this.id=t}}class le extends At{_deserialize(t){return new he(t)}}class de{constructor(t,e){this._contentVisibilityManager=t,this._modelStorage=e,this._modelsToVisualizedTiles=new Map,this._modelStorage.onAdded.addListener(this._onModelAdded,this),this._modelStorage.onRemoved.addListener(this._onModelRemoved,this)}showTileModels(t){for(const e of t.content.references||[]){const i=A(this._modelsToVisualizedTiles,e,()=>new Set);0===i.size&&this._tryToGetAndShowModel(e),i.add(t)}}hideTileModels(t){for(const e of t.content.references||[]){const i=this._modelsToVisualizedTiles.get(e);i&&(i.delete(t),0===i.size&&(this._modelsToVisualizedTiles.delete(e),this._tryToGetAndHideModel(e)))}}_onModelAdded(t){this._modelsToVisualizedTiles.has(t.id)&&this._contentVisibilityManager.showObject(t)}_onModelRemoved(t){this._modelsToVisualizedTiles.has(t.id)&&this._contentVisibilityManager.hideObject(t)}_tryToGetAndShowModel(t){const e=this._modelStorage.get(t);e&&this._contentVisibilityManager.showObject(e)}_tryToGetAndHideModel(t){const e=this._modelStorage.get(t);e&&this._contentVisibilityManager.hideObject(e)}}class ue{constructor(t,e,i,r,s,n,o){this._storage=r,this._contentManager=s,this._viewport=n,this._tileReadyChecker=o,this._everVisibleTiles=new Set,this._measuringTiles=new Set;const a="vector."+e+".tile_processing";this._metrics=new fe(t,a,i,{visible:"1"}),r.onRemoved.addListener(this._onTileRemoved,this),s.onTileContentAdded.addListener(this._onTileContentAdded,this),n.onViewportChanged.addListener(this._onViewportChanged,this)}submit(){this._metrics.submit()}destructor(){this._storage.onRemoved.removeListener(this._onTileRemoved),this._contentManager.onTileContentAdded.removeListener(this._onTileContentAdded),this._viewport.onViewportChanged.removeListener(this._onViewportChanged)}_onTileRemoved(t){this._everVisibleTiles.delete(t.id)}_onTileContentAdded(t,e,i){if(this._measuringTiles.has(t.id)){this._metrics.putValues(t.id,i),this._tileReadyChecker(t)&&this._metrics.measure(t.id,"tileReady");const r=e.primitives;(r[0]||r[1])&&this._metrics.measure(t.id,"polygonsReady"),(r[6]||r[5])&&this._metrics.measure(t.id,"labelsReady"),e.primitives[7]&&this._metrics.measure(t.id,"iconsReady")}}_onViewportChanged(t){for(const e of t.visibleAdded)this._everVisibleTiles.has(e.id)||this._storage.get(e.id)||(this._everVisibleTiles.add(e.id),this._measuringTiles.add(e.id),this._metrics.addTilesToMeasure(e.id));for(const e of t.visibleRemoved)this._measuringTiles.delete(e.id)&&this._metrics.removeTileMeasurement(e.id)}}class fe{constructor(t,e,i,r){const s=[Yt];this._metrics=new Zt(t,e,1024,s,Object.assign({firstViewport:"0"},r)),this._firstViewportMetrics=new Zt(t,e,1024,s,Object.assign({firstViewport:"1"},r)),this._firstViewportTiles=new Set,this._isFirstViewport=!0,this._camera=i}addTilesToMeasure(t){this._firstViewportState||(this._firstViewportState={x:this._camera.center.x,y:this._camera.center.y,zoom:this._camera.zoom}),!this._isFirstViewport||this._firstViewportState.x==this._camera.center.x&&this._firstViewportState.y==this._camera.center.y&&this._firstViewportState.zoom==this._camera.zoom||(this._isFirstViewport=!1),this._isFirstViewport?(this._firstViewportTiles.add(t),this._firstViewportMetrics.mark(t)):this._metrics.mark(t)}measure(t,e){this._firstViewportTiles.size>0&&this._firstViewportTiles.has(t)?this._firstViewportMetrics.putMeasuredValue(t,e,!0):this._metrics.putMeasuredValue(t,e,!0)}removeTileMeasurement(t){this._firstViewportTiles.size>0&&this._firstViewportTiles.delete(t)?this._firstViewportMetrics.unmark(t):this._metrics.unmark(t)}putValues(t,e){this._firstViewportTiles.size>0&&this._firstViewportTiles.has(t)?this._firstViewportMetrics.putValues(e):this._metrics.putValues(e)}submit(){this._firstViewportMetrics.submit(),this._metrics.submit()}}class _e{constructor(t){this.onUpdate=this._onUpdate=new s,this._camera=t,this._onZoomUpdated=this._onZoomUpdated.bind(this),t.onUpdate.addListener(this._onZoomUpdated)}destructor(){this._camera.onUpdate.removeListener(this._onZoomUpdated)}test(t){return this._camera.zoom>=t.minZoom}_onZoomUpdated(){this._prevZoom!==this._camera.zoom&&(this._onUpdate.fire(),this._prevZoom=this._camera.zoom)}}class pe{constructor(t){this._storages=t,this._index=new Map;for(const e of this._storages){for(const t of e.items)this._onObjectAdded(t);e.onAdded.addListener(this._onObjectAdded,this),e.onRemoved.addListener(this._onObjectRemoved,this)}}destructor(){for(const t of this._storages){for(const e of t.items)this._onObjectRemoved(e);t.onAdded.removeListener(this._onObjectAdded),t.onRemoved.removeListener(this._onObjectRemoved)}}getMetadata(t){var e;return null===(e=this._index.get(t))||void 0===e?void 0:e.metadata}_onObjectAdded(t){this._onContentAdded(t,t.content),t.onContentAdded.addListener(this._onContentAdded,this),t.onContentRemoved.addListener(this._onContentRemoved,this)}_onObjectRemoved(t){this._onContentRemoved(t,t.content),t.onContentAdded.removeListener(this._onContentAdded),t.onContentRemoved.removeListener(this._onContentRemoved)}_onContentAdded(t,e){e.metadata&&this._addPrimitivesMetadata(e.metadata)}_onContentRemoved(t,e){e.metadata&&this._removePrimitivesMetadata(e.metadata)}_addPrimitivesMetadata(t){for(const[e,i]of t.entries())this._retain(e,i)}_removePrimitivesMetadata(t){for(const e of t.keys())this._release(e)}_retain(t,e){const i=this._index.get(t);i?i.count++:this._index.set(t,{metadata:e,count:1})}_release(t){const e=this._index.get(t);e&&(e.count--,0===e.count&&this._index.delete(t))}}const me="_vector_";let ge=0;class ye{constructor(){this._key=Symbol("array_storage_metadata#"+ge++),this._data=[],this._isDirty=!1}*[Symbol.iterator](){this._isDirty&&(this._onDirtyDataAccessed(),this._isDirty=!1),yield*this._data}add(t){let e=this._getMetadata(t);return!e&&(e={index:this._data.push(t)-1},t[this._key]=e,!0)}remove(t){const e=this._getMetadata(t);return!!e&&(delete this._data[e.index],delete t[this._key],this._setDirty(),!0)}_setDirty(){this._isDirty=!0}_onDirtyDataAccessed(){this._shakeDown()}_shakeDown(){let t=0;for(let e=0;e<this._data.length;++e){const i=this._data[e];if(void 0!==i){const e=this._getMetadata(i);this._data[t]=i,e.index=t,++t}}this._data.length=t}_getMetadata(t){return t[this._key]}}function ve(t,e){let i=0;return(...r)=>{i&&clearTimeout(i),i=setTimeout(()=>{i=0,t(...r)},e)}}function be(t,e=!1){let i=!1;return(...r)=>{e&&i||(Promise.resolve().then(()=>{t(...r),i=!1}),i=!0)}}class xe{constructor(){this._primitives=new ye,this.onUpdate=this._onUpdate=new s,this._updateScheduler=be(this._fireUpdate.bind(this),!0)}get primitives(){return this._primitives}add(t){for(const e of t)this._primitives.add(e);this._updateScheduler()}delete(t){for(const e of t)this._primitives.remove(e);this._updateScheduler()}_fireUpdate(){this._onUpdate.fire()}}class we extends xe{constructor(t=new ye){super(),this._visiblePrimitives=t}get primitives(){return this.visiblePrimitives}get visiblePrimitives(){return this._visiblePrimitives}add(t){super.add(t),this.show(t)}delete(t){this.hide(t),super.delete(t)}show(t){this._show(t)&&this._updateScheduler()}hide(t){this._hide(t)&&this._updateScheduler()}_show(t){let e=!1;for(const i of t)this._visiblePrimitives.add(i)&&(e=!0);return e}_hide(t){let e=!1;for(const i of t)this._visiblePrimitives.remove(i)&&(e=!0);return e}}class Ae extends we{constructor(t,e){super(e),this._appearingEffectDuration=t,this._timeoutIds=new Set,this._removeSchedulerFlagKey=Symbol("1"),this._scheduler=be(this._scheduleRemovePrimitives.bind(this),!0),this._scheduledForRemovePrimitives=[]}get primitives(){return this._primitives}add(t){super.add(t);for(const e of t){const t=e[this._removeSchedulerFlagKey];t&&t.isScheduledForRemove&&(t.isScheduledForRemove=!1)}}delete(t){this.hide(t);for(const e of t){let t=e[this._removeSchedulerFlagKey];t||(t={isScheduledForRemove:!0},e[this._removeSchedulerFlagKey]=t),t.isScheduledForRemove=!0}this._scheduledForRemovePrimitives.push(...t),this._scheduler()}destroy(){for(const t of this._timeoutIds)clearTimeout(t)}_scheduleRemovePrimitives(){const t=setTimeout(e=>{super.delete([...Ut(e,t=>{const e=t[this._removeSchedulerFlagKey];return void 0!==e&&e.isScheduledForRemove})]),this._timeoutIds.delete(t)},this._appearingEffectDuration,[...this._scheduledForRemovePrimitives]);this._scheduledForRemovePrimitives.length=0,this._timeoutIds.add(t)}}class Te{constructor(...t){this.onUpdate=this._onUpdate=new s,this._filterUpdateListener=()=>this._onUpdate.fire();for(const e of t)e.onUpdate&&e.onUpdate.addListener(this._filterUpdateListener);this._filters=new Set(t)}addFilter(t){this._filters.has(t)||(this._filters.add(t),t.onUpdate&&t.onUpdate.addListener(this._filterUpdateListener),this._onUpdate.fire())}deleteFilter(t){this._filters.delete(t)&&(t.onUpdate&&t.onUpdate.removeListener(this._filterUpdateListener),this._onUpdate.fire())}test(t){return Dt(this._filters,e=>e.test(t))}}class Se{constructor(t){this._scene=t,this._filter=new Te,this._visible=new ye,this._hidden=new ye,this._onFilterUpdate=this._onFilterUpdate.bind(this),this._filter.onUpdate.addListener(this._onFilterUpdate,this)}addPrimitives(t){const e=[],i=[];for(const r of t)this._filter.test(r)?(e.push(r),this._visible.add(r)):(i.push(r),this._hidden.add(r));this._scene.add(e),this._scene.add(i),this._scene.show(e),this._scene.hide(i)}removePrimitives(t){this._scene.remove(t);for(const e of t)this._visible.remove(e),this._hidden.remove(e)}addFilter(t){this._filter.addFilter(t)}removeFilter(t){this._filter.deleteFilter(t)}_onFilterUpdate(){const t=[];for(const i of this._visible)this._filter.test(i)||(t.push(i),this._visible.remove(i),this._hidden.add(i));this._scene.hide(t);const e=[];for(const i of this._hidden)this._filter.test(i)&&(e.push(i),this._visible.add(i),this._hidden.remove(i));this._scene.show(e)}}class Pe{constructor(t){this._storage=t}add(t){this._storage.add(t)}remove(t){this._storage.delete(t)}show(t){this.add(t)}hide(t){this.remove(t)}}class Re extends Pe{show(t){this._storage.show(t)}hide(t){this._storage.hide(t)}}class Me{constructor(t){this._scene=t,this._filteringManagers={}}destructor(){}addFilter(t,e){let i=this._filteringManagers[t];if(!i){const e=this._scene[t],r=e instanceof we?new Re(e):new Pe(e);i=new Se(r),this._filteringManagers[t]=i}return i.addFilter(e),this}removeFilter(t,e){const i=this._filteringManagers[t];i&&i.removeFilter(e)}showObject(t){this._showObjectContent(t,t.content),t.onContentAdded.addListener(this._onContentAdded,this),t.onContentRemoved.addListener(this._onContentRemoved,this)}hideObject(t){this._hideObjectContent(t,t.content),t.onContentAdded.removeListener(this._onContentAdded),t.onContentRemoved.removeListener(this._onContentRemoved)}_showObjectContent(t,e){for(const i of c(e.primitives)){const t=e.primitives[i];if(t&&t.length>0){const e=this._filteringManagers[i];e?e.addPrimitives(t):this._scene[i].add(t)}}}_hideObjectContent(t,e){for(const i of c(e.primitives)){const t=e.primitives[i];if(t){const e=this._filteringManagers[i];e?e.removePrimitives(t):this._scene[i].delete(t)}}}_onContentAdded(t,e){this._showObjectContent(t,e)}_onContentRemoved(t,e){this._hideObjectContent(t,e)}}class Ce extends ye{constructor(t){super(),this._comparator=t}add(t){const e=super.add(t);return e&&this._setDirty(),e}_onDirtyDataAccessed(){super._onDirtyDataAccessed(),function(t,e=Tt,i=0,r=t.length){if(r-i<=32)return void Rt(t,e,i,r);{let s=i,n=s+32;for(;n<r;)Rt(t,e,s,n),s=n,n+=32;Rt(t,e,s,r)}const s=new Array(r-i);for(let n=32;n<r-i;n+=n){Pt(t,s,i,r);let o=i,a=0,c=n,h=c+n;for(;h<r-i;)Mt(s,t,e,a,c,h,o),a=h,c=a+n,h=c+n,o+=2*n;Mt(s,t,e,a,Math.min(c,r-i),r-i,o)}}(this._data,this._comparator);for(let t=0;t<this._data.length;t++)this._getMetadata(this._data[t]).index=t}}class ze{constructor(t,e,i,r,n,o,a){this._isPaused=!1,this.name=t,this._context=e,this._camera=i,this._registry=r,this._glyphAtlasRegistry=n,this._iconAtlasRegistry=o,this._objectMetadataIndex=a,this.scene=this._scene={0:new xe,1:new xe,2:new xe,3:new xe,4:new xe,5:new Ae(150),6:new Ae(150),7:new Ae(150,new Ce((t,e)=>t.zIndex-e.zIndex))},this._contentVisibilityManager=new Me(this._scene),this.memoryUsage=this._memoryUsage=Object.assign(Object.assign(Object.assign({},this._registry.memoryUsage),this._glyphAtlasRegistry.memoryUsage),this._iconAtlasRegistry.memoryUsage),this.onMemoryUsageChanged=this._onMemoryUsageChanged=new s}get isPaused(){return this._isPaused}destructor(){this._contentVisibilityManager.destructor()}getObjectMetadata(t){return this._objectMetadataIndex.getMetadata(t)}pause(){this._isPaused=!0}resume(){this._isPaused=!1}_createAdditionalMetadata(){return new Map([[me+"layerName",this.name]])}_onMemoryUsageComponentChange(t){Object.assign(this._memoryUsage,t),this._onMemoryUsageChanged.fire(this._memoryUsage)}}class Oe extends ze{constructor(t,e,i,r,s,o){const a=Object.assign({dpr:ee()},r),c=new n(t),h=new Lt(c.getCommunicator(1)),l=new le(c.getCommunicator(2));super(s,i,e,new Et(c.getCommunicator(4),i),new oe(c.getCommunicator(5),a,i),new ce(c.getCommunicator(6),a,i),new pe([h,l])),this._options=a,this._commutator=c,this._storage=h,this._modelStorage=l,this._metricsTransport=o,this._viewport=new wt(this._commutator.getCommunicator(0),e,this._options),this._tileModelVisibilityManager=new de(this._contentVisibilityManager,this._modelStorage),this._tileContentManager=this._createContentManager(),this._addZoomVisibilityFilters(),this.visibilityManager=this._visibilityManager=this._createViewportVisibilityManager(),this._metricsCollector=new ue(o,s,e,this._storage,this._tileContentManager,this._viewport,Kt),this._tileGeneration=0,this._recalculateViewport(),window.addEventListener("beforeunload",()=>this._submitMetrics())}destructor(){this._viewport.destructor(),this._metricsCollector.destructor(),this._storage.destructor(),this._modelStorage.destructor(),this._tileContentManager.destructor(),this._visibilityManager.destructor(),this._contentVisibilityManager.destructor(),this._registry.destructor(),this._glyphAtlasRegistry.destructor(),this._objectMetadataIndex.destructor(),this._commutator.destructor()}pause(){this._viewport.pause(),super.pause()}resume(){this._viewport.resume(),super.resume()}get options(){return this._options}updateUrlTemplates(t){const{tileUrlTemplate:e,iconUrlTemplate:i}=t;i&&(this._iconAtlasRegistry.updateOption("iconUrlTemplate",i),this._options.iconUrlTemplate=i),e&&(this._tileContentManager.updateOption("tileUrlTemplate",e),this._options.tileUrlTemplate=e),this._tileGeneration++,this._recalculateViewport()}setMapMode(t){t!==this._options.mapMode&&(this._tileContentManager.updateOption("mapMode",t),this._options.mapMode=t,this._recalculateViewport())}updateCustomizationConfig(t){this._tileContentManager.updateCustomizationConfig(t),this._options.customizationConfig=t,this._tileGeneration++,this._recalculateViewport()}addVisibilityFilter(t,e){return this._contentVisibilityManager.addFilter(t,e),this}removeVisibilityFilter(t,e){return this._contentVisibilityManager.removeFilter(t,e),this}_createViewportVisibilityManager(){return new te(this._viewport,this._storage,this._contentVisibilityManager,this._tileModelVisibilityManager,this._metricsTransport,this.name)}_createContentManager(){return new v(this._commutator.getCommunicator(3),this._storage,this._modelStorage,this._registry,this._glyphAtlasRegistry,this._iconAtlasRegistry,this._options,this._createAdditionalMetadata())}_addZoomVisibilityFilters(){const t=new _e(this._camera);this._contentVisibilityManager.addFilter(5,t).addFilter(6,t).addFilter(7,t)}_recalculateViewport(){this._viewport.tileIdPrefix=this._getTileIdPrefix(),this._viewport.forceCameraStateRecalculation()}_getTileIdPrefix(){return(1===this._options.mapMode?"night_":"")+this._tileGeneration.toString()}_submitMetrics(){this._metricsCollector.submit(),this._visibilityManager.submitMetrics()}}class Le{constructor(t,e,i,r){if(this.id=t,0===e.length)throw new Error("No levels provided for a plan");this.levels=e;const n=this._selectLevelById(e,i);if(!n)throw new Error("Cannot find default level");this.defaultLevel=this._activeLevel=n,this.bbox=r,this.onActiveLevelChange=this._onActiveLevelChange=new s,this.onVisibilityChange=this._onVisibilityChange=new s,this.onOpacityChange=this._onOpacityChange=new s,this._isVisible=!1,this._opacity=1}get activeLevel(){return this._activeLevel}setActiveLevel(t){const e=this._selectLevelById(this.levels,t);if(e&&e!==this._activeLevel){const t=this._activeLevel;this._activeLevel=e,this._onActiveLevelChange.fire({previousLevel:t,currentLevel:e},this)}}get isVisible(){return this._isVisible}set isVisible(t){t!==this._isVisible&&(this._isVisible=t,this._onVisibilityChange.fire(t,this))}get opacity(){return this._opacity}set opacity(t){t!==this._opacity&&(this._opacity=t,this._onOpacityChange.fire(t,this))}_selectLevelById(t,e){return t.find(t=>t.id===e)}}var ke;!function(t){t[t.SETUP=0]="SETUP",t[t.ADD=1]="ADD",t[t.DESTROY=2]="DESTROY"}(ke||(ke={}));class Ie{constructor(t,e){this._communicator=t,this._plans=new Map,this.onPlanAdded=this._onPlanAdded=new s,this.onPlanRemoved=this._onPlanRemoved=new s,this._communicator.onMessage.addListener(this._onMessage,this),this._communicator.sendMessage({type:ke.SETUP,options:e},!0)}destructor(){this._communicator.onMessage.removeListener(this._onMessage)}getPlan(t){return this._plans.get(t)}getAllPlans(){return[...this._plans.values()]}_onMessage(t){switch(t.type){case ke.ADD:this._onAdd(t);break;case ke.DESTROY:this._onDestroy(t)}}_onAdd(t){const{planId:e,levels:i,defaultLevelId:r,boundary:s}=t,n=new Le(e,i,r,s);this._plans.set(e,n),this._onPlanAdded.fire(n)}_onDestroy(t){const e=this._plans.get(t.planId);o(e)&&(this._plans.delete(t.planId),this._onPlanRemoved.fire(e))}}class Ee{constructor(t){this._planRegistry=t,this.onUpdate=this._onUpdate=new s,this._metaKey=Symbol(),this._currentVersion=0,this._onPlanAdded=this._onPlanAdded.bind(this),this._onPlanRemoved=this._onPlanRemoved.bind(this),this._onPlanVisibilityChange=this._onPlanVisibilityChange.bind(this),this._onPlanLevelChange=this._onPlanLevelChange.bind(this),this._planRegistry.onPlanAdded.addListener(this._onPlanAdded,this),this._planRegistry.onPlanRemoved.addListener(this._onPlanRemoved,this)}destructor(){this._planRegistry.onPlanRemoved.removeListener(this._onPlanRemoved),this._planRegistry.onPlanAdded.removeListener(this._onPlanAdded),this._planRegistry.getAllPlans().forEach(t=>{t.onActiveLevelChange.removeListener(this._onPlanLevelChange),t.onVisibilityChange.removeListener(this._onPlanVisibilityChange)})}test(t){const e=t[this._metaKey];if(e&&e.version===this._currentVersion)return e.result;const i=this._test(t);return e?e.result=i:t[this._metaKey]={version:this._currentVersion,result:i},i}_test(t){const{metadata:e}=t;if(!e)return!1;const i=e.get("indoor_plan_id");if(!i)return!1;const r=i&&this._planRegistry.getPlan(i);if(!r)return!1;const s=e.get("indoor_level_id");return!!s&&r.isVisible&&r.activeLevel.id===s}_onPlanAdded(t){t.onVisibilityChange.addListener(this._onPlanVisibilityChange),t.onActiveLevelChange.addListener(this._onPlanLevelChange),t.isVisible&&this._fireUpdate()}_onPlanRemoved(t){t.isVisible&&this._fireUpdate(),t.onActiveLevelChange.removeListener(this._onPlanLevelChange),t.onVisibilityChange.removeListener(this._onPlanVisibilityChange)}_onPlanVisibilityChange(){this._fireUpdate()}_onPlanLevelChange(t,e){e.isVisible&&this._fireUpdate()}_fireUpdate(){this._currentVersion++,this._onUpdate.fire()}}const Be=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1];function Ue(){return new Array(16)}function De(t,e=Ue()){for(let i=0;i<16;++i)e[i]=t[i];return e}const je=De(Be);function Ve(t,e,i=Ue()){for(let r=0;r<16;r+=4){const s=t[r],n=t[r+1],o=t[r+2],a=t[r+3];for(let t=0;t<4;++t)i[r+t]=s*e[t]+n*e[4+t]+o*e[8+t]+a*e[12+t]}return i}function Fe(t,e=Ue()){for(let i=0;i<4;i++)for(let r=i;r<4;r++){const s=t[4*i+r];e[4*i+r]=t[4*r+i],e[4*r+i]=s}return e}function Ne(t,e){return e?Ve(t,e):t}function qe(t){return[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,t]}function He(t){const{color:e,lightness:i,opacity:r,saturation:s}=t;if(void 0!==e){const t=function({r:t,g:e,b:i,a:r}){return[0,0,0,t,0,0,0,e,0,0,0,i,0,0,0,r]}(e);return Fe(t,t)}let n;return void 0!==i&&(n=Ne(function(t){const e=1-Math.abs(t),i=Math.max(0,t);return[e,0,0,i,0,e,0,i,0,0,e,i,0,0,0,1]}(i),n)),void 0!==s&&(n=Ne(function(t){const e=.2125*(1-t),i=.7154*(1-t),r=.0721*(1-t);return[e+t,i,r,0,e,i+t,r,0,e,i,r+t,0,0,0,0,1]}(s+1),n)),void 0!==r&&(n=Ne(qe(r),n)),n?Fe(n,n):De(Be)}class We{constructor(){this._plans=new Map,this.onTransformChanged=this._onTransformChanged=new s}destructor(){for(const{plan:t}of this._plans.values())this.removePlan(t)}addPlan(t){t.onOpacityChange.addListener(this._onOpacityChanged,this);const e=t.opacity<1?He({opacity:t.opacity}):void 0;this._plans.set(t.id,{plan:t,transform:e})}removePlan(t){t.onOpacityChange.removeListener(this._onOpacityChanged),this._plans.delete(t.id)}get(t){var e;const i=t.metadata&&t.metadata.get("indoor_plan_id");return i?null===(e=this._plans.get(i))||void 0===e?void 0:e.transform:void 0}_onOpacityChanged(t,e){const i=this._plans.get(e.id);o(i)&&(i.transform=qe(t)),this._onTransformChanged.fire()}}class Ge extends Oe{constructor(t,e,i,r,n,o){super(t,e,i,r,"indoor",n),this._planRegistry=new Ie(this._commutator.getCommunicator(7),this._options),this._planRegistry.onPlanAdded.addListener(this._onPlanAdded,this),this._planRegistry.onPlanRemoved.addListener(this._onPlanRemoved,this),this._applyContentVisibilityFilters();const a=new We;this._colorTransformProvider=this.colorTransformProvider=a,this._coveredByIndoorFilter=o,this._coveredByIndoorFilter.activate(),this.onPlansChanged=this._onPlansChanged=new s}destructor(){this._planRegistry&&(this._planRegistry.onPlanRemoved.removeListener(this._onPlanRemoved),this._planRegistry.onPlanAdded.removeListener(this._onPlanAdded),this._planRegistry.destructor()),this._coveredByIndoorFilter.deactivate(),this._colorTransformProvider.destructor(),super.destructor()}pause(){this._coveredByIndoorFilter.deactivate(),super.pause()}resume(){super.resume(),this._coveredByIndoorFilter.activate()}get plans(){return this._planRegistry.getAllPlans()}_applyContentVisibilityFilters(){const t=new Ee(this._planRegistry);this._contentVisibilityManager.addFilter(4,t).addFilter(0,t).addFilter(1,t).addFilter(5,t).addFilter(6,t).addFilter(7,t)}_onPlanAdded(t){this._colorTransformProvider.addPlan(t),this._onPlansChanged.fire(this._planRegistry.getAllPlans())}_onPlanRemoved(t){this._colorTransformProvider.removePlan(t),this._onPlansChanged.fire(this._planRegistry.getAllPlans())}}class Xe{constructor(){this._isActive=!1,this.onUpdate=this._onUpdate=new s}activate(){this._isActive||(this._isActive=!0,this._onUpdate.fire())}deactivate(){this._isActive&&(this._isActive=!1,this._onUpdate.fire())}test(t){const{metadata:e}=t;return!(this._isActive&&e&&"true"===e.get("indoor_covered"))}}class Ye extends y{constructor(t,e,i,r,n,o,a){super(i,r,n,a),this._communicator=t,this._options=o,this._detalizationStorage=e,this._onContentAdded=this.onContentAdded=new s,this._communicator.onMessage.addListener(this._onMessage,this),this._communicator.sendMessage({type:0,options:this._options},!1)}destructor(){this._communicator.onMessage.removeListener(this._onMessage)}updateOption(t,e){this._options[t]=e,this._communicator.sendMessage({type:0,options:this._options},!1)}_onMessage(t){switch(t.type){case 2:this._onAddPrimitives(t);break;case 3:this._onRemovePrimitives(t)}}_onAddPrimitives(t){const e=this._detalizationStorage.get(t.levelId);if(o(e)){const i=this._instantiatePrimitives(t.content,e.zoom);e.addContent(i),this._onContentAdded.fire(e,i)}}_onRemovePrimitives(t){const e=this._detalizationStorage.get(t.levelId);if(o(e)){const i={primitives:{},references:[]};for(const r of t.content)i.primitives[r]=e.content.primitives[r];e.removeContent(i)}}}class Ze{constructor(t,e){this.type=0,this.id=t,this.parent=e,this._onActiveDetalizationChanged=new s,this._latestActiveDetalizationVersion=-1,this._detalizationLevels=new Set}get activeDetalizationLevel(){return this._activeDetalizationLevel}set activeDetalizationLevel(t){if(t!==this._activeDetalizationLevel){const e=this._activeDetalizationLevel;this._activeDetalizationLevel=t,t&&t.version>this._latestActiveDetalizationVersion&&(this._latestActiveDetalizationVersion=t.version),this._onActiveDetalizationChanged.fire(this,e,this._activeDetalizationLevel)}}get onActiveDetalizationChanged(){return this._onActiveDetalizationChanged}get latestActiveDetalizationVersion(){return this._latestActiveDetalizationVersion}get detalizationLevels(){return this._detalizationLevels}addDetalizationLevel(t){this._detalizationLevels.add(t)}removeDetalizationLevel(t){this._detalizationLevels.delete(t)}}class Ke extends At{constructor(t,e){super(t),this._groupStorage=e}_deserialize({id:t,parentId:e}){const i=this._groupStorage.get(e);if(!i)throw new Error(`Parent ${e} for object ${t} is not found`);return new Ze(t,i)}_add(t,e){e.parent.addChild(e),super._add(t,e)}_remove(t){const e=this.get(t);e&&e.parent.removeChild(e),super._remove(t)}}class Qe extends zt{constructor(t){super({primitives:{}}),this.type=0,this.zIndex=t}}class $e{constructor(t,e,i){this.type=1,this.id=t,this.zIndex=e.zIndex,this.opacity=e.opacity,this.parent=i,this._children=new Set,this._batchedChildren=[],this._batchesByZIndex=new Map,this.onUpdate=this._onUpdate=new s}get children(){return this._children}get batchedChildren(){return this._batchedChildren}addChild(t){this._children.add(t),0===t.type?(t.onActiveDetalizationChanged.addListener(this._onChildActiveLevelChanged,this),t.activeDetalizationLevel&&this._onChildActiveLevelChanged(t,void 0,t.activeDetalizationLevel)):(t.onUpdate.addListener(this._onChildUpdate,this),this._insertBatchedChild(t),this._onChildUpdate())}removeChild(t){this._children.delete(t)&&(0===t.type?(t.onActiveDetalizationChanged.removeListener(this._onChildActiveLevelChanged),t.activeDetalizationLevel&&this._onChildActiveLevelChanged(t,t.activeDetalizationLevel,void 0)):(t.onUpdate.removeListener(this._onChildUpdate),this._removeBatchedChild(t),this._onChildUpdate()))}_onChildUpdate(){this._onUpdate.fire()}_onChildActiveLevelChanged(t,e,i){e&&(e.onContentAdded.removeListener(this._onChildContentAdded),e.onContentRemoved.removeListener(this._onChildContentRemoved),e.hasContent&&this._onChildContentRemoved(e,e.content)),i&&(i.onContentAdded.addListener(this._onChildContentAdded,this),i.onContentRemoved.addListener(this._onChildContentRemoved,this),i.hasContent&&this._onChildContentAdded(i,i.content))}_onChildContentAdded(t,e){this._addContentToBatch(e,t.zIndex),this._onChildUpdate()}_onChildContentRemoved(t,e){this._removeContentFromBatch(e,t.zIndex),this._onChildUpdate()}_addContentToBatch(t,e){let i=this._batchesByZIndex.get(e);i||(i=new Qe(e),this._batchesByZIndex.set(e,i),this._insertBatchedChild(i)),i.addContent(t)}_removeContentFromBatch(t,e){const i=this._batchesByZIndex.get(e);i&&i.removeContent(t)}_insertBatchedChild(t){const e=this._batchedChildren.findIndex(e=>e.zIndex>t.zIndex),i=-1===e?this._batchedChildren.length:e;this._batchedChildren.splice(i,0,t)}_removeBatchedChild(t){const e=this._batchedChildren.indexOf(t);e>-1&&this._batchedChildren.splice(e,1)}}class Je extends At{_deserialize({id:t,style:e,parentId:i}){const r=null===i?null:this.get(i);if(void 0===r)throw new Error(`Parent ${i} for group ${t} is not found`);return new $e(t,e,r)}_add(t,e){e.parent&&e.parent.addChild(e),super._add(t,e)}_remove(t){const e=this.get(t);e&&e.parent&&e.parent.removeChild(e),super._remove(t)}}class ti{constructor(){this.onUpdate=this._onUpdate=new s}get root(){return this._root}set root(t){const e=this._root;e&&e.onUpdate.removeListener(this._onRootUpdate),t&&t.onUpdate.addListener(this._onRootUpdate,this),this._root=t,t!==e&&this._onRootUpdate()}_onRootUpdate(){this._onUpdate.fire()}}class ei{constructor(t,e,i,r,n){this._scene=t,this._viewport=e,this._groupStorage=i,this._objectStorage=r,this._detalizationStorage=n,this.onStateChanged=this._onStateChanged=new s,this._state={objectsVisible:0,objectsTotal:0},this._visibleObjectIds=new Set,this._viewport.onUpdate.addListener(this._onViewportUpdate,this),this._onViewportUpdate(),this._groupStorage.onAdded.addListener(this._onGroupAdded,this),this._groupStorage.onRemoved.addListener(this._onGroupRemoved,this),this._objectStorage.onAdded.addListener(this._onObjectAdded,this),this._objectStorage.onRemoved.addListener(this._onObjectRemoved,this),this._detalizationStorage.onAdded.addListener(this._onLevelAdded,this),this._detalizationStorage.onRemoved.addListener(this._onLevelRemoved,this);for(const s of this._groupStorage.items)this._onGroupAdded(s);for(const s of this._objectStorage.items)this._onObjectAdded(s);for(const s of this._detalizationStorage.items)this._onLevelAdded(s)}get state(){return this._state}destructor(){this._groupStorage.onAdded.removeListener(this._onGroupAdded),this._groupStorage.onRemoved.removeListener(this._onGroupRemoved),this._objectStorage.onAdded.removeListener(this._onObjectAdded),this._objectStorage.onRemoved.removeListener(this._onObjectRemoved),this._detalizationStorage.onAdded.removeListener(this._onLevelAdded),this._detalizationStorage.onRemoved.removeListener(this._onLevelRemoved);for(const t of this._groupStorage.items)this._onGroupRemoved(t);for(const t of this._objectStorage.items)this._onObjectRemoved(t);for(const t of this._detalizationStorage.items)this._onLevelRemoved(t)}pause(){this._scene.root=void 0}resume(){this._scene.root=this._currentRoot}_onGroupAdded(t){null===t.parent&&(this._scene.root&&console.warn(`Adding another root to the scene, new: ${t.id}, old: ${this._scene.root}`),this._scene.root=t,this._currentRoot=t)}_onGroupRemoved(t){this._scene.root===t&&(this._scene.root=void 0,this._currentRoot=void 0)}_onObjectAdded(t){this._recalculateState()}_onObjectRemoved(t){this._setObjectActiveLevel(t,void 0),this._recalculateState()}_onLevelAdded(t){t.onContentAdded.addListener(this._onLevelContentAdded,this),t.onContentRemoved.addListener(this._onLevelContentRemoved,this),this._onLevelContentAdded(t,t.content)}_onLevelRemoved(t){t.onContentAdded.removeListener(this._onLevelContentAdded),t.onContentRemoved.removeListener(this._onLevelContentRemoved),t.object.activeDetalizationLevel===t&&this._findBestLevelForObject(t.object)}_onLevelContentAdded(t,e){const i=t.object.activeDetalizationLevel;ii(t.content)&&this._shouldReplaceLevel(i,t)&&this._setObjectActiveLevel(t.object,t)}_onLevelContentRemoved(t,e){t!==t.object.activeDetalizationLevel||ii(t.content)||this._setObjectActiveLevel(t.object,void 0)}_recalculateState(){const t=this._visibleObjectIds.size,e=this._objectStorage.size;this._state.objectsVisible===t&&this._state.objectsTotal===e||(this._state.objectsVisible=t,this._state.objectsTotal=e,this._onStateChanged.fire(this._state))}_onViewportUpdate(){for(const t of this._objectStorage.items)this._findBestLevelForObject(t)}_setObjectActiveLevel(t,e){t.activeDetalizationLevel=e,e?this._visibleObjectIds.add(t.id):this._visibleObjectIds.delete(t.id),this._recalculateState()}_findBestLevelForObject(t){let e=void 0;for(const i of t.detalizationLevels)ii(i.content)&&this._shouldReplaceLevel(e,i)&&(e=i);e!==t.activeDetalizationLevel&&this._setObjectActiveLevel(t,e)}_shouldReplaceLevel(t,e){return!(!e||e.version<e.object.latestActiveDetalizationVersion||t&&!(e.version!==t.version?e.version>t.version:Math.abs(e.zoom-this._viewport.zoom)<Math.abs(t.zoom-this._viewport.zoom)))}}function ii(t){return Boolean(t.primitives[4]||t.primitives[0]||t.primitives[1]||t.primitives[7])}class ri{constructor(t,e){this._communicator=t,this._currentObjectId=1,this._communicator.sendMessage({type:0,options:e},!1),this._addRootGroup()}addObject(t,e,i=oi.id,r=String(this._currentObjectId++)){return this._communicator.sendMessage({type:1,feature:t,style:Object.assign(Object.assign({},si),e),id:r,parentId:i},!0),r}updateObject(t,e,i){this._communicator.sendMessage({type:2,id:t,feature:e,style:Object.assign(Object.assign({},si),i)},!0)}removeObject(t){this._communicator.sendMessage({type:3,id:t},!0)}addGroup(t,e=oi.id,i=String(this._currentObjectId++)){return this._addGroup(i,Object.assign(Object.assign({},ni),t),e)}removeGroupAndChildren(t){this._communicator.sendMessage({type:5,id:t},!0)}_addGroup(t,e,i){return this._communicator.sendMessage({type:4,id:t,style:e,parentId:i},!0),t}_addRootGroup(){const{id:t,zIndex:e,opacity:i}=oi;this._addGroup(t,{zIndex:e,opacity:i},null)}}const si={zIndex:0,simplificationRate:0},ni={zIndex:0,opacity:1},oi=new $e("__root_id__",ni,null);class ai extends zt{constructor(t,e,i,r,s){super({primitives:{}}),this.object=e,this.zoom=r,this.zIndex=i,this.version=s,this.id=t,this._hasContent=!1}get hasContent(){return this._hasContent}addContent(t){super.addContent(t),this._hasContent=!0}}class ci extends At{constructor(t,e){super(t),this._objectStorage=e}_deserialize({id:t,objectId:e,zoom:i,zIndex:r,version:s}){const n=this._objectStorage.get(e);if(!n)throw new Error(`Object ${e} for level ${t} is not found`);return new ai(t,n,r,i,s)}_add(t,e){e.object.addDetalizationLevel(e),super._add(t,e)}_remove(t){const e=this.get(t);e&&e.object.removeDetalizationLevel(e),super._remove(t)}}class hi{constructor(t,e){this._communicator=t,this._camera=e,this._zoom=0,this.onUpdate=this._onUpdate=new s,this._onCameraUpdate=this._onCameraUpdate.bind(this),this._camera.onUpdate.addListener(this._onCameraUpdate),this._onCameraUpdate()}destructor(){this._camera.onUpdate.removeListener(this._onCameraUpdate)}get zoom(){return this._zoom}_tryToUpdateZoom(t){const e=Math.round(t);e!==this._zoom&&(this._zoom=e,this._communicator.sendMessage({type:0,zoom:e},!0),this._onUpdate.fire())}_onCameraUpdate(){this._tryToUpdateZoom(this._camera.zoom)}}class li{constructor(t,e,i,r,o){this.name=t,this._camera=e;const a=this._commutator=new n(r),c=Object.assign({dpr:ee(),iconUrlTemplate:"no icon url",glyphRangeUrlTemplate:"no glyph range url template"},o),h=new Je(a.getCommunicator(3));this._groupStorage=h;const l=new Ke(a.getCommunicator(2),h);this._objectStorage=l,this._detalizationStorage=new ci(a.getCommunicator(4),l),this._registry=new Et(a.getCommunicator(6),i),this._glyphAtlasRegistry=new oe(a.getCommunicator(8),c,i),this._iconAtlasRegistry=new ce(a.getCommunicator(7),c,i),this._objectMetadataIndex=new pe([this._detalizationStorage]),this._options=c;const d=new ti;this.scene=d,this._viewport=new hi(a.getCommunicator(5),e);const u=new ri(a.getCommunicator(1),this._options);this._graphicsManager=u,this.visibilityManager=new ei(d,this._viewport,this._groupStorage,this._objectStorage,this._detalizationStorage),this._contentManager=new Ye(this._commutator.getCommunicator(0),this._detalizationStorage,this._registry,this._glyphAtlasRegistry,this._iconAtlasRegistry,this._options,this._createAdditionalMetadata()),this.memoryUsage=this._memoryUsage=Object.assign(Object.assign(Object.assign({},this._registry.memoryUsage),this._glyphAtlasRegistry.memoryUsage),this._iconAtlasRegistry.memoryUsage),this.onMemoryUsageChanged=this._onMemoryUsageChanged=new s}destructor(){this._objectStorage.destructor(),this._groupStorage.destructor(),this._contentManager.destructor(),this._commutator.destructor(),this._viewport.destructor(),this.visibilityManager.destructor()}get options(){return this._options}get isPaused(){return this._isPaused}getObjectMetadata(t){return this._objectMetadataIndex.getMetadata(t)}pause(){this._isPaused||(this.visibilityManager.pause(),this._isPaused=!0)}resume(){this._isPaused&&(this.visibilityManager.resume(),this._isPaused=!1)}addObject(t,e,i,r){return this._graphicsManager.addObject(t,e,i,r)}updateObject(t,e,i){return this._graphicsManager.updateObject(t,e,i)}removeObject(t){return this._graphicsManager.removeObject(t)}addGroup(t,e,i){return this._graphicsManager.addGroup(t,e,i)}removeGroupAndChildren(t){return this._graphicsManager.removeGroupAndChildren(t)}_createAdditionalMetadata(){return new Map([[me+"layerName",this.name]])}_onMemoryUsageComponentChange(t){Object.assign(this._memoryUsage,t),this._onMemoryUsageChanged.fire(this._memoryUsage)}}class di extends class{constructor(t){this._addressee=t,this._messageQueue=[],this._transferableQueue=[],this._listeners=[]}addMessage(t,e=[]){this._messageQueue.push(t),this._transferableQueue.push(...e)}onMessage(t){this._listeners.push(t)}flushMessages(){0!==this._messageQueue.length&&this._addressee.postMessage(this._messageQueue,this._transferableQueue),this._messageQueue.length=0,this._transferableQueue.length=0}listen(){this._addressee.onmessage=({data:t})=>{for(const e of t)for(const t of this._listeners)t(e)}}}{constructor(t){const e="function"==typeof t?t():new Worker(t);super(e),this._worker=e,this.listen()}destroy(){this._worker.terminate()}}class ui{constructor(t){this._worker=t,this._scheduledFlush=be(()=>t.flushMessages()),this.onMessage=this._onMessage=new s,t.onMessage(t=>{this._onMessage.fire(t)})}sendMessage(t,e,...i){this._worker.addMessage(t,i),e&&this._scheduledFlush()}}function fi(t){if("function"!=typeof t)throw new Error("Predicate must be a function");return`(${t.toString()})`}function _i(t){const{polygonsBatchingRule:e,modelsBatchingRule:i,polylinesBatchingRule:r,labelsBatchingRule:s}=t,n=function(t,e){var i={};for(var r in t)Object.prototype.hasOwnProperty.call(t,r)&&e.indexOf(r)<0&&(i[r]=t[r]);if(null!=t&&"function"==typeof Object.getOwnPropertySymbols){var s=0;for(r=Object.getOwnPropertySymbols(t);s<r.length;s++)e.indexOf(r[s])<0&&Object.prototype.propertyIsEnumerable.call(t,r[s])&&(i[r[s]]=t[r[s]])}return i}(t,["polygonsBatchingRule","modelsBatchingRule","polylinesBatchingRule","labelsBatchingRule"]);return e&&(n.polygonsBatchingRule=fi(e)),i&&(n.modelsBatchingRule=fi(i)),r&&(n.polylinesBatchingRule=fi(r)),s&&(n.labelsBatchingRule=fi(s)),n}class pi extends zt{constructor(t,e){super({primitives:{},references:[]}),this.id=t,this.bbox=e}}class mi extends At{_deserialize(t){return new pi(t.id,t.bbox)}}class gi extends y{constructor(t,e,i,r,n,o,a){super(i,r,n,a),this._communicator=t,this._options=o,this._storage=e,this._onContentAdded=this.onContentAdded=new s,this._communicator.onMessage.addListener(this._onMessage,this),this._communicator.sendMessage({type:0,options:this._options},!1)}destructor(){this._communicator.onMessage.removeListener(this._onMessage)}updateOption(t,e){this._options[t]=e,this._communicator.sendMessage({type:0,options:this._options},!1)}_onMessage(t){switch(t.type){case 2:this._onAddPrimitives(t)}}_onAddPrimitives(t){const e=this._storage.get(t.objectId);if(o(e)){const i=this._instantiatePrimitives(t.content,0);e.addContent(i),this._onContentAdded.fire(e,i)}}}class yi{constructor(t,e,i){this._camera=t,this._storage=e,this._contentVisibilityManager=i,this._visibleObjects=new Map,this._cameraArea=bt(this._camera),this._camera.onUpdate.addListener(this._onCameraChanged,this),this._storage.onAdded.addListener(this._onObjectAdded,this),this._storage.onRemoved.addListener(this._onObjectRemoved,this)}destructor(){this._camera.onUpdate.removeListener(this._onCameraChanged),this._storage.onAdded.removeListener(this._onObjectAdded),this._storage.onRemoved.removeListener(this._onObjectRemoved)}_onCameraChanged(){for(const t of this._storage.items)this._updateObjectVisibility(t)}_onObjectAdded(t){this._updateObjectVisibility(t)}_onObjectRemoved(t){this._visibleObjects.has(t.id)&&(this._visibleObjects.delete(t.id),this._contentVisibilityManager.hideObject(t))}_updateObjectVisibility(t){!function(t,e){let i,r,s,n;return t.minX<e.minX?(i=t,r=e):(i=e,r=t),t.maxY>e.maxY?(s=t,n=e):(s=e,n=t),r.minX<i.maxX&&n.maxY>s.minY}(this._cameraArea,t.bbox)?this._visibleObjects.has(t.id)&&(this._visibleObjects.delete(t.id),this._contentVisibilityManager.hideObject(t)):this._visibleObjects.has(t.id)||(this._visibleObjects.set(t.id,t),this._contentVisibilityManager.showObject(t))}}class vi{constructor(t,e,i){this._camera=e,this._communicator=t,this._storage=i,this._isActive=!1,this._onCameraUpdateDebounced=ve(this._onCameraUpdate.bind(this),5e3),this._onUpdateInStorage()}destructor(){this._pause()}_pause(){this._isActive&&(this._camera.onUpdate.removeListener(this._onCameraUpdateDebounced),this._isActive=!1)}_resume(){this._isActive||(this._camera.onUpdate.addListener(this._onCameraUpdateDebounced,this),this._isActive=!0)}_onCameraUpdate(){this._communicator.sendMessage({type:0,viewportBBox:bt(this._camera)},!0)}_onUpdateInStorage(){0===this._storage.size?this._pause():this._resume()}}class bi extends ze{constructor(t,e,i,r,s){const o=new n(r),a=Object.assign({dpr:ee()},s),c=new mi(o.getCommunicator(2));super(t,e,i,new Et(o.getCommunicator(3),e),new oe(o.getCommunicator(5),a,e),new ce(o.getCommunicator(4),a,e),new pe([c])),this._options=a,this._commutator=o,this._communicator=this._commutator.getCommunicator(0),this._storage=c,this._geoContentManager=new gi(this._commutator.getCommunicator(1),this._storage,this._registry,this._glyphAtlasRegistry,this._iconAtlasRegistry,this._options),this._visibilityManager=new yi(this._camera,this._storage,this._contentVisibilityManager),this._gc=new vi(this._commutator.getCommunicator(6),this._camera,this._storage),this._onCameraChanged(),this._onCameraChanged=ve(this._onCameraChanged.bind(this),500),this._camera.onUpdate.addListener(this._onCameraChanged)}destructor(){this._camera.onUpdate.removeListener(this._onCameraChanged),this._storage.destructor(),this._geoContentManager.destructor(),this._visibilityManager.destructor(),this._gc.destructor(),this._commutator.destructor()}_onCameraChanged(){const t=this._camera.center;this._communicator.sendMessage({type:0,center:ut(t.x,t.y),zoom:this._camera.zoom},!0)}}function*xi(t,e=(()=>!1)){let i=0;const r=[t];for(;i<r.length;){const t=r[i];if(yield t,!e(t))for(const e of t.children)r.push(e);++i}}function wi(t,e,i){if(function(t,e){for(const i of e){let e=!0;for(const r of t)if(E(i.normal,r)+i.distance<0){e=!1;break}if(e)return!1}return!0}(t.bboxPoints,i.planes)){const r=[];if(!t.isDetailzationAcceptable(e))for(const s of t.children){const t=wi(s,e,i);t&&r.push(t)}return{tile:t,children:r}}}function Ai(t){let e=!0;for(const i of t.children)if(!Ai(i)){e=!1;break}return t.children.length>0&&e?(t.isSelfRenderable=!1,!0):t.tile.content?(t.isSelfRenderable=!0,!0):(t.isSelfRenderable=!1,!1)}class Ti extends class{constructor(t){this._camera=t,this._visibleRootTiles=[],this._onUpdate=new s,this._camera.onUpdate.addListener(this._onAnyUpdate,this)}get onUpdate(){return this._onUpdate}destructor(){this._camera.onUpdate.removeListener(this._onAnyUpdate)}*visibleTiles(){for(const t of this._visibleRootTiles)for(const e of xi(t))yield e.tile}*visibleRenderableTiles(){for(const t of this._visibleRootTiles){Ai(t);for(const e of xi(t,t=>t.isSelfRenderable))e.isSelfRenderable&&(yield e.tile)}}_recalculateVisibleTiles(){const t=nt(this._camera);this._visibleRootTiles.length=0;for(const e of this._getRootTiles()){const i=wi(e,this._camera,t);i&&this._visibleRootTiles.push(i)}}_onAnyUpdate(){this._recalculateVisibleTiles(),this._onUpdate.fire()}}{constructor(t){super(t),this._rootTiles=new Set}addRootTile(t){this._rootTiles.add(t),t.onUpdate.addListener(this._onTileUpdate,this),this._onAnyUpdate()}removeRootTile(t){this._rootTiles.delete(t),t.onUpdate.removeListener(this._onTileUpdate),this._onAnyUpdate()}forceVisibilityRecalculation(){this._onAnyUpdate()}_getRootTiles(){return this._rootTiles}_onTileUpdate(){this._onUpdate.fire()}}let Si=1;function Pi(t,e){return t.type===e}Number.MAX_SAFE_INTEGER;class Ri extends class extends class{constructor(t){this._addressee=t,this._events=new s,this._listeners=new Map,this._transferableExtractors=new Map,this._messages=[],this._transferables=[],this._timeoutHandle=0,this._flushMessagesBinded=this.flushMessages.bind(this)}setTransferableExtractor(t,e){this._transferableExtractors.set(t,e)}sendMessage(t,e=0){t.messagePostMetrics={postDelay:Wt(),postTime:0};const i=this._transferableExtractors.get(t.type),r=i?i(t):void 0,s=0===this._messages.length;s&&(this._firstMessageTime=Wt()),this._messages.push(t),r&&(this._transferables=this._transferables.concat(r)),clearTimeout(this._timeoutHandle),this._messages.length>50||1===e||!s&&Wt()-this._firstMessageTime>250?this.flushMessages():this._timeoutHandle=setTimeout(this._flushMessagesBinded,50)}request(t,e){return new Promise((i,r)=>{-1===t.requestId&&(t.requestId=Si++);const s=e=>{Pi(e,t.responseType)&&e.requestId===t.requestId&&(i(e),this._events.removeListener(s)),Pi(e,t.errorType)&&e.requestId===t.requestId&&(r(),this.off(s))};this._events.addListener(s),this.sendMessage(t,e)})}respond(t,e,i){e.requestId=t.requestId,this.sendMessage(e,i)}on(t,e){const i=i=>{Pi(i,t)&&e(i)};this._listeners.set(e,i),this._events.addListener(i)}off(t){const e=this._listeners.get(t);e&&this._events.removeListener(e)}flushMessages(){for(const t of this._messages)t.messagePostMetrics&&(t.messagePostMetrics.postDelay=Wt()-t.messagePostMetrics.postDelay,t.messagePostMetrics.postTime=Date.now());this._addressee.postMessage(this._messages,this._transferables),this._messages.length=0,this._transferables.length=0}listen(){this._addressee.onmessage=({data:t})=>{for(const e of t)this.onMessage(e)}}onMessage(t){this._events.fire(t)}}{constructor(t){const e="function"==typeof t?t():new Worker(t);super(e),this._worker=e,this.listen()}destroy(){this._worker.terminate()}}{}var Mi;!function(t){t[t.TO_BACKEND_DECODE_REQUEST=0]="TO_BACKEND_DECODE_REQUEST",t[t.FROM_BACKEND_DECODE_RESPONSE=1]="FROM_BACKEND_DECODE_RESPONSE"}(Mi||(Mi={}));class Ci{constructor(t){this._onFromBackendDecodeResponseMessage=t=>{const{resolve:e,reject:i}=this._queue.get(t.messageId);this._queue.delete(t.messageId),t.asset?e(t.asset):i(t.error)},this._nextMessageId=0,this._worker=new Ri(t),this._worker.setTransferableExtractor(Mi.TO_BACKEND_DECODE_REQUEST,zi),this._queue=new Map,this._worker.on(Mi.FROM_BACKEND_DECODE_RESPONSE,this._onFromBackendDecodeResponseMessage)}destructor(){this._worker.off(this._onFromBackendDecodeResponseMessage),this._worker.destroy()}decode(t,e){const i=this._getMessageId(),r={type:Mi.TO_BACKEND_DECODE_REQUEST,messageId:i,buffer:t,metadata:e};return this._worker.sendMessage(r),new Promise((t,e)=>{this._queue.set(i,{resolve:t,reject:e})})}_getMessageId(){return++this._nextMessageId}}function zi({buffer:t}){return[t]}class Oi{constructor(t){this._worker=new Ci(t)}destructor(){this._worker.destructor()}decode(t,e){return function(t,e,i,r){return new(i||(i=Promise))((function(s,n){function o(t){try{c(r.next(t))}catch(e){n(e)}}function a(t){try{c(r.throw(t))}catch(e){n(e)}}function c(t){var e;t.done?s(t.value):(e=t.value,e instanceof i?e:new i((function(t){t(e)}))).then(o,a)}c((r=r.apply(t,e||[])).next())}))}(this,void 0,void 0,(function*(){const{buffer:i,byteOffset:r,byteLength:s}=t,n=i.slice(r,r+s);return yield this._worker.decode(n,e)}))}}class Li{constructor(t){this._viewport=t,this.onUpdate=this._onUpdate=new s,this._viewport.onUpdate.addListener(this._onViewportUpdate,this)}get primitives(){return function*(t){for(const e of t)e.content&&(yield*e.content.primitives)}(this._viewport.visibleRenderableTiles())}destructor(){this._viewport.onUpdate.removeListener(this._onViewportUpdate)}_onViewportUpdate(){this._onUpdate.fire()}}function ki(t){return(t+1>>1)-1}function Ii(t){return(t+1<<1)-1}class Ei{constructor(t=Tt){this._items=[],this._comparator=t}insert(t){const e=this._items,i=this._comparator;let r=e.push(t)-1,s=ki(r);for(;s>-1&&i(e[r],e[s])>0;)St(e,r,s),r=s,s=ki(r)}pop(){const t=this._items;if(0===t.length)return;const e=t[0];return this._removeByIndex(0),e}peek(){return this._items[0]}*[Symbol.iterator](){for(const t of this._items)yield t}get size(){return this._items.length}remove(t){const e=this._items.findIndex(t);-1!=e&&this._removeByIndex(e)}_restoreOrderDownward(t){let e=t,i=Ii(e);const r=this._items.length,s=this._comparator,n=this._items;for(;i<r&&(i+1<r&&s(n[i],n[i+1])<0&&(i+=1),!(s(n[e],n[i])>0));)St(n,e,i),e=i,i=Ii(i)}_removeByIndex(t){St(this._items,t,this._items.length-1),this._items.pop(),this._restoreOrderDownward(t)}}function Bi(t,e=4){let i=0;return{attributes:[...Bt(t,([t,{type:r,size:s,normalized:n}])=>{const o=[t,{type:r,size:s,normalized:n,offset:i}],a=s*function(t){switch(t){case 5120:case 5121:return 1;case 5122:case 5123:return 2;case 5124:case 5125:case 5126:return 4}}(r),c=function(t,e){return(t-1&e)-e}(i+a,-e);return i=c,o})],vertexByteSize:i}}const Ui=Bi([[0,{size:2,type:5123,normalized:!1}],[1,{size:2,type:5123,normalized:!1}],[3,{size:1,type:5126,normalized:!1}]]),Di=Bi([[4,{size:2,type:5126,normalized:!1}]]);class ji extends l{constructor(t,e,i,r,s,n,o){super(t,e,i,s,n),this.color=r,this.modelId=o}}function Vi(t,e){return t.materials[e.material].pbrMetallicRoughness.baseColorTexture.index}function Fi(t){return"parts"in t}class Ni{constructor(t,e,i,r){const{description:s,buffers:n,images:o}=t;this._buffers=[],this._textures=[],this._vaos=[],this._primitives=[];for(const a of o){const t=e.createEmpty2DTexture(a.width,a.height,6408,5121,{magnificationFilter:9729});if(Fi(a))for(const i of a.parts){const r={x:i.location.minX,y:i.location.minY};e.setTextureDataFromDomElement(t,i.image,r)}else e.setTextureDataFromDomElement(t,a);this._textures.push(t)}for(const a of s.meshes||[])for(const t of a.primitives){const o=qi(s,n,t.attributes.POSITION),a=e.createVertexBuffer(o.byteLength);e.uploadDataToBuffer(a,o);const c=qi(s,n,t.attributes.TEXCOORD_0),h=e.createVertexBuffer(c.byteLength);e.uploadDataToBuffer(h,c);const l=qi(s,n,t.indices),d=e.createIndexBuffer(l.byteLength);e.uploadDataToBuffer(d,l),this._buffers.push(a),this._buffers.push(h),this._buffers.push(d);const u=e.createVao([{attributeMapping:Ui,buffer:a},{attributeMapping:Di,buffer:h}],d);this._vaos.push(u);const f=Vi(s,t),_=this._textures[f];this._primitives.push(new ji(u,{indexByteOffset:0,indexByteLength:l.byteLength,indexType:5123},_,i,void 0,void 0,r))}}get primitives(){return this._primitives}destructor(){for(const t of this._buffers)t.destroy();for(const t of this._textures)t.destroy();for(const t of this._vaos)t.destroy()}}function qi(t,e,i){const r=t.accessors[i],s=t.bufferViews[r.bufferView];return new Uint8Array(e[s.buffer],s.byteOffset||0,s.byteLength)}function Hi(){return"createImageBitmap"in self}function Wi(t){const e=new Image,i=new Promise(i=>{e.onload=()=>i(),e.src=URL.createObjectURL(t)});return[e,i]}function Gi(t){return function(t,e,i,r){return new(i||(i=Promise))((function(s,n){function o(t){try{c(r.next(t))}catch(e){n(e)}}function a(t){try{c(r.throw(t))}catch(e){n(e)}}function c(t){var e;t.done?s(t.value):(e=t.value,e instanceof i?e:new i((function(t){t(e)}))).then(o,a)}c((r=r.apply(t,e||[])).next())}))}(this,void 0,void 0,(function*(){const e=[],i=[];for(const r of t)if(Fi(r)){const t=[];for(const i of r.parts){const[r,s]=Wi(i.image);t.push({location:i.location,image:r}),e.push(s)}i.push(Object.assign(Object.assign({},r),{parts:t}))}else{const[t,s]=Wi(r);i.push(t),e.push(s)}return yield Promise.all(e),i}))}class Xi{constructor(t,e,i,r,s,n){this._onViewportUpdate=()=>{const t=new Set(this._viewport.visibleTiles());for(const e of this._visibleTiles)t.has(e)||(this._getDetails(e).isVisible=!1,this._stopTileProcessing(e));this._visibleTiles=t;for(const e of t){let t=this._getDetails(e);t?t.isVisible=!0:(t={isVisible:!0,stage:0},e[this._contentManagementKey]=t),this._continueTileProcessing(e)}},this._context=t,this._viewport=e,this._taskQueue=r,this._taskBasePriority=s,this._modelColor=n,this._freeDecoders=i.slice(),this._visibleTiles=new Set,this._contentManagementKey=Symbol("content_manager_details"),this._decodingQueue=new Ei((t,e)=>{const i=t[this._contentManagementKey];return e[this._contentManagementKey].contentDataReadyTime-i.contentDataReadyTime}),this._viewport.onUpdate.addListener(this._onViewportUpdate),this._onViewportUpdate()}destructor(){this._viewport.onUpdate.removeListener(this._onViewportUpdate)}_continueTileProcessing(t){const e=this._getDetails(t);var i,r;if(e.isVisible)switch(e.stage){case 0:case 2:t.load().then(this._onTileLoaded.bind(this,t),this._onTileLoadingFailed.bind(this,t)),e.stage=1;break;case 3:if(this._freeDecoders.length>0){const s=this._freeDecoders.pop(),n=s.decode(e.contentData.data,e.contentData.metadata).then(this._onTileDecoded.bind(this,t),this._onTileDecodingFailed.bind(this,t));r=()=>{this._freeDecoders.push(s),this._onDecoderReleased(s)},(i=n).finally?i.finally(r):i.then(t=>Promise.resolve(r()).then(()=>t),t=>Promise.resolve(r()).then(()=>Promise.reject(t))),e.stage=5}else this._decodingQueue.insert(t),e.stage=4;break;case 7:e.task={priority:this._taskBasePriority,execute:()=>function(t,e,i,r){return new(i||(i=Promise))((function(s,n){function o(t){try{c(r.next(t))}catch(e){n(e)}}function a(t){try{c(r.throw(t))}catch(e){n(e)}}function c(t){var e;t.done?s(t.value):(e=t.value,e instanceof i?e:new i((function(t){t(e)}))).then(o,a)}c((r=r.apply(t,e||[])).next())}))}(this,void 0,void 0,(function*(){const i=e.content,r=Hi()?i:Object.assign(Object.assign({},e.content),{images:yield Gi(i.images)});t.content=new Ni(r,this._context,this._modelColor,t.modelId),e.stage=9,e.contentData=void 0,e.content=void 0}))},this._taskQueue.enqueue(e.task),e.stage=8}}_stopTileProcessing(t){const e=this._getDetails(t);switch(e.stage){case 1:t.cancelLoading(),e.stage=0;break;case 4:this._decodingQueue.remove(e=>e===t),e.stage=3;break;case 8:this._taskQueue.remove(e.task),e.stage=7}}_onTileLoaded(t,e){const i=this._getDetails(t);i.contentData=e,i.contentDataReadyTime=Wt(),i.stage=3,this._continueTileProcessing(t)}_onTileLoadingFailed(t){this._getDetails(t).stage=2}_onTileDecoded(t,e){const i=this._getDetails(t);i.content=e,i.stage=7,this._continueTileProcessing(t)}_onTileDecodingFailed(t){this._getDetails(t).stage=6}_onDecoderReleased(t){if(this._decodingQueue.size>0){const t=this._decodingQueue.pop();t[this._contentManagementKey].stage=3,this._continueTileProcessing(t)}}_getDetails(t){return t[this._contentManagementKey]}}function Yi(t,e){return t.priority-e.priority}class Zi{constructor(){this._heap=new Ei(Yi)}enqueue(t){this._heap.insert(t)}dequeue(){return this._heap.pop()}peek(){return this._heap.peek()}isEmpty(){return 0===this._heap.size}get size(){return this._heap.size}remove(t){this._heap.remove(t)}}class Ki{constructor(t=50){this._queue=new Zi,this._frozen=!1,this._dequeueTimeoutHandle=0,this.onEmpty=this._onEmpty=new s,this.onAdd=this._onAdd=new s,this._maxDequeueDuration=t}destroy(){clearTimeout(this._dequeueTimeoutHandle)}enqueue(t){return this._onAdd.fire(),this._frozen||this._setDequeueTimeout(),new Promise((e,i)=>{this._queue.enqueue({execute(){try{t.execute(),e()}catch(r){i(r)}},priority:t.priority})})}enqueueSync(t){this._queue.enqueue(t),this._setDequeueTimeout()}remove(t){this._queue.remove(e=>e===t)}isEmpty(){return this._queue.isEmpty()}freeze(){this._dequeueTimeoutHandle&&(clearTimeout(this._dequeueTimeoutHandle),this._dequeueTimeoutHandle=0),this._frozen=!0}unfreeze(){this._frozen=!1,this._queue.isEmpty()||this._setDequeueTimeout()}_dequeue(){if(this._dequeueTimeoutHandle=0,null===this._maxDequeueDuration)for(;this._queue.size;)this._queue.dequeue().execute();else{const t=Wt();for(;this._queue.size&&(this._queue.dequeue().execute(),!(Wt()-t>this._maxDequeueDuration)););}this._queue.isEmpty()?this._onEmpty.fire():this._setDequeueTimeout()}_setDequeueTimeout(){this._dequeueTimeoutHandle||(this._dequeueTimeoutHandle=setTimeout(()=>this._dequeue(),0))}}$i(0,0,0,1);const Qi=$i(1,1,0,1);function $i(t,e,i,r=1){return{r:t,g:e,b:i,a:r}}$i(0,0,0,0);class Ji{constructor(t,e,i,r,n,o){this.name=r,this._buildingsFilter=o,this._renderLoop=i,this._options=Object.assign(Object.assign({},tr),n),this.memoryUsage={},this._onMemoryUsageChanged=new s,this.viewport=new Ti(e),this._decoders=Array.from({length:4}).map(()=>new Oi(this._options.gltfDecoderWorkerUrl)),this._taskQueue=new Ki,this._contentManager=new Xi(t,this.viewport,this._decoders,this._taskQueue,0,this._options.modelColor),this.scene=new Li(this.viewport),this._tiles=new Map}get onMemoryUsageChanged(){return this._onMemoryUsageChanged}destructor(){this._contentManager.destructor(),this._taskQueue.destroy();for(const t of this._decoders)t.destructor();this.viewport.destructor();for(const t of this._tiles.values())for(const e of t.objectIds)this._buildingsFilter.removeBuilding(e)}addRootTile(t,e=[]){const i=t.modelId;if(void 0===i)return;const r=this._tiles.get(i);if(r)return void(3===r.state&&(r.state=1,clearTimeout(r.removeTimeoutId),r.removeTimeoutId=-1));const s={tile:t,updateListener:()=>this._onTileUpdateEntryUpdate(s),preRenderListener:()=>this._onPrerenderEntryUpdate(s),objectIds:e,state:0,progress:0,progressUpdateTime:Wt(),removeTimeoutId:-1};t.onUpdate.addListener(s.updateListener),this.viewport.addRootTile(s.tile),this._onTileUpdateEntryUpdate(s),this._tiles.set(i,s)}removeRootTile(t){const e=t.modelId;if(void 0===e)return;const i=this._tiles.get(e);i&&3!==i.state&&(i.state=3,i.removeTimeoutId=setTimeout(()=>{if(t.onUpdate.removeListener(i.updateListener),this.viewport.removeRootTile(i.tile),this._renderLoop.onBeforeRender.removeListener(i.preRenderListener),0!==i.state&&i.objectIds.length>0)for(const t of i.objectIds)this._buildingsFilter.removeBuilding(t);this._tiles.delete(e)},i.progress*this._options.textureFadeinDuration),i.progressUpdateTime=Wt(),this._renderLoop.onBeforeRender.addListener(i.preRenderListener),this._renderLoop.update())}pause(){}resume(){}getObjectMetadata(t){}getModelAppearingProgress(t){var e;return null===(e=this._tiles.get(t))||void 0===e?void 0:e.progress}_onTileUpdateEntryUpdate(t){if(0===t.state&&void 0!==t.tile.content){for(const e of t.objectIds)this._buildingsFilter.addBuilding(e);t.state=1,t.progress=0,t.progressUpdateTime=Wt(),this._renderLoop.onBeforeRender.addListener(t.preRenderListener),this._renderLoop.update()}this.viewport.forceVisibilityRecalculation()}_onPrerenderEntryUpdate(t){const e=Wt(),i=e-t.progressUpdateTime,r=1===t.state?1:-1;t.progress=Ft(t.progress+r*(i/this._options.textureFadeinDuration),0,1),t.progressUpdateTime=e,t.progress<=0?this._renderLoop.onBeforeRender.removeListener(t.preRenderListener):t.progress>=1?(t.state=2,this._renderLoop.onBeforeRender.removeListener(t.preRenderListener)):this._renderLoop.update()}}const tr={basePriority:200,gltfDecoderWorkerUrl:"gltf_decoder.worker.js",modelColor:$i(.9098039215686274,.8941176470588236,.8705882352941177,.8980392156862745),textureFadeinDuration:500};class er{constructor(){this.onUpdate=this._onUpdate=new s,this._objectIds=new Set}addBuilding(t){this._objectIds.add(t),this._onUpdate.fire()}removeBuilding(t){this._objectIds.delete(t),this._onUpdate.fire()}test(t){const{metadata:e}=t;if(e){const t=e.get("objectId");if(void 0!==t)return!this._objectIds.has(t)}return!0}}class ir extends l{constructor(t,e,i,r,s){super(t,e,i,r,s)}}var rr;!function(t){t[t.TO_BACKEND_SETUP=0]="TO_BACKEND_SETUP",t[t.FROM_BACKEND_ADD_RASTER_TILE_CONTENT=1]="FROM_BACKEND_ADD_RASTER_TILE_CONTENT"}(rr||(rr={}));class sr extends v{constructor(t,e,i,r,s,n,o,a,c,h){super(t,r,s,n,o,a,c,h),this._extCommunicator=e,this._context=i,this._extCommunicator.onMessage.addListener(this._onExtMessage,this),this._extCommunicator.sendMessage({type:rr.TO_BACKEND_SETUP,options:c},!1)}destructor(){this._extCommunicator.onMessage.removeListener(this._onExtMessage),super.destructor()}_onExtMessage(t){switch(t.type){case rr.FROM_BACKEND_ADD_RASTER_TILE_CONTENT:this._onExtAddPrimitives(t)}}_onExtAddPrimitives(t){return function(t,e,i,r){return new(i||(i=Promise))((function(s,n){function o(t){try{c(r.next(t))}catch(e){n(e)}}function a(t){try{c(r.throw(t))}catch(e){n(e)}}function c(t){var e;t.done?s(t.value):(e=t.value,e instanceof i?e:new i((function(t){t(e)}))).then(o,a)}c((r=r.apply(t,e||[])).next())}))}(this,void 0,void 0,(function*(){const e=this._storage.get(t.tileId);if(o(e)){const i=t.content[2];for(const[r,s]of function*(t,e,i=((t,e)=>[t,e])){const r=t[Symbol.iterator](),s=e[Symbol.iterator]();for(let n=r.next(),o=s.next();!n.done&&!o.done;n=r.next(),o=s.next())yield i(n.value,o.value)}(i||[],t.images||[])){const t=this._registry.getPage(r.location.bufferId);if(!o(t))continue;const[i,n]=Hi()?[s,void 0]:Wi(s);n&&(yield n);const a=this._context.createEmpty2DTexture(i.width+2,i.height+2,6408,5121,{magnificationFilter:9729,minificationFilter:9729,premultipliedAlpha:!0});this._context.setTextureDataFromDomElement(a,i,{x:1,y:1});const c={primitives:{2:[new ir(t.vao,r.location,a)]}};e.addContent(c),this._onTileContentAdded.fire(e,c,{})}}}))}}class nr extends Oe{constructor(t,e,i,r,s,n){super(t,e,i,r,s,n)}_createViewportVisibilityManager(){return new te(this._viewport,this._storage,this._contentVisibilityManager,this._tileModelVisibilityManager,this._metricsTransport,this.name,or)}_createContentManager(){return new sr(this._commutator.getCommunicator(3),this._commutator.getCommunicator(7),this._context,this._storage,this._modelStorage,this._registry,this._glyphAtlasRegistry,this._iconAtlasRegistry,this._options,this._createAdditionalMetadata())}}function or(t){return!(!t.content.primitives[2]||!t.content.primitives[5]&&!t.content.primitives[6])}class ar extends Oe{_createViewportVisibilityManager(){return new te(this._viewport,this._storage,this._contentVisibilityManager,this._tileModelVisibilityManager,this._metricsTransport,this.name,cr)}_addZoomVisibilityFilters(){const t=new _e(this._camera);this._contentVisibilityManager.addFilter(5,t).addFilter(6,t)}}function cr(t){return Kt(t)&&Boolean(t.content.primitives[7])}class hr{constructor(t,e,i,r,o){this._metrics=new Zt(o,"vector.map.content_provider"),this._metrics.mark("workerInitialized");const a=new di(t);this._context=i,this._camera=e,this._renderLoop=r,this._metricsTransport=o,this._commutator=new n(new ui(a)),this._communicator=this._commutator.getCommunicator(0),this.onMemoryUsageChanged=this._onMemoryUsageChanged=new s,this._contentProviders=[],this.coveredByIndoorFilter=new Xe,this.buildingsFilter=new er,this._currentProviderId=1,this._communicator.onMessage.addListener(this._onMessage,this),window.addEventListener("beforeunload",()=>this._metrics.submit())}initContentProvider(t,e,i){const r=this._contentProviders.find(t=>t.provider.name===e);if(r){if(r.type!==t)throw new Error(`Provider ${e} already exists with another type: ${r.type}`);const i=r.provider;return i.isPaused?i.resume():console.warn("initializing already initialized and running content provider"),i}const s=this._currentProviderId++;let n;switch(t){case 0:{const r=_i(i);this._initContentProviderBackend(s,e,t,r),n=new Oe(this._commutator.getCommunicator(s),this._camera,this._context,r,e,this._metricsTransport);break}case 1:const r=_i(i);this._initContentProviderBackend(s,e,0,r),n=new ar(this._commutator.getCommunicator(s),this._camera,this._context,r,e,this._metricsTransport);break;case 2:{const r=_i(i);this._initContentProviderBackend(s,e,t,r),n=new nr(this._commutator.getCommunicator(s),this._camera,this._context,r,e,this._metricsTransport);break}case 3:{const r=_i(i);this._initContentProviderBackend(s,e,t,r),n=new Ge(this._commutator.getCommunicator(s),this._camera,this._context,r,this._metricsTransport,this.coveredByIndoorFilter);break}case 4:{const r=_i(i);this._initContentProviderBackend(s,e,t,r),n=new li(e,this._camera,this._context,this._commutator.getCommunicator(s),r);break}case 5:{const r=_i(i);this._initContentProviderBackend(s,e,t,r),n=new bi(e,this._context,this._camera,this._commutator.getCommunicator(s),r);break}case 6:n=new Ji(this._context,this._camera,this._renderLoop,e,i,this.buildingsFilter);break;default:throw new Error("Unknown content provider type: "+t)}return this._contentProviders.push({id:s,type:t,provider:n}),n}getObjectMetadata(t){for(const e of this._contentProviders){if(!e)continue;const i=e.provider.getObjectMetadata(t);if(i)return i}}destroyContentProvider(t){const e=this._contentProviders.findIndex(e=>e.provider===t);if(-1!==e){const i=this._contentProviders[e];t.destructor(),this._communicator.sendMessage({type:2,id:i.id},!1),this._contentProviders.splice(e,1)}}_onMessage(t){switch(t.type){case 3:this._onWorkerInitialized()}}_initContentProviderBackend(t,e,i,r){this._communicator.sendMessage({type:0,id:t,name:e,providerType:i,options:r},!1)}_onWorkerInitialized(){this._metrics.putMeasuredValue("workerInitialized")}_onMemoryUsageInContentProviderChanged(){const t={};t.total=this._computeTotalMemoryUsage();for(const{provider:e}of this._contentProviders)t[e.name]=e.memoryUsage;this._onMemoryUsageChanged.fire(t)}_computeTotalMemoryUsage(){const t=this._contentProviders;return{memoryForBuffers:t.reduce((t,{provider:e})=>t+e.memoryUsage.memoryForBuffers,0),memoryForVertices:t.reduce((t,{provider:e})=>t+e.memoryUsage.memoryForVertices,0),memoryForIndices:t.reduce((t,{provider:e})=>t+e.memoryUsage.memoryForIndices,0),memoryForGlyphs:t.reduce((t,{provider:e})=>t+e.memoryUsage.memoryForGlyphs,0),memoryForIcons:t.reduce((t,{provider:e})=>t+e.memoryUsage.memoryForIcons,0)}}}var lr=i(10),dr=i.n(lr);const ur={blend:!0,blendFuncSrcRgb:770,blendFuncDstRgb:771,blendFuncSrcAlpha:1,blendFuncDstAlpha:771},fr={blend:!0,blendFuncSrcRgb:1,blendFuncDstRgb:771,blendFuncSrcAlpha:1,blendFuncDstAlpha:771},_r={depthTest:!0,depthFunc:518};class pr{constructor(...t){this.clearColor=$i(0,0,0,0),this.clearDepth=1,this.clearStencil=0,this.colorMaskR=!0,this.colorMaskG=!0,this.colorMaskB=!0,this.colorMaskAlpha=!0,this.blend=!1,this.blendEquationRgb=32774,this.blendEquationAlpha=32774,this.blendFuncSrcRgb=1,this.blendFuncDstRgb=0,this.blendFuncSrcAlpha=1,this.blendFuncDstAlpha=0,this.cullFace=!1,this.cullFaceMode=1029,this.frontFaceMode=2305,this.depthTest=!1,this.depthFunc=513,this.depthRangeNear=0,this.depthRangeFar=1,this.depthMask=!0,this.dither=!0,this.polygonOffset=!1,this.polygonOffsetFactor=0,this.polygonOffsetUnits=0,this.sampleAlphaToCoverage=!1,this.sampleCoverage=!1,this.sampleCoverageValue=1,this.sampleCoverageInvert=!1,this.scissorTest=!1,this.scissorX=0,this.scissorY=0,this.scissorWidth=-1,this.scissorHeight=-1,this.stencilTest=!1,this.stencilReference=0,this.stencilMask=255,this.stencilWriteMask=255,this.stencilFrontFunc=519,this.stencilFrontFailOp=7680,this.stencilFrontDepthFailOp=7680,this.stencilFrontDepthPassOp=7680,this.stencilBackFunc=519,this.stencilBackFailOp=7680,this.stencilBackDepthFailOp=7680,this.stencilBackDepthPassOp=7680,this.viewportX=0,this.viewportY=0,this.viewportWidth=-1,this.viewportHeight=-1,Object.assign(this,...t)}}function mr(t){return 65535*t|0}function gr(t){return 4294967295*t|0}function*yr(t){for(let e=2;e<t;++e)yield 0,yield e-1,yield e}function*vr(t){yield 0,yield 1,yield 2;let e=1,i=2;for(let r=3;r<t;++r){yield r-e,yield r-i,yield r;const t=e;e=i,i=t}}class br{constructor(t){this._nextWordOffset=0,this._initBuffers(t)}get isFull(){return this._nextWordOffset>=this._uint32View.length}get occupiedSize(){return this._nextWordOffset}get byteSize(){return this._uint32View.byteLength}extend(t){const e=this._uint32View;this._initBuffers(t),this._uint32View.set(e)}pushUint32(t){this._uint32View[this._nextWordOffset++]=t}pushFloat32(t){this._float32View[this._nextWordOffset++]=t}asUint32Array(){return this._uint32View.subarray(0,this.occupiedSize)}_initBuffers(t){const e=new ArrayBuffer(t);this._uint32View=new Uint32Array(e),this._float32View=new Float32Array(e)}static transferDataTail(t,e,i,r=0){const s=t.occupiedSize-i,n=t._uint32View.subarray(i,t.occupiedSize);e._uint32View.set(n,r),e._nextWordOffset=s,t._nextWordOffset=i}}class xr{constructor(t){this._nextIndexOffset=0,this._uint16View=new Uint16Array(t)}get occupiedSize(){return this._nextIndexOffset}get size(){return this._uint16View.length}extend(t){const e=this._uint16View;this._uint16View=new Uint16Array(t),this._uint16View.set(e)}push(t){this._uint16View[this._nextIndexOffset++]=t}asUint16Array(){return new Uint16Array(this._uint16View.buffer,0,this.occupiedSize)}static transferDataTail(t,e,i,r,s=0){for(let n=r,o=s;n<t.occupiedSize;n++,o++)e._uint16View[o]=t._uint16View[n]-i;e._nextIndexOffset=t.occupiedSize-r,t._nextIndexOffset=r}}class wr{constructor(t,e=1024,i=65536,r=3072){this._vertexByteSize=t,this._initVertexBufferByteSize=t*e,this._maxVertexBufferByteSize=t*i,this._initIndexBufferUint16Size=r,this._vertexBuffer=new br(this._initVertexBufferByteSize),this._vertexBuffers=[this._vertexBuffer],this._indexBuffer=new xr(this._initIndexBufferUint16Size),this._indexBuffers=[this._indexBuffer],this._currentMeshVertexOffset=0,this._currentMeshIndexOffset=0,this._currentMeshBaseIndex=0}writeIndices(t){this._ensureEnoughIndexBufferSpace(t.length);const e=this._indexBuffer,i=this._currentMeshBaseIndex;for(let r=0;r<t.length;++r)e.push(i+t[r])}writeIndicesForStrip(t){this._ensureEnoughIndexBufferSpace(3*(t.length-2));const e=this._indexBuffer,i=this._currentMeshBaseIndex;for(const r of vr(t.length))e.push(i+t[r])}writeIndicesForContinuousStrip(t,e=0){this._ensureEnoughIndexBufferSpace(3*(t-2));const i=this._indexBuffer,r=this._currentMeshBaseIndex+e;for(const s of vr(t))i.push(r+s)}writeIndicesForFan(t){this._ensureEnoughIndexBufferSpace(3*(t.length-2));const e=this._indexBuffer,i=this._currentMeshBaseIndex;for(const r of yr(t.length))e.push(i+t[r])}writeIndicesForContinuousFan(t,e=0){this._ensureEnoughIndexBufferSpace(3*(t-2));const i=this._indexBuffer,r=e+this._currentMeshBaseIndex;for(const s of yr(t))i.push(r+s)}endMesh(){const t=this._currentMeshVertexOffset,e=this._vertexBuffer.occupiedSize;this._currentMeshVertexOffset=e,this._currentMeshBaseIndex=(e<<2)/this._vertexByteSize;const i=this._currentMeshIndexOffset,r=this._indexBuffer.occupiedSize;return this._currentMeshIndexOffset=r,{vertexByteOffset:t<<2,vertexByteLength:e-t<<2,indexByteOffset:i<<1,indexByteLength:r-i<<1,indexType:5123,bufferIndex:this._vertexBuffers.length-1}}getBuffers(){return function(t,e,i=((t,e)=>[t,e])){const r=Math.min(t.length,e.length),s=new Array(r);for(let n=0;n<r;++n)s[n]=i(t[n],e[n]);return s}(this._vertexBuffers,this._indexBuffers,(t,e)=>({vertexBuffer:t.asUint32Array(),indexBuffer:e.asUint16Array()}))}getCurrentVertexBufferByteOffset(){return this._vertexBuffer.occupiedSize<<2}getCurrentVertexIdx(){return((this._vertexBuffer.occupiedSize<<2)/this._vertexByteSize|0)-this._currentMeshBaseIndex}_writeFloat32(t){this._ensureEnoughVertexBufferSpace(),this._vertexBuffer.pushFloat32(t)}_writeWord(t){this._ensureEnoughVertexBufferSpace(),this._vertexBuffer.pushUint32(t)}_writeHalfWords(t,e){this._writeWord(e<<16|65535&t)}_writeBytes(t,e,i,r){this._writeWord(r<<24|(255&i)<<16|(255&e)<<8|255&t)}_writeWorldCoordinate(t){const e=gr(.5*(t.x+1)),i=gr(.5*(t.y+1));this._writeHalfWords(e>>>16,i>>>16),this._writeHalfWords(e,i)}_getNextVertexBufferByteSize(t){return t<<1}_getNextIndexBufferUint16Size(t){return t<<1}_ensureEnoughVertexBufferSpace(){const t=this._vertexBuffer;if(!t.isFull)return;if(t.byteSize<this._maxVertexBufferByteSize)return void this._vertexBuffer.extend(this._getNextVertexBufferByteSize(t.byteSize));const e=this._currentMeshVertexOffset,i=4*(t.occupiedSize-e);if(i===this._maxVertexBufferByteSize)throw new Error("Mesh is too big to fit in.");let r=this._initVertexBufferByteSize;for(;r<=i;)r=this._getNextVertexBufferByteSize(r);const s=new br(r);br.transferDataTail(t,s,e),this._vertexBuffer=s,this._vertexBuffers.push(s),this._currentMeshVertexOffset=0;const n=this._indexBuffer,o=this._currentMeshIndexOffset,a=n.occupiedSize-o;let c=this._initIndexBufferUint16Size;for(;c<=a;)c=this._getNextIndexBufferUint16Size(c);const h=new xr(c);xr.transferDataTail(n,h,this._currentMeshBaseIndex,o),this._currentMeshBaseIndex=0,this._currentMeshIndexOffset=0,this._indexBuffer=h,this._indexBuffers.push(h)}_ensureEnoughIndexBufferSpace(t){const e=this._indexBuffer,i=e.occupiedSize+t;if(i<=e.size)return;let r=e.size;for(;i>r;)r=this._getNextIndexBufferUint16Size(r);this._indexBuffer.extend(r)}}const Ar=Bi([[0,{size:2,type:5123,normalized:!0}]]);class Tr extends wr{constructor(t,e){const i=t*e;super(Ar.vertexByteSize,i,void 0,0);const r=mr(1/t),s=mr(1/e),n=s/2;for(let o=0,a=r/2;o<t;o++,a+=r)for(let t=0,i=n;t<e;t++,i+=s)this._writeHalfWords(a,i);this.data=this.getBuffers()[0].vertexBuffer,this.numberOfSamplers=i}}class Sr{constructor(t,e,i,r,s){this._context=t,this._renderState=e,this._program=i,this._hitTestRenderState=r,this._hitTestProgram=s}render(t,...e){this._program&&this._prepareProgram(this._program,...e),this._prepareRenderTarget(t,...e),this._render(...e)}renderHitTestBuffer(t,...e){this._hitTestProgram&&(this._prepareHitTestProgram(this._hitTestProgram,...e),this._prepareHitTestTarget(t,...e),this._renderHitTestBuffer(...e))}destroy(){this._program&&this._program.destroy(),this._hitTestProgram&&this._hitTestProgram.destroy()}_prepareProgram(t,...e){this._context.bindProgram(t)}_prepareHitTestProgram(t,...e){this._context.bindProgram(t)}_prepareRenderTarget(t,...e){this._context.bindRenderState(this._renderState),this._context.bindRenderTarget(t)}_prepareHitTestTarget(t,...e){const i=this._context;this._hitTestRenderState&&i.bindRenderState(this._hitTestRenderState),i.bindRenderTarget(t)}_renderHitTestBuffer(...t){}}class Pr extends Sr{constructor(t,e){super(t,e)}get target(){return this._target}get content(){return this._context.bindRenderTarget(this._target),this._target.readPixels()}get size(){return this._target.size}updateGrid(...t){return this.render(this._target,...t),this._texture}_render(t,e,i,r,s,n,o,a,c,h){for(const l of i)l.render(this._target,t,e,this._renderState,r,s,n,o,a,c,h)}setResolution(t,e){this._destroyResources(),this._depthBuffer=this._context.createRenderbuffer(t,e,34041),this._texture=this._context.createEmpty2DTexture(t,e,6408,5121),this._target=this._context.createFramebuffer({color:this._texture,depthStencil:this._depthBuffer})}destroy(){this._destroyResources()}_prepareRenderTarget(t,...e){super._prepareRenderTarget(t,...e),this._context.clearCurrentTarget(16640)}_destroyResources(){this._target&&(this._target.destroy(),this._texture.destroy(),this._depthBuffer.destroy())}}class Rr{render(t,e,i){for(const r of e)r.render(t,i)}}class Mr{constructor(t){this._mins=new Array(t),this._maxs=new Array(t),this._mins.fill(Number.POSITIVE_INFINITY),this._maxs.fill(Number.NEGATIVE_INFINITY)}updateValue(t,e){this._mins[t]=Math.min(this._mins[t],e),this._maxs[t]=Math.max(this._maxs[t],e)}*values(){const t={min:0,max:0,index:-1};for(let e=0;e<this._mins.length;e++)t.min=this._mins[e],t.max=this._maxs[e],t.index=e,yield t}}function Cr(t,e){return Number.isInteger(t)&&e===t?t-1:Math.floor(t)}const zr=ut(-1,-1),Or=t=>{const e=_t(t);return function(t,e,i=ut(0,0)){i.x=t.x-e.x,i.y=t.y-e.y}(e,zr,e),mt(e,.5,e),e},Lr=t=>.25*(t+2)*4294967295,kr=t=>Math.trunc(t/65536),Ir=t=>65535&t,Er=(t,e)=>t.x-e.x||t.y-e.y,Br=ut(0,0),Ur=[],Dr=[];function jr(t){const e=lt(t);if(0===function(t,e,i){const r=Math.min(e.length,i.length);for(let s=0;s<r;s++){const r=t(e[s],i[s]);if(r)return r}return e.length-i.length}(Er,Ur,e))return Dr;const i=[];for(const r of function(t){const e=[],i=vt(t),r=Math.floor(i.minX),s=Math.ceil(i.maxX)-r,n=new Mr(s);for(let o=t.length-1,a=0;a<t.length;o=a++){let e=t[o],s=t[a];if(e.x>s.x){const t=e;e=s,s=t}const c=Math.floor(e.x+1),h=Math.ceil(s.x-1),l=(e.y-s.y)/(e.x-s.x);n.updateValue(Cr(e.x,i.maxX)-r,Cr(e.y,i.maxY)),n.updateValue(Cr(s.x,i.maxX)-r,Cr(s.y,i.maxY));for(let t=c;t<=h;t++){const s=(isFinite(l)?l*(t-e.x):0)+e.y,o=t-r,a=o-1,c=Math.floor(s);Number.isInteger(s)?s===i.maxY?(n.updateValue(a,c-1),n.updateValue(o,c-1)):l>0?(n.updateValue(a,c-1),n.updateValue(o,c)):l<0&&(n.updateValue(a,c),n.updateValue(o,c-1)):(n.updateValue(a,c),n.updateValue(o,c))}}for(const{min:o,max:a,index:c}of n.values()){const t=r+c;for(let i=o;i<=a;i++)e.push(ut(t,i))}return e}(e.map(Or)))2!==t.options.wrapModeX&&0!==r.x||2!==t.options.wrapModeY&&0!==r.y||(mt(r,-2,Br),pt(t.center,Br,Br),gt(Br,Lr,Br),i.push({lookAtHigh:gt(Br,kr),lookAtLow:gt(Br,Ir)}));Pt(i,Dr),Dr.length=i.length,Ur.length=e.length;for(let r=0;r<e.length;r++)Ur[r]=_t(e[r],Ur[r]);return i}var Vr=i(11),Fr=i.n(Vr),Nr=i(0),qr=i.n(Nr);const Hr=new pr({depthTest:!0,clearDepth:0,depthFunc:516,dither:!1});class Wr extends Sr{constructor(t){const e=t.createProgram(Fr.a,qr.a,{attribMap:{position:0}});super(t,Hr,e),t.bindProgram(e),e.setIntScalarUniform("directPriorityGrid",0),e.setIntScalarUniform("reversePriorityGrid",1)}_prepareProgram(t,e,i,r,s,n){super._prepareProgram(t,e,i,r,s,n),this._context.bindTextureUnit(0),this._context.bindTexture(r),this._context.bindTextureUnit(1),this._context.bindTexture(s),t.setVector2Uniform("idHalfPxSize",n),t.setVector2Uniform("gridHalfPxSize",r.getHalfPxSize())}_render(t,e){this._context.bindVao(t),this._context.drawMesh(0,e,0)}_prepareRenderTarget(t,...e){super._prepareRenderTarget(t,...e),this._context.clearCurrentTarget(256)}}var Gr=i(12),Xr=i.n(Gr),Yr=i(13),Zr=i.n(Yr);const Kr=Bi([[0,{size:4,type:5120,normalized:!1}]]);class Qr extends wr{constructor(){super(Kr.vertexByteSize,4,4,6),this._writeBytes(-1,-1,0,0),this._writeBytes(-1,1,0,1),this._writeBytes(1,1,1,1),this._writeBytes(1,-1,1,0),this.writeIndicesForFan([0,1,2,3]),this.vertexData=this.getBuffers()[0].vertexBuffer,this.indexData=this.getBuffers()[0].indexBuffer}}const $r=new pr({dither:!1});class Jr extends Sr{constructor(t){const e=t.createProgram(Xr.a,Zr.a,{attribMap:{position:0}});super(t,$r,e);const i=new Qr;this._idSamplerVertexBuffer=this._context.createVertexBuffer(i.vertexData.byteLength),this._idSamplerIndexBuffer=this._context.createIndexBuffer(i.indexData.byteLength),this._idSamplerVao=this._context.createVao([{attributeMapping:Kr,buffer:this._idSamplerVertexBuffer}],this._idSamplerIndexBuffer),this._context.uploadDataToBuffer(this._idSamplerVertexBuffer,i.vertexData),this._context.uploadDataToBuffer(this._idSamplerIndexBuffer,i.indexData),t.bindProgram(e),e.setIntScalarUniform("prevVisibility",0),e.setIntScalarUniform("overlaps",1),e.setIntScalarUniform("scene",2)}_prepareProgram(t,e,i,r,s,n,o,a){super._prepareProgram(t,e,i,r,s,n,o,a),this._context.bindTextureUnit(0),this._context.bindTexture(e),this._context.bindTextureUnit(1),this._context.bindTexture(i),this._context.bindTextureUnit(2),this._context.bindTexture(r),t.setScalarUniform("fadeAnimationAmount",s),t.setScalarUniform("currentZoom",n),t.setScalarUniform("currentTilt",o),t.setScalarUniform("currentAzimuth",a)}_render(){this._context.bindVao(this._idSamplerVao),this._context.drawIndexedMesh(0,6,4)}}var ts=i(14),es=i.n(ts),is=i(15),rs=i.n(is);const ss=new pr({blend:!0,blendFuncSrcRgb:0,blendFuncDstRgb:1,blendFuncSrcAlpha:1,blendFuncDstAlpha:0,dither:!1});class ns extends Sr{constructor(t){const e=t.createProgram(es.a,rs.a,{attribMap:{position:0}});super(t,ss,e);const i=new Qr;this._idSamplerVertexBuffer=this._context.createVertexBuffer(i.vertexData.byteLength),this._idSamplerIndexBuffer=this._context.createIndexBuffer(i.indexData.byteLength),this._idSamplerVao=this._context.createVao([{attributeMapping:Kr,buffer:this._idSamplerVertexBuffer}],this._idSamplerIndexBuffer),this._context.uploadDataToBuffer(this._idSamplerVertexBuffer,i.vertexData),this._context.uploadDataToBuffer(this._idSamplerIndexBuffer,i.indexData)}_render(){this._context.bindVao(this._idSamplerVao),this._context.drawIndexedMesh(0,6,4)}}const os=6378137*Math.PI,as=1/os;function cs({lon:t,lat:e,alt:i},r=S(0,0,0)){r.x=1*t/Math.PI;const s=.0818191908426*Math.sin(e);return r.y=1*Math.log(Math.tan(Math.PI/4+e/2)*Math.pow((1-s)/(1+s),.0409095954213))/Math.PI,r.z=i*as,r}const hs=st((t,e=De(Be))=>{const{fov:i,azimuth:r,tilt:s,aspectRatio:n,screenSize:o}=t,a=q(t),c=N(t),h=X(o.height,i,c),l=Q(h,r,s,ds);De(Be,e),function(t,e,i,r,s=Ue()){const n=function(t,e,i=S(0,0,0)){return i.x=t.x-e.x,i.y=t.y-e.y,i.z=t.z-e.z,i}(e,i);I(n,n);const o=B(r,n);I(o,o);const a=B(n,o);je[0]=o.x,je[1]=a.x,je[2]=n.x,je[4]=o.y,je[5]=a.y,je[6]=n.y,je[8]=o.z,je[9]=a.z,je[10]=n.z,je[12]=-E(o,e),je[13]=-E(a,e),je[14]=-E(n,e),Ve(t,je,s)}(e,l,R,D(M,r),e);const d=Math.tan(Math.abs(s))*Math.tan(.5*a);return function(t,e,i,r,s,n=Ue()){const o=1/Math.tan(.5*e),a=o/i,c=(r+s)/(r-s),h=2*r*s/(r-s);for(let l=0;l<16;l+=4){n[l]=t[l]*a,n[l+1]=t[l+1]*o;const e=t[l+2],i=t[l+3];n[l+2]=e*c+i*h,n[l+3]=-e}}(e,a,n,Math.min(.01*h,h/(1+d)),h/(1-d)+ls,e),e}),ls=10/os,ds=S(0,0,0),us=new pr({clearColor:$i(0,0,0,0),dither:!1}),fs=$i(0,0,0,1),_s=new pr({clearColor:fs,depthTest:!0,clearDepth:-1,depthFunc:518,dither:!1}),ps=new pr({clearColor:fs,depthTest:!0,clearDepth:1,depthFunc:513,dither:!1});class ms{constructor(t,e,i,r,s=150){this.fadeEffectDuration=s,this._context=t,this._camera=e,this._renderLoop=i,this._lastRenderTimeInLoop=-1,this._lastSceneUpdateTime=Wt(),this._animationTicksCount=0,this._prevTargetSize={width:0,height:0},this._isEnabled=!0,this._camera.onUpdate.addListener(this._onSceneUpdate,this),this._renderLoop.onBeforeRender.addListener(this._onBeforeRender,this),this._directPriorityGridRenderer=new Pr(t,_s),this._reversePriorityGridRenderer=new Pr(t,ps),this._noCollidingVisibilityTexture=this._createPlainTexture($i(1,1,1,1)),this._currentVisibilityTexture=t.createEmpty2DTexture(256,256,6408,5121),this._prevVisibilityTexture=t.createEmpty2DTexture(256,256,6408,5121),this._sceneTexture=t.createEmpty2DTexture(256,256,6408,5121),this._overlapsTexture=t.createEmpty2DTexture(256,256,6408,5121),this._currentVisibilityBuffer=t.createFramebuffer({color:this._currentVisibilityTexture}),this._prevVisibilityBuffer=t.createFramebuffer({color:this._prevVisibilityTexture}),this._sceneBuffer=t.createFramebuffer({color:this._sceneTexture}),this._overlapsBuffer=t.createFramebuffer({color:this._overlapsTexture,depthStencil:t.createRenderbuffer(256,256,34041)}),this._stabilityShift=S(0,0,0),this._gridHalfPxSizeUniform=ut(0,0),this._idHalfPxSizeUniform=ut(.5/256,.5/256),this._resetRemoved=new Rr,this._makeAllOverlapped=new ns(t),this._findOverlaps=new Wr(t),this._computeVisibility=new Jr(t),this._clearVisibility(this._currentVisibilityBuffer),this._clearVisibility(this._overlapsBuffer),this._primitiveProviders=[],this._colorIdRenderers=[],this._resetRemovedRenderers=[],this.setTargetSize(r)}get visibilityTexture(){return this._isEnabled?this._currentVisibilityTexture:this._noCollidingVisibilityTexture}get noCollidingVisibilityTexture(){return this._noCollidingVisibilityTexture}setEnabled(t){this._isEnabled=t,this._renderLoop.update()}setTargetSize(t){const e=3*ee(),i=Math.ceil(t.width/e),r=Math.ceil(t.height/e);this._directPriorityGridRenderer.setResolution(i,r),this._reversePriorityGridRenderer.setResolution(i,r),this._gridSamplerVertexBuffer&&this._destroyGridResources();const s=new Tr(i,r),n=this._context;this._gridSamplerVertexBuffer=n.createVertexBuffer(s.data.byteLength),this._gridSamplerVao=n.createVao([{attributeMapping:Ar,buffer:this._gridSamplerVertexBuffer}]),this._numberOfGridSamplers=s.numberOfSamplers,this._context.uploadDataToBuffer(this._gridSamplerVertexBuffer,s.data),re(t,this._prevTargetSize),this._gridHalfPxSizeUniform.x=.5/i,this._gridHalfPxSizeUniform.y=.5/r}updateVisibilityIfNeeded(){if(!this._isEnabled||!this._isDirty)return;this._isDirty=!1;const t=this._stabilityShift;_t(this._camera.center,t),t.z=0,function(t,e,i=S(0,0,0)){const r=t[3]*e.x+t[7]*e.y+t[11]*e.z+t[15],s=(t[0]*e.x+t[4]*e.y+t[8]*e.z+t[12])/r,n=(t[1]*e.x+t[5]*e.y+t[9]*e.z+t[13])/r,o=(t[2]*e.x+t[6]*e.y+t[10]*e.z+t[14])/r;i.x=s,i.y=n,i.z=o}(hs(this._camera),t,t),t.x%=4*this._gridHalfPxSizeUniform.x,t.y%=4*this._gridHalfPxSizeUniform.y;const e=this._currentVisibilityTexture,i=this._currentVisibilityBuffer,r=this._prevVisibilityTexture,s=this._prevVisibilityBuffer,n=this._overlapsTexture,o=this._overlapsBuffer,a=this._sceneTexture,c=this._sceneBuffer;this._currentVisibilityBuffer=s,this._currentVisibilityTexture=r,this._prevVisibilityBuffer=i,this._prevVisibilityTexture=e,this._clearVisibility(s),this._clearVisibility(c),this._resetRemoved.render(c,this._resetRemovedRenderers,this._idHalfPxSizeUniform);const h=this._camera.zoom/this._camera.options.maxZoom,l=this._camera.tilt,d=this._camera.azimuth/(2*Math.PI),u=hs(this._camera),f=jr(this._camera),_=this._directPriorityGridRenderer.updateGrid(u,f,this._colorIdRenderers,t,e,n,a,h,l,d),p=this._reversePriorityGridRenderer.updateGrid(u,f,this._colorIdRenderers,t,e,n,a,h,l,d),m=Wt(),g=this._lastRenderTimeInLoop,y=-1!==g,v=m-this._lastSceneUpdateTime>this.fadeEffectDuration||y&&m-g>this.fadeEffectDuration,b=v?1:y?(m-g)/this.fadeEffectDuration:(m-this._lastSceneUpdateTime)/this.fadeEffectDuration;this._animationTicksCount++;const x=this._idHalfPxSizeUniform,w=this._gridSamplerVao,A=this._numberOfGridSamplers;this._makeAllOverlapped.render(o),this._findOverlaps.render(o,w,A,_,p,x),this._computeVisibility.render(s,e,n,a,b,h,l,d),v&&this._animationTicksCount>1?this._lastRenderTimeInLoop=-1:(this._renderLoop.update(),this._lastRenderTimeInLoop=m)}registerCollidingPrimitives(t,e,i){this._primitiveProviders.push(t),this._colorIdRenderers.push(e),this._resetRemovedRenderers.push(i),this._colorIdRenderers.sort((t,e)=>Number(t.options.clearDepth)-Number(e.options.clearDepth)),t.onUpdate.addListener(this._onSceneUpdate,this)}deregisterCollidingPrimitives(t,e,i){let r=this._primitiveProviders.indexOf(t);r>-1&&this._primitiveProviders.splice(r,1),r=this._colorIdRenderers.indexOf(e),r>-1&&this._colorIdRenderers.splice(r,1),r=this._resetRemovedRenderers.indexOf(i),r>-1&&this._resetRemovedRenderers.splice(r,1),t.onUpdate.removeListener(this._onSceneUpdate)}destroy(){this._destroyGridResources(),this._directPriorityGridRenderer.destroy(),this._reversePriorityGridRenderer.destroy(),this._camera.onUpdate.removeListener(this._onSceneUpdate);for(const t of this._primitiveProviders)t.onUpdate.removeListener(this._onSceneUpdate)}_onSceneUpdate(){this._lastSceneUpdateTime=Wt(),this._animationTicksCount=0,this._renderLoop.update()}_onBeforeRender(){this._isDirty=!0}_clearVisibility(t){this._context.bindRenderState(us),this._context.bindRenderTarget(t),this._context.clearCurrentTarget(16384)}_createPlainTexture(t){const e=this._context.createEmpty2DTexture(1,1,6408,5121);return this._context.setTextureData(e,new Uint8Array([255*t.r,255*t.g,255*t.b,255*t.a])),e}_destroyGridResources(){this._gridSamplerVertexBuffer.destroy(),this._gridSamplerVao.destroy()}}const gs=8/ee(),ys=ie(128,128);function vs(t){return 128*Math.ceil(t/gs/128)}class bs{constructor(t,e,i){this._context=t,this._renderer=e,this._renderLoop=i,this._tileCache=new Map,this._isDirty=!0,this._allocateResources(),this._lastRenderTime=0}destroy(){this._deleteResources()}updateSize(){this._deleteResources(),this._allocateResources(),this.setDirty()}setDirty(){this._isDirty||(this._isDirty=!0,this._tileCache.clear())}getIdAt(t){this._isDirty&&(!this._lastRenderTime||Wt()-this._lastRenderTime>100)&&(this._lastRenderTime=Wt(),this._renderer.renderHitTestBuffer(this._framebuffer),this._renderLoop.update(),this._tileCache.clear(),this._isDirty=!1);const e=this._context,i=this._framebuffer,r=e.getDefaultRenderTarget().size,s=t.x/r.width,n=1-t.y/r.height,o=s*i.size.width|0,a=n*i.size.height|0,c=ut(128*Math.floor(o/128),128*Math.floor(a/128)),h=c.x<<16|c.y;let l=this._tileCache.get(h);return l||(e.bindRenderTarget(i),l=new Uint32Array(i.readPixels(ys,c).buffer),this._renderLoop.update(),this._tileCache.set(h,l)),l[128*(a-c.y)+(o-c.x)]}_deleteResources(){this._framebuffer.destroy(),this._colorBuffer.destroy(),this._depthBuffer.destroy()}_allocateResources(){const t=this._context,{width:e,height:i}=t.getDefaultRenderTarget().size,r=vs(e),s=vs(i);this._colorBuffer=t.createEmpty2DTexture(r,s,6408,5121),this._depthBuffer=t.createRenderbuffer(r,s,34041),this._framebuffer=t.createFramebuffer({color:this._colorBuffer,depthStencil:this._depthBuffer})}}class xs extends Error{constructor(){super("Base render unit is not in the list")}}class ws{constructor(){this.onUpdate=this._onUpdate=new s,this._subRenderUnits=[]}addRenderUnit(t){this._subRenderUnits.push(t),t.onUpdate.addListener(this._onSubRenderUnitUpdate,this),this._onUpdate.fire()}removeRenderUnit(t){const e=this._subRenderUnits.indexOf(t);-1!==e&&(this._subRenderUnits.splice(e,1),t.onUpdate.removeListener(this._onSubRenderUnitUpdate),this._onUpdate.fire())}addRenderUnitAbove(t,e){const i=this._subRenderUnits.indexOf(t);if(-1===i)throw new xs;this._subRenderUnits.splice(i+1,0,e),e.onUpdate.addListener(this._onSubRenderUnitUpdate,this)}addRenderUnitBelow(t,e){const i=this._subRenderUnits.indexOf(t);if(-1===i)throw new xs;this._subRenderUnits.splice(i,0,e),e.onUpdate.addListener(this._onSubRenderUnitUpdate,this)}render(t,...e){for(const i of this._subRenderUnits)i.render(t,...e)}renderHitTestBuffer(t,...e){for(const i of this._subRenderUnits)i.renderHitTestBuffer(t,...e)}_onSubRenderUnitUpdate(){this._onUpdate.fire()}}const As=new pr({clearDepth:-1,depthTest:!0,depthFunc:518}),Ts=new pr(Object.assign(Object.assign({},As),{clearColor:Qi})),Ss={r:0,g:0,b:0,a:0};class Ps extends ws{constructor(t,e){super(),this._context=t,this._camera=e,this.onRender=this._onRender=new s,this.setBackgroundColor(Ss)}render(t){const e=hs(this._camera),i=jr(this._camera);this._context.bindRenderTarget(t),this._context.bindRenderState(this._renderState),this._context.clearCurrentTarget(17664);for(const r of this._subRenderUnits)r.render(t,e,i);this._onRender.fire()}renderHitTestBuffer(t){const e=hs(this._camera),i=jr(this._camera);this._context.bindRenderTarget(t),this._context.bindRenderState(Ts),this._context.clearCurrentTarget(17664);for(const r of this._subRenderUnits)r.renderHitTestBuffer(t,e,i)}setBackgroundColor(t){this._renderState=new pr(As,{clearColor:t})}}class Rs extends h{}function Ms(t,e){return e<<16|65535&t}function Cs(t){return gr(.25*(t+2))}class zs extends class{constructor(t){this._bufferDataProvider=t,this._currentMeshWrittenVertices=0}endMesh(){return this._currentMeshWrittenVertices=0,this._currentBufferData.endMesh()}writeIndices(t){this._ensureEnoughIndexBufferSpace(t.length),this._currentBufferData.writeIndices(t)}writeVertex(...t){return this._ensureEnoughVertexBufferSpace(),this._writeVertex(this._currentBufferData,...t),this._currentMeshWrittenVertices++}_ensureEnoughVertexBufferSpace(t=1){this._currentBufferData||this._requestNewBuffer();const e=this._currentBufferData.vertexBuffer,i=t*e.vertexByteSize;if(e.occupiedByteSize+i>e.byteSize&&(this._requestNewBuffer(),i>this._currentBufferData.vertexBuffer.byteSize))throw new Error("Mesh is too big to write its vertices")}_ensureEnoughIndexBufferSpace(t){this._currentBufferData||this._requestNewBuffer();const e=this._currentBufferData.indexBuffer;if(e.occupiedSize+t>e.size&&(this._requestNewBuffer(),t>this._currentBufferData.indexBuffer.size))throw new Error("Mesh is too big to write its indices")}_requestNewBuffer(){const t=this._currentBufferData;if(this._currentBufferData=this._bufferDataProvider(),t){if(0===t.vertexBuffer.currentMeshBaseIndex)throw new Error("Mesh is too big: tried to transfer the whole buffer");t.vertexBuffer.transferUnfinishedMesh(this._currentBufferData.vertexBuffer),t.indexBuffer.transferUnfinishedMesh(this._currentBufferData.indexBuffer,t.vertexBuffer.currentMeshBaseIndex)}}}{writeFakePrimitive(t,e,i){const r=this.writeVertex(t,e.minX,e.minY,i),s=this.writeVertex(t,e.minX,e.maxY,i),n=this.writeVertex(t,e.maxX,e.minY,i),o=this.writeVertex(t,e.maxX,e.maxY,i);return this.writeIndices([r,n,s,s,n,o]),this.endMesh()}_writeVertex(t,e,i,r,s){(function(t,e){const i=Cs(e.x),r=Cs(e.y);t.writeVertexUint32(function(t,e){return Ms(t>>>16,e>>>16)}(i,r)),t.writeVertexUint32(function(t,e){return Ms(t,e)}(i,r))})(t,e),t.writeVertexUint32(Ms(i,r)),t.writeVertexUint32(s)}}Error;class Os{constructor(t,e){this._wordByteSize=e,this._nextWordOffset=0,this._currentMeshByteOffset=0,this._uint8View=new Uint8Array(t)}get data(){return this._uint8View.buffer}get byteSize(){return this._uint8View.byteLength}get occupiedByteSize(){return this._nextWordOffset*this._wordByteSize}endMesh(){const t=this._currentMeshByteOffset,e=this.occupiedByteSize,i=e-t;return this._currentMeshByteOffset=e,{byteOffset:t,byteSize:i}}transferUnfinishedMesh(t){const e=this.occupiedByteSize,i=e-this._currentMeshByteOffset,r=this._uint8View.subarray(this._currentMeshByteOffset,e);t._uint8View.set(r,0),t._nextWordOffset=i/this._wordByteSize,this._nextWordOffset=this._currentMeshByteOffset/this._wordByteSize}reset(){this._nextWordOffset=0,this._currentMeshByteOffset=0}}class Ls extends Os{constructor(t,e){super(t*e,Uint32Array.BYTES_PER_ELEMENT),this.vertexByteSize=e,this._uint32View=new Uint32Array(this._uint8View.buffer),this._float32View=new Float32Array(this._uint8View.buffer),this._currentMeshBaseIndex=0}get currentMeshBaseIndex(){return this._currentMeshBaseIndex}get isFull(){return this._nextWordOffset>=this._uint32View.length}pushUint32(t){this._uint32View[this._nextWordOffset++]=t}pushFloat32(t){this._float32View[this._nextWordOffset++]=t}asUint32Array(){return this._uint32View.subarray(0,this._nextWordOffset)}endMesh(){return this._currentMeshBaseIndex=this.occupiedByteSize/this.vertexByteSize,super.endMesh()}reset(){this._currentMeshBaseIndex=0,super.reset()}}class ks extends Os{constructor(t){const e=Uint16Array.BYTES_PER_ELEMENT;super(t*e,e),this._uint16View=new Uint16Array(this._uint8View.buffer)}get size(){return this._uint16View.length}get occupiedSize(){return this._nextWordOffset}push(t){this._uint16View[this._nextWordOffset++]=t}asUint16Array(){return this._uint16View.subarray(0,this._nextWordOffset)}transferUnfinishedMesh(t,e=0){if(super.transferUnfinishedMesh(t),e)for(let i=0;i<t._nextWordOffset;i++)t._uint16View[i]-=e}}class Is{constructor(t,e,i,r){this.id=t,this.vertexBuffer=new Ls(e,i),this.indexBuffer=new ks(r),this.onMeshWritten=this._onMeshWritten=new s}writeVertexUint32(t){this.vertexBuffer.pushUint32(t)}writeVertexFloat32(t){this.vertexBuffer.pushFloat32(t)}writeIndices(t){const e=this.vertexBuffer.currentMeshBaseIndex;for(const i of t)this.indexBuffer.push(e+i)}endMesh(){const t=this.vertexBuffer.endMesh(),e=this.indexBuffer.endMesh(),i={vertexByteOffset:t.byteOffset,vertexByteLength:t.byteSize,indexByteOffset:e.byteOffset,indexByteLength:e.byteSize,indexType:5123,bufferId:this.id};return this._onMeshWritten.fire(i),i}reset(){this.vertexBuffer.reset(),this.indexBuffer.reset()}}const Es={vertexMinByte:Number.MAX_SAFE_INTEGER,vertexMaxByte:Number.MIN_SAFE_INTEGER,indexMinByte:Number.MAX_SAFE_INTEGER,indexMaxByte:Number.MIN_SAFE_INTEGER};class Bs extends class{constructor(){this.onReleased=this._onReleased=new s,this.onRetain=this._onRetain=new s,this._clients=0}get isRetained(){return 0!==this._clients}retain(){++this._clients,this._onRetain.fire(this)}release(){this._clients>0&&(--this._clients,0===this._clients&&this._onReleased.fire(this))}}{constructor(t,e,i,r,n){super(),this.id=t,this.attribMapping=e,this.data=new Is(t,i,r,n),this.data.onMeshWritten.addListener(this._onMeshWritten,this),this.onUpdate=this._onUpdate=new s,this._updatedRegion=Object.assign({},Es)}reset(){this.data.reset(),this.flushUpdatedRegion()}touch(t){this._onMeshWritten(t)}flushUpdatedRegion(){const t=this._updatedRegion;return this._updatedRegion=Object.assign({},Es),t}_onMeshWritten(t){t.vertexByteOffset<this._updatedRegion.vertexMinByte&&(this._updatedRegion.vertexMinByte=t.vertexByteOffset);const e=t.vertexByteOffset+t.vertexByteLength;e>this._updatedRegion.vertexMaxByte&&(this._updatedRegion.vertexMaxByte=e),t.indexByteOffset<this._updatedRegion.indexMinByte&&(this._updatedRegion.indexMinByte=t.indexByteOffset);const i=t.indexByteOffset+t.indexByteLength;i>this._updatedRegion.indexMaxByte&&(this._updatedRegion.indexMaxByte=i),this._onUpdate.fire(this)}}class Us{constructor(t){this._communicator=t,this._updatedPages=new Set,this._pages=new Map,this._freePages=new Map,this._lastGeneratedPageId=0}getPage(t){return this._pages.get(t)}getFreeOrCreatePage(t){const e=this._freePages.get(t),i=e&&e.pop();if(i)return i.reset(),i;{const e=this._generateId(),i=new Bs(e,t,65536,t.vertexByteSize,131072);return i.onUpdate.addListener(this._onPageUpdated,this),i.onReleased.addListener(this._onPageReleased,this),this._pages.set(e,i),this._communicator.sendMessage({type:It.FROM_BACKEND_ADD_PAGE,id:e,attribMapping:t,vertexDataByteSize:i.data.vertexBuffer.byteSize,indexDataByteSize:i.data.indexBuffer.byteSize},!1),i}}flushBackendUpdates(){for(const t of this._updatedPages){const{vertexMinByte:e,vertexMaxByte:i,indexMinByte:r,indexMaxByte:s}=t.flushUpdatedRegion(),n=t.data.vertexBuffer.data.slice(e,i),o=t.data.indexBuffer.data.slice(r,s);this._communicator.sendMessage({type:It.FROM_BACKEND_UPDATE_PAGE,id:t.id,vertexData:n,vertexByteOffset:e,indexData:o,indexByteOffset:r},!1,n,o)}this._updatedPages.clear()}_onPageUpdated(t){this._updatedPages.add(t)}_onPageReleased(t){const e=this._freePages.get(t.attribMapping);e?e.push(t):this._freePages.set(t.attribMapping,[t])}_generateId(){return this._lastGeneratedPageId++}}const Ds=Bi([[0,{size:2,type:5123,normalized:!1}],[1,{size:2,type:5123,normalized:!1}],[6,{size:2,type:5122,normalized:!1}],[2,{size:4,type:5121,normalized:!1}]]);var js=i(2),Vs=i.n(js);function Fs(t,e){switch(e){case 5123:return t>>1;case 5125:return t>>2;default:return-1}}function Ns(t,e){return e.indexByteOffset+e.indexByteLength===t.indexByteOffset&&(e.indexByteLength+=t.indexByteLength,!0)}function qs(t,e,i){return function*(t,e,i,r=(()=>!0),s=Ns){const n=t[Symbol.iterator]();let o=n.next().value;if(!o)return;let a=o,c=i(a);for(o=n.next().value;o;){const t=e(o);r(a,o,c)&&s(t,c)||(yield c,c=i(o)),a=o,o=n.next().value}yield c}(t,t=>t.location,t=>Object.assign({firstPrimitive:t},t.location),(t,i)=>!(t.vao!==i.vao||e&&!e(t,i)),i)}class Hs extends Sr{constructor(t,e,i,r,n,o){super(e,i,r,n,o),this.primitiveProvider=t,this.onUpdate=this._onUpdate=new s,this._updateListener=()=>this._onUpdate.fire(),this.primitiveProvider.onUpdate.addListener(this._updateListener),this._canBatchPredicate=this._canBatchAdjacentPrimitives.bind(this)}destroy(){this.primitiveProvider.onUpdate.removeListener(this._updateListener),super.destroy()}_render(t,e){const i=this._program;for(const r of e){i.setVector2Uniform("lookAtHigh",r.lookAtHigh),i.setVector2Uniform("lookAtLow",r.lookAtLow);for(const t of qs(this._getPrimitives(),this._canBatchPredicate))this._renderBatch(t,i)}}_renderHitTestBuffer(t,e){const i=this._hitTestProgram;for(const r of e){i.setVector2Uniform("lookAtHigh",r.lookAtHigh),i.setVector2Uniform("lookAtLow",r.lookAtLow);for(const t of qs(this._getHitTestPrimitives(),this._canBatchPredicate))this._renderHitTestBufferBatch(t,i)}}_getPrimitives(){return this.primitiveProvider.primitives}_getHitTestPrimitives(){return this.primitiveProvider.primitives}_prepareProgram(t,e,i,...r){super._prepareProgram(t,e,i,...r),t.setMatrix4Uniform("viewProjMatrix",e)}_prepareHitTestProgram(t,e,i,...r){super._prepareProgram(t,e,i,...r),t.setMatrix4Uniform("viewProjMatrix",e)}_renderBatch(t,e){this._context.bindVao(t.firstPrimitive.vao),this._context.drawIndexedMesh(t.indexByteOffset,Fs(t.indexByteLength,t.indexType))}_renderHitTestBufferBatch(t,e){this._context.bindVao(t.firstPrimitive.vao),this._context.drawIndexedMesh(t.indexByteOffset,Fs(t.indexByteLength,t.indexType))}_canBatchAdjacentPrimitives(t,e){return!0}}class Ws extends Hs{constructor(t,e,i,r=Gs){super(t,e,new pr,i),this.options=r}_getPrimitives(){return this.primitiveProvider.visiblePrimitives}_prepareProgram(t,e,i,r,s,n,o,a,c,h,l){super._prepareProgram(t,e,i,r,s,n,o,a,c,h,l),this._context.bindTextureUnit(0),this._context.bindTexture(n),this._context.bindTextureUnit(1),this._context.bindTexture(o),this._context.bindTextureUnit(2),this._context.bindTexture(a),t.setIntScalarUniform("visibility",0),t.setIntScalarUniform("overlap",1),t.setIntScalarUniform("scene",2),t.setVector2Uniform("idHalfPxSize",n.getHalfPxSize()),t.setVector2Uniform("shift",s),t.setScalarUniform("currentZoom",c),t.setScalarUniform("currentTilt",h),t.setScalarUniform("currentAzimuth",l)}_prepareRenderTarget(t,e,i,r,s,n,o){this._context.bindRenderState(r),this._context.bindRenderTarget(t),this.options.clearDepth&&this._context.clearCurrentTarget(256)}}const Gs={clearDepth:!1},Xs={attribMap:{vertexPosHigh:0,vertexPosLow:1,vertexDisplacement:6,vertexId:2}};class Ys extends Ws{constructor(t,e,i,r){super(t,e,e.createProgram(Vs.a,qr.a,Xs),r),this._camera=i}_prepareProgram(t,e,i,r,s,n,o,a,c,h,l){super._prepareProgram(t,e,i,r,s,n,o,a,c,h,l),t.setVector2Uniform("pixelSize",this._camera.pixelSize)}}var Zs=i(16),Ks=i.n(Zs),Qs=i(17),$s=i.n(Qs);class Js extends Sr{constructor(t,e){const i=e.createProgram(Ks.a,$s.a,{attribMap:{vertexId:2}});super(e,new pr,i),this._primitiveProvider=t}_render(){const t=this._primitiveProvider.primitives;for(const e of qs(t))this._context.bindVao(e.firstPrimitive.vao),this._context.drawIndexedMesh(e.indexByteOffset,Fs(e.indexByteLength,e.indexType),0)}_prepareProgram(t,e){super._prepareProgram(t,e),t.setVector2Uniform("idHalfPxSize",e)}}class tn{constructor(){this.onMessage=this._onMessage=new s}sendMessage(t,e){this.peerCommunicator&&this.peerCommunicator._onMessage.fire(t)}}class en{constructor(t,e,i,r){this._pageRegistryCommunicators=function(){const t=new tn,e=new tn;return t.peerCommunicator=e,e.peerCommunicator=t,{master:t,worker:e}}(),this._pageRegistry=new Et(this._pageRegistryCommunicators.master,t),this._pageRegistryBackend=new Us(this._pageRegistryCommunicators.worker),this._bufferWriter=new zs(function(t,e){let i;return()=>{i&&setTimeout(t=>t.release(),0,i),i=t.getFreeOrCreatePage(e),i.retain();const r=t=>{t.release(),t.onRetain.removeListener(r)};return i.retain(),i.onRetain.addListener(r),i.data}}(this._pageRegistryBackend,Ds)),this._visibilityManager=i,this._fakePrimitiveStorage=new we,this._fakePrimitiveColorIdRenderer=new Ys(this._fakePrimitiveStorage,t,e),this._fakePrimitiveResetRemovedRenderer=new Js(this._fakePrimitiveStorage,t),this._visibilityManager.registerCollidingPrimitives(this._fakePrimitiveStorage,this._fakePrimitiveColorIdRenderer,this._fakePrimitiveResetRemovedRenderer),this._idGenerator=r,this._primitives=new Map}destructor(){this._visibilityManager.deregisterCollidingPrimitives(this._fakePrimitiveStorage,this._fakePrimitiveColorIdRenderer,this._fakePrimitiveResetRemovedRenderer),this._fakePrimitiveResetRemovedRenderer.destroy(),this._fakePrimitiveColorIdRenderer.destroy(),this._pageRegistry.destructor()}addPrimitives(...t){const e=t.map(({anchor:t,rect:e})=>{const i=this._idGenerator();return{id:i,location:this._bufferWriter.writeFakePrimitive(t,e,i)}});this._pageRegistryBackend.flushBackendUpdates();const i=e.map(({location:t,id:e})=>{const i=this._pageRegistry.getPage(t.bufferId);if(!i)throw new Error("No page for created fake primitive");return new Rs(i.vao,t,e)});return this._fakePrimitiveStorage.add(i),this._createCollidingPrimitives(i)}removePrimitives(...t){const e=[];for(const i of t){const t=this._primitives.get(i);t&&(e.push(t),this._primitives.delete(i))}this._fakePrimitiveStorage.delete(e)}clear(){this.removePrimitives(...this._primitives.keys())}_createCollidingPrimitives(t){return t.map(t=>{const e={};return this._primitives.set(e,t),e})}}const rn={min:1,max:511};class sn{constructor(t,e,i,r=new ms(t,e,i,t.getDefaultRenderTarget().size)){this.camera=e,this.context=t,this._renderTarget=t.getDefaultRenderTarget(),this.renderer=new Ps(t,e),this.renderLoop=i,this._hitTestManager=new bs(t,this.renderer,i),this.visibilityManager=r,this.visibilityTextureProvider=()=>(this.visibilityManager.updateVisibilityIfNeeded(),this.visibilityManager.visibilityTexture),this.invisibleCollidingPrimitiveManager=new en(t,e,r,function({min:t,max:e}){let i=0;return()=>i++%(e-t+1)+t}(rn)),this._onRender=this._onRender.bind(this),i.onRender.addListener(this._onRender),this.onInternalError=this._onInternalError=new s,this.camera.onUpdate.addListener(this._onUpdate,this),this.renderer.onUpdate.addListener(this._onUpdate,this),this.context.onLoss.addListener(this._onContextLost,this)}setRenderTargetSize(t){se(this._renderTarget.size,t)||(this._renderTarget.size=t,this.visibilityManager.setTargetSize(t),this._hitTestManager.updateSize())}destroy(){this.camera.onUpdate.removeListener(this._onUpdate),this.renderer.onUpdate.removeListener(this._onUpdate),this.context.onLoss.removeListener(this._onContextLost),this.invisibleCollidingPrimitiveManager.destructor()}getObjectIdAt(t){return this._hitTestManager.getIdAt(t)}setBackgroundColor(t){this.renderer.setBackgroundColor(t),this.renderLoop.update()}_onUpdate(){this.renderLoop.update()}_onRender(){this.visibilityManager.updateVisibilityIfNeeded(),this.renderer.render(this._renderTarget),this._hitTestManager.setDirty()}_onContextLost(){this._onInternalError.fire()}}const nn={wrapModeX:1,wrapModeY:1,minZoom:0,maxZoom:24,fov:et(30),maxTilt:et(40),minTilt:et(0),noTiltMaxZoom:1};class on{constructor(t){this.options=Object.assign(Object.assign({},nn),t),this.center=new on._Center(this),this.onUpdate=this._onUpdate=new s;const e=new on._ScreenSize(this);this.screenSize=e,this._zoom=this.options.minZoom,this._fov=this.options.fov,this._tilt=this._azimuth=0,this._pixelSize=ut(0,0),this._updateVersion=0,this._updateVersionLastFlushed=0}get aspectRatio(){const{width:t,height:e}=this.screenSize;return 0!==e?t/e:1}get zoom(){return this._zoom}set zoom(t){(t=Ft(t,this.options.minZoom,this.options.maxZoom))!==this._zoom&&(this._zoom=t,this.tilt=this._tilt,this._updateVersion++)}get fov(){return this._fov}get tilt(){return this._tilt}set tilt(t){const{minTilt:e,maxTilt:i,noTiltMaxZoom:r}=this.options,s=function(t,e,i){const r=Ft((i-t)/(e-t),0,1);return r*r*(3-2*r)}(r,r+cn,this._zoom);t=Ft(t,e*s,i*s),this._tilt!==t&&(this._tilt=t,this._updateVersion++)}get azimuth(){return this._azimuth}set azimuth(t){t=Nt(t,0,2*Math.PI),this._azimuth!==t&&(this._azimuth=t,this._updateVersion++)}get pixelSize(){return this._pixelSize}get updateVersion(){return this._updateVersion}flushUpdates(){this._updateVersionLastFlushed<this._updateVersion&&(this._onUpdate.fire(),this._updateVersionLastFlushed=this._updateVersion)}}function an(t,e){switch(t){case 0:return e;case 1:return Ft(e,-1,1);case 2:return Nt(e,-1,1)}}on._Center=class{constructor(t){this._camera=t,this._x=this._y=0}get x(){return this._x}set x(t){t=an(this._camera.options.wrapModeX,t),this._x!==t&&(this._x=t,this._camera._updateVersion++)}get y(){return this._y}set y(t){t=an(this._camera.options.wrapModeY,t),this._y!==t&&(this._y=t,this._camera._updateVersion++)}},on._ScreenSize=class{constructor(t){this._camera=t,this._width=this._height=0}get width(){return this._width}set width(t){this._width!==t&&(this._width=t,this._camera._pixelSize.x=2/this._width,this._camera._updateVersion++)}get height(){return this._height}set height(t){this._height!==t&&(this._height=t,this._camera._pixelSize.y=2/this._height,this._camera._updateVersion++)}};const cn=1;class hn{constructor(t,e,i){this._gl=t,this._target=e,this._handle=t.createBuffer(),this._size=i}get size(){return this._size}bind(){this._gl.bindBuffer(this._target,this._handle)}isBound(){const t=this._gl,e=this._handle;switch(this._target){case t.ARRAY_BUFFER:return t.getParameter(t.ARRAY_BUFFER_BINDING)===e;case t.ELEMENT_ARRAY_BUFFER:return t.getParameter(t.ELEMENT_ARRAY_BUFFER_BINDING)===e}return!1}getTarget(){return this._target}getSize(){return this._size}destroy(){this._gl.deleteBuffer(this._handle)}}class ln{constructor(t,e){this.isClear=!1,this._gl=t,this._handle=t.createFramebuffer(),this.size=re(e)}bind(){const t=this._gl;t.bindFramebuffer(t.FRAMEBUFFER,this._handle)}isBound(){const t=this._gl;return t.getParameter(t.FRAMEBUFFER_BINDING)===this._handle}readPixels(t=this.size,e=ft,i=new Uint8Array(t.width*t.height*4)){return this._gl.readPixels(e.x,e.y,t.width,t.height,6408,5121,i),i}destroy(){this._gl.deleteFramebuffer(this._handle)}}function dn(t,e){const i=Object.keys(e).map(t=>"#define "+t+" "+e[t]).join("\n"),r=t.indexOf("#version");if(-1===r)return i+"\n"+t;const s=t.indexOf("\n",r)+1;return t.slice(0,s)+i+"\n"+t.slice(s)}function un(t,e,i){const r=t.createShader(e);return t.shaderSource(r,i),t.compileShader(r),r}class fn{constructor(t,e,i,r){this._gl=t;const s=this._handle=t.createProgram();r&&r.defines&&(e=dn(e,r.defines),i=dn(i,r.defines));const n=un(t,t.VERTEX_SHADER,e),o=un(t,t.FRAGMENT_SHADER,i);t.attachShader(s,n),t.attachShader(s,o),t.deleteShader(n),t.deleteShader(o),r&&r.attribMap&&Object.keys(r.attribMap).forEach(e=>t.bindAttribLocation(s,r.attribMap[e],e)),t.linkProgram(s),this._uniformCache=new Map}bind(){const t=this._gl,e=this._handle;t.useProgram(e)}isBound(){const t=this._gl;return t.getParameter(t.CURRENT_PROGRAM)===this._handle}setIntScalarUniform(t,e){const i=this._getUniformLocation(t);i&&this._gl.uniform1i(i,e)}setScalarUniform(t,e){const i=this._getUniformLocation(t);i&&this._gl.uniform1f(i,e)}setVector2Uniform(t,e){const i=this._getUniformLocation(t);i&&this._gl.uniform2f(i,e.x,e.y)}setVector3Uniform(t,e){const i=this._getUniformLocation(t);i&&this._gl.uniform3f(i,e.x,e.y,e.z)}setVector4Uniform(t,e){const i=this._getUniformLocation(t);i&&this._gl.uniform4f(i,e.x,e.y,e.z,e.w)}setColorUniform(t,e){const i=this._getUniformLocation(t);i&&this._gl.uniform4f(i,e.r,e.g,e.b,e.a)}setMatrix3Uniform(t,e){const i=this._getUniformLocation(t);i&&this._gl.uniformMatrix3fv(i,!1,e)}setMatrix4Uniform(t,e){const i=this._getUniformLocation(t);i&&this._gl.uniformMatrix4fv(i,!1,e)}destroy(){this._gl.deleteProgram(this._handle)}_getUniformLocation(t){const e=this._uniformCache;let i=e.get(t);return i||(i=this._gl.getUniformLocation(this._handle,t),e.set(t,i),i)?i:null}}class _n{constructor(t,e,i){this._gl=t,this._handle=t.createRenderbuffer(),this._width=e,this._height=i}bind(){const t=this._gl;t.bindRenderbuffer(t.RENDERBUFFER,this._handle)}isBound(){const t=this._gl;return t.getParameter(t.RENDERBUFFER_BINDING)===this._handle}attachToFramebuffer(t){const e=this._gl;e.framebufferRenderbuffer(e.FRAMEBUFFER,t,e.RENDERBUFFER,this._handle)}getWidth(){return this._width}getHeight(){return this._height}destroy(){this._gl.deleteRenderbuffer(this._handle)}}class pn{constructor(t){this._gl=t,this._paramValues=new Map}getAliasedLineWidthRange(){return this._getParam(33902)}getAliasedPointSizeRange(){return this._getParam(33901)}getMaxCombinedTextureImageUnits(){return this._getParam(35661)}getMaxCubeMapTextureSize(){return this._getParam(34076)}getMaxFragmentUniformVectors(){return this._getParam(36349)}getMaxRenderbufferSize(){return this._getParam(34024)}getMaxTextureImageUnits(){return this._getParam(34930)}getMaxTextureSize(){return this._getParam(3379)}getMaxVaryingVectors(){return this._getParam(36348)}getMaxVertexAttribs(){return this._getParam(34921)}getMaxVertexTextureImageUnits(){return this._getParam(35660)}getMaxVertexUniformVectors(){return this._getParam(36347)}getMaxViewportDims(){return this._getParam(3386)}getRenderer(){return this._getParam(7937)}getSubpixelBits(){return this._getParam(3408)}getVendor(){return this._getParam(7936)}getVersion(){return this._getParam(7938)}getUnmaskedVendor(){return this._getParam(37445)}getUnmaskedRenderer(){return this._getParam(37446)}_getParam(t){const e=this._paramValues;let i=e.get(t);return i||(i=this._gl.getParameter(t),e.set(t,i)),i}}const mn={wrapS:33071,wrapT:33071,magnificationFilter:9728,minificationFilter:9728,premultipliedAlpha:!1,unpackAlignment:4};class gn{constructor(t,e,i,r,s,n){const o=Object.assign(Object.assign({},mn),n);this._gl=t,this._format=r,this._type=s,this._params=o,this._width=e,this._height=i,this._halfPxSize=yn(e,i),this._handle=t.createTexture(),this._magnificationFilter=null,this._minificationFilter=null}initialize(){const t=this._gl;t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,this._params.wrapS),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,this._params.wrapT),this.setFilters(this._params.magnificationFilter,this._params.minificationFilter),t.texImage2D(t.TEXTURE_2D,0,this._format,this._width,this._height,0,this._format,this._type,null)}bind(){const t=this._gl;t.bindTexture(t.TEXTURE_2D,this._handle)}isBound(){const t=this._gl;return t.getParameter(t.TEXTURE_BINDING_2D)===this._handle}attachToFramebuffer(t){const e=this._gl;e.framebufferTexture2D(e.FRAMEBUFFER,t,e.TEXTURE_2D,this._handle,0)}getWidth(){return this._width}getHeight(){return this._height}getFormat(){return this._format}getType(){return this._type}getParams(){return this._params}getHalfPxSize(){return this._halfPxSize}setFilters(t=this._params.magnificationFilter,e=this._params.minificationFilter){const i=this._gl;this._magnificationFilter!==t&&(this._magnificationFilter=t,i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MAG_FILTER,t)),this._minificationFilter!==e&&(this._minificationFilter=e,i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MIN_FILTER,e))}resize({width:t,height:e}){this._width=t,this._height=e,this._halfPxSize=yn(t,e)}destroy(){this._gl.deleteTexture(this._handle)}}function yn(t,e){return ut(.5/t,.5/e)}class vn{constructor(t,e){this._gl=t,this._vaoExt=e,this._handle=e.createVertexArrayOES(),this.onDestroy=this._onDestroy=new s}bind(){this._vaoExt.bindVertexArrayOES(this._handle)}isBound(){return this._gl.getParameter(this._vaoExt.VERTEX_ARRAY_BINDING_OES)===this._handle}destroy(){this._vaoExt.deleteVertexArrayOES(this._handle),this._onDestroy.fire()}}const bn=new Float32Array([-1,-1,0,0,1,1,1,1,-1,1,0,1,-1,-1,0,0,1,-1,1,0,1,1,1,1]),xn=Bi([[0,{size:2,type:5126,normalized:!1}],[4,{size:2,type:5126,normalized:!1}]]);class wn{constructor(t){this.isClear=!1,this._gl=t}bind(){const t=this._gl;t.bindFramebuffer(t.FRAMEBUFFER,null)}setSize(t,e){const i=this._gl.canvas;i.width=t,i.height=e}get size(){return ie(this._gl.drawingBufferWidth,this._gl.drawingBufferHeight)}set size(t){const e=this._gl.canvas;e.width=t.width,e.height=t.height}destroy(){}}class An{constructor(t){this._gl=t,this.onLoss=this._onLoss=new s,this._contextLostListener=t=>{t.preventDefault(),this._onLoss.fire()},t.canvas.addEventListener("webglcontextlost",this._contextLostListener),this._capabilities=new pn(t);const e=t.getExtension("OES_vertex_array_object");if(!e)throw new Error("OES_vertex_array_object is required.");if(this._vaoExt=e,!t.getExtension("OES_standard_derivatives"))throw new Error("OES_standard_derivatives is required.");const i=this._boundRenderTarget=this._defaultRenderTarget=new wn(t),r=this._boundRenderState=new pr;this._unpackPremultiplyAlpha=!1,this._unpackAlignment=4;const{width:n,height:o}=i.size;r.scissorWidth=r.viewportWidth=n,r.scissorHeight=r.viewportHeight=o;const a=this._quadVertexBuffer=new hn(t,t.ARRAY_BUFFER,t.STATIC_DRAW);a.bind(),t.bufferData(t.ARRAY_BUFFER,bn,t.STATIC_DRAW),this._quadVao=this.createVao([{attributeMapping:xn,buffer:a}]),t.bindBuffer(t.ARRAY_BUFFER,null),this._boundProgram=null,this._boundVao=null,this._boundTextures=new Array(this._capabilities.getMaxCombinedTextureImageUnits()),this._boundTextures.fill(null),this._boundTextureUnit=0}getCapabilities(){return this._capabilities}createFramebuffer({color:t,depth:e,stencil:i,depthStencil:r}){const s=this._gl;let n=0,o=0;t?(n=t.getWidth(),o=t.getHeight()):e?(n=e.getWidth(),o=e.getHeight()):i?(n=i.getWidth(),o=i.getHeight()):r&&(n=r.getWidth(),o=r.getHeight());const a=new ln(s,ie(n,o));return this.bindRenderTarget(a),t&&t.attachToFramebuffer(s.COLOR_ATTACHMENT0),e&&e.attachToFramebuffer(s.DEPTH_ATTACHMENT),i&&i.attachToFramebuffer(s.STENCIL_ATTACHMENT),r&&r.attachToFramebuffer(s.DEPTH_STENCIL_ATTACHMENT),a}createRenderbuffer(t,e,i){const r=this._gl,s=new _n(r,t,e);return s.bind(),r.renderbufferStorage(r.RENDERBUFFER,i,t,e),s}createEmpty2DTexture(t,e,i,r,s){const n=new gn(this._gl,t,e,i,r,s);return this._setTextureDataUnpackParams(n.getParams()),this.bindTexture(n),n.initialize(),n}createProgram(t,e,i){return new fn(this._gl,t,e,i)}createVertexBuffer(t,e=35044){return this._createBuffer(this._gl.ARRAY_BUFFER,t,e)}createIndexBuffer(t,e=35044){return this._createBuffer(this._gl.ELEMENT_ARRAY_BUFFER,t,e)}uploadDataToBuffer(t,e,i=0){t.bind(),this._gl.bufferSubData(t.getTarget(),i,e)}createVao(t,e){const i=this._gl,r=new vn(i,this._vaoExt);r.bind(),e?e.bind():i.bindBuffer(i.ELEMENT_ARRAY_BUFFER,null);for(const{attributeMapping:s,buffer:n,stride:o}of t){n.bind();for(const[t,e]of s.attributes)i.enableVertexAttribArray(t),i.vertexAttribPointer(t,e.size,e.type,e.normalized,o||s.vertexByteSize,e.offset)}return this._vaoExt.bindVertexArrayOES(null),r}setTextureData(t,e,i={x:0,y:0},r={width:t.getWidth(),height:t.getHeight()}){const s=this._gl,n=t.getFormat(),o=t.getType(),a=t.getParams(),{width:c,height:h}=r;this._setTextureDataUnpackParams(a),this.bindTexture(t),s.texSubImage2D(s.TEXTURE_2D,0,i.x,i.y,c,h,n,o,e),this._onTextureDataUpdated(t)}setTextureDataFromDomElement(t,e,i={x:0,y:0}){const r=this._gl,s=t.getFormat(),n=t.getType(),o=t.getParams();this._setTextureDataUnpackParams(o),this.bindTexture(t),r.texSubImage2D(r.TEXTURE_2D,0,i.x,i.y,s,n,e),this._onTextureDataUpdated(t)}resizeTexture(t,e){const i=this._gl,r=t.getFormat(),s=t.getType(),n=t.getParams();t.resize(e),this._setTextureDataUnpackParams(n),this.bindTexture(t),i.texImage2D(i.TEXTURE_2D,0,r,e.width,e.height,0,r,s,null),this._onTextureDataUpdated(t)}getDefaultRenderTarget(){return this._defaultRenderTarget}clearCurrentTarget(t){t&&(this._gl.clear(t),this._boundRenderTarget.isClear=!0)}bindRenderTarget(t){this._boundRenderTarget!==t&&(t.bind(),this._boundRenderTarget=t);const{width:e,height:i}=t.size;this._setViewportState(new pr({viewportWidth:e,viewportHeight:i}))}bindRenderState(t){this._setColorBufferState(t),this._setBlendState(t),this._setCullFaceState(t),this._setFrontFaceState(t),this._setDepthTestState(t),this._setDitherState(t),this._setPolygonOffsetState(t),this._setAlphaToCoverageState(t),this._setSampleCoverageState(t),this._setStencilTestState(t),this._setScissorTestState(t),this._setViewportState(t)}bindProgram(t){this._boundProgram!==t&&(t.bind(),this._boundProgram=t)}bindVao(t){this._boundVao!==t&&(t?t.bind():this._vaoExt.bindVertexArrayOES(null),this._boundVao=t)}bindQuadVao(){this.bindVao(this._quadVao)}bindTextureUnit(t){const e=this._gl;this._boundTextureUnit!==t&&(e.activeTexture(e.TEXTURE0+t),this._boundTextureUnit=t)}bindTexture(t,e,i){const r=this._boundTextureUnit;this._boundTextures[r]!==t&&(t.bind(),this._boundTextures[r]=t),t.setFilters(e,i)}drawQuad(){this.drawMesh(0,6,4)}drawMesh(t,e,i=4){this._gl.drawArrays(i,t,e),this._boundRenderTarget.isClear=!1}drawIndexedMesh(t,e,i=4){const r=this._gl;r.drawElements(i,e,r.UNSIGNED_SHORT,t),this._boundRenderTarget.isClear=!1}destroy(){this._quadVao.destroy(),this._quadVertexBuffer.destroy(),this._gl.canvas.removeEventListener("webglcontextlost",this._contextLostListener)}static createFromCanvas(t,e){const i=t.getContext("webgl",e);if(!i)throw new Error("Failed to create GL context from canvas.");return new An(i)}_setCapabilityEnabled(t,e){e?this._gl.enable(t):this._gl.disable(t)}_setColorBufferState(t){const e=this._gl,i=this._boundRenderState,r=t.clearColor;var s,n;n=r,((s=i.clearColor).r!==n.r||s.g!==n.g||s.b!==n.b||s.a!==n.a)&&(e.clearColor(r.r,r.g,r.b,r.a),function(t,e=$i(0,0,0,0)){e.r=t.r,e.g=t.g,e.b=t.b,e.a=t.a}(r,i.clearColor)),i.colorMaskR===t.colorMaskR&&i.colorMaskG===t.colorMaskG&&i.colorMaskB===t.colorMaskB&&i.colorMaskAlpha===t.colorMaskAlpha||(this._gl.colorMask(t.colorMaskR,t.colorMaskG,t.colorMaskB,t.colorMaskAlpha),i.colorMaskR=t.colorMaskR,i.colorMaskG=t.colorMaskG,i.colorMaskB=t.colorMaskB,i.colorMaskAlpha=t.colorMaskAlpha)}_setBlendState(t){const e=this._gl,i=this._boundRenderState;i.blend!==t.blend&&(this._setCapabilityEnabled(e.BLEND,t.blend),i.blend=t.blend),t.blend&&(i.blendEquationRgb===t.blendEquationRgb&&i.blendEquationAlpha===t.blendEquationAlpha||(e.blendEquationSeparate(t.blendEquationRgb,t.blendEquationAlpha),i.blendEquationRgb=t.blendEquationRgb,i.blendEquationAlpha=t.blendEquationAlpha),i.blendFuncDstRgb===t.blendFuncDstRgb&&i.blendFuncSrcRgb===t.blendFuncSrcRgb&&i.blendFuncDstAlpha===t.blendFuncDstAlpha&&i.blendFuncSrcAlpha===t.blendFuncSrcAlpha||(e.blendFuncSeparate(t.blendFuncSrcRgb,t.blendFuncDstRgb,t.blendFuncSrcAlpha,t.blendFuncDstAlpha),i.blendFuncSrcRgb=t.blendFuncSrcRgb,i.blendFuncDstRgb=t.blendFuncDstRgb,i.blendFuncSrcAlpha=t.blendFuncSrcAlpha,i.blendFuncDstAlpha=t.blendFuncDstAlpha))}_setCullFaceState(t){const e=this._gl,i=this._boundRenderState;i.cullFace!==t.cullFace&&(this._setCapabilityEnabled(e.CULL_FACE,t.cullFace),i.cullFace=t.cullFace),t.cullFace&&i.cullFaceMode!==t.cullFaceMode&&(e.cullFace(t.cullFaceMode),i.cullFaceMode=t.cullFaceMode)}_setFrontFaceState(t){const e=this._boundRenderState;e.frontFaceMode!==t.frontFaceMode&&(this._gl.frontFace(t.frontFaceMode),e.frontFaceMode=t.frontFaceMode)}_setDepthTestState(t){const e=this._gl,i=this._boundRenderState;i.depthTest!==t.depthTest&&(this._setCapabilityEnabled(e.DEPTH_TEST,t.depthTest),i.depthTest=t.depthTest),t.depthTest&&(i.clearDepth!==t.clearDepth&&(e.clearDepth(t.clearDepth),i.clearDepth=t.clearDepth),i.depthMask!==t.depthMask&&(e.depthMask(t.depthMask),i.depthMask=t.depthMask),i.depthFunc!==t.depthFunc&&(e.depthFunc(t.depthFunc),i.depthFunc=t.depthFunc),i.depthRangeNear===t.depthRangeNear&&i.depthRangeFar===t.depthRangeFar||(e.depthRange(t.depthRangeNear,t.depthRangeFar),i.depthRangeNear=t.depthRangeNear,i.depthRangeFar=t.depthRangeFar))}_setDitherState(t){const e=this._boundRenderState;e.dither!==t.dither&&(this._setCapabilityEnabled(this._gl.DITHER,t.dither),e.dither=t.dither)}_setPolygonOffsetState(t){const e=this._gl,i=this._boundRenderState;i.polygonOffset!==t.polygonOffset&&(this._setCapabilityEnabled(e.POLYGON_OFFSET_FILL,t.polygonOffset),i.polygonOffset=t.polygonOffset),!t.polygonOffset||i.polygonOffsetFactor===t.polygonOffsetFactor&&i.polygonOffsetUnits===t.polygonOffsetUnits||(e.polygonOffset(t.polygonOffsetFactor,t.polygonOffsetUnits),i.polygonOffsetFactor=t.polygonOffsetFactor,i.polygonOffsetUnits=t.polygonOffsetUnits)}_setAlphaToCoverageState(t){const e=this._boundRenderState;e.sampleAlphaToCoverage!==t.sampleAlphaToCoverage&&(this._setCapabilityEnabled(this._gl.SAMPLE_ALPHA_TO_COVERAGE,t.sampleAlphaToCoverage),e.sampleAlphaToCoverage=t.sampleAlphaToCoverage)}_setSampleCoverageState(t){const e=this._gl,i=this._boundRenderState;i.sampleCoverage!==t.sampleCoverage&&(this._setCapabilityEnabled(e.SAMPLE_COVERAGE,t.sampleCoverage),i.sampleCoverage=t.sampleCoverage),!t.sampleCoverage||i.sampleCoverageValue===t.sampleCoverageValue&&i.sampleCoverageInvert===t.sampleCoverageInvert||(e.sampleCoverage(t.sampleCoverageValue,t.sampleCoverageInvert),i.sampleCoverageValue=t.sampleCoverageValue,i.sampleCoverageInvert=t.sampleCoverageInvert)}_setStencilTestState(t){const e=this._gl,i=this._boundRenderState;if(i.stencilTest!==t.stencilTest&&(this._setCapabilityEnabled(e.STENCIL_TEST,t.stencilTest),i.stencilTest=t.stencilTest),t.stencilTest){i.clearStencil!==t.clearStencil&&(e.clearStencil(t.clearStencil),i.clearStencil=t.clearStencil),i.stencilWriteMask!==t.stencilWriteMask&&(e.stencilMask(t.stencilWriteMask),i.stencilWriteMask=t.stencilWriteMask);const r=i.stencilMask!==t.stencilMask||i.stencilReference!==t.stencilReference;r&&(i.stencilMask=t.stencilMask,i.stencilReference=t.stencilReference),(i.stencilFrontFunc!==t.stencilFrontFunc||r)&&(e.stencilFuncSeparate(e.FRONT,t.stencilFrontFunc,t.stencilReference,t.stencilMask),i.stencilFrontFunc=t.stencilFrontFunc),(i.stencilBackFunc!==t.stencilBackFunc||r)&&(e.stencilFuncSeparate(e.BACK,t.stencilBackFunc,t.stencilReference,t.stencilMask),i.stencilBackFunc=t.stencilBackFunc),i.stencilFrontFailOp===t.stencilFrontFailOp&&i.stencilFrontDepthFailOp===t.stencilFrontDepthFailOp&&i.stencilFrontDepthPassOp===t.stencilFrontDepthPassOp||(e.stencilOpSeparate(e.FRONT,t.stencilFrontFailOp,t.stencilFrontDepthFailOp,t.stencilFrontDepthPassOp),i.stencilFrontFailOp=t.stencilFrontFailOp,i.stencilFrontDepthFailOp=t.stencilFrontDepthFailOp,i.stencilFrontDepthPassOp=t.stencilFrontDepthPassOp),i.stencilBackFailOp===t.stencilBackFailOp&&i.stencilBackDepthFailOp===t.stencilBackDepthFailOp&&i.stencilBackDepthPassOp===t.stencilBackDepthPassOp||(e.stencilOpSeparate(e.BACK,t.stencilBackFailOp,t.stencilBackDepthFailOp,t.stencilBackDepthPassOp),i.stencilBackFailOp=t.stencilBackFailOp,i.stencilBackDepthFailOp=t.stencilBackDepthFailOp,i.stencilBackDepthPassOp=t.stencilBackDepthPassOp)}}_setScissorTestState(t){const e=this._gl,i=this._boundRenderState;i.scissorTest!==t.scissorTest&&(this._setCapabilityEnabled(e.SCISSOR_TEST,t.scissorTest),i.scissorTest=t.scissorTest),t.scissorTest&&t.scissorWidth>=0&&t.scissorHeight>=0&&(i.scissorX!==t.scissorX||i.scissorY!==t.scissorY||i.scissorWidth!==t.scissorWidth||i.scissorHeight!==t.scissorHeight)&&(e.scissor(t.scissorX,t.scissorY,t.scissorWidth,t.scissorHeight),i.scissorX=t.scissorX,i.scissorY=t.scissorY,i.scissorWidth=t.scissorWidth,i.scissorHeight=t.scissorHeight)}_setViewportState(t){const e=this._boundRenderState;t.viewportWidth>=0&&t.viewportHeight>=0&&(e.viewportX!==t.viewportX||e.viewportY!==t.viewportY||e.viewportWidth!==t.viewportWidth||e.viewportHeight!==t.viewportHeight)&&(this._gl.viewport(t.viewportX,t.viewportY,t.viewportWidth,t.viewportHeight),e.viewportX=t.viewportX,e.viewportY=t.viewportY,e.viewportWidth=t.viewportWidth,e.viewportHeight=t.viewportHeight)}_setTextureDataUnpackParams(t){const e=this._gl;this._unpackPremultiplyAlpha!==t.premultipliedAlpha&&(e.pixelStorei(37441,+t.premultipliedAlpha),this._unpackPremultiplyAlpha=t.premultipliedAlpha),this._unpackAlignment!==t.unpackAlignment&&(e.pixelStorei(3317,t.unpackAlignment),this._unpackAlignment=t.unpackAlignment)}_onTextureDataUpdated(t){const e=this._gl;t.getParams().minificationFilter>=9984&&e.generateMipmap(e.TEXTURE_2D)}_createBuffer(t,e,i=this._gl.STATIC_DRAW){const r=this._gl,s=new hn(r,t,e);return this.bindVao(null),s.bind(),r.bufferData(t,e,i),s}}class Tn{constructor(t,e,i="GET",r={}){this._url=t,this._method=i,this._xhr=new XMLHttpRequest,this._xhr.responseType=e,r.withCredentials&&(this._xhr.withCredentials=!0)}get isCanceled(){return this._xhr.readyState===XMLHttpRequest.DONE&&0===this._xhr.status}send(){const t=this._xhr;return t.readyState!==XMLHttpRequest.UNSENT?Promise.reject(new Error("already sent")):new Promise((e,i)=>{t.open(this._method,this._url),t.onload=()=>{this.isCanceled||(200<=t.status&&t.status<300?e(this._prepareResponse(t.response)):i(new Error(`Failed request: ${t.status} ${t.statusText}, ${this._url}`)))},this._xhr.onerror=()=>{i(new Error("Failed request: "+this._url))},this._xhr.send()})}cancel(){this._xhr.readyState===XMLHttpRequest.UNSENT||this.isCanceled||this._xhr.abort()}}class Sn extends Tn{constructor(t,e="GET",i={}){super(t,"arraybuffer",e,i)}_prepareResponse(t){return t instanceof ArrayBuffer?t:new ArrayBuffer(0)}}class Pn extends Tn{constructor(t,e="GET",i={}){super(t,"json",e,i)}_prepareResponse(t){return t}}var Rn=function(t){return null!=t};function Mn(t){var e;this.name="DeveloperError",this.message=t;try{throw new Error}catch(i){e=i.stack}this.stack=e}Rn(Object.create)&&(Mn.prototype=Object.create(Error.prototype),Mn.prototype.constructor=Mn),Mn.prototype.toString=function(){var t=this.name+": "+this.message;return Rn(this.stack)&&(t+="\n"+this.stack.toString()),t},Mn.throwInstantiationError=function(){throw new Mn("This function defines an interface and should not be called directly.")};var Cn=Mn,zn={};function On(t,e,i){return"Expected "+i+" to be typeof "+e+", actual typeof was "+t}zn.typeOf={},zn.defined=function(t,e){if(!Rn(e))throw new Cn(function(t){return t+" is required, actual value was undefined"}(t))},zn.typeOf.func=function(t,e){if("function"!=typeof e)throw new Cn(On(typeof e,"function",t))},zn.typeOf.string=function(t,e){if("string"!=typeof e)throw new Cn(On(typeof e,"string",t))},zn.typeOf.number=function(t,e){if("number"!=typeof e)throw new Cn(On(typeof e,"number",t))},zn.typeOf.number.lessThan=function(t,e,i){if(zn.typeOf.number(t,e),e>=i)throw new Cn("Expected "+t+" to be less than "+i+", actual value was "+e)},zn.typeOf.number.lessThanOrEquals=function(t,e,i){if(zn.typeOf.number(t,e),e>i)throw new Cn("Expected "+t+" to be less than or equal to "+i+", actual value was "+e)},zn.typeOf.number.greaterThan=function(t,e,i){if(zn.typeOf.number(t,e),e<=i)throw new Cn("Expected "+t+" to be greater than "+i+", actual value was "+e)},zn.typeOf.number.greaterThanOrEquals=function(t,e,i){if(zn.typeOf.number(t,e),e<i)throw new Cn("Expected "+t+" to be greater than or equal to "+i+", actual value was "+e)},zn.typeOf.object=function(t,e){if("object"!=typeof e)throw new Cn(On(typeof e,"object",t))},zn.typeOf.bool=function(t,e){if("boolean"!=typeof e)throw new Cn(On(typeof e,"boolean",t))},zn.typeOf.bigint=function(t,e){if("bigint"!=typeof e)throw new Cn(On(typeof e,"bigint",t))},zn.typeOf.number.equals=function(t,e,i,r){if(zn.typeOf.number(t,i),zn.typeOf.number(e,r),i!==r)throw new Cn(t+" must be equal to "+e+", the actual values are "+i+" and "+r)};var Ln=zn;function kn(t,e){return null!=t?t:e}kn.EMPTY_OBJECT=Object.freeze({});var In=kn;function En(t){null==t&&(t=(new Date).getTime()),this.N=624,this.M=397,this.MATRIX_A=2567483615,this.UPPER_MASK=2147483648,this.LOWER_MASK=2147483647,this.mt=new Array(this.N),this.mti=this.N+1,this.init_genrand(t)}En.prototype.init_genrand=function(t){for(this.mt[0]=t>>>0,this.mti=1;this.mti<this.N;this.mti++)t=this.mt[this.mti-1]^this.mt[this.mti-1]>>>30,this.mt[this.mti]=(1812433253*((4294901760&t)>>>16)<<16)+1812433253*(65535&t)+this.mti,this.mt[this.mti]>>>=0},En.prototype.genrand_int32=function(){var t,e=new Array(0,this.MATRIX_A);if(this.mti>=this.N){var i;for(this.mti==this.N+1&&this.init_genrand(5489),i=0;i<this.N-this.M;i++)t=this.mt[i]&this.UPPER_MASK|this.mt[i+1]&this.LOWER_MASK,this.mt[i]=this.mt[i+this.M]^t>>>1^e[1&t];for(;i<this.N-1;i++)t=this.mt[i]&this.UPPER_MASK|this.mt[i+1]&this.LOWER_MASK,this.mt[i]=this.mt[i+(this.M-this.N)]^t>>>1^e[1&t];t=this.mt[this.N-1]&this.UPPER_MASK|this.mt[0]&this.LOWER_MASK,this.mt[this.N-1]=this.mt[this.M-1]^t>>>1^e[1&t],this.mti=0}return t=this.mt[this.mti++],t^=t>>>11,t^=t<<7&2636928640,t^=t<<15&4022730752,(t^=t>>>18)>>>0},En.prototype.random=function(){return this.genrand_int32()*(1/4294967296)};var Bn=En,Un={EPSILON1:.1,EPSILON2:.01,EPSILON3:.001,EPSILON4:1e-4,EPSILON5:1e-5,EPSILON6:1e-6,EPSILON7:1e-7,EPSILON8:1e-8,EPSILON9:1e-9,EPSILON10:1e-10,EPSILON11:1e-11,EPSILON12:1e-12,EPSILON13:1e-13,EPSILON14:1e-14,EPSILON15:1e-15,EPSILON16:1e-16,EPSILON17:1e-17,EPSILON18:1e-18,EPSILON19:1e-19,EPSILON20:1e-20,EPSILON21:1e-21,GRAVITATIONALPARAMETER:3986004418e5,SOLAR_RADIUS:6955e5,LUNAR_RADIUS:1737400,SIXTY_FOUR_KILOBYTES:65536,FOUR_GIGABYTES:4294967296};Un.sign=In(Math.sign,(function(t){return 0==(t=+t)||t!=t?t:t>0?1:-1})),Un.signNotZero=function(t){return t<0?-1:1},Un.toSNorm=function(t,e){return e=In(e,255),Math.round((.5*Un.clamp(t,-1,1)+.5)*e)},Un.fromSNorm=function(t,e){return e=In(e,255),Un.clamp(t,0,e)/e*2-1},Un.normalize=function(t,e,i){return 0===(i=Math.max(i-e,0))?0:Un.clamp((t-e)/i,0,1)},Un.sinh=In(Math.sinh,(function(t){return(Math.exp(t)-Math.exp(-t))/2})),Un.cosh=In(Math.cosh,(function(t){return(Math.exp(t)+Math.exp(-t))/2})),Un.lerp=function(t,e,i){return(1-i)*t+i*e},Un.PI=Math.PI,Un.ONE_OVER_PI=1/Math.PI,Un.PI_OVER_TWO=Math.PI/2,Un.PI_OVER_THREE=Math.PI/3,Un.PI_OVER_FOUR=Math.PI/4,Un.PI_OVER_SIX=Math.PI/6,Un.THREE_PI_OVER_TWO=3*Math.PI/2,Un.TWO_PI=2*Math.PI,Un.ONE_OVER_TWO_PI=1/(2*Math.PI),Un.RADIANS_PER_DEGREE=Math.PI/180,Un.DEGREES_PER_RADIAN=180/Math.PI,Un.RADIANS_PER_ARCSECOND=Un.RADIANS_PER_DEGREE/3600,Un.toRadians=function(t){if(!Rn(t))throw new Cn("degrees is required.");return t*Un.RADIANS_PER_DEGREE},Un.toDegrees=function(t){if(!Rn(t))throw new Cn("radians is required.");return t*Un.DEGREES_PER_RADIAN},Un.convertLongitudeRange=function(t){if(!Rn(t))throw new Cn("angle is required.");var e=Un.TWO_PI,i=t-Math.floor(t/e)*e;return i<-Math.PI?i+e:i>=Math.PI?i-e:i},Un.clampToLatitudeRange=function(t){if(!Rn(t))throw new Cn("angle is required.");return Un.clamp(t,-1*Un.PI_OVER_TWO,Un.PI_OVER_TWO)},Un.negativePiToPi=function(t){if(!Rn(t))throw new Cn("angle is required.");return t>=-Un.PI&&t<=Un.PI?t:Un.zeroToTwoPi(t+Un.PI)-Un.PI},Un.zeroToTwoPi=function(t){if(!Rn(t))throw new Cn("angle is required.");if(t>=0&&t<=Un.TWO_PI)return t;var e=Un.mod(t,Un.TWO_PI);return Math.abs(e)<Un.EPSILON14&&Math.abs(t)>Un.EPSILON14?Un.TWO_PI:e},Un.mod=function(t,e){if(!Rn(t))throw new Cn("m is required.");if(!Rn(e))throw new Cn("n is required.");if(0===e)throw new Cn("divisor cannot be 0.");return Un.sign(t)===Un.sign(e)&&Math.abs(t)<Math.abs(e)?t:(t%e+e)%e},Un.equalsEpsilon=function(t,e,i,r){if(!Rn(t))throw new Cn("left is required.");if(!Rn(e))throw new Cn("right is required.");i=In(i,0),r=In(r,i);var s=Math.abs(t-e);return s<=r||s<=i*Math.max(Math.abs(t),Math.abs(e))},Un.lessThan=function(t,e,i){if(!Rn(t))throw new Cn("first is required.");if(!Rn(e))throw new Cn("second is required.");if(!Rn(i))throw new Cn("absoluteEpsilon is required.");return t-e<-i},Un.lessThanOrEquals=function(t,e,i){if(!Rn(t))throw new Cn("first is required.");if(!Rn(e))throw new Cn("second is required.");if(!Rn(i))throw new Cn("absoluteEpsilon is required.");return t-e<i},Un.greaterThan=function(t,e,i){if(!Rn(t))throw new Cn("first is required.");if(!Rn(e))throw new Cn("second is required.");if(!Rn(i))throw new Cn("absoluteEpsilon is required.");return t-e>i},Un.greaterThanOrEquals=function(t,e,i){if(!Rn(t))throw new Cn("first is required.");if(!Rn(e))throw new Cn("second is required.");if(!Rn(i))throw new Cn("absoluteEpsilon is required.");return t-e>-i};var Dn=[1];Un.factorial=function(t){if("number"!=typeof t||t<0)throw new Cn("A number greater than or equal to 0 is required.");var e=Dn.length;if(t>=e)for(var i=Dn[e-1],r=e;r<=t;r++){var s=i*r;Dn.push(s),i=s}return Dn[t]},Un.incrementWrap=function(t,e,i){if(i=In(i,0),!Rn(t))throw new Cn("n is required.");if(e<=i)throw new Cn("maximumValue must be greater than minimumValue.");return++t>e&&(t=i),t},Un.isPowerOfTwo=function(t){if("number"!=typeof t||t<0||t>4294967295)throw new Cn("A number between 0 and (2^32)-1 is required.");return 0!==t&&0==(t&t-1)},Un.nextPowerOfTwo=function(t){if("number"!=typeof t||t<0||t>2147483648)throw new Cn("A number between 0 and 2^31 is required.");return--t,t|=t>>1,t|=t>>2,t|=t>>4,t|=t>>8,t|=t>>16,++t},Un.previousPowerOfTwo=function(t){if("number"!=typeof t||t<0||t>4294967295)throw new Cn("A number between 0 and (2^32)-1 is required.");return t|=t>>1,t|=t>>2,t|=t>>4,t|=t>>8,t|=t>>16,((t|=t>>32)>>>0)-(t>>>1)},Un.clamp=function(t,e,i){if(!Rn(t))throw new Cn("value is required");if(!Rn(e))throw new Cn("min is required.");if(!Rn(i))throw new Cn("max is required.");return t<e?e:t>i?i:t};var jn=new Bn;Un.setRandomNumberSeed=function(t){if(!Rn(t))throw new Cn("seed is required.");jn=new Bn(t)},Un.nextRandomNumber=function(){return jn.random()},Un.randomBetween=function(t,e){return Un.nextRandomNumber()*(e-t)+t},Un.acosClamped=function(t){if(!Rn(t))throw new Cn("value is required.");return Math.acos(Un.clamp(t,-1,1))},Un.asinClamped=function(t){if(!Rn(t))throw new Cn("value is required.");return Math.asin(Un.clamp(t,-1,1))},Un.chordLength=function(t,e){if(!Rn(t))throw new Cn("angle is required.");if(!Rn(e))throw new Cn("radius is required.");return 2*e*Math.sin(.5*t)},Un.logBase=function(t,e){if(!Rn(t))throw new Cn("number is required.");if(!Rn(e))throw new Cn("base is required.");return Math.log(t)/Math.log(e)},Un.cbrt=In(Math.cbrt,(function(t){var e=Math.pow(Math.abs(t),1/3);return t<0?-e:e})),Un.log2=In(Math.log2,(function(t){return Math.log(t)*Math.LOG2E})),Un.fog=function(t,e){var i=t*e;return 1-Math.exp(-i*i)},Un.fastApproximateAtan=function(t){return Ln.typeOf.number("x",t),t*(-.1784*Math.abs(t)-.0663*t*t+1.0301)},Un.fastApproximateAtan2=function(t,e){var i,r;Ln.typeOf.number("x",t),Ln.typeOf.number("y",e);var s=Math.abs(t);i=Math.abs(e),r=Math.max(s,i);var n=(i=Math.min(s,i))/r;if(isNaN(n))throw new Cn("either x or y must be nonzero");return s=Un.fastApproximateAtan(n),s=Math.abs(e)>Math.abs(t)?Un.PI_OVER_TWO-s:s,s=t<0?Un.PI-s:s,e<0?-s:s};var Vn=Un;function Fn(t,e,i){this.x=In(t,0),this.y=In(e,0),this.z=In(i,0)}Fn.fromSpherical=function(t,e){Ln.typeOf.object("spherical",t),Rn(e)||(e=new Fn);var i=t.clock,r=t.cone,s=In(t.magnitude,1),n=s*Math.sin(r);return e.x=n*Math.cos(i),e.y=n*Math.sin(i),e.z=s*Math.cos(r),e},Fn.fromElements=function(t,e,i,r){return Rn(r)?(r.x=t,r.y=e,r.z=i,r):new Fn(t,e,i)},Fn.clone=function(t,e){if(Rn(t))return Rn(e)?(e.x=t.x,e.y=t.y,e.z=t.z,e):new Fn(t.x,t.y,t.z)},Fn.fromCartesian4=Fn.clone,Fn.packedLength=3,Fn.pack=function(t,e,i){return Ln.typeOf.object("value",t),Ln.defined("array",e),i=In(i,0),e[i++]=t.x,e[i++]=t.y,e[i]=t.z,e},Fn.unpack=function(t,e,i){return Ln.defined("array",t),e=In(e,0),Rn(i)||(i=new Fn),i.x=t[e++],i.y=t[e++],i.z=t[e],i},Fn.packArray=function(t,e){Ln.defined("array",t);var i=t.length,r=3*i;if(Rn(e)){if(!Array.isArray(e)&&e.length!==r)throw new Cn("If result is a typed array, it must have exactly array.length * 3 elements");e.length!==r&&(e.length=r)}else e=new Array(r);for(var s=0;s<i;++s)Fn.pack(t[s],e,3*s);return e},Fn.unpackArray=function(t,e){if(Ln.defined("array",t),Ln.typeOf.number.greaterThanOrEquals("array.length",t.length,3),t.length%3!=0)throw new Cn("array length must be a multiple of 3.");var i=t.length;Rn(e)?e.length=i/3:e=new Array(i/3);for(var r=0;r<i;r+=3){var s=r/3;e[s]=Fn.unpack(t,r,e[s])}return e},Fn.fromArray=Fn.unpack,Fn.maximumComponent=function(t){return Ln.typeOf.object("cartesian",t),Math.max(t.x,t.y,t.z)},Fn.minimumComponent=function(t){return Ln.typeOf.object("cartesian",t),Math.min(t.x,t.y,t.z)},Fn.minimumByComponent=function(t,e,i){return Ln.typeOf.object("first",t),Ln.typeOf.object("second",e),Ln.typeOf.object("result",i),i.x=Math.min(t.x,e.x),i.y=Math.min(t.y,e.y),i.z=Math.min(t.z,e.z),i},Fn.maximumByComponent=function(t,e,i){return Ln.typeOf.object("first",t),Ln.typeOf.object("second",e),Ln.typeOf.object("result",i),i.x=Math.max(t.x,e.x),i.y=Math.max(t.y,e.y),i.z=Math.max(t.z,e.z),i},Fn.magnitudeSquared=function(t){return Ln.typeOf.object("cartesian",t),t.x*t.x+t.y*t.y+t.z*t.z},Fn.magnitude=function(t){return Math.sqrt(Fn.magnitudeSquared(t))};var Nn=new Fn;Fn.distance=function(t,e){return Ln.typeOf.object("left",t),Ln.typeOf.object("right",e),Fn.subtract(t,e,Nn),Fn.magnitude(Nn)},Fn.distanceSquared=function(t,e){return Ln.typeOf.object("left",t),Ln.typeOf.object("right",e),Fn.subtract(t,e,Nn),Fn.magnitudeSquared(Nn)},Fn.normalize=function(t,e){Ln.typeOf.object("cartesian",t),Ln.typeOf.object("result",e);var i=Fn.magnitude(t);if(e.x=t.x/i,e.y=t.y/i,e.z=t.z/i,isNaN(e.x)||isNaN(e.y)||isNaN(e.z))throw new Cn("normalized result is not a number");return e},Fn.dot=function(t,e){return Ln.typeOf.object("left",t),Ln.typeOf.object("right",e),t.x*e.x+t.y*e.y+t.z*e.z},Fn.multiplyComponents=function(t,e,i){return Ln.typeOf.object("left",t),Ln.typeOf.object("right",e),Ln.typeOf.object("result",i),i.x=t.x*e.x,i.y=t.y*e.y,i.z=t.z*e.z,i},Fn.divideComponents=function(t,e,i){return Ln.typeOf.object("left",t),Ln.typeOf.object("right",e),Ln.typeOf.object("result",i),i.x=t.x/e.x,i.y=t.y/e.y,i.z=t.z/e.z,i},Fn.add=function(t,e,i){return Ln.typeOf.object("left",t),Ln.typeOf.object("right",e),Ln.typeOf.object("result",i),i.x=t.x+e.x,i.y=t.y+e.y,i.z=t.z+e.z,i},Fn.subtract=function(t,e,i){return Ln.typeOf.object("left",t),Ln.typeOf.object("right",e),Ln.typeOf.object("result",i),i.x=t.x-e.x,i.y=t.y-e.y,i.z=t.z-e.z,i},Fn.multiplyByScalar=function(t,e,i){return Ln.typeOf.object("cartesian",t),Ln.typeOf.number("scalar",e),Ln.typeOf.object("result",i),i.x=t.x*e,i.y=t.y*e,i.z=t.z*e,i},Fn.divideByScalar=function(t,e,i){return Ln.typeOf.object("cartesian",t),Ln.typeOf.number("scalar",e),Ln.typeOf.object("result",i),i.x=t.x/e,i.y=t.y/e,i.z=t.z/e,i},Fn.negate=function(t,e){return Ln.typeOf.object("cartesian",t),Ln.typeOf.object("result",e),e.x=-t.x,e.y=-t.y,e.z=-t.z,e},Fn.abs=function(t,e){return Ln.typeOf.object("cartesian",t),Ln.typeOf.object("result",e),e.x=Math.abs(t.x),e.y=Math.abs(t.y),e.z=Math.abs(t.z),e};var qn=new Fn;Fn.lerp=function(t,e,i,r){return Ln.typeOf.object("start",t),Ln.typeOf.object("end",e),Ln.typeOf.number("t",i),Ln.typeOf.object("result",r),Fn.multiplyByScalar(e,i,qn),r=Fn.multiplyByScalar(t,1-i,r),Fn.add(qn,r,r)};var Hn=new Fn,Wn=new Fn;Fn.angleBetween=function(t,e){Ln.typeOf.object("left",t),Ln.typeOf.object("right",e),Fn.normalize(t,Hn),Fn.normalize(e,Wn);var i=Fn.dot(Hn,Wn),r=Fn.magnitude(Fn.cross(Hn,Wn,Hn));return Math.atan2(r,i)};var Gn=new Fn;Fn.mostOrthogonalAxis=function(t,e){Ln.typeOf.object("cartesian",t),Ln.typeOf.object("result",e);var i=Fn.normalize(t,Gn);return Fn.abs(i,i),i.x<=i.y?i.x<=i.z?Fn.clone(Fn.UNIT_X,e):Fn.clone(Fn.UNIT_Z,e):i.y<=i.z?Fn.clone(Fn.UNIT_Y,e):Fn.clone(Fn.UNIT_Z,e)},Fn.projectVector=function(t,e,i){Ln.defined("a",t),Ln.defined("b",e),Ln.defined("result",i);var r=Fn.dot(t,e)/Fn.dot(e,e);return Fn.multiplyByScalar(e,r,i)},Fn.equals=function(t,e){return t===e||Rn(t)&&Rn(e)&&t.x===e.x&&t.y===e.y&&t.z===e.z},Fn.equalsArray=function(t,e,i){return t.x===e[i]&&t.y===e[i+1]&&t.z===e[i+2]},Fn.equalsEpsilon=function(t,e,i,r){return t===e||Rn(t)&&Rn(e)&&Vn.equalsEpsilon(t.x,e.x,i,r)&&Vn.equalsEpsilon(t.y,e.y,i,r)&&Vn.equalsEpsilon(t.z,e.z,i,r)},Fn.cross=function(t,e,i){Ln.typeOf.object("left",t),Ln.typeOf.object("right",e),Ln.typeOf.object("result",i);var r=t.x,s=t.y,n=t.z,o=e.x,a=e.y,c=e.z,h=s*c-n*a,l=n*o-r*c,d=r*a-s*o;return i.x=h,i.y=l,i.z=d,i},Fn.midpoint=function(t,e,i){return Ln.typeOf.object("left",t),Ln.typeOf.object("right",e),Ln.typeOf.object("result",i),i.x=.5*(t.x+e.x),i.y=.5*(t.y+e.y),i.z=.5*(t.z+e.z),i},Fn.fromDegrees=function(t,e,i,r,s){return Ln.typeOf.number("longitude",t),Ln.typeOf.number("latitude",e),t=Vn.toRadians(t),e=Vn.toRadians(e),Fn.fromRadians(t,e,i,r,s)};var Xn=new Fn,Yn=new Fn,Zn=new Fn(40680631590769,40680631590769,40408299984661.445);Fn.fromRadians=function(t,e,i,r,s){Ln.typeOf.number("longitude",t),Ln.typeOf.number("latitude",e),i=In(i,0);var n=Rn(r)?r.radiiSquared:Zn,o=Math.cos(e);Xn.x=o*Math.cos(t),Xn.y=o*Math.sin(t),Xn.z=Math.sin(e),Xn=Fn.normalize(Xn,Xn),Fn.multiplyComponents(n,Xn,Yn);var a=Math.sqrt(Fn.dot(Xn,Yn));return Yn=Fn.divideByScalar(Yn,a,Yn),Xn=Fn.multiplyByScalar(Xn,i,Xn),Rn(s)||(s=new Fn),Fn.add(Yn,Xn,s)},Fn.fromDegreesArray=function(t,e,i){if(Ln.defined("coordinates",t),t.length<2||t.length%2!=0)throw new Cn("the number of coordinates must be a multiple of 2 and at least 2");var r=t.length;Rn(i)?i.length=r/2:i=new Array(r/2);for(var s=0;s<r;s+=2){var n=t[s],o=t[s+1],a=s/2;i[a]=Fn.fromDegrees(n,o,0,e,i[a])}return i},Fn.fromRadiansArray=function(t,e,i){if(Ln.defined("coordinates",t),t.length<2||t.length%2!=0)throw new Cn("the number of coordinates must be a multiple of 2 and at least 2");var r=t.length;Rn(i)?i.length=r/2:i=new Array(r/2);for(var s=0;s<r;s+=2){var n=t[s],o=t[s+1],a=s/2;i[a]=Fn.fromRadians(n,o,0,e,i[a])}return i},Fn.fromDegreesArrayHeights=function(t,e,i){if(Ln.defined("coordinates",t),t.length<3||t.length%3!=0)throw new Cn("the number of coordinates must be a multiple of 3 and at least 3");var r=t.length;Rn(i)?i.length=r/3:i=new Array(r/3);for(var s=0;s<r;s+=3){var n=t[s],o=t[s+1],a=t[s+2],c=s/3;i[c]=Fn.fromDegrees(n,o,a,e,i[c])}return i},Fn.fromRadiansArrayHeights=function(t,e,i){if(Ln.defined("coordinates",t),t.length<3||t.length%3!=0)throw new Cn("the number of coordinates must be a multiple of 3 and at least 3");var r=t.length;Rn(i)?i.length=r/3:i=new Array(r/3);for(var s=0;s<r;s+=3){var n=t[s],o=t[s+1],a=t[s+2],c=s/3;i[c]=Fn.fromRadians(n,o,a,e,i[c])}return i},Fn.ZERO=Object.freeze(new Fn(0,0,0)),Fn.UNIT_X=Object.freeze(new Fn(1,0,0)),Fn.UNIT_Y=Object.freeze(new Fn(0,1,0)),Fn.UNIT_Z=Object.freeze(new Fn(0,0,1)),Fn.prototype.clone=function(t){return Fn.clone(this,t)},Fn.prototype.equals=function(t){return Fn.equals(this,t)},Fn.prototype.equalsEpsilon=function(t,e,i){return Fn.equalsEpsilon(this,t,e,i)},Fn.prototype.toString=function(){return"("+this.x+", "+this.y+", "+this.z+")"};var Kn=Fn,Qn=new Kn,$n=new Kn;function Jn(t,e,i){this.longitude=In(t,0),this.latitude=In(e,0),this.height=In(i,0)}Jn.fromRadians=function(t,e,i,r){return Ln.typeOf.number("longitude",t),Ln.typeOf.number("latitude",e),i=In(i,0),Rn(r)?(r.longitude=t,r.latitude=e,r.height=i,r):new Jn(t,e,i)},Jn.fromDegrees=function(t,e,i,r){return Ln.typeOf.number("longitude",t),Ln.typeOf.number("latitude",e),t=Vn.toRadians(t),e=Vn.toRadians(e),Jn.fromRadians(t,e,i,r)};var to=new Kn,eo=new Kn,io=new Kn,ro=new Kn(1/6378137,1/6378137,1/6356752.314245179),so=new Kn(1/40680631590769,1/40680631590769,1/40408299984661.445),no=Vn.EPSILON1;Jn.fromCartesian=function(t,e,i){var r=Rn(e)?e.oneOverRadii:ro,s=Rn(e)?e.oneOverRadiiSquared:so,n=function(t,e,i,r,s){if(!Rn(t))throw new Cn("cartesian is required.");if(!Rn(e))throw new Cn("oneOverRadii is required.");if(!Rn(i))throw new Cn("oneOverRadiiSquared is required.");if(!Rn(r))throw new Cn("centerToleranceSquared is required.");var n=t.x,o=t.y,a=t.z,c=e.x,h=e.y,l=e.z,d=n*n*c*c,u=o*o*h*h,f=a*a*l*l,_=d+u+f,p=Math.sqrt(1/_),m=Kn.multiplyByScalar(t,p,Qn);if(_<r)return isFinite(p)?Kn.clone(m,s):void 0;var g=i.x,y=i.y,v=i.z,b=$n;b.x=m.x*g*2,b.y=m.y*y*2,b.z=m.z*v*2;var x,w,A,T,S,P,R,M=(1-p)*Kn.magnitude(t)/(.5*Kn.magnitude(b)),C=0;do{C=(x=d*(S=(w=1/(1+(M-=C)*g))*w)+u*(P=(A=1/(1+M*y))*A)+f*(R=(T=1/(1+M*v))*T)-1)/(-2*(d*(S*w)*g+u*(P*A)*y+f*(R*T)*v))}while(Math.abs(x)>Vn.EPSILON12);return Rn(s)?(s.x=n*w,s.y=o*A,s.z=a*T,s):new Kn(n*w,o*A,a*T)}(t,r,s,Rn(e)?e._centerToleranceSquared:no,eo);if(Rn(n)){var o=Kn.multiplyComponents(n,s,to);o=Kn.normalize(o,o);var a=Kn.subtract(t,n,io),c=Math.atan2(o.y,o.x),h=Math.asin(o.z),l=Vn.sign(Kn.dot(a,t))*Kn.magnitude(a);return Rn(i)?(i.longitude=c,i.latitude=h,i.height=l,i):new Jn(c,h,l)}},Jn.toCartesian=function(t,e,i){return Ln.defined("cartographic",t),Kn.fromRadians(t.longitude,t.latitude,t.height,e,i)},Jn.clone=function(t,e){if(Rn(t))return Rn(e)?(e.longitude=t.longitude,e.latitude=t.latitude,e.height=t.height,e):new Jn(t.longitude,t.latitude,t.height)},Jn.equals=function(t,e){return t===e||Rn(t)&&Rn(e)&&t.longitude===e.longitude&&t.latitude===e.latitude&&t.height===e.height},Jn.equalsEpsilon=function(t,e,i){return i=In(i,0),t===e||Rn(t)&&Rn(e)&&Math.abs(t.longitude-e.longitude)<=i&&Math.abs(t.latitude-e.latitude)<=i&&Math.abs(t.height-e.height)<=i},Jn.ZERO=Object.freeze(new Jn(0,0,0)),Jn.prototype.clone=function(t){return Jn.clone(this,t)},Jn.prototype.equals=function(t){return Jn.equals(this,t)},Jn.prototype.equalsEpsilon=function(t,e){return Jn.equalsEpsilon(this,t,e)},Jn.prototype.toString=function(){return"("+this.longitude+", "+this.latitude+", "+this.height+")"};var oo=Jn;function ao(t,e={lon:0,lat:0,alt:0}){const i=oo.fromCartesian(t,void 0,co);return e.lon=i.longitude,e.lat=i.latitude,e.alt=i.height,e}const co=new oo,ho={minX:1/0,maxX:-1/0,minY:1/0,maxY:-1/0,minZ:1/0,maxZ:-1/0},lo=S(0,0,0),uo={lon:0,lat:0,alt:0},fo=[S(0,0,0),S(0,0,0),S(0,0,0),S(0,0,0),S(0,0,0),S(0,0,0),S(0,0,0),S(0,0,0)];class _o{constructor({buffer:t,byteOffset:e,byteLength:i}){this._buffer=t,this._currentOffset=e,this._availableBytes=i,this._u32view=new Uint32Array(t)}readUint32(){this._checkAvailableBytes(4);const t=this._u32view[this._currentOffset>>2];return this._advance(4),t}readBinary(t){this._checkAvailableBytes(t);const e=new Uint8Array(this._buffer,this._currentOffset,t);return this._advance(t+(4-t%4)%4),e}readJSON(t){const e=this.readBinary(t);return JSON.parse(String.fromCharCode(...e))}availableBytes(){return this._availableBytes}_checkAvailableBytes(t){if(t>this._availableBytes)throw new Error("not enough data")}_advance(t){this._currentOffset+=t,this._availableBytes-=t}}st(t=>X(t.screenSize.height,t.fov,t.zoom));const po=F(t=>2*Math.tan(.5*t));var mo=function(t,e,i,r){return new(i||(i=Promise))((function(s,n){function o(t){try{c(r.next(t))}catch(e){n(e)}}function a(t){try{c(r.throw(t))}catch(e){n(e)}}function c(t){var e;t.done?s(t.value):(e=t.value,e instanceof i?e:new i((function(t){t(e)}))).then(o,a)}c((r=r.apply(t,e||[])).next())}))};class go{constructor(t,e,i,r=1){this._updateTile(t),this._baseUri=e,this.modelId=i,this.detalizationFactor=r,this._onUpdate=new s}get bboxPoints(){return this._bboxPoints}get children(){return this._children?this._children:(this._children=this._initChildren(),this._children||[])}get content(){return this._content}set content(t){this._content=t,this._onUpdate.fire()}get onUpdate(){return this._onUpdate}load(){return mo(this,void 0,void 0,(function*(){if(!this._content&&this._tile.content){const t=this._baseUri+this._tile.content.uri,e=this._contentRequest=new Sn(t),i=yield e.send();this._contentRequest=void 0;const{featureTable:r,binaryGlTF:s}=function(t){const e=new _o(new Uint8Array(t)),i=function(t){if(1835283298!==t.readUint32())throw new Error("b3dm header magic mismatch");if(1!==t.readUint32())throw new Error("b3dm format version mismatch");return{tileByteLength:t.readUint32(),featureTableJSONByteLength:t.readUint32(),featureTableBinaryByteLength:t.readUint32(),batchTableJSONByteLength:t.readUint32(),batchTableBinaryByteLength:t.readUint32()}}(e);return{featureTable:function(t,e){if(0===e.featureTableJSONByteLength)return{RTC_CENTER:[0,0,0],BATCH_LENGTH:0};const i=t.readJSON(e.featureTableJSONByteLength);return t.readBinary(e.featureTableBinaryByteLength),{RTC_CENTER:i.RTC_CENTER,BATCH_LENGTH:i.BATCH_LENGTH||0}}(e,i),batchTable:function(t,e){if(0===e.batchTableJSONByteLength)return{};const i=t.readJSON(e.batchTableJSONByteLength);return t.readBinary(e.batchTableBinaryByteLength),i}(e,i),binaryGlTF:e.readBinary(e.availableBytes())}}(i);return{data:s,metadata:r}}throw new Error("no contentUri or already loaded")}))}cancelLoading(){this._contentRequest&&(this._contentRequest.cancel(),this._contentRequest=void 0)}isDetailzationAcceptable(t){const e=q(t),i=nt(t).origin.z,{height:r}=t.screenSize,s=this.detalizationFactor;return this._tile.geometricError*r/(i*po(e))*s<55e6}_updateTile(t){var e;this._tile=t,this._bbox=function(t,e=Object.assign({},ho)){if(t.box){const i=t.box;Object.assign(e,ho);const r=fo;cs(ao(P(i[0]+i[3]+i[6]+i[9],i[1]+i[4]+i[7]+i[10],i[2]+i[5]+i[8]+i[11],lo),uo),r[0]),cs(ao(P(i[0]+i[3]+i[6]-i[9],i[1]+i[4]+i[7]-i[10],i[2]+i[5]+i[8]-i[11],lo),uo),fo[1]),cs(ao(P(i[0]+i[3]-i[6]+i[9],i[1]+i[4]-i[7]+i[10],i[2]+i[5]-i[8]+i[11],lo),uo),fo[2]),cs(ao(P(i[0]+i[3]-i[6]-i[9],i[1]+i[4]-i[7]-i[10],i[2]+i[5]-i[8]-i[11],lo),uo),fo[3]),cs(ao(P(i[0]-i[3]+i[6]+i[9],i[1]-i[4]+i[7]+i[10],i[2]-i[5]+i[8]+i[11],lo),uo),fo[4]),cs(ao(P(i[0]-i[3]+i[6]-i[9],i[1]-i[4]+i[7]-i[10],i[2]-i[5]+i[8]-i[11],lo),uo),fo[5]),cs(ao(P(i[0]-i[3]-i[6]+i[9],i[1]-i[4]-i[7]+i[10],i[2]-i[5]-i[8]+i[11],lo),uo),fo[6]),cs(ao(P(i[0]-i[3]-i[6]-i[9],i[1]-i[4]-i[7]-i[10],i[2]-i[5]-i[8]-i[11],lo),uo),fo[7]);for(const t of r)e.maxX=Math.max(e.maxX,t.x),e.minX=Math.min(e.minX,t.x),e.maxY=Math.max(e.maxY,t.y),e.minY=Math.min(e.minY,t.y),e.maxZ=Math.max(e.maxZ,t.z),e.minZ=Math.min(e.minZ,t.z);return e}throw new Error("unsupported bounding volume type")}(t.boundingVolume,this._bbox),this._bboxCenter=function(t,e=S(0,0,0)){return e.x=(t.minX+t.maxX)/2,e.y=(t.minY+t.maxY)/2,e.z=(t.minZ+t.maxZ)/2,e}(this._bbox,this._bboxCenter),this._bboxPoints=function(t,e=[S(0,0,0),S(0,0,0),S(0,0,0),S(0,0,0),S(0,0,0),S(0,0,0),S(0,0,0),S(0,0,0)]){return P(t.minX,t.minY,t.minZ,e[0]),P(t.minX,t.minY,t.maxZ,e[1]),P(t.minX,t.maxY,t.minZ,e[2]),P(t.minX,t.maxY,t.maxZ,e[3]),P(t.maxX,t.minY,t.minZ,e[4]),P(t.maxX,t.minY,t.maxZ,e[5]),P(t.maxX,t.maxY,t.minZ,e[6]),P(t.maxX,t.maxY,t.maxZ,e[7]),e}(this._bbox,this._bboxPoints),this._bboxRadius=(e=this._bbox,Math.max(Math.abs(e.maxX-e.minX)/2,Math.abs(e.maxY-e.minY)/2,Math.abs(e.maxZ-e.minZ)/2))}_initChildren(){if(!this._tile.children)return;const t=[];for(const e of this._tile.children)if(e.content){const i=this._baseUri+e.content.uri,r=i.match(/\.json$/)?new yo(i,e,this.modelId,this.detalizationFactor):new go(e,this._baseUri,this.modelId,this.detalizationFactor);r.onUpdate.addListener(()=>this._onUpdate.fire()),t.push(r)}return t}}class yo extends go{constructor(t,e,i=vo++,r){super(e,t.substring(0,t.lastIndexOf("/")+1),i,r),this._tilesetUri=t}load(){const t=Object.create(null,{load:{get:()=>super.load}});return mo(this,void 0,void 0,(function*(){if(!this._tileset){const t=this._tilesetRequest=new Pn(this._tilesetUri);this._tileset=yield t.send(),this._tilesetRequest=void 0,this._updateTile(this._tileset.root)}return t.load.call(this)}))}cancelLoading(){this._tilesetRequest&&(this._tilesetRequest.cancel(),this._tilesetRequest=void 0),super.cancelLoading()}}let vo=0;var bo=i(1),xo=i.n(bo),wo=i(18),Ao=i.n(wo);const To=new pr({depthTest:!0,depthFunc:518}),So={LIGHT:{r:.98,g:.97,b:.94,a:1},DARK:{r:.12,g:.14,b:.18,a:1}};class Po extends Sr{constructor(t){const e=t.createProgram(xo.a,Ao.a,{attribMap:{vertexPosition:0,vertexUv:4}});super(t,To,e),this._color=So.LIGHT,t.bindProgram(e),e.setScalarUniform("zIndex",-1),this.onUpdate=new s}setColor(t){this._color=t,this.onUpdate.fire()}_render(){this._context.bindQuadVao(),this._context.drawQuad()}_prepareProgram(t){super._prepareProgram(t),t.setScalarUniform("dpr",ee());const{r:e,g:i,b:r,a:s}=this._color;t.setVector4Uniform("color",{x:e,y:i,z:r,w:s})}}const Ro=new pr({depthTest:!0,clearDepth:-1});class Mo extends ws{constructor(t,e=0){super(),this._depthClearStrategy=e,this._context=t}render(t,...e){this._clearDepthIfNeeded(t),super.render(t,...e)}renderHitTestBuffer(t,...e){this._clearDepthIfNeeded(t),super.renderHitTestBuffer(t,...e)}_clearDepthIfNeeded(t){1===this._depthClearStrategy&&(this._context.bindRenderState(Ro),this._context.bindRenderTarget(t),this._context.clearCurrentTarget(256))}}var Co=i(19),zo=i.n(Co);const Oo=new pr(ur);class Lo extends Sr{constructor(t,e){super(t,Oo,t.createProgram(xo.a,zo.a,{attribMap:{vertexPosition:0}})),this._renderers=new ws,this._renderLoop=e,this.onUpdate=this._renderers.onUpdate,this._pixelSize=ut(0,0)}addRenderUnit(t){this._renderers.addRenderUnit(t)}removeRenderUnit(t){this._renderers.removeRenderUnit(t)}render(t,...e){if(this._renderLoop.isActive)return this._renderers.render(t,...e),void this._renderLoop.update();this._intermediateRenderbuffer?se(this._intermediateRenderbuffer.size,t.size)||(this._destroyInternalRenderTargets(),this._initIntermediateRenderTargets(t.size)):this._initIntermediateRenderTargets(t.size),this._context.bindRenderTarget(this._intermediateRenderbuffer),this._context.clearCurrentTarget(17664),this._renderers.render(this._intermediateRenderbuffer,...e),this._intermediateRenderbuffer.isClear||(this._updateFrameUniformState(t),super.render(t,...e))}renderHitTestBuffer(t,...e){this._renderers.renderHitTestBuffer(t,...e)}destroy(){this._intermediateRenderbuffer&&this._destroyInternalRenderTargets()}_render(){this._context.bindQuadVao(),this._context.drawQuad()}_prepareProgram(t,...e){super._prepareProgram(t,...e),this._context.bindTextureUnit(0),this._context.bindTexture(this._intermediateColorBuffer),t.setIntScalarUniform("texture",0),t.setVector2Uniform("pixelSize",this._pixelSize),t.setScalarUniform("dpr",ee())}_updateFrameUniformState(t){this._pixelSize.x=1/t.size.width,this._pixelSize.y=1/t.size.height}_initIntermediateRenderTargets({width:t,height:e}){const i=this._context,r=this._intermediateColorBuffer=i.createEmpty2DTexture(t,e,6408,5121),s=this._intermediateDepthStencilBuffer=i.createRenderbuffer(t,e,34041);this._intermediateRenderbuffer=i.createFramebuffer({color:r,depthStencil:s})}_destroyInternalRenderTargets(){this._intermediateRenderbuffer.destroy(),this._intermediateColorBuffer.destroy(),this._intermediateDepthStencilBuffer.destroy()}}var ko=i(20),Io=i.n(ko),Eo=i(21),Bo=i.n(Eo);const Uo=new pr(ur),Do={attribMap:{vertexPosition:0,vertexUV:4}};class jo extends Sr{constructor(t){super(t,Uo,t.createProgram(Io.a,Bo.a,Do))}_render(t){this._context.bindTextureUnit(0),this._context.bindTexture(t),this._context.bindQuadVao(),this._context.drawQuad()}}class Vo{constructor(t,e=!0){this._context=t,this._depthBufferEnabled=e,this._outputSize=ie(-1,-1),this._overlayRenderer=new jo(t)}render(t,e,...i){this._syncOutputBufferWith(t),this._prepareOutputBuffer(),e(this._outputBuffer,...i),this._outputBuffer.isClear||this._overlayRenderer.render(t,this._outputTexture)}destroy(){var t,e,i;this._overlayRenderer.destroy(),null===(t=this._outputTexture)||void 0===t||t.destroy(),null===(e=this._outputDepthBuffer)||void 0===e||e.destroy(),null===(i=this._outputBuffer)||void 0===i||i.destroy()}_syncOutputBufferWith(t){var e;if(!se(this._outputSize,t.size)){(this._outputTexture||this._outputDepthBuffer||this._outputBuffer)&&(this._outputTexture.destroy(),null===(e=this._outputDepthBuffer)||void 0===e||e.destroy(),this._outputBuffer.destroy());const{width:i,height:r}=re(t.size,this._outputSize);this._outputTexture=this._context.createEmpty2DTexture(i,r,6408,5121),this._outputDepthBuffer=this._depthBufferEnabled?this._context.createRenderbuffer(i,r,34041):void 0,this._outputBuffer=this._context.createFramebuffer({color:this._outputTexture,depthStencil:this._outputDepthBuffer})}}_prepareOutputBuffer(){this._context.bindRenderTarget(this._outputBuffer),this._context.bindRenderState(Fo),this._context.clearCurrentTarget(16640)}}const Fo=new pr({depthTest:!0,clearDepth:1});class No extends Mo{constructor(t){super(t),this._midRenderer=new Vo(t)}render(t,...e){this._midRenderer.render(t,super.render.bind(this),...e)}renderHitTestBuffer(t,...e){this._prepareHitTestRenderTarget(t),super.renderHitTestBuffer(t,...e)}destroy(){this._midRenderer.destroy()}_prepareHitTestRenderTarget(t){this._context.bindRenderTarget(t),this._context.bindRenderState(qo),this._context.clearCurrentTarget(256)}}const qo=new pr({depthTest:!0,clearDepth:1});var Ho=i(22),Wo=i.n(Ho),Go=i(23),Xo=i.n(Go);class Yo extends Hs{constructor(t,e,i=(()=>1)){super(t,e,Ko,e.createProgram(Wo.a,Xo.a,Zo)),this._texturingProgress=i}_renderBatch(t,e){const i=t.firstPrimitive;this._context.bindTextureUnit(0),this._context.bindTexture(i.texture),e.setColorUniform("diffuseColor",i.color);const r=i.modelId,s=void 0!==r?this._texturingProgress(r):1;e.setScalarUniform("texturingProgress",void 0===s?1:s),super._renderBatch(t,e)}}const Zo={attribMap:{vertexPosHigh:0,vertexPosLow:1,vertexHeight:3,vertexUV:4}},Ko=new pr({depthTest:!0});class Qo{constructor(t,e,i,r,s,n){this._camera=t,this._renderLoop=e,this._viewport=i,this._startFromZoom=s,this._duration=r,this._limitByZoom=n,this._isWorld3D=!1,this._lastAnimationTick=void 0,this._heightFactor=0,this.heightProvider=()=>this._heightFactor,this._viewport.onViewportStateChanged.addListener(this._onViewportUpdate,this),this._camera.onUpdate.addListener(this._onViewportUpdate,this),this._renderLoop.onBeforeRender.addListener(this._onBeforeRender,this),this._onViewportUpdate(this._viewport.viewportState)}destroy(){this._renderLoop.onBeforeRender.removeListener(this._onBeforeRender),this._viewport.onViewportStateChanged.removeListener(this._onViewportUpdate)}get _maxHeightFactor(){return Ft(1-(this._startFromZoom-this._camera.zoom)/this._limitByZoom,0,1)}_onViewportUpdate(t=this._viewport.viewportState){const e=t.visualizableTileNumber>0,i=this._camera.zoom>=this._startFromZoom;e&&i!==this._isWorld3D&&(this._lastAnimationTick=Wt(),this._isWorld3D=i,this._renderLoop.update())}_onBeforeRender(){if(void 0!==this._lastAnimationTick){const t=Wt(),e=(t-this._lastAnimationTick)/this._duration;this._heightFactor=Ft(this._heightFactor+(this._isWorld3D?e:-e),0,this._maxHeightFactor);const i=this._isWorld3D?this._heightFactor<1:this._heightFactor>0;this._lastAnimationTick=i?t:void 0,this._renderLoop.update()}}}class $o{constructor(t,e){this.capacity=t,this._factory=e,this._usedObjs=new Set,this._freeObjs=[]}destroy(){for(const t of this._freeObjs)t.destroy()}acquire(){const t=this._freeObjs.pop()||this._factory();return this._usedObjs.add(t),t}release(t){this._usedObjs.delete(t)&&(this._freeObjs.length<this.capacity?(this._freeObjs.push(t),t.reset&&t.reset()):t.destroy())}}var Jo=i(24),ta=i.n(Jo);const ea=new pr(ur);class ia extends ws{constructor(t,e,i){super(),this._context=t,this._scene=e,this._portionPrimitiveProvider=i,this._pool=new $o(4,()=>this._createFramebuffer()),this._program=t.createProgram(xo.a,ta.a,{attribMap:{vertexPosition:0,vertexUv:4}}),this._scene.onUpdate.addListener(this._onSceneUpdate,this)}destroy(){this._scene.onUpdate.removeListener(this._onSceneUpdate),this._program.destroy(),this._pool.destroy()}render(t,...e){const{root:i}=this._scene;i&&this._renderGroup(i,t,...e)}renderHitTestBuffer(t,...e){const{root:i}=this._scene;i&&this._renderGroupHitTest(i,t,...e)}_renderGroupChildren(t,e,...i){for(const r of t.batchedChildren)1===r.type?this._renderGroup(r,e,...i):(this._portionPrimitiveProvider.setPortion(r.content),super.render(e,...i))}_renderGroup(t,e,...i){if(t.opacity<1){const r=this._pool.acquire();this._resizeIfNeeded(r),this._context.bindRenderTarget(r.framebuffer),this._context.clearCurrentTarget(16384),this._renderGroupChildren(t,r.framebuffer,...i),this._renderTexture(r.color,t.opacity,e),this._pool.release(r)}else this._renderGroupChildren(t,e,...i)}_renderGroupHitTest(t,e,...i){for(const r of t.batchedChildren)1===r.type?this._renderGroupHitTest(r,e,...i):(this._portionPrimitiveProvider.setPortion(r.content),super.renderHitTestBuffer(e,...i))}_renderTexture(t,e,i){this._context.bindProgram(this._program),this._context.bindTextureUnit(0),this._context.bindTexture(t),this._program.setIntScalarUniform("texture",0),this._program.setScalarUniform("opacity",e),this._context.bindRenderState(ea),this._context.bindRenderTarget(i),this._context.bindQuadVao(),this._context.drawQuad()}_createFramebuffer(){const{width:t,height:e}=this._context.getDefaultRenderTarget().size,i=this._context.createEmpty2DTexture(t,e,6408,5121),r=this._context.createFramebuffer({color:i});return{framebuffer:r,color:i,destroy:()=>{r.destroy(),i.destroy()}}}_resizeIfNeeded(t){const{color:e}=t,{size:i}=this._context.getDefaultRenderTarget();i.width===e.getWidth()&&i.height===e.getHeight()||(t.framebuffer.destroy(),this._context.resizeTexture(e,i),t.framebuffer=this._context.createFramebuffer({color:e}))}_onSceneUpdate(){this._onUpdate.fire()}}class ra{constructor(){this._currentPortion={primitives:{}}}setPortion(t){this._currentPortion=t}getProvider(t){const e=this,i={get primitives(){return e._currentPortion.primitives[t]||[]},get visiblePrimitives(){return i.primitives},onUpdate:new s};return i}}class sa{constructor(t,e){this._type=t,this._scene=e,this.onUpdate=new s}get primitives(){const t=this._scene,e=this._type;return{*[Symbol.iterator](){const i=t.root?[t.root]:[];for(;i.length>0;){const t=i.pop();for(const r of t.batchedChildren)0===r.type?yield*r.content.primitives[e]:i.push(r)}}}}get visiblePrimitives(){return this.primitives}}var na=i(4),oa=i.n(na),aa=i(25),ca=i.n(aa);class ha extends Hs{constructor(t,e,i,r,s,n,o){super(t,e,i,r,s,n),this._colorTransformProvider=o}_renderBatch(t,e){const i=this._colorTransformProvider&&this._colorTransformProvider.get(t.firstPrimitive);i?(e.setIntScalarUniform("isColorTransformed",1),e.setMatrix4Uniform("colorTransform",i)):e.setIntScalarUniform("isColorTransformed",0),super._renderBatch(t,e)}_canBatchAdjacentPrimitives(t,e){const i=this._colorTransformProvider;return super._canBatchAdjacentPrimitives(t,e)&&(!i||i.get(t)===i.get(e))}}const la={hitTest:!1};function da(t,...e){const i=Object.assign({},t);for(const r of e)if(r)for(const t of Object.keys(r)){const e=r[t];void 0!==e&&(i[t]=e)}return i}const ua=F(t=>2/(256*Math.pow(2,t))),fa=Object.assign(Object.assign({},la),{maxZoomWithTilesLoading:1/0,snapGeometryToNearestZoom:!1}),_a=new pr(fr,{depthTest:!0,depthMask:!1,depthFunc:518}),pa={attribMap:{vertexId:2,vertexPosHigh:0,vertexPosLow:1,vertexNormal:5,vertexDisplacement:6,vertexZIndex:10,vertexUv:4,vertexIconLocation:12,vertexScale:13,vertexZoomRelatedData:14,vertexCurrentAndSegmentLength:15}},ma={attribMap:pa.attribMap,defines:{YV_COLOR_ID:1}};class ga extends ha{constructor(t,e,i,r,s){const n=da(fa,s),o=e.createProgram(oa.a,ca.a,pa),a=n.hitTest?e.createProgram(oa.a,qr.a,ma):void 0;super(t,e,_a,o,new pr(_r),a,null==r?void 0:r.colorTransform),this._camera=i,this._atlasSizeUniform=ut(0,0),this._maxZoomWithTilesLoading=n.maxZoomWithTilesLoading,this._snapGeometryToNearestZoom=n.snapGeometryToNearestZoom}_prepareProgram(t,e,i,...r){super._prepareProgram(t,e,i,...r),this._prepareProgramState(t)}_prepareHitTestProgram(t,e,i,...r){super._prepareHitTestProgram(t,e,i,...r),this._prepareProgramState(t)}_renderBatch(t,e){const i=t.firstPrimitive.texture;this._atlasSizeUniform.x=i.getWidth(),this._atlasSizeUniform.y=i.getHeight(),e.setVector2Uniform("atlasSize",this._atlasSizeUniform),this._context.bindTextureUnit(0),this._context.bindTexture(i,9729,9729),super._renderBatch(t,e)}_canBatchAdjacentPrimitives(t,e){return super._canBatchAdjacentPrimitives(t,e)&&t.texture===e.texture}_prepareProgramState(t){const e=this._camera.zoom,i=Ft((e-this._maxZoomWithTilesLoading)/2*.5+.5,.5,1);t.setScalarUniform("worldToPxFactor",ua(e)),t.setScalarUniform("zoom",e),t.setScalarUniform("zoomScaleFactor",i),t.setIntScalarUniform("snapGeometryToNearestZoom",Number(this._snapGeometryToNearestZoom))}}var ya=i(5),va=i.n(ya),ba=i(3),xa=i.n(ba);const wa=new pr(ur,{cullFace:!0,cullFaceMode:1028}),Aa=new pr;class Ta extends ha{constructor(t,e,i,r,s,n){super(t,e,wa,r,Aa,s,n.colorTransform),this._camera=i,this._visibilityProvider=n.visibility,this._atlasSizeUniform=ut(0,0)}_render(t,e){this._program.setScalarUniform("isOutlinePhase",1),super._render(t,e),this._program.setScalarUniform("isOutlinePhase",0),super._render(t,e)}_prepareProgram(t,e,i){const r=this._visibilityProvider();super._prepareProgram(t,e,i),this._prepareProgramState(t,r)}_prepareHitTestProgram(t,e,i){const r=this._visibilityProvider();super._prepareHitTestProgram(t,e,i),this._prepareProgramState(t,r)}_renderBatch(t,e){const i=t.firstPrimitive.texture;this._atlasSizeUniform.x=i.getWidth(),this._atlasSizeUniform.y=i.getHeight(),e.setIntScalarUniform("atlas",1),e.setVector2Uniform("atlasSize",this._atlasSizeUniform),this._context.bindTextureUnit(1),this._context.bindTexture(i),super._renderBatch(t,e)}_canBatchAdjacentPrimitives(t,e){return super._canBatchAdjacentPrimitives(t,e)&&t.texture===e.texture}_prepareProgramState(t,e){this._context.bindTextureUnit(0),this._context.bindTexture(e),t.setVector2Uniform("idHalfPxSize",e.getHalfPxSize()),t.setVector2Uniform("pixelSize",this._camera.pixelSize),t.setScalarUniform("dpr",window.devicePixelRatio)}}const Sa={attribMap:{vertexId:2,vertexPosHigh:0,vertexPosLow:1,vertexDisplacement:6,vertexUV:4,vertexPriority:9,vertexColor:7,vertexOutlineColor:8,vertexScale:11}},Pa={defines:{YV_COLOR_ID:1},attribMap:Sa.attribMap};class Ra extends Ta{constructor(t,e,i,r,s){const n=da(la,s),o=e.createProgram(va.a,xa.a,Sa),a=n.hitTest?e.createProgram(va.a,qr.a,Pa):void 0;super(t,e,i,o,a,r)}_getHitTestPrimitives(){return Ut(super._getHitTestPrimitives(),({metadata:t})=>!!t)}}var Ma=i(6),Ca=i.n(Ma),za=i(26),Oa=i.n(za),La=i(27),ka=i.n(La),Ia=i(28),Ea=i.n(Ia);const Ba=new pr(fr),Ua=new pr;class Da extends ha{constructor(t,e,i=function(t){return t.createProgram(ka.a,Ea.a,{attribMap:{vertexPosHigh:0,vertexPosLow:1,vertexUV:4}})}(e),r,s){super(t,e,Ba,i,Ua,r,s),this._atlasSizeUniform=ut(0,0)}_renderBatch(t,e){const i=t.firstPrimitive.texture;this._atlasSizeUniform.x=i.getWidth(),this._atlasSizeUniform.y=i.getHeight(),e.setVector2Uniform("atlasSize",this._atlasSizeUniform),this._prepareTexture(i),super._renderBatch(t,e)}_prepareTexture(t){this._context.bindTextureUnit(0),this._context.bindTexture(t)}_canBatchAdjacentPrimitives(t,e){return super._canBatchAdjacentPrimitives(t,e)&&t.texture===e.texture}}const ja=Object.assign(Object.assign({},la),{iconHitTestField:0,iconHitTestMinSize:0}),Va={attribMap:{vertexPosHigh:0,vertexPosLow:1,vertexDisplacement:6,vertexOffset:11,vertexUV:4,vertexId:2,vertexPriority:9,vertexBrightness:12}},Fa={attribMap:Va.attribMap,defines:{YV_COLOR_ID:1}};class Na extends Da{constructor(t,e,i,r,s){const n=da(ja,s),o=e.createProgram(Ca.a,Oa.a,Va),a=n.hitTest?e.createProgram(Ca.a,qr.a,Fa):void 0;super(t,e,o,a,r.colorTransform),this._camera=i,this._linearFilterFrames=0,this._cameraUpdateListener=()=>{this._linearFilterFrames=3},this._camera.onUpdate.addListener(this._cameraUpdateListener),this._visibilityProvider=r.visibility,this._extensionAndMinSize={x:n.iconHitTestField,y:n.iconHitTestMinSize}}destroy(){this._camera.onUpdate.removeListener(this._cameraUpdateListener),super.destroy()}_render(t,e){super._render(t,e),this._linearFilterFrames>0&&(this._linearFilterFrames--,this._requestRerender())}_prepareProgram(t,e,i){const r=this._visibilityProvider();super._prepareProgram(t,e,i),this._prepareProgramState(t,r),t.setVector2Uniform("extensionAndMinSize",ft)}_prepareHitTestProgram(t,e,i){const r=this._visibilityProvider();super._prepareHitTestProgram(t,e,i),this._prepareProgramState(t,r),t.setVector2Uniform("extensionAndMinSize",this._extensionAndMinSize)}_prepareTexture(t){this._context.bindTextureUnit(0);const e=this._linearFilterFrames>0?9729:void 0;this._context.bindTexture(t,e,e)}_requestRerender(){this._onUpdate.fire()}_prepareProgramState(t,e){this._context.bindTextureUnit(1),this._context.bindTexture(e),t.setIntScalarUniform("visibility",1),t.setVector2Uniform("idHalfPxSize",e.getHalfPxSize()),t.setVector2Uniform("pixelSize",this._camera.pixelSize)}}var qa=i(7),Ha=i.n(qa),Wa=i(29),Ga=i.n(Wa);const Xa={depthTest:!0,depthFunc:518},Ya={vertexPosHigh:0,vertexPosLow:1,vertexColor:7,vertexZIndex:10,vertexId:2},Za={attribMap:Ya},Ka={attribMap:Ya,defines:{YV_COLOR_ID:1}},Qa=Object.assign(Object.assign({},la),{renderState:new pr(Xa)});class $a extends ha{constructor(t,e,i,r){const s=da(Qa,r),n=e.createProgram(Ha.a,Ga.a,Za),o=s.hitTest?e.createProgram(Ha.a,qr.a,Ka):void 0;super(t,e,s.renderState,n,new pr(_r),o,null==i?void 0:i.colorTransform)}}const Ja=new pr(Xa,{depthMask:!1},ur);class tc extends $a{constructor(t,e,i,r){super(t,e,i,Object.assign(Object.assign({},r),{renderState:Ja}))}}var ec=i(8),ic=i.n(ec),rc=i(30),sc=i.n(rc);const nc=new pr({depthTest:!0}),oc={attribMap:{vertexPosHigh:0,vertexPosLow:1,vertexHeight:3,vertexColor:7,vertexId:2}},ac={attribMap:oc.attribMap,defines:{YV_COLOR_ID:1}},cc=()=>1;class hc extends ha{constructor(t,e,i,r){const s=da(la,r),n=e.createProgram(ic.a,sc.a,oc),o=s.hitTest?e.createProgram(ic.a,qr.a,ac):void 0;super(t,e,nc,n,nc,o,null==i?void 0:i.colorTransform),this._heightFactorProvider=(null==i?void 0:i.heightFactor)||cc}_prepareProgram(t,e,i,...r){super._prepareProgram(t,e,i,...r),t.setScalarUniform("zFactor",this._heightFactorProvider())}_prepareHitTestProgram(t,e,i,...r){super._prepareHitTestProgram(t,e,i,...r),t.setScalarUniform("zFactor",this._heightFactorProvider())}}var lc=i(9),dc=i.n(lc);const uc={attribMap:{vertexId:2,vertexPosHigh:0,vertexPosLow:1,vertexDisplacements:6,vertexUV:4,vertexColor:7,vertexOutlineColor:8,vertexPriority:9,leftPolylineRatios:12,leftPolylineAngles:13,rightPolylineRatios:14,rightPolylineAngles:15,polylineLength_vertexScale:11}},fc={defines:{YV_COLOR_ID:1},attribMap:uc.attribMap};class _c extends Ta{constructor(t,e,i,r,s){const n=da(la,s),o=e.createProgram(dc.a,xa.a,uc),a=n.hitTest?e.createProgram(dc.a,qr.a,fc):void 0;super(t,e,i,o,a,r)}}const pc={vertexPosHigh:0,vertexPosLow:1,vertexDisplacement:6};class mc extends Hs{constructor(t,e,i,r=new pr){super(t,e,r,e.createProgram(Vs.a,qr.a,{attribMap:pc})),this._camera=i}_prepareProgram(t,e,i){super._prepareProgram(t,e,i),t.setVector2Uniform("pixelSize",this._camera.pixelSize)}}var gc=i(31),yc=i.n(gc);class vc extends Ws{constructor(t,e,i,r,s){super(t,e,i,s),this._camera=r}_prepareProgram(t,e,i,r,s,n,o,a,c,h,l){super._prepareProgram(t,e,i,r,s,n,o,a,c,h,l),t.setVector2Uniform("pixelSize",this._camera.pixelSize)}}class bc extends vc{constructor(t,e,i){super(t,e,e.createProgram(yc.a,qr.a,Sa),i)}}const xc=new Map;class wc extends Js{_render(){const t=this._primitiveProvider.primitives;for(const e of qs(t,void 0,Tc)){const t=e.firstPrimitive,i=t.page.layout.vertexByteSize,r=Ac(i)*i,s=t.vao;xc.get(s)||(xc.set(s,this._context.createVao([{attributeMapping:t.page.layout,buffer:t.page.vertexBuffer,stride:r}])),s.onDestroy.addListener(()=>{xc.get(s).destroy(),xc.delete(s)})),this._context.bindVao(xc.get(s)),this._context.drawMesh(e.vertexByteOffset/r,e.vertexByteLength/r,0)}}}function Ac(t){const e=Math.floor(255/t);return Math.min(e,4)}function Tc(t,e){return e.vertexByteOffset+e.vertexByteLength===t.vertexByteOffset&&e.indexByteOffset+e.indexByteLength===t.indexByteOffset&&(e.vertexByteLength+=t.vertexByteLength,e.indexByteLength+=t.indexByteLength,!0)}var Sc=i(32),Pc=i.n(Sc);class Rc extends vc{constructor(t,e,i){super(t,e,e.createProgram(Pc.a,qr.a,uc),i)}}var Mc=i(33),Cc=i.n(Mc);class zc extends Ws{constructor(t,e,i,r){super(t,e,e.createProgram(Cc.a,qr.a,Va),r),this._camera=i}_prepareProgram(t,e,i,r,s,n,o,a,c,h,l){super._prepareProgram(t,e,i,r,s,n,o,a,c,h,l),t.setVector2Uniform("pixelSize",this._camera.pixelSize)}}function Oc(t,e,i,r){return new hr(dr.a,t,e,i,r)}e.default=r}]).default)},506:function(t,e,i){"use strict";i.r(e);var r,s=i(8),n=i(10),o=i(80),a=i(25),c=i(79),h=i(11),l=i(126),d=i(99),u=i(12),f=i(107),_=i(101),p=function(){function t(t,e){this.source=t,this._plan=e}return t.prototype.getId=function(){return this._plan.id},t.prototype.getBounds=function(){var t=this._plan.bbox;return[[t.lowerCorner.lon,t.lowerCorner.lat],[t.upperCorner.lon,t.upperCorner.lat]]},t.prototype.isVisible=function(){return this._plan.isVisible},t.prototype.setVisible=function(t){this._plan.isVisible=t},t.prototype.getLevels=function(){return this._plan.levels},t.prototype.getDefaultLevel=function(){return this._plan.defaultLevel},t.prototype.getActiveLevel=function(){return this._plan.activeLevel},t.prototype.setActiveLevel=function(t){this._plan.setActiveLevel(t)},t.prototype.getOpacity=function(){return this._plan.opacity},t.prototype.setOpacity=function(t){this._plan.opacity=t},t}(),m=i(81),g=i(230);var y=function(){function t(t){void 0===t&&(t={}),this._additionalData=t}return t.prototype.submit=function(t,e){var i,n=(i=Object(s.a)(Object(s.a)({},e),this._additionalData),Object.keys(i).map((function(t){return"".concat(t,"=").concat(i[t])})).join("/")),o="/dtype=stred/pid=".concat(443,"/cid=").concat(73323,"/path=").concat(t,"/").concat(n,"/*"),a=function(){if(r)return r;switch(location.hostname.split(".").pop()){case"tr":return r="https://yandex.com.tr/clck/counter";case"com":case"fr":return r="https://yandex.com/clck/counter";case"eu":return r="https://yandex.eu/clck/counter";default:return r="https://yandex.ru/clck/counter"}}();window.navigator.sendBeacon?navigator.sendBeacon(a,o):document.createElement("img").src="".concat(a).concat(o)},t}(),v=i(82),b=(i(35),i(58)),x=i(21),w=i(13),A=i(100);function T(t){return{feature:S(t),style:P(t)}}function S(t){var e=t.id,i=t.feature,r=t.style;switch(i.geometry.type){case"Point":return function(t,e,i){return{type:"Feature",geometry:e.geometry,properties:{style:R(i),metadata:z(t,i)}}}(e,i,r);case"LineString":case"MultiLineString":return function(t,e,i){for(var r=e.geometry,s="LineString"===r.type?function(t,e){if(0===e.length)return[t];for(var i=[],r=0,s=0,n=e;s<n.length;s++){var o=n[s];i.push(t.slice(r,o+1)),r=o}return i}(r.coordinates,i.paletteColorStops):r.coordinates,n=[],o=i.stroke.length-1;o>=0;o--)for(var a=i.stroke[o],c=s.length-1;c>=0;c--){var h=s[c];n.push({type:"Feature",geometry:{type:"LineString",coordinates:h},properties:{style:C(a,c),metadata:z(t,i)}})}return{type:"FeatureCollection",features:n}}(e,i,r);case"Polygon":case"MultiPolygon":return function(t,e,i){return{type:"Feature",geometry:e.geometry,properties:{style:M(i),metadata:z(t,i)}}}(e,i,r);default:Object(w.c)(new Error("Unexpected geometry type: ".concat(i.geometry.type)))}}function P(t){return{zIndex:t.style.zIndex,simplificationRate:"Point"===t.feature.geometry.type?0:t.style.simplificationRate}}function R(t){return{"icon-image":t.icon.url,"icon-offset":t.icon.offset,"icon-scale":t.icon.scale}}function M(t){var e=t.stroke[0];return{"fill-color":t.fill,"fill-opacity":t.fillOpacity,"fill-rule":t.fillRule,"fill-contour-width":null==e?void 0:e.width,"fill-contour-color":null==e?void 0:e.color,"fill-contour-opacity":null==e?void 0:e.opacity,"fill-contour-dasharray":null==e?void 0:e.dash}}function C(t,e){return{"line-color":t.paletteColors.length>0?t.paletteColors[e]:t.color,"line-width":t.width,"line-opacity":t.opacity,"line-dasharray":t.dash,"line-cap":"round"}}function z(t,e){return e.interactive?{objectId:t}:void 0}var O=function(){function t(t,e){var i=this;this._destroyed=!1,this.onBeforeRender=new t.EventTrigger,this.onRender=new t.EventTrigger,this._renderLoop=e,this._renderLoopSubscription=this._renderLoop.on("beforeRender",(function(){return i.onBeforeRender.fire()})).on("render",(function(){return i.onRender.fire()}))}return Object.defineProperty(t.prototype,"isActive",{get:function(){return this._renderLoop.isActive},enumerable:!1,configurable:!0}),t.prototype.update=function(){this._destroyed||this._renderLoop.update()},t.prototype.destroy=function(){this._destroyed=!0,this._renderLoopSubscription.offAll()},t}();var L={ground:function(t,e,i){var r=e.context,s=e.camera,n=i.scene,o={get:function(t){var e;return null===(e=this.provider)||void 0===e?void 0:e.get(t)}};return{contentProvider:i,colorTransformer:o,renderUnits:[new t.LayerRenderUnit(r,1),i instanceof t.IndoorContentProvider?new t.TransparentPolygonRenderUnit(n[0],r,{colorTransform:o},{hitTest:!0}):new t.PolygonRenderUnit(n[0],r,{colorTransform:o},{hitTest:!0}),new t.TransparentPolygonRenderUnit(n[1],r,{colorTransform:o},{hitTest:!0}),new t.PolylineRenderUnit(n[4],r,s,{colorTransform:o},{hitTest:!0})],collidingPrimitives:[],destroyables:[]}},buildings:function(t,e,i,r,s){if(i instanceof t.Tile3DContentProvider)return function(t,e,i,r,s){var n={get:function(t){var e;return null===(e=this.provider)||void 0===e?void 0:e.get(t)}},o=new t.GlTFPrimitiveRenderUnit(i.scene,e.context,(function(t){return i.getModelAppearingProgress(t)})),a=[],c=[],h=null==s?void 0:s.rootRenderUnit;if(!h){var l=new t.FxaaRenderUnit(e.context,e.renderLoop),d=new t.BuildingsRenderUnit(e.context);l.addRenderUnit(d),a.push(l),c.push(d),h=d}return h.addRenderUnit(o),c.push({destroy:function(){h&&h.removeRenderUnit(o),o.destroy()}}),{contentProvider:i,colorTransformer:n,renderUnits:a,destroyables:c,collidingPrimitives:[]}}(t,e,i,0,s);var n,o={get:function(t){var e;return null===(e=this.provider)||void 0===e?void 0:e.get(t)}};(null==r?void 0:r.modelsAppearingAnimation)&&(n=new t.ModelsAnimationManager(e.camera,e.renderLoop,i.visibilityManager,r.modelsAppearingAnimation.duration,r.modelsAppearingAnimation.transitionZoom,r.modelsAppearingAnimation.limitByZoom));var a=new t.ModelRenderUnit(i.scene[3],e.context,{heightFactor:null==n?void 0:n.heightProvider,colorTransform:o},{hitTest:!0}),c=new t.FxaaRenderUnit(e.context,e.renderLoop),h=new t.BuildingsRenderUnit(e.context);h.addRenderUnit(a),c.addRenderUnit(h);var l=[a];return n&&l.push(n),{contentProvider:i,destroyables:l,colorTransformer:o,renderUnits:[c],collidingPrimitives:[],rootRenderUnit:h}},icons:function(t,e,i,r){var s,n,o={get:function(t){var e;return null===(e=this.provider)||void 0===e?void 0:e.get(t)}},a=new t.IconRenderUnit(i.scene[7],e.context,e.camera,{visibility:e.visibilityTextureProvider,colorTransform:o},{hitTest:!0,iconHitTestField:null===(s=null==r?void 0:r.iconsInteractiveArea)||void 0===s?void 0:s.field,iconHitTestMinSize:null===(n=null==r?void 0:r.iconsInteractiveArea)||void 0===n?void 0:n.minSize}),c=new t.ColorIdIconRenderer(i.scene[7],e.context,e.camera,{clearDepth:null==r?void 0:r.isolateObjectsColliding}),h=new t.CollidingPrimitivesResetRemovedRenderer(i.scene[7],e.context);return{contentProvider:i,colorTransformer:o,renderUnits:[a],collidingPrimitives:[[i.scene[7],c,h]],destroyables:[c,h]}},labels:function(t,e,i){var r=e.context,s=e.camera,n=i.scene,o={get:function(t){var e;return null===(e=this.provider)||void 0===e?void 0:e.get(t)}},a=new t.PointLabelRenderUnit(n[5],r,s,{visibility:e.visibilityTextureProvider,colorTransform:o},{hitTest:!0}),c=new t.CurvedLabelRenderUnit(n[6],r,s,{visibility:e.visibilityTextureProvider}),h=new t.ColorIdCurvedLabelRenderer(n[6],e.context,e.camera),l=new t.LabelResetRemovedRenderer(n[6],e.context),d=new t.ColorIdPointLabelRenderer(n[5],e.context,e.camera),u=new t.LabelResetRemovedRenderer(n[5],e.context);return{contentProvider:i,colorTransformer:o,renderUnits:[c,a],collidingPrimitives:[[n[6],h,l],[n[5],d,u]],destroyables:[h,d,l,u]}},graphics:function(t,e,i){var r=e.context,s=e.camera,n=e.visibilityManager,o=(e.visibilityTextureProvider,i.scene),a={get:function(t){var e;return null===(e=this.provider)||void 0===e?void 0:e.get(t)}},c=[],h=function(){return n.noCollidingVisibilityTexture},l=new t.ContentPortionPrimitiveProvider,d=new t.GraphicsRenderUnit(r,o,l),u=new t.PolygonRenderUnit(l.getProvider(0),r,{},{hitTest:!0}),f=new t.TransparentPolygonRenderUnit(l.getProvider(1),r,{},{hitTest:!0}),_=new t.PolylineRenderUnit(l.getProvider(4),r,s,{},{hitTest:!0,snapGeometryToNearestZoom:!0}),p=new t.IconRenderUnit(l.getProvider(7),r,s,{visibility:h},{hitTest:!0}),m=new t.LayerRenderUnit(r,1);return d.addRenderUnit(u),d.addRenderUnit(f),d.addRenderUnit(_),d.addRenderUnit(p),{contentProvider:i,colorTransformer:a,renderUnits:[m,d],collidingPrimitives:c,destroyables:[u,f,_,p]}}},k=i(16);i.d(e,"VectorMapEngine",(function(){return B}));var I=[],E=function(t){var e=Math.floor(t);return t-e<.5?e:e+1},B=function(t){function e(e,i,r,o,a,c,h,l){var d=t.call(this)||this;return d._processingQueue=new m.a(20),d._contentProvidersBySource=new n.Map,d._layersById=new n.Map,d._layerDescriptions=[],d._dataSources={},d._filters=new n.Map,d._finalizeSetLayers=function(t,e,i){d._layersById.forEach((function(t){for(var e=0,i=t.renderUnits;e<i.length;e++){var r=i[e];d._engine.renderer.removeRenderUnit(r)}})),d._contentProvidersBySource=i,d._layerDescriptions=t,d._layersById=e,d._layersById.forEach((function(t){for(var e=0,i=t.renderUnits;e<i.length;e++){var r=i[e];d._engine.renderer.addRenderUnit(r)}})),d._contentProvidersBySource.forEach((function(t){d._updateDataSourceZoomRange(t,d._camera)})),d._asyncSetLayersAbortController=void 0,d._emit("indoorPlansChanged")},d._createContentProvider=function(t){var e,i,r=t.source,s=t.sourceName;if(r instanceof A.a)return d._createGraphicsContentProvider(r,s);if(r instanceof _.a)return d._createTile3dContentProvider(r,s);var n=r.vectorSourceDescription,o={iconUrlTemplate:n.imageUrl,glyphRangeUrlTemplate:n.glyphRangeUrl,tileUrlTemplate:n.tileUrl,meshUrlTemplate:n.meshUrl,tileSize:d._getVectorTileSize(n.requestTileSize||"X1"),preloadedTilesBeltWidth:n.tileBeltSize||0,useLowPrecisionBeltTiles:n.lowPrecisionBeltTiles,tileCacheSize:n.tileCacheSize||100,indoorPlanUrlTemplate:n.indoorPlanUrl,basePriority:d._getVectorContentProviderPriority(n.priority),objectsCollisionPriority:d._getVectorCollisionPriority(null!==(e=n.collisionPriority)&&void 0!==e?e:"medium"),customizationConfig:null!==(i=n.customization)&&void 0!==i?i:I,tileRequestWithCredentials:n.tileRequestWithCredentials,iconRequestWithCredentials:n.imageRequestWithCredentials,glyphRequestWithCredentials:n.glyphRequestWithCredentials,meshRequestWithCredentials:n.meshRequestWithCredentials,mapMode:"night"===n.mapMode?1:0,allObjectsInteractive:n.allObjectsInteractive,computeIconBrightnessRange:!0},a=n.indoorPlanUrl?3:n.iconsOnlyTiles?1:0,c=d._contentProdiver.initContentProvider(a,s,o);if(c instanceof d.vector.IndoorContentProvider)c.onPlansChanged.addListener(d._onPlansChanged),d._colorTransformers.indoorOpacity=c.colorTransformProvider;else{var h=d._contentProdiver,l=h.coveredByIndoorFilter,u=h.buildingsFilter;d._toggleVisibilityFilter(c,l,!0,[7,5,3]),d._toggleVisibilityFilter(c,u,!0,[3])}var f=r.group().on("changed",(function(){var t,e=c.options,i=null!==(t=r.vectorSourceDescription.customization)&&void 0!==t?t:I;i!==e.customizationConfig&&c.updateCustomizationConfig(i);var s=r.vectorSourceDescription,n=s.tileUrl,o=s.imageUrl,a=n!==e.tileUrlTemplate?n:void 0,h=o!==e.iconUrlTemplate?o:void 0;(a||h)&&c.updateUrlTemplates({tileUrlTemplate:a,iconUrlTemplate:h}),d._applyMapMode(c,r.vectorSourceDescription)}));return c.visibilityManager.onViewportStateChanged.addListener(d._onViewportStateChanged),d._filters.forEach((function(t){d._toggleVisibilityFilter(c,t,!0)})),{contentProvider:c,source:r,sourceSubscription:f,type:"tile"}},d._destroyContentProvider=function(t){"tile"===t.type?t.contentProvider.visibilityManager.onViewportStateChanged.removeListener(d._onViewportStateChanged):"graphics"===t.type&&t.contentProvider.visibilityManager.onStateChanged.removeListener(d._onGraphicsStateChanged),t.sourceSubscription.offAll(),d._contentProdiver.destroyContentProvider(t.contentProvider)},d._onPlansChanged=function(){return d._emit("indoorPlansChanged")},d._onViewportStateChanged=function(){d._emit("stateChanged"),d._areTilesReady()&&(d._emit("tilesLoaded"),d._emit("tilesReady"))},d._onGraphicsStateChanged=function(){d._emit("stateChanged")},d._createLayerImplementation=function(t,e,i){var r,n="graphics"===e.type?"graphics":t.type,o=L[n];o||Object(w.c)(new Error("Unknown type for vector layer: ".concat(t.type)));var a=t.options.vector.parentLayerId,c=a?d._layersById.get(a):void 0,h=Object(s.a)(Object(s.a)({},o(d.vector,d._engine,e.contentProvider,t.options.vector,c)),{source:d._dataSources[t.source],sourceSubscription:d._dataSources[t.source].group()});h.colorTransformer.provider=i||d._colorTransformers.general,d._setupHotspotLayer(h,t),h.sourceSubscription.on("changed",(function(){d._teardownHotspotLayer(h),d._setupHotspotLayer(h,t)}));for(var l=0,u=h.collidingPrimitives;l<u.length;l++){var f=u[l];(r=d._engine.visibilityManager).registerCollidingPrimitives.apply(r,f)}return h},d._destroyLayerImplementation=function(t){var e;t.sourceSubscription.offAll(),d._teardownHotspotLayer(t);for(var i=t.collidingPrimitives.length-1;i>=0;i--)(e=d._engine.visibilityManager).deregisterCollidingPrimitives.apply(e,t.collidingPrimitives[i]);for(i=t.renderUnits.length-1;i>=0;i--){var r=t.renderUnits[i];d._engine.renderer.removeRenderUnit(r),r.destroy&&r.destroy()}for(var s=0,n=t.destroyables;s<n.length;s++){n[s].destroy()}},d.renderLoop=h,d.vector=e,d.worldOptions=l,d._metricsTransport=new y(i),d._applyDataSources(c),d.element=r.canvas,d.element.style.width="100%",d.element.style.height="100%",d._context=new d.vector.Context(r),d._vectorRenderLoop=new O(d.vector,h),d._size=o,d._renderLoopSubscription=h.on("render",(function(t){d._layersById.forEach((function(e){var i=e.hotspotLayer;return i&&i.render(t)}))})).on("beforeRender",(function(){(!d._renderedSize&&Boolean(d._size)||!u.areEqual(d._size,d._renderedSize))&&d._doResize()})),d._engine=new d.vector.Engine(d._context,new d.vector.Camera({wrapModeX:2,wrapModeY:0,minTilt:b.d,maxTilt:b.c}),d._vectorRenderLoop),d._backgroundRenderUnit=new d.vector.BackgroundRenderUnit(d._context),d._engine.renderer.addRenderUnit(d._backgroundRenderUnit),d._applyBackgroundColor(c),d._engine.onInternalError.addListener((function(){return d._emit("internalError")})),d._updateRenderLoop=d.renderLoop.update.bind(d.renderLoop),d._contentProdiver=d.vector.createContentProvider(d._engine.camera,d._engine.context,d._engine.renderLoop,d._metricsTransport),d._colorTransformers={general:{get:function(t){var e,i;return(null===(e=d._colorTransformers.hoverHighlight)||void 0===e?void 0:e.get(t))||(null===(i=d._colorTransformers.indoorOpacity)||void 0===i?void 0:i.get(t))}}},d.update(a),d}return Object(s.b)(e,t),e.prototype.getLayerReadyState=function(t){var e,i=null===(e=this._layersById.get(t))||void 0===e?void 0:e.contentProvider;if(i){var r={tilesReady:0,tilesLoaded:0,tilesTotal:0,graphicsReady:0,graphicsTotal:0};if(i instanceof this.vector.GraphicsContentProvider&&(r.graphicsReady=i.visibilityManager.state.objectsVisible,r.graphicsTotal=i.visibilityManager.state.objectsTotal),i instanceof this.vector.VectorMapContentProvider){var s=i.visibilityManager.viewportState.visibleTileNumber,n=i.visibilityManager.viewportState.visualizableTileNumber;r.tilesReady=n,r.tilesLoaded=n,r.tilesTotal=s}return r}},e.prototype.destroy=function(){this.setLayers([]),this._backgroundRenderUnit.destroy(),this._renderLoopSubscription.offAll(),this._engine.destroy(),this._context.destroy(),this._vectorRenderLoop.destroy(),this._asyncSetLayersAbortController&&(this._asyncSetLayersAbortController.abort(),this._asyncSetLayersAbortController=void 0)},e.prototype.setDataSources=function(t){this._applyDataSources(t),this._applyBackgroundColor(t),this.setLayers(this._layerDescriptions)},e.prototype.update=function(t){var e=this;this._camera=t,this._engine.camera.zoom=t.zoom,this._engine.camera.center.x=t.worldCenter.x,this._engine.camera.center.y=t.worldCenter.y,this._engine.camera.azimuth=t.azimuth,this._engine.camera.tilt=t.tilt,this._engine.camera.flushUpdates(),this._layersById.forEach((function(i){var r=i.hotspotLayer;return r&&r.update(t,e.fov)})),this._contentProvidersBySource.forEach((function(i){return e._updateDataSourceZoomRange(i,t)}))},e.prototype.resize=function(t){this._size=t},e.prototype.setLayers=function(t){var e=this;this._abortAndCleanupAsyncLayersInitIfInProgress();for(var i=new n.Map,r=new n.Map,s=0,o=t;s<o.length;s++){var a=o[s],c=this._dataSources[a.source];c instanceof f.a&&!c.vectorSourceDescription&&Object(w.c)(new Error("".concat(a.id," does not have vector source"))),i.set(a.id,a),r.set(a.source,{source:c,sourceName:a.source})}var h=Object(d.a)(this._contentProvidersBySource,r,this._createContentProvider,this._destroyContentProvider,(function(){}),(function(){return!0})).result,l=this._getColorTransformersByLayers(t),u=Object(d.a)(this._layersById,i,(function(t){var i=h.get(t.source);return e._createLayerImplementation(t,i,l[t.id])}),this._destroyLayerImplementation,(function(t,i){t.colorTransformer.provider=l[i.id]||e._colorTransformers.general}),(function(t,i){return t.source===e._dataSources[i.source]}));this._finalizeSetLayers(t,u.result,h)},e.prototype.initLayersAsync=function(t,e){var i,r=this;if(e.aborted)return Promise.reject(new v.a);this._asyncSetLayersAbortController=new o.AbortController;var s=this._asyncSetLayersAbortController.signal,c=function(){e.removeEventListener("abort",c),r._abortAndCleanupAsyncLayersInitIfInProgress()};e.addEventListener("abort",c);for(var h=this._getColorTransformersByLayers(t),l=new n.Map,d=new n.Map,u=[],_=function(t){var e=p._dataSources[t.source];e instanceof f.a&&!e.vectorSourceDescription&&Object(w.c)(new Error("".concat(t.id," does not have vector source.")));var n=null!==(i=l.get(t.source))&&void 0!==i?i:p._createContentProvider({source:e,sourceName:t.source});l.set(t.source,n);u.push(new Promise((function(t){return setTimeout(t)})).then((function(){if(!s.aborted){var e=r._createLayerImplementation(t,n,h[t.id]);d.set(t.id,e)}})))},p=this,m=0,g=t;m<g.length;m++){_(g[m])}return Object(a.promiseFinally)(new Promise((function(t,e){s.addEventListener("abort",(function(){l.forEach(r._destroyContentProvider),t()})),Promise.all(u).then((function(){return t()})).catch((function(t){Object(w.b)(t),e(t)}))})).then((function(){s.aborted||r._finalizeSetLayers(t,d,l)})),(function(){e.removeEventListener("abort",c),r._asyncSetLayersAbortController&&(r._asyncSetLayersAbortController=void 0)}))},e.prototype.preloadHotspotsInPoint=function(t){this._layersById.forEach((function(e){e.hotspotLayer&&e.hotspotLayer.preloadHotspotsInPoint(t)}))},e.prototype.preloadHotspotsForViewport=function(){this._layersById.forEach((function(t){t.hotspotLayer&&t.hotspotLayer.preloadHotspotsForViewport()}))},e.prototype.setObjectFilters=function(t){for(var e=this,i=Object(d.a)(this._filters,t,(function(t){var i=new e.vector.EventTrigger,r=t.on("update",(function(){return i.fire()}));return{filter:t,onUpdate:i,subscription:r,test:function(e){return t.test(e)}}}),(function(t){t.subscription.offAll()})),r=function(t){s._contentProvidersBySource.forEach((function(i){"tile"===i.type&&e._toggleVisibilityFilter(i.contentProvider,t,!1)}))},s=this,n=0,o=i.removed;n<o.length;n++){r(o[n])}for(var a=function(t){c._contentProvidersBySource.forEach((function(i){"tile"===i.type&&e._toggleVisibilityFilter(i.contentProvider,t,!0)}))},c=this,h=0,l=i.created;h<l.length;h++){a(l[h])}this._filters=i.result},e.prototype.setInvisibleCollidingPrimitives=function(t){var e=this._engine.invisibleCollidingPrimitiveManager,i=[];t.forEach((function(t){return i.push(t)})),e.clear(),e.addPrimitives.apply(e,i)},e.prototype.getIndoorPlans=function(){var t=this,e=[];if(this._contentProvidersBySource.forEach((function(i,r){var s=i.contentProvider;s instanceof t.vector.IndoorContentProvider&&e.push([s,r])})),0===e.length)return null;for(var i=[],r=0,s=e;r<s.length;r++){var n=s[r],o=n[0],a=n[1];if(!o.isPaused)for(var c=0,h=o.plans;c<h.length;c++){var l=h[c];i.push(new p(a,l))}}return i},e.prototype.getVisibleObjects=function(t){var e=this._contentProvidersBySource.get(t);if(!e)return null;if("graphics"===e.type||"tile3d"===e.type)return null;for(var i=[],r=e.contentProvider.scene[7].visiblePrimitives[n.Symbol.iterator](),s=r.next();!s.done;s=r.next())s.value.metadata&&i.push(s.value.metadata);return i},e.prototype._abortAndCleanupAsyncLayersInitIfInProgress=function(){this._asyncSetLayersAbortController&&(this._asyncSetLayersAbortController.abort(),this._asyncSetLayersAbortController=void 0)},e.prototype._applyDataSources=function(t){this._dataSources={};for(var e=0,i=Object.keys(t);e<i.length;e++){var r=i[e],s=t[r];(s instanceof f.a&&s.vectorSourceDescription||s instanceof A.a||s instanceof _.a)&&(this._dataSources[r]=s)}},e.prototype._updateDataSourceZoomRange=function(t,e){var i=t.source,r=t.contentProvider;if(i instanceof f.a&&i.zoomRange){var s=e.zoom>=i.zoomRange.min&&e.zoom<=i.zoomRange.max;this._setContentProviderActive(r,s)}},e.prototype._setContentProviderActive=function(t,e){var i=!1;e&&t.isPaused?(t.resume(),i=!0):e||t.isPaused||(t.pause(),i=!0),i&&t instanceof this.vector.IndoorContentProvider&&this._onPlansChanged()},e.prototype._isNightMapMode=function(t){var e=Object(n.arrayFind)(Object.keys(t),(function(e){var i,r=t[e];return r instanceof f.a&&"night"===(null===(i=r.vectorSourceDescription)||void 0===i?void 0:i.mapMode)}));return Boolean(e)},e.prototype._applyMapMode=function(t,e){this._applyBackgroundColor(this._dataSources);var i="night"===e.mapMode?1:0;t.setMapMode(i)},e.prototype._applyBackgroundColor=function(t){this._backgroundRenderUnit.setColor(this._isNightMapMode(t)?this.vector.BackgroundColor.DARK:this.vector.BackgroundColor.LIGHT)},e.prototype._doResize=function(){var t=this,e=Math.max(this._size.x,1),i=Math.max(this._size.y,1),r=Object(l.a)();this._engine.camera.screenSize.width=e,this._engine.camera.screenSize.height=i,this._engine.camera.flushUpdates(),this._engine.setRenderTargetSize({width:e*r,height:i*r}),this._layersById.forEach((function(e){var i=e.hotspotLayer;return i&&i.resize(t._size)})),this._renderedSize=this._size},e.prototype._createGraphicsContentProvider=function(t,e){var i=this._contentProdiver.initContentProvider(4,e,{basePriority:200,objectsCollisionPriority:2});i.visibilityManager.onStateChanged.addListener(this._onGraphicsStateChanged);var r=function(e){var r=t.features.get(e),s=T(r),n=s.feature,o=s.style;i.addObject(n,o,U(r.parentGroupId),e)},s=function(t){i.removeObject(t)},n=function(e){var r=t.groups.get(e);i.addGroup({opacity:r.style.opacity,zIndex:r.style.zIndex},U(r.parentGroupId),e)},o=t.on("featureAdded",r).on("featureRemoved",s).on("featureUpdated",(function(e){var r=T(t.features.get(e)),s=r.feature,n=r.style;i.updateObject(e,s,n)})).on("groupAdded",n).on("groupRemoved",(function(t){var e=t.id;i.removeGroupAndChildren(e)})).on("featureMovedToGroup",(function(t){s(t),r(t)})),a=function(t){n(t.id);for(var e=0,i=t.children;e<i.length;e++){var s=i[e];"feature"===s.type?r(s.id):a(s)}};return a(t.groups.get(A.b)),{contentProvider:i,source:t,sourceSubscription:o,type:"graphics"}},e.prototype._createTile3dContentProvider=function(t,e){var i=this,r=this._contentProdiver.initContentProvider(6,e,{basePriority:this._getVectorContentProviderPriority(t.priority),gltfDecoderWorkerUrl:t.workerUrl}),s=new n.Map,o=t.on("rootTileAdded",(function(t){var e=t.uri,n=t.tile,o=t.buildingObjectIds,a=t.detalizationFactor,c=new i.vector.Cesium3DTileSet(e,n,void 0,a);r.addRootTile(c,o),s.set(e,c)})).on("rootTileRemoved",(function(t){var e=s.get(t);e&&r.removeRootTile(e)}));return{type:"tile3d",source:t,sourceSubscription:o,contentProvider:r}},e.prototype._getVectorContentProviderPriority=function(t){return{low:100,medium:200,high:300}[t]},e.prototype._getVectorTileSize=function(t){return{X1:0,X4:1,X16:2}[t]},e.prototype._getVectorCollisionPriority=function(t){return{low:0,medium:1,high:2,ultra:3}[t]},e.prototype._getColorTransformersByLayers=function(t){var e=this;return t.reduce((function(t,i){var r=i.options.vector.transformLayers||{};if(Object.keys(r).forEach((function(i){var s=e.vector.createColorTransform(r[i]);t[i]={get:function(){return s}}})),"number"==typeof i.options.vector.opacity){var s=Object(k.b)(i.options.vector.opacity,0,1),n=e.vector.createColorTransform({opacity:s});t[i.id]={get:function(){return n}}}return t}),{})},e.prototype._setupHotspotLayer=function(t,e){var i=this._dataSources[e.source];if(i instanceof f.a){var r=(i.vectorSourceDescription.hotspots||{})[e.type];if("function"==typeof r){var s=new g.a(this._size,this._camera,{fetchHotspots:r,hotspotAbortRadius:i.hotspotAbortRadius,tileSize:i.tileSize,zoomRange:i.zoomRange,inset:c.b,padding:0,internalFindHotspotInPosition:void 0},this._processingQueue,this.worldOptions,E);s.on("requestRender",this._updateRenderLoop),t.hotspotLayer=s}}},e.prototype._teardownHotspotLayer=function(t){t.hotspotLayer&&(t.hotspotLayer.offSingle("requestRender",this._updateRenderLoop),t.hotspotLayer.destroy())},e.prototype._areTilesReady=function(){var t=!0;return this._contentProvidersBySource.forEach((function(e){if("tile"===e.type){var i=e.contentProvider.visibilityManager.viewportState;t=t&&i.visibleTileNumber===i.visualizableTileNumber}})),t},e.prototype.findObjectInPosition=function(t){var e=Object(x.d)(t,Object(s.a)(Object(s.a)({},this._camera),{fov:this.fov,size:{x:this._engine.camera.screenSize.width,y:this._engine.camera.screenSize.height}})),i=this._engine.getObjectIdAt(u.muln(e,Object(l.a)())),r=this._contentProdiver.getObjectMetadata(i);if(!r)return this._findRasterHotspotObjectAbove(t,void 0);var n=r.get("uri"),o=r.get("position"),a=r.get("objectId"),c=o?o.split(",").map(Number):void 0,h=(r.get("tags")||r.get("eventTags")||r.get("group")||"").split(",").filter(Boolean),d=r.get(this.vector.VECTOR_METADATA_PREFIX+"layerName"),_=this._findLayerForMetadata(h,d),p=this._findRasterHotspotObjectAbove(t,_);if(p)return p;if(!_)return null;var m=this._dataSources[d],g=m instanceof f.a&&m.vectorSourceDescription.hotspots;return g&&!this._areHotspotsEnabled(g[_.type])?null:m instanceof A.a?a?{type:"feature",featureId:a,layer:_.id,source:d}:null:{type:"hotspot",layer:_.id,source:d,feature:{type:"Feature",id:a||n||o||"",geometry:c&&{type:"Point",coordinates:{x:c[0],y:c[1]}},properties:{uri:n,tags:h,name:r.get("name"),selectedIconUrl:r.get(this.vector.VECTOR_METADATA_PREFIX+"selectedIconUrl"),vectorMetadata:r,vectorId:i}}}},e.prototype.findObjectInPositionEx=function(t){var e,i=this.findObjectInPosition(t),r=this._layerDescriptions.slice().reverse(),s=Object(n.arrayFindIndex)(r,(function(t){return t.id===(null==i?void 0:i.layer)}));s>=0&&(r=r.slice(0,s));var o={layers:[]};return(e=o.layers).push.apply(e,r.map((function(t){return{layer:t.id,object:null}}))),i&&o.layers.push({layer:i.layer,object:i}),o},e.prototype.setObjectHighlight=function(t){var e=null==t?void 0:t.object.properties.vectorMetadata,i=null==e?void 0:e.get("objectId");if(t&&e&&i){var r=this.vector.createColorTransform(t.color);this._colorTransformers.hoverHighlight={get:function(t){var e=t.metadata;return e&&e.get("objectId")===i?r:void 0}}}else this._colorTransformers.hoverHighlight=void 0;this._vectorRenderLoop.update()},e.prototype._findRasterHotspotObjectAbove=function(t,e){for(var i=0,r=this._layerDescriptions.slice().reverse();i<r.length;i++){var n=r[i],o=this._layersById.get(n.id);if(o.hotspotLayer){var a=o.hotspotLayer.findObjectInPosition(t);if(a)return Object(s.a)(Object(s.a)({},a),{layer:n.id,source:n.source})}if(n===e)return null}return null},e.prototype._findLayerForMetadata=function(t,e){for(var i=-1!==t.indexOf("building"),r=0,s=this._layerDescriptions;r<s.length;r++){var o=s[r];if(o.source===e&&(i&&"buildings"===o.type||"icons"===o.type))return o}return Object(n.arrayFind)(this._layerDescriptions,(function(t){return t.source===e}))},e.prototype._areHotspotsEnabled=function(t){return"object"==typeof t?void 0===t.minZoom||this._engine.camera.zoom>=t.minZoom:void 0===t||!0===t},e.prototype._toggleVisibilityFilter=function(t,e,i,r){void 0===r&&(r=[7,5]);for(var s=i?"addVisibilityFilter":"removeVisibilityFilter",n=0,o=r;n<o.length;n++){var a=o[n];t[s](a,e)}},Object.defineProperty(e.prototype,"fov",{get:function(){return this._engine.camera.fov},enumerable:!1,configurable:!0}),e}(Object(h.a)().with());function U(t){return t===A.b||null===t?void 0:t}},64:function(t,e,i){"use strict";i.d(e,"a",(function(){return n})),i.d(e,"c",(function(){return s})),i.d(e,"b",(function(){return o}));var r=i(13),s=function(){return{min:0,max:21}},n=function(t){t.min>=t.max&&Object(r.c)(new Error("Invalid zoom range, min >= max (".concat(t.min," >= ").concat(t.max,")"))),(t.min<0||t.max<0)&&Object(r.c)(new Error("Invalid zoom range, min or max is less than zero (min=".concat(t.min," max=").concat(t.max,")")))},o=function(t,e,i){return void 0===i&&(i=s()),i.min=Math.max(t.min,e.min),i.max=Math.min(t.max,e.max),i}},65:function(t,e,i){"use strict";function r(t,e,i){return{x:t,y:e,z:i}}i.d(e,"e",(function(){return r})),i.d(e,"a",(function(){return s})),i.d(e,"d",(function(){return n})),i.d(e,"c",(function(){return o})),i.d(e,"m",(function(){return a})),i.d(e,"i",(function(){return c})),i.d(e,"j",(function(){return h})),i.d(e,"g",(function(){return l})),i.d(e,"f",(function(){return d})),i.d(e,"k",(function(){return u})),i.d(e,"l",(function(){return f})),i.d(e,"b",(function(){return _})),i.d(e,"h",(function(){return p}));var s=r(0,0,0);function n(t,e){return void 0===e&&(e=r(0,0,0)),e.x=t.x,e.y=t.y,e.z=t.z,e}function o(t,e,i){return void 0===i&&(i=r(0,0,0)),i.x=t.x+e.x,i.y=t.y+e.y,i.z=t.z+e.z,i}function a(t,e,i){return void 0===i&&(i=r(0,0,0)),i.x=t.x-e.x,i.y=t.y-e.y,i.z=t.z-e.z,i}function c(t,e,i){return void 0===i&&(i=r(0,0,0)),i.x=t.x*e.x,i.y=t.y*e.y,i.z=t.z*e.z,i}function h(t,e){return void 0===e&&(e=r(0,0,0)),function(t,e,i){return void 0===i&&(i=r(0,0,0)),i.x=t.x/e,i.y=t.y/e,i.z=t.z/e,i}(t,function(t){return Math.sqrt(Math.pow(t.x,2)+Math.pow(t.y,2)+Math.pow(t.z,2))}(t),e)}function l(t,e){return t.x*e.x+t.y*e.y+t.z*e.z}function d(t,e,i){void 0===i&&(i=r(0,0,0));var s=t.y*e.z-t.z*e.y,n=t.z*e.x-t.x*e.z,o=t.x*e.y-t.y*e.x;return i.x=s,i.y=n,i.z=o,i}function u(t,e,i){void 0===i&&(i=r(0,0,0));var s=Math.cos(e),n=Math.sin(e),o=t.y;return i.x=t.x,i.y=o*s-t.z*n,i.z=o*n+t.z*s,i}function f(t,e,i){void 0===i&&(i=r(0,0,0));var s=Math.cos(e),o=Math.sin(e);return t=t===i?n(t):t,i.x=t.x*s-t.y*o,i.y=t.x*o+t.y*s,i.z=t.z,i}var _={normal:r(0,0,1),distance:0};function p(t,e,i){void 0===i&&(i=r(0,0,0));var s=l(e.direction,t.normal);if(0===s)return null;var a=(t.distance-l(t.normal,e.origin))/s;return a<0?null:(n(e.direction,i),function(t,e,i){void 0===i&&(i=r(0,0,0)),i.x=t.x*e,i.y=t.y*e,i.z=t.z*e}(i,a,i),o(i,e.origin,i),i)}},80:function(t,e,i){"use strict";i.r(e),i.d(e,"AbortController",(function(){return r}));var r,s=i(8),n=i(11),o=window;if(o.AbortController)r=o.AbortController;else{var a=function(t){function e(e){var i=t.call(this)||this;return i.onabort=null,i._controller=e,i}return Object(s.b)(e,t),Object.defineProperty(e.prototype,"aborted",{get:function(){return this._controller.aborted},enumerable:!1,configurable:!0}),e.prototype.addEventListener=function(t,e){this.on(String(t),e)},e.prototype.removeEventListener=function(t,e){this.offSingle(String(t),e)},e.prototype.dispatchEvent=function(t){return this.onabort&&this.onabort(t),this._emit(t.type,t),!1},e}(Object(n.a)().with());r=function(){function t(){this._aborted=!1,this.signal=new a(this)}return t.prototype.abort=function(){if(!this._aborted){this._aborted=!0;var t=document.createEvent("Event");t.initEvent("abort",!1,!1),this.signal.dispatchEvent(t)}},Object.defineProperty(t.prototype,"aborted",{get:function(){return this._aborted},enumerable:!1,configurable:!0}),t}()}},81:function(t,e,i){"use strict";i.d(e,"a",(function(){return c})),i.d(e,"b",(function(){return a}));var r=i(80),s=i(25),n=i(82),o=i(13),a=function(){var t=this;this.promise=new Promise((function(e,i){t.resolve=e,t.reject=function(t){t&&Object(o.b)(t),i(t)}}))},c=function(){function t(t){var e=this;this._queue=[],this._processing=[],this._paused=!1,this._changed=!1,this._onTaskAbort=function(t,i){var r=e._processing.indexOf(t);if(-1!==r)e._processing.splice(r,1);else{var s=e._queue.indexOf(t);-1!==s&&e._queue.splice(s,1),i.reject(new n.a)}},this._maxConcurrency=t}return t.prototype.enqueue=function(t,e){var i=this;void 0===e&&(e=0);var s=new r.AbortController,n=new a,o={task:t,abortController:s,process:function(){return t(s.signal).then(n.resolve,n.reject)},priority:e};return s.signal.addEventListener("abort",(function(){return i._onTaskAbort(o,n)})),this._queue.push(o),this._changed=!0,this._paused||this._process(),{abortController:s,promise:n.promise,updatePriority:function(){o.priority=e,i._changed=!0}}},t.prototype.pause=function(){this._paused=!0},t.prototype.resume=function(){this._paused=!1,this._process()},t.prototype._process=function(){var t,e=this;if(!(this._processing.length>=this._maxConcurrency)){this._changed&&this._queue.sort((function(t,e){return t.priority-e.priority}));var i=this._queue.splice(0,this._maxConcurrency-this._processing.length);(t=this._processing).push.apply(t,i);for(var r=function(t){Object(s.promiseFinally)(t.process(),(function(){var i=e._processing.indexOf(t);-1!==i&&e._processing.splice(i,1),e._process()}))},n=0,o=i;n<o.length;n++){r(o[n])}}},t}()},82:function(t,e,i){"use strict";i.d(e,"a",(function(){return s}));var r=i(8),s=function(t){function e(i){var r=t.call(this,void 0===i?"Aborted":i)||this;return r.name="AbortError",r.__proto__=e.prototype,r}return Object(r.b)(e,t),e}(Error)},83:function(t,e,i){"use strict";i.d(e,"a",(function(){return d})),i.d(e,"c",(function(){return u})),i.d(e,"b",(function(){return f})),i.d(e,"f",(function(){return m})),i.d(e,"h",(function(){return p})),i.d(e,"d",(function(){return g})),i.d(e,"e",(function(){return y})),i.d(e,"g",(function(){return _}));var r=i(8),s=i(10),n=i(17),o=i(12),a=i(16),c=i(98),h=i(65),l=i(13);function d(t,e,i,r){var s=o.divn(e,2*i),n=o.sub(t,s);o.divn(n,r,n),o.applyFunction(n,Math.floor,n);var a=o.add(t,s);return o.divn(a,r,a),o.applyFunction(a,Math.floor,a),{minX:n.x,minY:n.y,maxX:a.x,maxY:a.y}}function u(t,e,i,r,s){var n=o.divn(i,2*r);return[{x:n.x,y:n.y},{x:n.x,y:-n.y},{x:-n.x,y:-n.y},{x:-n.x,y:n.y}].map((function(t){return o.rotate(t,-e)})).map((function(e){return o.sub(t,e)})).map((function(t){return o.divn(t,s)}))}function f(t,e,i,a,c,d,u){var f={worldCenter:t,zoom:Object(s.mathLog2)(Math.pow(2,a)*c),azimuth:e,tilt:i},_=function(t,e,i,s,a){var c=e.worldCenter,d=e.tilt,u=e.azimuth,f=e.zoom,_={x:0,y:0,z:.5*-n.a.convertPixelSizeToWorldSize(i,f).y/Math.tan(.5*t)};h.k(_,d,_),h.l(_,u,_),h.c(_,Object(r.a)(Object(r.a)({},c),{z:0}),_);for(var p=Math.tan(.5*t),m=i.x/i.y,g=h.e(p*m,p,1),y=[h.d(h.a),h.d(h.a),h.d(h.a),h.d(h.a)],b=h.e(0,0,0),x={origin:_,direction:b},w=0;w<4;++w){h.i(v[w],g,b),h.k(b,d,b),h.l(b,u,b),h.h(h.b,x,y[w])||Object(l.c)(new Error("Visible quadrilateral is unbounded, engine can't handle that case (yet)"))}return y.map((function(t){var e=n.a.worldToPixels(t,s);return o.divn(e,a)}))}(Math.PI/6,f,d,a,u),p=function(t){for(var e=1/0,i=-1/0,r=[],s=0,n=1;s<t.length;++s,n=++n%t.length){var o=[t[s],t[(s+1)%t.length]].sort((function(t,e){return t.y-e.y})),a=o[0],c=o[1],h=Math.floor(a.y),l=Math.ceil(c.y);e=Math.min(e,h),i=Math.max(i,l);var d=(c.x-a.x)/(c.y-a.y),u=a.x-(isFinite(d)?d*(a.y-h):0);r.push({firstRow:h,lastRow:l,startX:a.x,endX:c.x,x:u,k:d})}for(var f=[],_=e;_<i;_++){for(var p=1/0,m=-1/0,g=0,y=r;g<y.length;g++){var v=y[g];if(!(_<v.firstRow||_>=v.lastRow)){var b=v.x+v.k,x=v.k>=0?Math.max(v.x,v.startX):Math.min(v.x,v.startX),w=v.k>=0?Math.min(b,v.endX):Math.max(b,v.endX);p=Math.floor(Math.min(p,x,w)),m=Math.ceil(Math.max(m,x,w)),v.x=b}}for(u=p;u<m;u++)f.push({x:u,y:_})}return f}(_),m=new s.Map;return p.forEach((function(t){return m.set(y(t,a),Object(r.a)(Object(r.a)({},t),{border:!1}))})),{tiles:m,tileBounds:_}}function _(t,e){return t.every((function(t){return Object(c.b)(e,t)}))}function p(t,e){return{x:Object(a.a)(t.x,0,e),y:Object(a.a)(t.y,0,e)}}function m(t,e,i){var r=t.x,s=t.y;return(i.cycledX||r<e&&r>=0)&&(i.cycledY||s<e&&s>=0)}function g(t,e){return Math.ceil(Math.pow(2,t+8)/e)}function y(t,e){return"".concat(t.x,".").concat(t.y,".").concat(e)}var v=[h.e(-1,1,-1),h.e(1,1,-1),h.e(1,-1,-1),h.e(-1,-1,-1)]},98:function(t,e,i){"use strict";function r(t,e){for(var i=e.x,r=e.y,s=t.length-1,n=!1,o=0;o<t.length;o++){var a=t[o].y<=r&&t[s].y>r||t[s].y<=r&&t[o].y>r,c=i>(t[s].x-t[o].x)*(r-t[o].y)/(t[s].y-t[o].y)+t[o].x;a&&c&&(n=!n),s=o}return n}function s(t,e){for(var i=1;i<t.length;i++)if(r(t[i],e))return!1;return r(t[0],e)}function n(t,e){if("Point"===t.type)return!1;if("LineString"===t.type)return!1;if("Polygon"===t.type)return s(t.coordinates,e);if("MultiPolygon"===t.type){for(var i=0,r=t.coordinates;i<r.length;i++){if(s(r[i],e))return!0}return!1}return!1}i.d(e,"b",(function(){return r})),i.d(e,"a",(function(){return n}))},99:function(t,e,i){"use strict";i.d(e,"a",(function(){return s}));var r=i(10);function s(t,e,i,s,n,o){void 0===s&&(s=function(){}),void 0===n&&(n=function(){}),void 0===o&&(o=function(){return!0});var a=new r.Map,c=[],h=[],l=[];function d(t,e){s(t,e),l.push(t)}return e.forEach((function(e,r){var s=t.get(r);if(s&&o(s,e)?(n(s,e),h.push(s)):s&&(d(s,r),s=void 0),!s){var l=i(e);c.push(l),s=l}a.set(r,s)})),t.forEach((function(t,i){e.has(i)||d(t,i)})),{result:a,created:c,updated:h,removed:l}}}}]);